<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pari Alliance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #5D5CDE;
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(93, 92, 222, 0.3);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --event-bg: #f1f1f1;
            --event-border: #e0e0e0;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #ffffff;
            --side-menu-active: #f0f2f5;
            --side-menu-hover: #f5f5f5;
            --log-panel-bg: #f8f9fa;
            --log-panel-border: #e0e0e0;
            --link-hover: #0056b3;
            --admin-notif-bg: #f8f9fa;
            --admin-notif-border: #e0e0e0;
            --forecast-win-bg: rgba(76, 175, 80, 0.2);
            --forecast-loss-bg: rgba(244, 67, 54, 0.2);
            --forecast-pending-bg: rgba(255, 193, 7, 0.2);
            --comment-bg: #f5f5f5;
            --comment-border: #ebebeb;
            --social-whatsapp: #25D366;
            --social-telegram: #0088cc;
            --social-youtube: #FF0000;
            --partner-google: #4285F4;
            --partner-firebase: #FFCA28;
            --partner-github: #333333;
            --partner-quora: #B92B27;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.1);
            --warning-text: #FF9800;
            --image-message-bg: rgba(93, 92, 222, 0.1);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --selected-message-border: rgba(93, 92, 222, 0.7);
            --date-separator-bg: rgba(0, 0, 0, 0.05);
            --date-separator-text: var(--inactive-text);
            --reply-preview-bg: rgba(93, 92, 222, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(0, 0, 0, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: var(--bg-color);
            --action-bar-text: var(--text-color);
            --action-bar-border: var(--border-color);
            --reply-quote-bg: rgba(93, 92, 222, 0.15);
            --reply-quote-border: var(--primary-color);
            --group-info-bg: var(--bg-color);
            --group-info-border: var(--border-color);
            --download-btn-bg: var(--primary-color);
            --download-btn-text: white;
            --new-badge-bg: var(--primary-color);
            --new-badge-text: white;
            --private-chat-bg: #e8f5e8;
            --private-chat-border: #4CAF50;
            --user-status-online: #4CAF50;
            --user-status-offline: #9E9E9E;
        }
        
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --selection-color: rgba(93, 92, 222, 0.4);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --event-bg: #2a2a2a;
            --event-border: #3e3e3e;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #222222;
            --side-menu-active: #333333;
            --side-menu-hover: #2a2a2a;
            --log-panel-bg: #222222;
            --log-panel-border: #3e3e3e;
            --link-hover: #64B5F6;
            --admin-notif-bg: #2a2a2a;
            --admin-notif-border: #333333;
            --forecast-win-bg: rgba(76, 175, 80, 0.15);
            --forecast-loss-bg: rgba(244, 67, 54, 0.15);
            --forecast-pending-bg: rgba(255, 193, 7, 0.15);
            --comment-bg: #2a2a2a;
            --comment-border: #333333;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.15);
            --warning-text: #FFA726;
            --image-message-bg: rgba(93, 92, 222, 0.15);
            --image-viewer-bg: rgba(0, 0, 0, 0.95);
            --selected-message-border: rgba(93, 92, 222, 0.8);
            --date-separator-bg: rgba(255, 255, 255, 0.1);
            --date-separator-text: #aaaaaa;
            --reply-preview-bg: rgba(93, 92, 222, 0.15);
            --reply-preview-border: var(--primary-color);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(255, 255, 255, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: #222222;
            --action-bar-text: #ffffff;
            --action-bar-border: #3e3e3e;
            --reply-quote-bg: rgba(93, 92, 222, 0.2);
            --reply-quote-border: var(--primary-color);
            --group-info-bg: #222222;
            --group-info-border: #3e3e3e;
            --download-btn-bg: #5D5CDE;
            --download-btn-text: white;
            --private-chat-bg: rgba(76, 175, 80, 0.1);
            --private-chat-border: #4CAF50;
            --user-status-online: #4CAF50;
            --user-status-offline: #757575;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: -0.2px;
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            height: 100%;
            width: 250px;
            background-color: var(--side-menu-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .side-menu.active {
            left: 0;
        }
        
        .side-menu-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .side-menu-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 15px;
        }
        
        .side-menu-close {
            font-size: 20px;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
        
        .side-menu-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .side-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .side-menu-item.active {
            background-color: var(--side-menu-active);
        }
        
        .side-menu-item i {
            font-size: 20px;
            width: 30px;
            color: var(--primary-color);
        }
        
        .side-menu-text {
            margin-left: 15px;
            font-weight: 500;
        }
        
        .side-menu-footer {
            margin-top: auto;
        }
        
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .side-menu-overlay.active {
            display: block;
        }
        
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .header.search-active {
            height: 50px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: none;
            text-decoration: none;
            transition: opacity 0.3s ease;
            flex: 1;
        }
        
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
            transition: opacity 0.3s ease;
        }
        
        .menu-button, .back-button, .search-button, .events-button, .info-button {
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .menu-button:active, .back-button:active, .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        .notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: var(--notification-dot);
            border-radius: 50%;
            display: none;
        }
        
        .notification-dot.active {
            display: block;
        }
        
        .events-button {
            position: relative;
        }
        
        .search-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .search-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
            margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        
        .search-close {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-close:active {
            background-color: var(--secondary-color);
        }
        
        .header.search-active .header-left,
        .header.search-active .header-title,
        .header.search-active #header-action {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Message actions header bar */
        .message-actions-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--action-bar-bg);
            border-bottom: 1px solid var(--action-bar-border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .message-actions-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .message-actions-title {
            flex: 1;
            font-weight: 500;
            color: var(--action-bar-text);
        }
        
        .message-action-buttons {
            display: flex;
            gap: 15px;
        }
        
        .message-action-btn {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .message-action-btn:active {
            background-color: var(--secondary-color);
        }
        
        .message-action-btn.delete {
            color: var(--danger-color);
        }
        
        .content {
            position: fixed;
            top: 50px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        .content.no-bottom-nav {
            bottom: 0;
        }
        
        .bottom-nav {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--inactive-text);
            font-size: 10px;
            cursor: pointer;
            height: 100%;
            padding: 8px 0;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        .profile-pic-edit:hover, .profile-pic-edit:active {
            transform: scale(1.1);
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .group-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            z-index: 2;
        }
        
        .group-pic-edit:hover, .group-pic-edit:active {
            transform: scale(1.1);
        }
        
        .chat-item, .user-item, .event-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item.private {
            background-color: var(--private-chat-bg);
            border-left: 3px solid var(--private-chat-border);
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .restricted-badge {
            display: inline-block;
            background-color: var(--restricted-badge-bg);
            color: var(--restricted-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .private-badge {
            display: inline-block;
            background-color: var(--user-status-online);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .new-badge {
            display: inline-block;
            background-color: var(--new-badge-bg);
            color: var(--new-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .user-status {
            position: absolute;
            bottom: 2px;
            right: 14px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-color);
        }
        
        .user-status.online {
            background-color: var(--user-status-online);
        }
        
        .user-status.offline {
            background-color: var(--user-status-offline);
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .loading-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: pulse 2s infinite, bounce 1.5s infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease, background-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button:hover {
            background-color: #4a49c0;
        }

        .button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button.danger:hover {
            background-color: #e53935;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            min-height: 60px;
            max-height: 150px;
            transition: min-height 0.2s ease;
        }
        
        .message-container {
            margin-bottom: 16px;
            clear: both;
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        
        .message-container.sent {
            float: right;
            margin-left: auto;
            align-items: flex-end;
        }
        
        .message-container.received {
            float: left;
            margin-right: auto;
            align-items: flex-start;
        }
        
        .message-sender {
            font-size: 12px;
            margin-bottom: 2px;
            font-weight: bold;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .message {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            border-bottom-left-radius: 4px;
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            border-bottom-right-radius: 4px;
        }

        /* Improved visual marking for selected messages */
        .message.selected {
            box-shadow: 0 0 0 2px var(--selected-message-border);
        }
        
        /* Style for deleted messages */
        .message.deleted {
            background-color: var(--deleted-message-bg);
            color: var(--deleted-message-text);
            font-style: italic;
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            position: relative;
        }
        
        /* Improved input field style */
        .chat-input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            font-weight: 400;
            outline: none;
            min-height: 40px;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            vertical-align: middle;
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        .send-button:hover {
            background-color: #4a49c0;
        }

        .send-button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .image-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .image-button:active {
            transform: scale(0.9);
        }

        .image-button:disabled {
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        .profile-edit {
            color: var(--primary-color);
            font-size: 14px;
            margin-top: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 8px;
            border-radius: 15px;
        }
        
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
            text-decoration: none;
            border-bottom: none;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }
        
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            line-height: 1.4;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .notification.success {
            background-color: var(--bg-color);
            color: var(--success-color);
        }

        .notification.error {
            background-color: var(--bg-color);
            color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        
        .verify-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .football-bounce {
            font-size: 80px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-40px); }
            60% { transform: translateY(-20px); }
        }

        .verify-text {
            margin-top: 30px;
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            text-align: center;
        }
        
        @keyframes deleteMessage {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            20% {
                opacity: 0.8;
                transform: scale(0.95);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }
        
        .message.deleting {
            animation: deleteMessage 0.3s ease forwards;
            pointer-events: none;
        }
        
        .create-group-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .create-group-dialog.active {
            display: flex;
        }
        
        .create-group-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .create-group-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .create-group-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .create-group-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-form {
            display: flex;
            flex-direction: column;
        }
        
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-dialog.active {
            display: flex;
        }
        
        .edit-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .edit-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .edit-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .edit-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--group-icon-bg);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .group-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .group-image-preview:hover .group-image-overlay {
            opacity: 1;
        }
        
        .group-image-overlay i {
            color: white;
            font-size: 20px;
        }
        
        .image-upload-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab:hover {
            background-color: #4a49c0;
        }

        .fab.disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
            box-shadow: none;
        }

        .fab.disabled:active {
            transform: none;
        }
        
        .fab i {
            font-size: 24px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 300px;
            padding: 20px;
            z-index: 150;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirmation-button {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .confirmation-delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }

        .event-icon {
            width: 50px;
            height: 50px;
            background-color: var(--event-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            border: 1px solid var(--event-border);
        }
        
        .event-icon i {
            font-size: 22px;
            color: var(--primary-color);
        }

        .event-item {
            transition: none;
            cursor: default;
            position: relative;
        }

        .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-content {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .event-time {
            font-size: 12px;
            color: var(--inactive-text);
            margin-top: 5px;
        }
        
        .admin-count-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .event-item.group-create .event-icon {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .event-item.group-create .event-icon i {
            color: var(--success-color);
        }
        
        .event-item.permission-change .event-icon {
            background-color: rgba(255, 193, 7, 0.2);
        }
        
        .event-item.permission-change .event-icon i {
            color: var(--restricted-badge-bg);
        }
        
        .event-item.user-join .event-icon {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .event-item.user-join .event-icon i {
            color: var(--log-info);
        }

        .restricted-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .profile-edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-edit-dialog.active {
            display: flex;
        }
        
        .profile-image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .profile-image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .profile-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-image-preview i {
            font-size: 50px;
            color: var(--primary-color);
        }
        
        .profile-upload-btn {
            position: absolute;
            bottom: 10px;
            right: calc(50% - 60px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .profile-upload-btn:hover, .profile-upload-btn:active {
            transform: scale(1.1);
            background-color: #4a49c0;
        }

        input[type="file"] {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            text-decoration: none;
            border-bottom: none;
            padding: 0 16px; 
            margin: 15px 0;
        }
        
        .field-error {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .save-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .save-field-btn:hover {
            background-color: #4a49c0;
        }
        
        .save-field-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .editable-field {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .editable-field-input {
            flex: 1;
        }
        
        .forecasts-section {
            padding: 0 0 15px 0;
        }
        
        .forecasts-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .forecast-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
        }
        
        .forecast-tab.active {
            color: var(--primary-color);
        }
        
        .forecast-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        .forecasts-content {
            display: none;
            padding: 0 15px;
        }
        
        .forecasts-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .forecasts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .forecast-item {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .forecast-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .forecast-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .forecast-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        
        .forecast-team-logo {
            width: 40px;
            height: 40px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .forecast-team-name {
            font-weight: 500;
            text-align: center;
            font-size: 14px;
        }
        
        .forecast-score {
            font-size: 22px;
            font-weight: bold;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        .forecast-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .forecast-status.pending {
            background-color: var(--forecast-pending-bg);
            color: var(--text-color);
        }
        
        .forecast-status.win {
            background-color: var(--forecast-win-bg);
            color: var(--text-color);
        }
        
        .forecast-status.loss {
            background-color: var(--forecast-loss-bg);
            color: var(--text-color);
        }
        
        .forecast-date {
            font-size: 12px;
            color: var(--inactive-text);
        }
        
        .forecast-confidence {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-color);
        }
        
        .confidence-bar-container {
            flex: 1;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .confidence-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .no-forecasts {
            text-align: center;
            padding: 30px 15px;
            color: var(--inactive-text);
        }
        
        .no-forecasts i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .admin-notification {
            background-color: var(--bg-color);
            border-radius: 15px;
            margin: 10px 15px 20px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .admin-notification-header {
            color: var(--text-color);
            padding: 0 0 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .admin-notification-title {
            display: flex;
            align-items: center;
        }
        
        .admin-notification-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .admin-notification-content {
            padding: 5px 0;
            line-height: 1.4;
        }
        
        .admin-notification-footer {
            padding: 5px 0 0;
            font-size: 12px;
            color: var(--inactive-text);
            text-align: right;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
            padding-top: 8px;
        }
        
        .event-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .event-close-btn:hover, .event-close-btn:active {
            transform: scale(1.1);
        }
        
        .event-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        
        .event-action-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s ease;
        }
        
        .event-action-btn:hover, .event-action-btn:active {
            transform: translateY(-1px);
        }
        
        .event-action-btn.delete {
            color: var(--danger-color);
        }
        
        .admin-notif-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .admin-notif-dialog.active {
            display: flex;
        }
        
        .score-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .score-option {
            padding: 5px 12px;
            border-radius: 15px;
            background-color: var(--bg-color);
            font-weight: bold;
            font-size: 14px;
            border: 1px solid var(--border-color);
            transition: transform 0.1s ease;
            cursor: pointer;
        }
        
        .score-option:hover, .score-option:active {
            transform: translateY(-1px);
        }

        .score-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #delete-account-confirmation .confirmation-text {
            color: var(--danger-color);
            font-weight: bold;
        }

        .social-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 15px;
            gap: 10px;
        }
        
        .social-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .social-button:active {
            transform: scale(0.98);
        }
        
        .social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .social-button.whatsapp {
            color: var(--social-whatsapp);
        }
        
        .social-button.telegram {
            color: var(--social-telegram);
        }
        
        .social-button.youtube {
            color: var(--social-youtube);
        }

        .about-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .about-dialog.active {
            display: flex;
        }
        
        .about-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .about-logo {
            text-align: center;
            margin: 20px 0;
        }
        
        .about-logo i {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .about-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .about-version {
            text-align: center;
            font-size: 14px;
            color: var(--inactive-text);
            margin-bottom: 30px;
        }
        
        .about-section {
            margin-bottom: 25px;
        }
        
        .about-section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .about-section-content {
            line-height: 1.5;
            font-size: 14px;
        }
        
        .about-footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: var(--inactive-text);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        
        @media (max-height: 640px) {
            .fab {
                bottom: 70px;
            }
        }
        
        @media (max-width: 380px) {
            .confirmation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .confirmation-button {
                width: 100%;
            }
        }
        
        .message-with-image {
            padding: 5px;
            border-radius: 18px;
            background-color: var(--image-message-bg);
            max-width: 100%;
        }
        
        .message-image {
            width: 100%;
            border-radius: 13px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            pointer-events: auto;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .message-image:hover {
            transform: scale(0.98);
        }
        
        .message-text {
            padding: 0 10px 5px;
            word-break: break-word;
        }
        
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .viewer-image-container {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
            margin: 0 auto;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            object-fit: contain;
            pointer-events: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .viewer-close:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .terms-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .terms-dialog.active {
            display: flex;
        }
        
        .terms-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .terms-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .terms-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .terms-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .warning-box {
            background-color: var(--warning-bg);
            border-left: 4px solid var(--warning-text);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .warning-box i {
            color: var(--warning-text);
            margin-right: 10px;
        }
    
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-button, .events-button, .info-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        /* Improved search bar animation */
        @keyframes searchBarIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes searchBarOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        
        .search-container.active {
            animation: searchBarIn 0.3s ease forwards;
        }
        
        .search-container.hiding {
            animation: searchBarOut 0.3s ease forwards;
        }
        
        /* Touch ripple effect for buttons */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Date separators in messages */
        .date-separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
            user-select: none;
        }

        .date-separator:before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: var(--border-color);
            z-index: 1;
        }

        .date-separator-text {
            display: inline-block;
            position: relative;
            z-index: 2;
            background-color: var(--date-separator-bg);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--date-separator-text);
            font-weight: 500;
        }

        /* Reply system */
        .reply-preview {
            background-color: var(--reply-preview-bg);
            border-left: 3px solid var(--reply-preview-border);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 14px;
            position: relative;
            display: none;
        }

        .reply-preview.active {
            display: block;
        }

        .reply-preview-header {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
        }

        .reply-preview-content {
            color: var(--reply-preview-text);
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .reply-preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            cursor: pointer;
            font-size: 10px;
        }

        .chat-input-wrapper.with-reply {
            display: flex;
            flex-direction: column;
        }

        /* Adaptations for reply mode */
        .chat-input-container.with-reply {
            min-height: 100px;
        }
        
        /* Expandable text input styling */
        .chat-input {
            resize: none;
            overflow-y: auto;
            transition: height 0.2s ease;
        }

        /* Improved message quote styling */
        .message-quote {
            margin-bottom: 8px;
            background-color: var(--reply-quote-bg);
            border-left: 3px solid var(--reply-quote-border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            position: relative;
        }
        
        .message-quote-sender {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
            font-size: 12px;
        }
        
        .message-quote-content {
            color: var(--text-color);
            opacity: 0.85;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Group info dialog */
        .group-info-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--group-info-bg);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .group-info-dialog.active {
            display: flex;
        }
        
        .group-info-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--group-info-border);
        }
        
        .group-info-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .group-info-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .group-info-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-info-section {
            margin-bottom: 20px;
        }
        
        .group-info-section-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .group-info-detail {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .group-info-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .group-info-value {
            color: var(--text-color);
            line-height: 1.4;
        }
        
        .group-info-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .group-info-image {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .group-info-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }
        
        .group-info-image:hover img {
            transform: scale(1.05);
        }
        
        .group-info-image-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--border-color);
            opacity: 0.5;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            height: 100%;
        }
        
        .download-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: var(--download-btn-bg);
            color: var(--download-btn-text);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        
        .download-button:hover {
            transform: scale(1.1);
        }

        /* Logs visuels styles */
        .logs-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            max-height: 200px;
            background-color: var(--log-panel-bg);
            border: 1px solid var(--log-panel-border);
            border-radius: 10px;
            z-index: 100;
            display: none;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logs-panel.active {
            display: flex;
        }

        .logs-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--secondary-color);
            border-radius: 10px 10px 0 0;
        }

        .logs-title {
            font-weight: bold;
            font-size: 14px;
            color: var(--primary-color);
        }

        .logs-close {
            cursor: pointer;
            color: var(--text-color);
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .logs-close:hover {
            background-color: var(--border-color);
        }

        .logs-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            max-height: 150px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.3;
            border-left: 3px solid;
        }

        .log-entry.info {
            background-color: rgba(33, 150, 243, 0.1);
            border-left-color: var(--log-info);
        }

        .log-entry.success {
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: var(--log-success);
        }

        .log-entry.warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left-color: var(--log-warning);
        }

        .log-entry.error {
            background-color: rgba(244, 67, 54, 0.1);
            border-left-color: var(--log-error);
        }

        .log-timestamp {
            font-weight: bold;
            margin-right: 8px;
            opacity: 0.7;
        }

        .log-message-text {
            word-break: break-word;
        }

        .log-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }

        .log-link:hover {
            color: var(--link-hover);
            text-decoration: underline;
        }

        .logs-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 50;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .logs-toggle:hover {
            transform: scale(1.05);
            background-color: var(--primary-color);
            color: white;
        }

        .logs-toggle i {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="verify-animation" class="verify-animation">
        <div class="football-bounce">
            <i class="fas fa-futbol"></i>
        </div>
        <div class="verify-text">Vérification en cours...</div>
    </div>
    
    <div class="side-menu" id="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-close" id="side-menu-close">
                <i class="fas fa-times"></i>
            </div>
            <div class="side-menu-title">Pari Alliance</div>
        </div>
        <div class="side-menu-content">
            <div class="side-menu-item" id="menu-profile">
                <i class="fas fa-user"></i>
                <div class="side-menu-text">Profil</div>
            </div>
        </div>
        <div class="side-menu-footer">
            <div class="side-menu-item" id="menu-terms">
                <i class="fas fa-file-alt"></i>
                <div class="side-menu-text">Conditions d'utilisation</div>
            </div>
            <div class="side-menu-item" id="menu-about">
                <i class="fas fa-info-circle"></i>
                <div class="side-menu-text">À propos</div>
            </div>
        </div>
    </div>
    
    <div class="side-menu-overlay" id="side-menu-overlay"></div>
    
    <div id="auth-screen" class="auth-screen" style="display: none;">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">Pari Alliance</h1>
            <p class="auth-subtitle">Messagerie de groupe sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <i class="fas fa-futbol loading-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">Pari Alliance</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <div class="header">
        <div class="header-left">
            <div id="header-menu-button" class="menu-button">
                <i class="fas fa-bars"></i>
            </div>
            <div id="header-back-button" class="back-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        <div id="header-title" class="header-title">Conversations</div>
        <div id="header-action">
            <div class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </div>
            <div class="events-button" id="events-button">
                <i class="fas fa-bell"></i>
                <div class="notification-dot" id="events-notification-dot"></div>
            </div>
        </div>
        
        <div class="search-container" id="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            <div class="search-close" id="search-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <!-- Message actions bar -->
        <div class="message-actions-container" id="message-actions-container">
            <div class="message-actions-title">1 message sélectionné</div>
            <div class="message-action-buttons">
                <div class="message-action-btn reply" id="action-reply-btn">
                    <i class="fas fa-reply"></i>
                </div>
                <div class="message-action-btn copy" id="action-copy-btn">
                    <i class="fas fa-copy"></i>
                </div>
                <div class="message-action-btn delete" id="action-delete-btn">
                    <i class="fas fa-trash"></i>
                </div>
                <div class="message-action-btn cancel" id="action-cancel-btn">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="conversations-section" class="section active">
            <div class="chat-list" id="conversations-list">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <div class="empty-state-title">Aucune conversation</div>
                    <div class="empty-state-text">Vos conversations apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="create-group-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div id="users-section" class="section">
            <div class="chat-list" id="users-list">
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <div class="empty-state-title">Aucun utilisateur</div>
                    <div class="empty-state-text">Les utilisateurs apparaîtront ici</div>
                </div>
            </div>
        </div>
        
        <div id="events-section" class="section">
            <div id="events-list">
                <div class="empty-state">
                    <i class="fas fa-bell"></i>
                    <div class="empty-state-title">Aucun événement</div>
                    <div class="empty-state-text">Les événements apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="close-events-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="fab" id="create-notification-btn" style="display: none; bottom: 150px;">
                <i class="fas fa-bullhorn"></i>
            </div>
        </div>
        
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                    <div class="profile-pic-edit" id="edit-profile-pic">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                    <div class="profile-edit" id="edit-profile-btn">
                        <i class="fas fa-edit"></i> Modifier le profil
                    </div>
                </div>
            </div>
            
            <div class="section-title">Paramètres</div>
            
            <div class="settings-container">
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="section-title">Nous rejoindre</div>
                
                <div class="social-buttons">
                    <div class="social-button whatsapp" id="whatsapp-btn">
                        WhatsApp
                    </div>
                    <div class="social-button telegram" id="telegram-btn">
                        Telegram
                    </div>
                    <div class="social-button youtube" id="youtube-btn">
                        YouTube
                    </div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                <button id="delete-account-btn" class="button danger" style="margin-top: 15px;">Supprimer mon compte</button>
            </div>
        </div>
        
        <div id="forecasts-section" class="section">
            <div class="forecasts-tabs">
                <div class="forecast-tab active" data-tab="safes">Safes du jour</div>
                <div class="forecast-tab" data-tab="exact">Scores exacts</div>
                <div class="forecast-tab" data-tab="ai">Prédictions IA</div>
            </div>
            
            <div class="forecasts-content active" id="safes-content">
                <div class="forecasts-list" id="safes-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="exact-content">
                <div class="forecasts-list" id="exact-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="ai-content">
                <div class="forecasts-list" id="ai-list">
                </div>
            </div>
        </div>
    </div>

    <div id="chat-interface" class="chat-section">
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="image-button" id="image-button">
                <i class="fas fa-image"></i>
            </div>
            <div class="chat-input-wrapper" id="chat-input-wrapper">
                <!-- Reply preview dynamically added here -->
                <div class="reply-preview" id="reply-preview">
                    <div class="reply-preview-close" id="reply-close">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="reply-preview-header">Réponse à <span id="reply-name">Utilisateur</span></div>
                    <div class="reply-preview-content" id="reply-content">Message original</div>
                </div>
                <textarea id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off" rows="1"></textarea>
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <input type="file" id="chat-image-input" accept="image/*">
    </div>
    
    <div id="create-group-dialog" class="create-group-dialog">
        <div class="create-group-header">
            <div class="create-group-back" id="create-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="create-group-title">Nouveau groupe</div>
        </div>
        <div class="create-group-content">
            <div class="group-form">
                <div class="group-image-preview" id="new-group-image-preview">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="new-group-image-input" accept="image/*">
                
                <div class="form-group">
                    <label class="form-label">Nom du groupe</label>
                    <input type="text" class="form-input" id="group-name" placeholder="Entrez le nom du groupe">
                    <div id="group-name-error" class="form-error">Le nom du groupe est requis</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnelle)</label>
                    <input type="text" class="form-input" id="group-description" placeholder="Décrivez le groupe">
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions de message</label>
                    <div style="display: flex; align-items: center; margin-top: 8px;">
                        <label class="switch">
                            <input type="checkbox" id="group-public-messages" checked>
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    </div>
                    <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                        Si désactivé, seuls les administrateurs pourront écrire des messages
                    </div>
                </div>
                <button class="button" id="create-group-submit">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Créer le groupe</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="edit-group-dialog" class="edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="edit-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le groupe</div>
        </div>
        <div class="edit-content">
            <div class="group-image-preview" id="edit-group-image-preview">
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="edit-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="edit-group-image-input" accept="image/*">
            
            <div class="form-group">
                <label class="form-label">Nom du groupe</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-name" placeholder="Entrez le nom du groupe">
                    <button class="save-field-btn" id="save-group-name-btn">Enregistrer</button>
                </div>
                <div id="edit-group-name-error" class="field-error">Le nom du groupe est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-description" placeholder="Décrivez le groupe">
                    <button class="save-field-btn" id="save-group-description-btn">Enregistrer</button>
                </div>
                <div id="edit-group-description-error" class="field-error"></div>
            </div>
            
            <div class="form-group" id="edit-group-permissions-container">
                <label class="form-label">Permissions de message</label>
                <div style="display: flex; align-items: center; margin-top: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="edit-group-public-messages">
                        <span class="slider"></span>
                    </label>
                    <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    <button class="save-field-btn" id="save-group-permissions-btn" style="margin-left: auto;">Enregistrer</button>
                </div>
                <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                    Si désactivé, seuls les administrateurs pourront écrire des messages
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Image du groupe</label>
                <button class="button" id="save-group-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer l'image</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Group Info Dialog -->
    <div id="group-info-dialog" class="group-info-dialog">
        <div class="group-info-header">
            <div class="group-info-back" id="group-info-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="group-info-title">Informations du groupe</div>
        </div>
        <div class="group-info-content">
            <div class="group-info-section">
                <div class="group-image-preview" id="info-group-image-preview" style="width: 120px; height: 120px; margin-bottom: 20px;">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Nom</div>
                    <div class="group-info-value" id="info-group-name">Nom du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Description</div>
                    <div class="group-info-value" id="info-group-description">Description du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Type</div>
                    <div class="group-info-value" id="info-group-type">Public</div>
                </div>
            </div>
            
            <div class="group-info-section">
                <div class="group-info-section-title">Images partagées</div>
                <div class="group-info-images" id="info-group-images">
                    <div class="group-info-image-empty">Aucune image partagée</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-notif-dialog" class="admin-notif-dialog">
        <div class="edit-header">
            <div class="edit-back" id="admin-notif-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Nouvelle notification</div>
        </div>
        <div class="edit-content">
            <div class="form-group">
                <label class="form-label">Titre de la notification</label>
                <input type="text" class="form-input" id="notif-title" placeholder="Titre de votre notification">
                <div id="notif-title-error" class="field-error">Le titre est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contenu</label>
                <textarea class="form-input" id="notif-content" placeholder="Contenu de votre notification" rows="5" style="resize: none;"></textarea>
                <div id="notif-content-error" class="field-error">Le contenu est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type de notification</label>
                <select class="form-input" id="notif-type">
                    <option value="info">Information</option>
                    <option value="alert">Alerte</option>
                    <option value="update">Mise à jour</option>
                </select>
            </div>
            
            <button class="button" id="send-notification-btn">
                <span class="btn-loader" style="display:none;"></span>
                <span class="btn-text">Envoyer la notification</span>
            </button>
        </div>
    </div>
    
    <div id="profile-edit-dialog" class="profile-edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="profile-edit-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le profil</div>
        </div>
        <div class="edit-content">
            <div class="profile-image-upload">
                <div class="profile-image-preview" id="profile-image-preview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-upload-btn" id="profile-upload-btn">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="profile-image-input" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom d'utilisateur</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-display-name" placeholder="Entrez votre nom d'utilisateur">
                    <button class="save-field-btn" id="save-display-name-btn">Enregistrer</button>
                </div>
                <div id="edit-display-name-error" class="field-error">Le nom d'utilisateur est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Photo de profil</label>
                <button class="button" id="save-profile-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer la photo</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="about-dialog" class="about-dialog">
        <div class="edit-header">
            <div class="edit-back" id="about-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">À propos</div>
        </div>
        <div class="about-content">
            <div class="about-logo">
                <i class="fas fa-futbol"></i>
                <div class="about-title">Pari Alliance</div>
                <div class="about-version">Version 2.0.0</div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Description</div>
                <div class="about-section-content">
                    Pari Alliance est une application de messagerie sécurisée qui permet aux utilisateurs de créer et de participer à des discussions de groupe et des conversations privées.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Fonctionnalités</div>
                <div class="about-section-content">
                    • Conversations de groupe en temps réel<br>
                    • Discussions privées sécurisées<br>
                    • Partage de pronostics sportifs<br>
                    • Mode sombre personnalisable<br>
                    • Gestion simple des groupes<br>
                    • Envoi de notifications pour les administrateurs<br>
                    • Logs d'activité détaillés
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">À propos de l'application</div>
                <div class="about-section-content">
                    Le logo de l'application est constitué deux mains qui se soutiennent et en arrière-plan ballon de football. L'application a été créée par Pronosoft AI.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Confidentialité</div>
                <div class="about-section-content">
                    Pari Alliance respecte votre vie privée. Vos données personnelles ne sont utilisées que pour le fonctionnement de l'application et ne sont jamais partagées avec des tiers.
                </div>
            </div>
            
            <div class="about-footer">
                © 2025-2026 Pari Alliance. Tous droits réservés.
            </div>
        </div>
    </div>
    
    <div id="terms-dialog" class="terms-dialog">
        <div class="terms-header">
            <div class="terms-back" id="terms-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="terms-title">Conditions d'utilisation</div>
        </div>
        <div class="terms-content">
            <div class="about-section">
                <div class="about-section-title">Conditions générales</div>
                <div class="about-section-content">
                    En utilisant l'application Pari Alliance, vous acceptez de respecter les présentes conditions d'utilisation. L'accès et l'utilisation de cette application sont soumis à votre acceptation et au respect des présentes conditions.
                </div>
            </div>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i> <strong>AVERTISSEMENT :</strong> Les pronostics sont fournis à titre informatif uniquement. La vente ou revente de ces pronostics est strictement interdite et passible de bannissement à vie et de poursuites judiciaires.
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation des pronostics</div>
                <div class="about-section-content">
                    Les pronostics sportifs fournis dans cette application sont destinés uniquement à des fins d'information et de divertissement. Ils peuvent être utilisés pour effectuer des paris réels, mais il est recommandé de le faire avec responsabilité.<br><br>
                    
                    Nous ne sommes pas responsables de leurs pertes éventuelles. Les pronostics ne constituent en aucun cas une incitation au jeu ou un conseil d'investissement.<br><br>
                    
                    Il est strictement interdit de:<br>
                    • Revendre ou commercialiser ces pronostics<br>
                    • Partager ces informations en dehors de la plateforme<br>
                    • Utiliser ces informations à des fins commerciales<br><br>
                    
                    Tout utilisateur enfreignant ces règles s'expose à une suspension immédiate de son compte et à d'éventuelles poursuites judiciaires.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation de l'application</div>
                <div class="about-section-content">
                    Vous vous engagez à utiliser l'application de manière légale et responsable. Il est interdit de:<br>
                    • Publier du contenu illégal, diffamatoire, harcelant ou menaçant<br>
                    • Usurper l'identité d'une autre personne<br>
                    • Tenter d'accéder sans autorisation à des parties de l'application qui vous sont interdites<br>
                    • Perturber le fonctionnement normal de l'application<br>
                    • Publier des messages à caractère commercial non sollicités
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Responsabilité</div>
                <div class="about-section-content">
                    Pari Alliance n'est pas responsable des pertes financières ou autres dommages qui pourraient résulter de l'utilisation des pronostics(des événements imprévus tels que les cartons rouges,les fautes pouvant causer un penalty etc...)ou des informations disponibles sur l'application. Les utilisateurs sont seuls responsables de leurs décisions et de leurs actions.
                </div>
            </div>
        </div>
    </div>
    
    <div id="delete-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer ce message ?</div>
        <div class="confirmation-text">Cette action est irréversible et le message sera définitivement supprimé.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-event-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer cet événement ?</div>
        <div class="confirmation-text">Cette action est irréversible et l'événement sera supprimé.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-event-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-event-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-account-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer votre compte ?</div>
        <div class="confirmation-text">ATTENTION : Cette action est définitive et irréversible. Toutes vos données seront supprimées.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <div id="logout-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Se déconnecter ?</div>
        <div class="confirmation-text">Voulez-vous vraiment vous déconnecter de Pari Alliance ?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="logout-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="logout-confirm">Déconnecter</div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div class="notification" id="notification"></div>
    
    <div id="image-viewer" class="image-viewer">
        <div class="viewer-image-container">
            <img src="" alt="Image" class="viewer-image" id="viewer-image" oncontextmenu="return false">
        </div>
        <div class="viewer-close" id="viewer-close">
            <i class="fas fa-times"></i>
        </div>
        <div class="download-button" id="download-image-btn">
            <i class="fas fa-download"></i>
        </div>
    </div>

    <!-- Logs panel -->
    <div class="logs-panel" id="logs-panel">
        <div class="logs-header">
            <div class="logs-title">
                <i class="fas fa-clipboard-list"></i> Logs d'activité
            </div>
            <div class="logs-close" id="logs-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="logs-content" id="logs-content">
            <!-- Logs entries will be added here dynamically -->
        </div>
    </div>

    <!-- Logs toggle button -->
    <div class="logs-toggle" id="logs-toggle">
        <i class="fas fa-clipboard-list"></i>
    </div>

    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-section="conversations" style="flex: 1;">
            <i class="nav-icon fas fa-comments"></i>
            <span>Conversations</span>
        </div>
        <div class="nav-item" data-section="users" style="flex: 1;">
            <i class="nav-icon fas fa-users"></i>
            <span>Utilisateurs</span>
            <div class="notification-dot" id="users-notification-dot" style="display: none;"></div>
        </div>
        <div class="nav-item" data-section="forecasts" style="flex: 1;">
            <i class="nav-icon fas fa-futbol"></i>
            <span>Pronostics</span>
            <div class="notification-dot" id="forecasts-notification-dot" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let currentConversation = '';
        let currentConversationId = null;
        let currentConversationData = null;
        let currentSection = 'conversations';
        let isOnline = navigator.onLine;
        let messageQueue = [];
        let chatUnsubscribers = {};
        let longPressTimer = null;
        let longPressDuration = 500;
        let currentMessageForAction = null;
        let eventsUnsubscribe = null;
        let forecastsUnsubscribe = null;
        let usersUnsubscribe = null;
        let conversationsUnsubscribe = null;
        let groupImageFile = null;
        let profileImageFile = null;
        let editingConversationId = null;
        let profileUpdating = false;
        let isLoadingConversations = false;
        let isLoadingUsers = false;
        let isLoadingEvents = false;
        let profileNameChanged = false;
        let groupNameChanged = false;
        let groupDescriptionChanged = false;
        let groupPermissionsChanged = false;
        let currentEventForDeletion = null;
        let currentForecastTab = 'safes';
        let lastViewedEventTimestamp = null;
        let hasNewEvents = false;
        let chatImageFile = null;
        let isSearchActive = false;
        let currentSearchContext = '';
        let replyingToMessage = null;
        let autoResizeTextarea = null;
        let isMessageActionsVisible = false;
        let groupImageCache = {}; // Cache for images in conversation
        let currentDownloadImage = ''; // Current image URL for download
        let allUsers = []; // Store all users data
        let logs = []; // Store logs
        
        function setupDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });
            
            document.getElementById('dark-toggle').checked = document.documentElement.classList.contains('dark');
        }
        
        function setupConnectionMonitoring() {
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    isOnline = true;
                    processQueuedMessages();
                } else {
                    isOnline = false;
                    showNotification("Pas de connexion internet. Les messages seront envoyés lorsque vous serez connecté.", "error");
                }
            }
            
            window.addEventListener('online', () => {
                showNotification("Connexion rétablie", "success");
                isOnline = true;
                
                setTimeout(() => {
                    if (isLoggedIn && currentSection === 'conversations') {
                        loadConversations();
                    }
                    processQueuedMessages();
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
            });
            
            updateConnectionStatus();
        }
        
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            const processedMessages = [...messageQueue];
            messageQueue = [];
            
            for (const message of processedMessages) {
                try {
                    await sendMessageToFirestore(
                        message.conversationId, 
                        message.text,
                        message.imageData,
                        message.replyTo
                    );
                } catch (error) {
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu être envoyés`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont été envoyés', 'success');
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            // Ensure any previous notification is fully hidden
            notification.classList.remove('show');
            
            // Wait a short delay to avoid animation conflicts
            setTimeout(() => {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                
                // Remove the class after a delay
                setTimeout(() => {
                    notification.classList.remove('show');
                    
                    // Clean up the element after animation ends
                    setTimeout(() => {
                        notification.className = 'notification';
                        notification.textContent = '';
                    }, 300);
                }, 3000);
            }, 100);
        }
        
        // Log system
        function addLog(message, type = 'info', details = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const logEntry = {
                id: Date.now() + Math.random(),
                timestamp,
                message,
                type,
                details
            };
            
            logs.unshift(logEntry); // Add to beginning
            
            // Keep only last 50 logs
            if (logs.length > 50) {
                logs = logs.slice(0, 50);
            }
            
            updateLogsPanel();
        }
        
        function updateLogsPanel() {
            const logsContent = document.getElementById('logs-content');
            if (!logsContent) return;
            
            logsContent.innerHTML = '';
            
            logs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.className = `log-entry ${log.type}`;
                
                let messageText = log.message;
                
                // Make URLs clickable
                if (log.details && log.details.url) {
                    messageText += ` <a href="${log.details.url}" target="_blank" rel="noopener noreferrer" class="log-link">→ Ouvrir le lien</a>`;
                }
                
                // Replace Firebase URLs with readable links
                messageText = messageText.replace(
                    /https:\/\/console\.firebase\.google\.com\/[^\s]+/g,
                    '<a href="$&" target="_blank" rel="noopener noreferrer" class="log-link">→ Console Firebase</a>'
                );
                
                messageText = messageText.replace(
                    /https:\/\/firestore\.googleapis\.com\/[^\s]+/g,
                    '<a href="$&" target="_blank" rel="noopener noreferrer" class="log-link">→ Firestore API</a>'
                );
                
                logElement.innerHTML = `
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-message-text">${messageText}</span>
                `;
                
                logsContent.appendChild(logElement);
            });
        }
        
        function toggleLogsPanel() {
            const logsPanel = document.getElementById('logs-panel');
            logsPanel.classList.toggle('active');
        }
        
        // Function to auto-resize textarea
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('chat-input');
            if (!textarea) return;
            
            // Function to adjust height
            const adjustHeight = () => {
                // Reset height to get content height
                textarea.style.height = 'auto';
                
                // Calculate new height (with max limit)
                const newHeight = Math.min(textarea.scrollHeight, 100);
                textarea.style.height = `${newHeight}px`;
                
                // Adjust container height if needed
                const container = document.getElementById('chat-input-container');
                if (container) {
                    if (replyingToMessage) {
                        container.style.minHeight = `${60 + newHeight}px`;
                    } else {
                        container.style.minHeight = `${newHeight + 20}px`;
                    }
                }
            };
            
            // Initialize height
            adjustHeight();
            
            // Add events to adjust height when content changes
            textarea.addEventListener('input', adjustHeight);
            
            // Store the function for reuse
            autoResizeTextarea = adjustHeight;
        }
        
        function setupUIEvents() {
            document.getElementById('header-menu-button').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('active');
                document.getElementById('side-menu-overlay').classList.add('active');
            });
            
            document.getElementById('side-menu-close').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('side-menu-overlay').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('menu-profile').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showProfileSection();
            });
            
            document.getElementById('menu-terms').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showTermsDialog();
            });
            
            document.getElementById('terms-back').addEventListener('click', hideTermsDialog);
            
            document.getElementById('menu-about').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showAboutDialog();
            });
            
            document.getElementById('about-back').addEventListener('click', hideAboutDialog);
            
            // Search button handler
            document.getElementById('search-button').addEventListener('click', function() {
                toggleSearchBar();
            });
            
            document.getElementById('search-close').addEventListener('click', function() {
                hideSearchBar();
            });
            
            // Search input handler
            document.getElementById('search-input').addEventListener('input', function() {
                handleSearch(this.value);
            });
            
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                // Mark events as viewed
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            document.getElementById('close-events-btn').addEventListener('click', function() {
                if (currentSection === 'events') {
                    showConversationsSection();
                }
            });
            
            // Group info dialog handler
            document.getElementById('group-info-back').addEventListener('click', hideGroupInfoDialog);
            
            document.getElementById('bottom-nav').addEventListener('click', function(e) {
                const navItems = this.querySelectorAll('.nav-item');
                
                for (let i = 0; i < navItems.length; i++) {
                    const item = navItems[i];
                    const rect = item.getBoundingClientRect();
                    
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const section = item.getAttribute('data-section');
                        if (section === 'conversations') {
                            showConversationsSection();
                        } else if (section === 'users') {
                            showUsersSection();
                        } else if (section === 'forecasts') {
                            showForecastsSection();
                        }
                        
                        break;
                    }
                }
            });
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchForecastTab(tabId);
                });
            });
            
            // Logs toggle button
            document.getElementById('logs-toggle').addEventListener('click', toggleLogsPanel);
            document.getElementById('logs-close').addEventListener('click', toggleLogsPanel);
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                localStorage.setItem('parisAllianceDarkMode', this.checked ? 'true' : 'false');
            });
            
            document.getElementById('logout-btn').addEventListener('click', showLogoutConfirmation);
            document.getElementById('logout-cancel').addEventListener('click', hideLogoutConfirmation);
            document.getElementById('logout-confirm').addEventListener('click', logoutUser);
            
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            
            document.getElementById('delete-account-cancel').addEventListener('click', hideDeleteAccountConfirmation);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            document.getElementById('edit-profile-btn').addEventListener('click', showProfileEditDialog);
            document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            
            document.getElementById('profile-edit-back').addEventListener('click', hideProfileEditDialog);
            document.getElementById('profile-upload-btn').addEventListener('click', function() {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('profile-image-input').addEventListener('change', handleProfileImageSelect);
            
            document.getElementById('save-display-name-btn').addEventListener('click', updateDisplayName);
            document.getElementById('save-profile-image-btn').addEventListener('click', updateProfileImage);
            
            document.getElementById('edit-display-name').addEventListener('input', function() {
                profileNameChanged = true;
                document.getElementById('save-display-name-btn').disabled = this.value.trim() === '';
            });
            
            // Chat input setup
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Reply close handler
            document.getElementById('reply-close').addEventListener('click', function() {
                cancelReply();
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            
            // Image handlers
            document.getElementById('image-button').addEventListener('click', function() {
                document.getElementById('chat-image-input').click();
            });
            
            document.getElementById('chat-image-input').addEventListener('change', handleChatImageSelect);
            
            // Image viewer handlers
            document.getElementById('viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('download-image-btn').addEventListener('click', downloadCurrentImage);
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('create-group-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showCreateGroupDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent créer des groupes", "error");
                }
            });
            
            document.getElementById('create-group-back').addEventListener('click', hideCreateGroupDialog);
            document.getElementById('create-group-submit').addEventListener('click', createNewGroup);
            
            document.getElementById('create-notification-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showAdminNotificationDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                }
            });
            
            document.getElementById('admin-notif-back').addEventListener('click', hideAdminNotificationDialog);
            document.getElementById('send-notification-btn').addEventListener('click', sendAdminNotification);
            
            document.getElementById('new-group-image-upload').addEventListener('click', function() {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('new-group-image-input').addEventListener('change', handleNewGroupImageSelect);
            
            document.getElementById('edit-group-back').addEventListener('click', hideEditGroupDialog);
            
            document.getElementById('edit-group-image-upload').addEventListener('click', function() {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-image-input').addEventListener('change', handleEditGroupImageSelect);
            
            document.getElementById('save-group-name-btn').addEventListener('click', updateGroupName);
            document.getElementById('save-group-description-btn').addEventListener('click', updateGroupDescription);
            document.getElementById('save-group-permissions-btn').addEventListener('click', updateGroupPermissions);
            document.getElementById('save-group-image-btn').addEventListener('click', updateGroupImage);
            
            document.getElementById('edit-group-name').addEventListener('input', function() {
                groupNameChanged = true;
                document.getElementById('save-group-name-btn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('edit-group-description').addEventListener('input', function() {
                groupDescriptionChanged = true;
                document.getElementById('save-group-description-btn').disabled = false;
            });
            
            document.getElementById('edit-group-public-messages').addEventListener('change', function() {
                groupPermissionsChanged = true;
                document.getElementById('save-group-permissions-btn').disabled = false;
            });
            
            document.getElementById('delete-cancel').addEventListener('click', hideDeleteConfirmation);
            document.getElementById('delete-confirm').addEventListener('click', confirmDeleteMessage);
            
            document.getElementById('delete-event-cancel').addEventListener('click', hideDeleteEventConfirmation);
            document.getElementById('delete-event-confirm').addEventListener('click', confirmDeleteEvent);
            
            // Message action buttons
            document.getElementById('action-reply-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    replyToMessage();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-copy-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    copyMessageText();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-delete-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    showDeleteConfirmation();
                }
            });
            
            document.getElementById('action-cancel-btn').addEventListener('click', function() {
                hideMessageActionsBar();
            });
            
            // Disable browser context menu on images
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('touchstart', handleGlobalTouchStart, { passive: true });
            document.addEventListener('touchend', handleGlobalTouchEnd, { passive: true });
            document.addEventListener('touchmove', handleGlobalTouchMove, { passive: true });
            document.addEventListener('touchcancel', handleGlobalTouchCancel, { passive: true });
            
            // Social network button handlers
            document.getElementById('whatsapp-btn').addEventListener('click', function() {
                openSocialLink('whatsapp');
            });
            
            document.getElementById('telegram-btn').addEventListener('click', function() {
                openSocialLink('telegram');
            });
            
            document.getElementById('youtube-btn').addEventListener('click', function() {
                openSocialLink('youtube');
            });
            
            // Add ripple effect for touchable buttons
            const touchableElements = document.querySelectorAll('.menu-button, .back-button, .search-button, .events-button, .info-button, .search-close');
            touchableElements.forEach(element => {
                element.addEventListener('touchstart', createRippleEffect);
            });
            
            // Handle Android back button
            window.addEventListener('popstate', handleBackButton);
            
            // Add initial state to history
            history.pushState({ page: 'main' }, '');
        }
        
        // Android back button handler
        function handleBackButton(event) {
            // Prevent default behavior
            event.preventDefault();
            
            // If message actions bar is visible, close it first
            if (isMessageActionsVisible) {
                hideMessageActionsBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If a confirmation dialog is open, close it
            if (document.querySelector('.confirmation-dialog.active')) {
                document.querySelectorAll('.confirmation-dialog.active').forEach(dialog => {
                    // Find the cancel button and simulate click
                    const cancelBtn = dialog.querySelector('.confirmation-cancel');
                    if (cancelBtn) cancelBtn.click();
                });
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If search is active, close it
            if (isSearchActive) {
                hideSearchBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If side menu is open, close it
            if (document.getElementById('side-menu').classList.contains('active')) {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If in chat interface, close it
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If in a section other than main, return to main section
            if (currentSection !== 'conversations') {
                showConversationsSection();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If a dialog is open, close it
            const dialogs = [
                { id: 'about-dialog', backBtn: 'about-back' },
                { id: 'terms-dialog', backBtn: 'terms-back' },
                { id: 'profile-edit-dialog', backBtn: 'profile-edit-back' },
                { id: 'edit-group-dialog', backBtn: 'edit-group-back' },
                { id: 'create-group-dialog', backBtn: 'create-group-back' },
                { id: 'admin-notif-dialog', backBtn: 'admin-notif-back' },
                { id: 'group-info-dialog', backBtn: 'group-info-back' }
            ];
            
            for (const dialog of dialogs) {
                if (document.getElementById(dialog.id).classList.contains('active')) {
                    document.getElementById(dialog.backBtn).click();
                    history.pushState({ page: 'main' }, '');
                    return;
                }
            }
            
            // If image viewer is open, close it
            if (document.getElementById('image-viewer').classList.contains('active')) {
                closeImageViewer();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If already in main section, prevent leaving app
            if (currentSection === 'conversations') {
                history.pushState({ page: 'main' }, '');
            }
        }
        
        function cancelReply() {
            replyingToMessage = null;
            const replyPreview = document.getElementById('reply-preview');
            replyPreview.classList.remove('active');
            
            const chatInputContainer = document.getElementById('chat-input-container');
            chatInputContainer.classList.remove('with-reply');
            
            // Readjust textarea height
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
        }
        
        // Show message actions bar function
        function showMessageActionsBar(messageElement) {
            if (!messageElement) return;
            
            const messageId = messageElement.getAttribute('data-id');
            const messageFrom = messageElement.getAttribute('data-from');
            
            // Store message info for actions
            currentMessageForAction = {
                element: messageElement,
                id: messageId,
                from: messageFrom,
                text: messageElement.textContent.trim()
            };
            
            // Adjust display of options based on message sender
            const deleteBtn = document.getElementById('action-delete-btn');
            if (messageFrom !== currentUser.uid && !isAdmin) {
                deleteBtn.style.display = 'none';
            } else {
                deleteBtn.style.display = 'flex';
            }
            
            // Apply selected class to message
            messageElement.classList.add('selected');
            
            // Show actions bar
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.add('active');
            
            // Hide normal header elements
            document.querySelector('.header-left').style.opacity = '0';
            document.querySelector('.header-title').style.opacity = '0';
            document.getElementById('header-action').style.opacity = '0';
            
            isMessageActionsVisible = true;
            
            // Add state to history for back button handling
            history.pushState({ page: 'message-actions' }, '');
        }
        
        // Hide message actions bar function
        function hideMessageActionsBar() {
            // Hide actions bar
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.remove('active');
            
            // Show normal header elements
            document.querySelector('.header-left').style.opacity = '1';
            document.querySelector('.header-title').style.opacity = '1';
            document.getElementById('header-action').style.opacity = '1';
            
            // Deselect message
            if (currentMessageForAction && currentMessageForAction.element) {
                currentMessageForAction.element.classList.remove('selected');
            }
            
            currentMessageForAction = null;
            isMessageActionsVisible = false;
        }
        
        // Ripple effect for buttons
        function createRippleEffect(e) {
            const button = e.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.touches[0].pageX - button.offsetLeft - diameter / 2}px`;
            circle.style.top = `${e.touches[0].pageY - button.offsetTop - diameter / 2}px`;
            circle.classList.add('ripple');
            
            const ripple = button.querySelector('.ripple');
            if (ripple) {
                ripple.remove();
            }
            
            button.appendChild(circle);
            
            setTimeout(() => {
                circle.remove();
            }, 600);
        }
        
        // Search bar functions
        function toggleSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            if (isSearchActive) {
                hideSearchBar();
            } else {
                header.classList.add('search-active');
                searchContainer.classList.add('active');
                searchInput.focus();
                isSearchActive = true;
                
                // Add state to history for back button handling
                history.pushState({ page: 'search' }, '');
                
                // Determine search context based on active section
                currentSearchContext = currentSection;
                
                // Adapt placeholder based on context
                if (currentSearchContext === 'conversations') {
                    searchInput.placeholder = 'Rechercher une conversation...';
                } else if (currentSearchContext === 'users') {
                    searchInput.placeholder = 'Rechercher un utilisateur...';
                } else if (currentSearchContext === 'events') {
                    searchInput.placeholder = 'Rechercher un événement...';
                } else if (currentSearchContext === 'forecasts') {
                    searchInput.placeholder = 'Rechercher un pronostic...';
                }
            }
        }
        
        function hideSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            searchContainer.classList.remove('active');
            searchContainer.classList.add('hiding');
            
            setTimeout(() => {
                header.classList.remove('search-active');
                searchInput.value = '';
                searchContainer.classList.remove('hiding');
                isSearchActive = false;
                
                // Reset filters
                handleSearch('');
            }, 300);
        }
        
        // Handle search based on context
        function handleSearch(query) {
            if (currentSearchContext === 'conversations') {
                filterConversations(query);
            } else if (currentSearchContext === 'users') {
                filterUsers(query);
            } else if (currentSearchContext === 'events') {
                filterEvents(query);
            }
            // Add other search contexts as needed
        }
        
        // Function to open social links safely
        function openSocialLink(platform) {
            let url = '';
            
            switch(platform) {
                case 'whatsapp':
                    url = 'https://wa.me/';
                    showNotification('Ouverture de WhatsApp', 'info');
                    break;
                case 'telegram':
                    url = 'https://t.me/';
                    showNotification('Ouverture de Telegram', 'info');
                    break;
                case 'youtube':
                    url = 'https://www.youtube.com/';
                    showNotification('Ouverture de YouTube', 'info');
                    break;
                default:
                    return;
            }
            
            // Add log
            addLog(`Ouverture du lien ${platform}`, 'info', { url });
            
            // Open in new window/tab with security parameters
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function showTermsDialog() {
            document.getElementById('terms-dialog').classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'terms' }, '');
        }
        
        function hideTermsDialog() {
            document.getElementById('terms-dialog').classList.remove('active');
        }
        
        function showAboutDialog() {
            document.getElementById('about-dialog').classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'about' }, '');
        }
        
        function hideAboutDialog() {
            document.getElementById('about-dialog').classList.remove('active');
        }
        
        // Show Group Info Dialog
        function showGroupInfoDialog() {
            if (!currentConversationData) return;
            
            const dialog = document.getElementById('group-info-dialog');
            const imagePreview = document.getElementById('info-group-image-preview');
            const nameElement = document.getElementById('info-group-name');
            const descriptionElement = document.getElementById('info-group-description');
            const typeElement = document.getElementById('info-group-type');
            const imagesContainer = document.getElementById('info-group-images');
            
            // Set group info
            nameElement.textContent = currentConversationData.name || 'Sans nom';
            descriptionElement.textContent = currentConversationData.description || 'Sans description';
            
            if (currentConversationData.type === 'private') {
                typeElement.textContent = 'Discussion privée';
            } else {
                typeElement.textContent = currentConversationData.allowPublicMessages !== false ? 
                    'Groupe public (Tous peuvent écrire)' : 'Groupe restreint (Écriture limitée aux administrateurs)';
            }
            
            // Set group image
            if (currentConversationData.imageURL) {
                imagePreview.innerHTML = `<img src="${currentConversationData.imageURL}" alt="${currentConversationData.name}">`;
            } else {
                const iconClass = currentConversationData.type === 'private' ? 'fas fa-user' : 'fas fa-users';
                imagePreview.innerHTML = `<i class="${iconClass}" style="color: white; font-size: 40px;"></i>`;
            }
            
            // Reset images container
            imagesContainer.innerHTML = '<div class="group-info-image-empty">Chargement des images...</div>';
            
            // Load conversation images
            loadConversationImages();
            
            dialog.classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'group-info' }, '');
        }
        
        function hideGroupInfoDialog() {
            document.getElementById('group-info-dialog').classList.remove('active');
        }
        
        // Load images shared in the conversation
        async function loadConversationImages() {
            if (!currentConversationId) return;
            
            const imagesContainer = document.getElementById('info-group-images');
            
            try {
                // Use cache if available
                if (groupImageCache[currentConversationId] && groupImageCache[currentConversationId].length > 0) {
                    displayConversationImages(groupImageCache[currentConversationId]);
                    return;
                }
                
                // Query messages with images
                const messagesRef = collection(db, "conversations", currentConversationId, "messages");
                const q = query(messagesRef, where("imageData", "!=", null));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partagée</div>';
                    return;
                }
                
                const images = [];
                querySnapshot.forEach(doc => {
                    const messageData = doc.data();
                    if (messageData.imageData) {
                        images.push({
                            url: messageData.imageData,
                            id: doc.id,
                            timestamp: messageData.createdAt
                        });
                    }
                });
                
                // Sort by timestamp (newest first)
                images.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return b.timestamp.seconds - a.timestamp.seconds;
                    }
                    return 0;
                });
                
                // Store in cache
                groupImageCache[currentConversationId] = images;
                
                // Display images
                displayConversationImages(images);
                
            } catch (error) {
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Erreur lors du chargement des images</div>';
                addLog(`Erreur lors du chargement des images de conversation: ${error.message}`, 'error');
            }
        }
        
        function displayConversationImages(images) {
            const imagesContainer = document.getElementById('info-group-images');
            
            if (!images || images.length === 0) {
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partagée</div>';
                return;
            }
            
            imagesContainer.innerHTML = '';
            
            // Display up to 9 most recent images
            const imagesToShow = images.slice(0, 9);
            
            imagesToShow.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'group-info-image';
                imageElement.innerHTML = `<img src="${image.url}" alt="Image partagée">`;
                
                imageElement.addEventListener('click', () => {
                    showImageViewer(image.url);
                });
                
                imagesContainer.appendChild(imageElement);
            });
        }
        
        // Functions for image viewer with download
        function showImageViewer(imageUrl) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            viewerImage.src = imageUrl;
            viewer.classList.add('active');
            
            // Store current image for download
            currentDownloadImage = imageUrl;
            
            // Add state to history for back button handling
            history.pushState({ page: 'image-viewer' }, '');
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('viewer-image').src = '';
                currentDownloadImage = '';
            }, 300);
        }
        
        // Function to download current image
        function downloadCurrentImage() {
            if (!currentDownloadImage) return;
            
            try {
                // Create a temporary anchor element
                const a = document.createElement('a');
                a.href = currentDownloadImage;
                a.download = 'image_' + new Date().getTime() + '.jpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showNotification('Téléchargement démarré', 'success');
                addLog('Image téléchargée', 'success');
            } catch (error) {
                showNotification('Erreur lors du téléchargement de l\'image', 'error');
                addLog(`Erreur téléchargement image: ${error.message}`, 'error');
            }
        }
        
        // Process chat images
        async function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image valide', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) { // 5 MB max
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                showNotification('Préparation de l\'image...', 'info');
                
                const base64Image = await encodeImageToBase64(file);
                chatImageFile = base64Image;
                
                // Optional: Show preview
                const inputField = document.getElementById('chat-input');
                if (inputField) {
                    inputField.placeholder = 'Ajoutez un commentaire à l\'image (optionnel)';
                    inputField.focus();
                }
                
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--success-color)';
                }
                
                showNotification('Image prête à être envoyée', 'success');
                addLog('Image sélectionnée pour envoi', 'info');
            } catch (error) {
                console.error('Erreur lors du traitement de l\'image:', error);
                showNotification('Erreur lors du traitement de l\'image', 'error');
                addLog(`Erreur traitement image: ${error.message}`, 'error');
                chatImageFile = null;
            }
            
            // Reset input to allow selecting the same image again
            document.getElementById('chat-image-input').value = '';
        }
        
        function switchForecastTab(tabId) {
            currentForecastTab = tabId;
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.forecasts-content').forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            loadForecastsData(tabId);
        }
        
        function showConversationsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                return;
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'conversations') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'conversations';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('conversations-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Conversations';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            // Show bottom nav
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadConversations();
            addLog('Section conversations affichée', 'info');
        }
        
        function showUsersSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'users') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'users';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('users-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Utilisateurs';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            // Show bottom nav
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadUsers();
            addLog('Section utilisateurs affichée', 'info');
        }
        
        function showForecastsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'forecasts') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'forecasts';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('forecasts-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Pronostics';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            // Show bottom nav
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadForecastsData(currentForecastTab);
            addLog('Section pronostics affichée', 'info');
        }

        // Function to check if date is today or tomorrow
        function isDateTodayOrTomorrow(date) {
            if (!date) return false;

            let forecastDate;
            if (date.toDate) {
                forecastDate = date.toDate();
            } else if (date instanceof Date) {
                forecastDate = date;
            } else {
                return false;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            // Compare only year, month, day (not time)
            return (
                (forecastDate.getFullYear() === today.getFullYear() && 
                 forecastDate.getMonth() === today.getMonth() && 
                 forecastDate.getDate() === today.getDate()) ||
                (forecastDate.getFullYear() === tomorrow.getFullYear() && 
                 forecastDate.getMonth() === tomorrow.getMonth() && 
                 forecastDate.getDate() === tomorrow.getDate())
            );
        }
        
        async function loadForecastsData(tabType) {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
                
                if (forecastsSnap.empty) {
                    await initCollections();
                }
            } catch (error) {
                console.error("Initial error:", error);
            }
            
            if (forecastsUnsubscribe) {
                forecastsUnsubscribe();
                forecastsUnsubscribe = null;
            }
            
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement) return;
            
            listElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des pronostics...</div>
                </div>
            `;
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const q = query(
                    forecastsRef, 
                    where("type", "==", tabType), 
                    orderBy("date", "desc"),
                    limit(50)
                );
                
                forecastsUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-futbol"></i>
                                <div class="empty-state-title">Aucun pronostic</div>
                                <div class="empty-state-text">Aucun pronostic disponible actuellement</div>
                            </div>
                        `;
                        return;
                    }
                    
                    let hasMatchesToday = false;
                    listElement.innerHTML = '';
                    
                    const fragment = document.createDocumentFragment();
                    
                    snapshot.forEach((doc) => {
                        const forecastData = doc.data();
                        // Check if forecast date is today or tomorrow
                        if (isDateTodayOrTomorrow(forecastData.date)) {
                            hasMatchesToday = true;
                            const forecastElement = createForecastElement(forecastData, tabType);
                            fragment.appendChild(forecastElement);
                        }
                    });
                    
                    if (hasMatchesToday) {
                        listElement.appendChild(fragment);
                        addLog(`${snapshot.size} pronostics ${tabType} chargés`, 'success');
                    } else {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-calendar-day"></i>
                                <div class="empty-state-title">Pas de matchs aujourd'hui</div>
                                <div class="empty-state-text">Aucun pronostic disponible pour aujourd'hui ou demain</div>
                            </div>
                        `;
                    }
                });
            } catch (error) {
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les pronostics</div>
                    </div>
                `;
                addLog(`Erreur chargement pronostics ${tabType}: ${error.message}`, 'error');
            }
        }
        
        async function initCollections() {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
                addLog('Collections initialisées', 'info');
            } catch (error) {
                addLog(`Erreur initialisation collections: ${error.message}`, 'error');
            }
        }
        
        function createForecastElement(forecastData, type) {
            const forecastElement = document.createElement('div');
            forecastElement.className = 'forecast-item';
            
            let statusClass = 'pending';
            let statusText = 'À venir';
            
            if (forecastData.status === 'win') {
                statusClass = 'win';
                statusText = 'Gagné';
            } else if (forecastData.status === 'loss') {
                statusClass = 'loss';
                statusText = 'Perdu';
            }
            
            let formattedDate = 'Date inconnue';
            if (forecastData.date) {
                let date;
                if (forecastData.date.toDate) {
                    date = forecastData.date.toDate();
                } else {
                    date = new Date(forecastData.date);
                }
                
                formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let mainContent = '';
            
            if (type === 'safes') {
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Pronostic: ${forecastData.prediction}
                    </div>
                `;
            } else if (type === 'exact') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center;">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                const scoreOptions = forecastData.scoreOptions || [forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`];
                const scoreOptionsHTML = `
                    <div class="score-options">
                        ${scoreOptions.map(score => `
                            <div class="score-option ${score === (forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`) ? 'active' : ''}">
                                ${score}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Options de score:</div>
                        ${scoreOptionsHTML}
                    </div>
                    ${resultDisplay}
                `;
            } else if (type === 'ai') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center; font-weight: bold; color: ${forecastData.status === 'win' ? 'var(--success-color)' : 'var(--danger-color)'}">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Prédiction: ${forecastData.prediction}
                    </div>
                    ${resultDisplay}
                    <div style="font-size: 13px; margin-top: 10px; font-style: italic;">
                        "${forecastData.analysis}"
                    </div>
                `;
            }
            
            const confidenceBar = `
                <div class="forecast-confidence">
                    <span>Confiance:</span>
                    <div class="confidence-bar-container">
                        <div class="confidence-bar" style="width: ${forecastData.confidence}%"></div>
                    </div>
                    <span>${forecastData.confidence}%</span>
                </div>
            `;
            
            const footer = `
                <div class="forecast-date">${formattedDate}</div>
            `;
            
            forecastElement.innerHTML = mainContent + confidenceBar + footer;
            return forecastElement;
        }
        
        function showEventsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'events';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('events-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Événements';
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            // Reattach search event handler
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            
            const createNotifBtn = document.getElementById('create-notification-btn');
            if (createNotifBtn) {
                if (isAdmin) {
                    createNotifBtn.style.display = 'flex';
                } else {
                    createNotifBtn.style.display = 'none';
                }
            }
            
            // Hide bottom nav
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            listenToEvents();
            
            // Add state to history for back button handling
            history.pushState({ page: 'events' }, '');
            addLog('Section événements affichée', 'info');
        }
        
        function showProfileSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'profile';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('profile-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Profil';
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-action').innerHTML = '';
            
            document.getElementById('header-back-button').addEventListener('click', function() {
                showConversationsSection();
            });

            // Hide bottom nav
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            // Add state to history for back button handling
            history.pushState({ page: 'profile' }, '');
            addLog('Section profil affichée', 'info');
        }
        
        // FIXED: Load all conversations (groups and private) correctly
        async function loadConversations() {
            if (isLoadingConversations) return;
            isLoadingConversations = true;
            
            try {
                const conversationsList = document.getElementById('conversations-list');
                if (!conversationsList) return;
                
                // Show loading state
                conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des conversations...</div>
                    </div>
                `;
                
                // Clean up previous listeners
                if (conversationsUnsubscribe) {
                    conversationsUnsubscribe();
                    conversationsUnsubscribe = null;
                }
                
                // NEW APPROACH: Load all conversations and filter them based on visibility rules
                const conversationsRef = collection(db, "conversations");
                
                conversationsUnsubscribe = onSnapshot(conversationsRef, async (snapshot) => {
                    try {
                        if (snapshot.empty) {
                            conversationsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-comments"></i>
                                    <div class="empty-state-title">Aucune conversation</div>
                                    <div class="empty-state-text">${isAdmin ? 'Créez un nouveau groupe en appuyant sur le bouton +' : 'Vos conversations apparaîtront ici'}</div>
                                </div>
                            `;
                            isLoadingConversations = false;
                            return;
                        }
                        
                        // Filter conversations based on visibility rules
                        const visibleConversations = [];
                        
                        for (const conversationDoc of snapshot.docs) {
                            const conversationData = conversationDoc.data();
                            
                            // Check if user should see this conversation
                            let shouldShow = false;
                            
                            if (conversationData.type === 'private') {
                                // Private: only show if user is a participant
                                shouldShow = conversationData.participants && 
                                           conversationData.participants.includes(currentUser.uid);
                            } else {
                                // Group: show to all users (groups are public by default)
                                shouldShow = true;
                            }
                            
                            if (shouldShow) {
                                visibleConversations.push({
                                    id: conversationDoc.id,
                                    data: conversationData
                                });
                            }
                        }
                        
                        // Sort by lastMessageTime
                        visibleConversations.sort((a, b) => {
                            const timeA = a.data.lastMessageTime ? 
                                (a.data.lastMessageTime.toDate ? a.data.lastMessageTime.toDate() : new Date(a.data.lastMessageTime)) : 
                                new Date(0);
                            const timeB = b.data.lastMessageTime ? 
                                (b.data.lastMessageTime.toDate ? b.data.lastMessageTime.toDate() : new Date(b.data.lastMessageTime)) : 
                                new Date(0);
                            return timeB - timeA; // Most recent first
                        });
                        
                        if (visibleConversations.length === 0) {
                            conversationsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-comments"></i>
                                    <div class="empty-state-title">Aucune conversation</div>
                                    <div class="empty-state-text">${isAdmin ? 'Créez un nouveau groupe en appuyant sur le bouton +' : 'Vos conversations apparaîtront ici'}</div>
                                </div>
                            `;
                            isLoadingConversations = false;
                            return;
                        }
                        
                        // Clear list and create conversation elements
                        conversationsList.innerHTML = '';
                        const fragment = document.createDocumentFragment();
                        
                        for (const conversation of visibleConversations) {
                            const conversationElement = await createConversationElement(conversation.id, conversation.data);
                            fragment.appendChild(conversationElement);
                        }
                        
                        conversationsList.appendChild(fragment);
                        addLog(`${visibleConversations.length} conversations chargées`, 'success');
                        isLoadingConversations = false;
                        
                    } catch (error) {
                        console.error("Error processing conversations:", error);
                        conversationsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="empty-state-title">Erreur</div>
                                <div class="empty-state-text">Impossible de charger les conversations</div>
                            </div>
                        `;
                        addLog(`Erreur traitement conversations: ${error.message}`, 'error');
                        isLoadingConversations = false;
                    }
                }, (error) => {
                    console.error("Conversations snapshot error:", error);
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les conversations</div>
                        </div>
                    `;
                    addLog(`Erreur chargement conversations: ${error.message}`, 'error');
                    isLoadingConversations = false;
                });
                
            } catch (error) {
                console.error("loadConversations error:", error);
                const conversationsList = document.getElementById('conversations-list');
                if (conversationsList) {
                    conversationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les conversations</div>
                        </div>
                    `;
                }
                addLog(`Erreur chargement conversations: ${error.message}`, 'error');
                isLoadingConversations = false;
            }
        }

        async function createConversationElement(conversationId, conversationData) {
            const conversationItem = document.createElement('div');
            conversationItem.className = conversationData.type === 'private' ? 'chat-item private' : 'chat-item';
            conversationItem.setAttribute('data-id', conversationId);
            conversationItem.setAttribute('data-conversation', conversationData.name || 'Sans nom');
            
            let displayName = conversationData.name || 'Sans nom';
            let subtitle = conversationData.description || 'Aucune description';
            let iconContent = '';
            let badges = '';
            
            if (conversationData.type === 'private') {
                // For private conversations, get the other user's info
                const otherUserId = conversationData.participants?.find(id => id !== currentUser.uid);
                if (otherUserId) {
                    try {
                        const otherUserDoc = await getDoc(doc(db, "Users", otherUserId));
                        if (otherUserDoc.exists()) {
                            const otherUserData = otherUserDoc.data();
                            displayName = otherUserData.displayName || otherUserData.email.split('@')[0];
                            subtitle = otherUserData.email;
                            
                            if (otherUserData.photoURL) {
                                iconContent = `<img src="${otherUserData.photoURL}" alt="${displayName}">`;
                            } else {
                                iconContent = '<i class="fas fa-user" style="color: var(--primary-color); font-size: 20px;"></i>';
                            }
                            
                            if (otherUserData.statut === 'admin') {
                                badges += '<span class="admin-badge">Admin</span>';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading other user data:', error);
                    }
                }
                
                badges += '<span class="private-badge">Privé</span>';
            } else {
                // Group conversation
                if (conversationData.imageURL) {
                    iconContent = `<img src="${conversationData.imageURL}" alt="${conversationData.name}">`;
                } else {
                    iconContent = '<i class="fas fa-users" style="color: white; font-size: 20px;"></i>';
                }
                
                if (conversationData.allowPublicMessages === false) {
                    badges += '<span class="restricted-badge">Restreint</span>';
                }
            }
            
            let timeDisplay = '';
            if (conversationData.lastMessageTime) {
                try {
                    let date;
                    if (conversationData.lastMessageTime.toDate) {
                        date = conversationData.lastMessageTime.toDate();
                    } else {
                        date = new Date(conversationData.lastMessageTime);
                    }
                    
                    const now = new Date();
                    const diffInHours = (now - date) / (1000 * 60 * 60);
                    
                    if (diffInHours < 24) {
                        timeDisplay = date.toLocaleTimeString('fr-FR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    } else {
                        timeDisplay = date.toLocaleDateString('fr-FR', { 
                            day: 'numeric', 
                            month: 'short' 
                        });
                    }
                } catch (error) {
                    timeDisplay = '';
                }
            }
            
            const picClass = conversationData.type === 'private' ? 'profile-pic' : 'group-pic';
            
            conversationItem.innerHTML = `
                <div class="${picClass}">
                    ${iconContent}
                </div>
                <div class="item-content">
                    <div class="item-title">
                        ${displayName}
                        ${badges}
                    </div>
                    <div class="item-subtitle">${subtitle}</div>
                </div>
                <div class="item-time">${timeDisplay}</div>
            `;
            
            conversationItem.addEventListener('click', function() {
                openChat(conversationId, displayName, conversationData);
            });
            
            // Long press for edit (admin only, not for private conversations)
            if (isAdmin && conversationData.type !== 'private') {
                let longPressTimer;
                
                conversationItem.addEventListener('touchstart', function(e) {
                    longPressTimer = setTimeout(() => {
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        showEditGroupDialog(conversationId, conversationData);
                    }, 800);
                });
                
                conversationItem.addEventListener('touchend', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                    }
                });
                
                conversationItem.addEventListener('touchmove', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                    }
                });
            }
            
            return conversationItem;
        }

        function openChat(conversationId, conversationName, conversationData) {
            currentConversationId = conversationId;
            currentConversation = conversationName;
            currentConversationData = conversationData;
            
            document.getElementById('chat-interface').style.display = 'block';
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            // Update header based on conversation type
            updateConversationHeader();
            
            // Set up header actions for group conversations
            if (conversationData.type !== 'private') {
                document.getElementById('header-action').innerHTML = `
                    <div class="info-button" id="conversation-info-btn">
                        <i class="fas fa-info-circle"></i>
                    </div>
                `;
                
                document.getElementById('conversation-info-btn').addEventListener('click', showGroupInfoDialog);
            } else {
                document.getElementById('header-action').innerHTML = '';
            }
            
            // Hide bottom nav
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            // Clear messages
            document.getElementById('chat-messages').innerHTML = '';
            
            // Check send permissions
            checkSendPermissions();
            
            // Load messages
            loadMessages(conversationId);
            
            // Setup textarea auto-resize
            setupTextareaAutoResize();
            
            // Clear reply mode
            cancelReply();
            
            // Clear image selection
            chatImageFile = null;
            const imageButton = document.getElementById('image-button');
            if (imageButton) {
                imageButton.style.color = 'var(--primary-color)';
            }
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.placeholder = 'Écrire un message...';
            }
            
            addLog(`Chat ouvert: ${conversationName}`, 'info');
            
            // Add state to history for back button handling
            history.pushState({ page: 'chat', conversationId }, '');
        }

        function closeChat() {
            document.getElementById('chat-interface').style.display = 'none';
            
            // Stop listening to messages
            if (chatUnsubscribers[currentConversationId]) {
                chatUnsubscribers[currentConversationId]();
                delete chatUnsubscribers[currentConversationId];
            }
            
            // Clear image cache for this conversation
            if (currentConversationId && groupImageCache[currentConversationId]) {
                delete groupImageCache[currentConversationId];
            }
            
            currentConversationId = null;
            currentConversation = '';
            currentConversationData = null;
            
            // Clear reply mode
            cancelReply();
            
            // Clear image selection
            chatImageFile = null;
            const imageButton = document.getElementById('image-button');
            if (imageButton) {
                imageButton.style.color = 'var(--primary-color)';
            }
            
            // Return to conversations
            showConversationsSection();
            addLog('Chat fermé', 'info');
        }

        function checkSendPermissions() {
            const sendButton = document.getElementById('send-button');
            const imageButton = document.getElementById('image-button');
            const chatInput = document.getElementById('chat-input');
            
            if (!currentConversationData) {
                return;
            }
            
            if (currentConversationData.type === 'private') {
                // Private conversations: always allow
                sendButton.disabled = false;
                imageButton.disabled = false;
                chatInput.disabled = false;
                chatInput.placeholder = 'Écrire un message...';
                return;
            }
            
            // Group conversations: check permissions
            const canSendMessages = currentConversationData.allowPublicMessages !== false || isAdmin;
            
            sendButton.disabled = !canSendMessages;
            imageButton.disabled = !canSendMessages;
            chatInput.disabled = !canSendMessages;
            
            if (!canSendMessages) {
                chatInput.placeholder = 'Seuls les administrateurs peuvent écrire dans ce groupe';
                
                // Show restriction message
                const chatMessages = document.getElementById('chat-messages');
                const existingRestrictionMsg = chatMessages.querySelector('.restricted-message');
                if (!existingRestrictionMsg) {
                    const restrictionMessage = document.createElement('div');
                    restrictionMessage.className = 'restricted-message';
                    restrictionMessage.innerHTML = `
                        <i class="fas fa-lock"></i>
                        Seuls les administrateurs peuvent envoyer des messages dans ce groupe
                    `;
                    chatMessages.appendChild(restrictionMessage);
                }
            } else {
                chatInput.placeholder = 'Écrire un message...';
                
                // Remove restriction message if it exists
                const restrictionMsg = document.getElementById('chat-messages').querySelector('.restricted-message');
                if (restrictionMsg) {
                    restrictionMsg.remove();
                }
            }
        }

        async function loadMessages(conversationId) {
            if (chatUnsubscribers[conversationId]) {
                chatUnsubscribers[conversationId]();
                delete chatUnsubscribers[conversationId];
            }
            
            try {
                const messagesRef = collection(db, "conversations", conversationId, "messages");
                const q = query(messagesRef, orderBy("createdAt", "asc"), limit(100));
                
                chatUnsubscribers[conversationId] = onSnapshot(q, async (snapshot) => {
                    const chatMessages = document.getElementById('chat-messages');
                    if (!chatMessages) return;
                    
                    if (snapshot.empty) {
                        chatMessages.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 10px;"></i>
                                <div>Commencez la conversation !</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Clear existing messages except restriction message
                    const restrictionMsg = chatMessages.querySelector('.restricted-message');
                    chatMessages.innerHTML = '';
                    if (restrictionMsg) {
                        chatMessages.appendChild(restrictionMsg);
                    }
                    
                    let lastDate = null;
                    const fragment = document.createDocumentFragment();
                    
                    for (const messageDoc of snapshot.docs) {
                        const messageData = messageDoc.data();
                        
                        // Add date separator if needed
                        if (messageData.createdAt) {
                            let messageDate;
                            if (messageData.createdAt.toDate) {
                                messageDate = messageData.createdAt.toDate();
                            } else {
                                messageDate = new Date(messageData.createdAt);
                            }
                            
                            const messageDateString = messageDate.toDateString();
                            if (lastDate !== messageDateString) {
                                const dateSeparator = createDateSeparator(messageDate);
                                fragment.appendChild(dateSeparator);
                                lastDate = messageDateString;
                            }
                        }
                        
                        const messageElement = await createMessageElement(messageDoc.id, messageData);
                        fragment.appendChild(messageElement);
                    }
                    
                    chatMessages.appendChild(fragment);
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 100);
                }, (error) => {
                    console.error("Messages snapshot error:", error);
                    addLog(`Erreur chargement messages: ${error.message}`, 'error');
                });
                
            } catch (error) {
                console.error("Load messages error:", error);
                addLog(`Erreur chargement messages: ${error.message}`, 'error');
            }
        }

        function createDateSeparator(date) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            let dateText;
            if (date.toDateString() === today.toDateString()) {
                dateText = "Aujourd'hui";
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateText = "Hier";
            } else {
                dateText = date.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            separator.innerHTML = `<div class="date-separator-text">${dateText}</div>`;
            return separator;
        }

        async function createMessageElement(messageId, messageData) {
            const messageContainer = document.createElement('div');
            const isSent = messageData.senderId === currentUser.uid;
            
            messageContainer.className = `message-container ${isSent ? 'sent' : 'received'}`;
            
            let senderName = 'Utilisateur';
            if (!isSent && !messageData.isSystem) {
                try {
                    const senderDoc = await getDoc(doc(db, "Users", messageData.senderId));
                    if (senderDoc.exists()) {
                        const senderData = senderDoc.data();
                        senderName = senderData.displayName || senderData.email.split('@')[0];
                    }
                } catch (error) {
                    console.error('Error loading sender data:', error);
                }
            }
            
            let timeString = '';
            if (messageData.createdAt) {
                try {
                    let date;
                    if (messageData.createdAt.toDate) {
                        date = messageData.createdAt.toDate();
                    } else {
                        date = new Date(messageData.createdAt);
                    }
                    timeString = date.toLocaleTimeString('fr-FR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                } catch (error) {
                    timeString = '';
                }
            }
            
            if (messageData.isSystem) {
                messageContainer.innerHTML = `
                    <div class="message message-received" style="background-color: var(--secondary-color); font-style: italic; text-align: center;">
                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                        ${messageData.text}
                        ${timeString ? `<div class="message-time">${timeString}</div>` : ''}
                    </div>
                `;
                return messageContainer;
            }
            
            let messageContent = '';
            
            if (messageData.imageData) {
                messageContent = `
                    <div class="message message-with-image ${isSent ? 'message-sent' : 'message-received'}" 
                         data-id="${messageId}" 
                         data-from="${messageData.senderId}">
                        <img src="${messageData.imageData}" 
                             alt="Image" 
                             class="message-image" 
                             onclick="showImageViewer('${messageData.imageData}')">
                        ${messageData.text ? `<div class="message-text">${messageData.text}</div>` : ''}
                        ${timeString ? `<div class="message-time">${timeString}</div>` : ''}
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}" 
                         data-id="${messageId}" 
                         data-from="${messageData.senderId}">
                        ${messageData.replyTo ? createReplyQuote(messageData.replyTo) : ''}
                        ${messageData.text}
                        ${timeString ? `<div class="message-time">${timeString}</div>` : ''}
                    </div>
                `;
            }
            
            if (!isSent && currentConversationData && currentConversationData.type !== 'private') {
                messageContainer.innerHTML = `
                    <div class="message-sender sender-${messageData.senderId}">${senderName}</div>
                    ${messageContent}
                `;
            } else {
                messageContainer.innerHTML = messageContent;
            }
            
            return messageContainer;
        }

        function createReplyQuote(replyData) {
            return `
                <div class="message-quote">
                    <div class="message-quote-sender">${replyData.sender}</div>
                    <div class="message-quote-content">${replyData.text}</div>
                </div>
            `;
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const text = chatInput.value.trim();
            
            if (!text && !chatImageFile) return;
            if (!currentConversationId) return;
            
            // Check permissions
            if (currentConversationData && currentConversationData.type !== 'private') {
                const canSendMessages = currentConversationData.allowPublicMessages !== false || isAdmin;
                if (!canSendMessages) {
                    showNotification("Vous n'avez pas l'autorisation d'envoyer des messages dans ce groupe", "error");
                    return;
                }
            }
            
            try {
                if (isOnline) {
                    await sendMessageToFirestore(currentConversationId, text, chatImageFile, replyingToMessage);
                } else {
                    messageQueue.push({
                        conversationId: currentConversationId,
                        text: text,
                        imageData: chatImageFile,
                        replyTo: replyingToMessage
                    });
                    showNotification('Message ajouté à la file d\'attente', 'info');
                }
                
                // Clear input
                chatInput.value = '';
                
                // Clear image
                chatImageFile = null;
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--primary-color)';
                }
                
                // Clear reply
                cancelReply();
                
                // Resize textarea
                if (autoResizeTextarea) {
                    autoResizeTextarea();
                }
                
                // Reset placeholder
                chatInput.placeholder = 'Écrire un message...';
                
                addLog('Message envoyé', 'success');
                
            } catch (error) {
                showNotification('Erreur lors de l\'envoi du message', 'error');
                addLog(`Erreur envoi message: ${error.message}`, 'error');
            }
        }

        async function sendMessageToFirestore(conversationId, text, imageData, replyTo) {
            try {
                const messagesRef = collection(db, "conversations", conversationId, "messages");
                const messageData = {
                    text: text || '',
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    imageData: imageData || null
                };
                
                if (replyTo) {
                    messageData.replyTo = replyTo;
                }
                
                await addDoc(messagesRef, messageData);
                
                // Update conversation last message time
                const conversationRef = doc(db, "conversations", conversationId);
                await updateDoc(conversationRef, {
                    lastMessageTime: serverTimestamp()
                });
                
                return true;
            } catch (error) {
                throw error;
            }
        }
        
        // Load all users
        async function loadUsers() {
            if (isLoadingUsers) return;
            isLoadingUsers = true;
            
            try {
                const usersList = document.getElementById('users-list');
                if (!usersList) return;
                
                // Show loading state
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des utilisateurs...</div>
                    </div>
                `;
                
                if (usersUnsubscribe) {
                    usersUnsubscribe();
                    usersUnsubscribe = null;
                }
                
                const usersRef = collection(db, "Users");
                const q = query(usersRef, orderBy("createdAt", "desc"));
                
                usersUnsubscribe = onSnapshot(q, async (snapshot) => {
                    if (snapshot.empty) {
                        usersList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <div class="empty-state-title">Aucun utilisateur</div>
                                <div class="empty-state-text">Aucun utilisateur trouvé</div>
                            </div>
                        `;
                        isLoadingUsers = false;
                        return;
                    }
                    
                    // Clear list
                    usersList.innerHTML = '';
                    allUsers = [];
                    
                    const fragment = document.createDocumentFragment();
                    
                    for (const userDoc of snapshot.docs) {
                        const userData = userDoc.data();
                        if (userDoc.id !== currentUser.uid) { // Don't show current user
                            const userElement = await createUserElement(userDoc.id, userData);
                            fragment.appendChild(userElement);
                            allUsers.push({ id: userDoc.id, ...userData });
                        }
                    }
                    
                    usersList.appendChild(fragment);
                    addLog(`${snapshot.size - 1} utilisateurs chargés`, 'success');
                    isLoadingUsers = false;
                });
                
            } catch (error) {
                const usersList = document.getElementById('users-list');
                if (usersList) {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les utilisateurs</div>
                        </div>
                    `;
                }
                addLog(`Erreur chargement utilisateurs: ${error.message}`, 'error');
            } finally {
                isLoadingUsers = false;
            }
        }
        
        async function createUserElement(userId, userData) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.setAttribute('data-id', userId);
            userItem.setAttribute('data-name', userData.displayName || userData.email);
            
            const isUserAdmin = userData.statut === 'admin';
            
            userItem.innerHTML = `
                <div class="profile-pic">
                    ${userData.photoURL ? `<img src="${userData.photoURL}" alt="${userData.displayName}">` : '<i class="fas fa-user" style="color: var(--primary-color); font-size: 20px;"></i>'}
                    <div class="user-status online"></div>
                </div>
                <div class="item-content">
                    <div class="item-title">
                        ${userData.displayName || userData.email.split('@')[0]}
                        ${isUserAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                    </div>
                    <div class="item-subtitle">${userData.email}</div>
                </div>
                <div class="item-time">
                    <i class="fas fa-comment" style="color: var(--primary-color);"></i>
                </div>
            `;
            
            userItem.addEventListener('click', function() {
                startPrivateConversation(userId, userData);
            });
            
            return userItem;
        }
        
        async function startPrivateConversation(otherUserId, otherUserData) {
            try {
                // Check if private conversation already exists
                const conversationsRef = collection(db, "conversations");
                const q = query(
                    conversationsRef,
                    where("type", "==", "private"),
                    where("participants", "array-contains", currentUser.uid)
                );
                
                const querySnapshot = await getDocs(q);
                let existingConversation = null;
                
                // Look for existing conversation with this user
                querySnapshot.forEach(doc => {
                    const convData = doc.data();
                    if (convData.participants.includes(otherUserId)) {
                        existingConversation = { id: doc.id, ...convData };
                    }
                });
                
                if (existingConversation) {
                    // Open existing conversation
                    openChat(existingConversation.id, getPrivateConversationName(existingConversation, otherUserData), existingConversation);
                    addLog(`Conversation privée ouverte avec ${otherUserData.displayName || otherUserData.email}`, 'info');
                } else {
                    // Create new private conversation
                    const newConversation = {
                        type: 'private',
                        name: `${currentUserData.displayName || currentUserData.email.split('@')[0]} & ${otherUserData.displayName || otherUserData.email.split('@')[0]}`,
                        participants: [currentUser.uid, otherUserId],
                        createdBy: currentUser.uid,
                        createdAt: serverTimestamp(),
                        lastMessageTime: serverTimestamp(),
                        isPrivate: true
                    };
                    
                    const conversationDocRef = await addDoc(conversationsRef, newConversation);
                    
                    // Add initial system message
                    const messagesRef = collection(db, "conversations", conversationDocRef.id, "messages");
                    await addDoc(messagesRef, {
                        text: "Discussion privée créée",
                        senderId: currentUser.uid,
                        createdAt: serverTimestamp(),
                        isSystem: true
                    });
                    
                    // Log the creation
                    await addEventLog({
                        type: 'private-conversation-create',
                        conversationId: conversationDocRef.id,
                        participants: [currentUser.uid, otherUserId],
                        userId: currentUser.uid,
                        timestamp: new Date()
                    });
                    
                    // Open the new conversation
                    const fullConversationData = { 
                        id: conversationDocRef.id, 
                        ...newConversation,
                        participants: [currentUser.uid, otherUserId]
                    };
                    
                    openChat(conversationDocRef.id, getPrivateConversationName(fullConversationData, otherUserData), fullConversationData);
                    
                    showNotification(`Discussion privée créée avec ${otherUserData.displayName || otherUserData.email}`, 'success');
                    addLog(`Nouvelle conversation privée créée avec ${otherUserData.displayName || otherUserData.email}`, 'success');
                }
                
            } catch (error) {
                showNotification('Erreur lors de la création de la discussion privée', 'error');
                addLog(`Erreur création conversation privée: ${error.message}`, 'error');
            }
        }
        
        function getPrivateConversationName(conversationData, otherUserData) {
            if (otherUserData) {
                return otherUserData.displayName || otherUserData.email.split('@')[0];
            }
            
            // Fallback: extract other user's name from conversation data
            return conversationData.name || 'Discussion privée';
        }
        
        function updateConversationHeader() {
            if (!currentConversationData) return;
            
            const headerTitle = document.getElementById('header-title');
            if (!headerTitle) return;
            
            if (currentConversationData.type === 'private') {
                headerTitle.innerHTML = `${currentConversation} <span class="private-badge">Privé</span>`;
            } else if (currentConversationData.allowPublicMessages === false) {
                headerTitle.innerHTML = `${currentConversation} <span class="restricted-badge">Restreint</span>`;
            } else {
                headerTitle.innerText = currentConversation;
            }
        }
        
        async function updateDisplayName() {
            if (!profileNameChanged) return;
            
            const displayName = document.getElementById('edit-display-name').value.trim();
            
            if (!displayName) {
                document.getElementById('edit-display-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-display-name-error').style.display = 'none';
            }
            
            document.getElementById('save-display-name-btn').disabled = true;
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    displayName: displayName
                });
                
                currentUserData.displayName = displayName;
                
                updateProfileInfo();
                
                showNotification('Nom d\'utilisateur mis à jour', 'success');
                addLog(`Nom utilisateur mis à jour: ${displayName}`, 'success');
                profileNameChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour du nom d\'utilisateur', 'error');
                addLog(`Erreur mise à jour nom: ${error.message}`, 'error');
            } finally {
                document.getElementById('save-display-name-btn').disabled = false;
            }
        }
        
        async function updateProfileImage() {
            if (!profileImageFile) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-profile-image-btn', true);
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    photoURL: profileImageFile
                });
                
                currentUserData.photoURL = profileImageFile;
                
                updateProfileInfo();
                
                showNotification('Photo de profil mise à jour', 'success');
                addLog('Photo de profil mise à jour', 'success');
                profileImageFile = null;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de la photo', 'error');
                addLog(`Erreur mise à jour photo: ${error.message}`, 'error');
            } finally {
                setButtonLoading('save-profile-image-btn', false);
            }
        }
        
        async function updateGroupName() {
            if (!groupNameChanged || !editingConversationId) return;
            
            const groupName = document.getElementById('edit-group-name').value.trim();
            
            if (!groupName) {
                document.getElementById('edit-group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-group-name-error').style.display = 'none';
            }
            
            document.getElementById('save-group-name-btn').disabled = true;
            
            try {
                const conversationRef = doc(db, "conversations", editingConversationId);
                await updateDoc(conversationRef, {
                    name: groupName,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentConversationId === editingConversationId) {
                    currentConversation = groupName;
                    if (currentConversationData) {
                        currentConversationData.name = groupName;
                    }
                    
                    updateConversationHeader();
                }
                
                showNotification('Nom du groupe mis à jour', 'success');
                addLog(`Nom de groupe mis à jour: ${groupName}`, 'success');
                groupNameChanged = false;
                
                loadConversations();
            } catch (error) {
                showNotification('Erreur lors de la mise à jour du nom', 'error');
                addLog(`Erreur mise à jour nom groupe: ${error.message}`, 'error');
            } finally {
                document.getElementById('save-group-name-btn').disabled = false;
            }
        }
        
        async function updateGroupDescription() {
            if (!groupDescriptionChanged || !editingConversationId) return;
            
            const groupDescription = document.getElementById('edit-group-description').value.trim();
            
            document.getElementById('save-group-description-btn').disabled = true;
            
            try {
                const conversationRef = doc(db, "conversations", editingConversationId);
                await updateDoc(conversationRef, {
                    description: groupDescription,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentConversationId === editingConversationId && currentConversationData) {
                    currentConversationData.description = groupDescription;
                }
                
                showNotification('Description du groupe mise à jour', 'success');
                addLog('Description de groupe mise à jour', 'success');
                groupDescriptionChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de la description', 'error');
                addLog(`Erreur mise à jour description: ${error.message}`, 'error');
            } finally {
                document.getElementById('save-group-description-btn').disabled = false;
            }
        }
        
        async function updateGroupPermissions() {
            if (!groupPermissionsChanged || !editingConversationId) return;
            
            const allowPublicMessages = document.getElementById('edit-group-public-messages').checked;
            
            document.getElementById('save-group-permissions-btn').disabled = true;
            
            try {
                const conversationRef = doc(db, "conversations", editingConversationId);
                
                const conversationDoc = await getDoc(conversationRef);
                if (!conversationDoc.exists()) {
                    throw new Error("Conversation introuvable");
                }
                
                const conversationData = conversationDoc.data();
                const permissionsChanged = allowPublicMessages !== conversationData.allowPublicMessages;
                
                await updateDoc(conversationRef, {
                    allowPublicMessages: allowPublicMessages,
                    lastUpdated: serverTimestamp()
                });
                
                if (permissionsChanged) {
                    try {
                        await addEventLog({
                            type: 'permission-change',
                            conversationId: editingConversationId,
                            conversationName: conversationData.name,
                            userId: currentUser.uid,
                            allowPublicMessages,
                            timestamp: new Date()
                        });
                    } catch (error) {
                        // Handle error silently
                    }
                }
                
                if (currentConversationId === editingConversationId) {
                    if (currentConversationData) {
                        currentConversationData.allowPublicMessages = allowPublicMessages;
                    }
                    
                    updateConversationHeader();
                    
                    checkSendPermissions();
                }
                
                showNotification('Permissions du groupe mises à jour', 'success');
                addLog('Permissions de groupe mises à jour', 'success');
                groupPermissionsChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise à jour des permissions', 'error');
                addLog(`Erreur mise à jour permissions: ${error.message}`, 'error');
            } finally {
                document.getElementById('save-group-permissions-btn').disabled = false;
            }
        }
        
        async function updateGroupImage() {
            if (!groupImageFile || !editingConversationId) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-group-image-btn', true);
            
            try {
                const conversationRef = doc(db, "conversations", editingConversationId);
                await updateDoc(conversationRef, {
                    imageURL: groupImageFile,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentConversationId === editingConversationId && currentConversationData) {
                    currentConversationData.imageURL = groupImageFile;
                }
                
                showNotification('Image du groupe mise à jour', 'success');
                addLog('Image de groupe mise à jour', 'success');
                groupImageFile = null;
                
                loadConversations();
            } catch (error) {
                showNotification('Erreur lors de la mise à jour de l\'image', 'error');
                addLog(`Erreur mise à jour image: ${error.message}`, 'error');
            } finally {
                setButtonLoading('save-group-image-btn', false);
            }
        }
        
        function setupAuthEvents() {
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        function encodeImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    resolve(event.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function handleProfileImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                profileImageFile = base64Image;
                
                const preview = document.getElementById('profile-image-preview');
                preview.innerHTML = `<img src="${base64Image}" alt="Profile Image">`;
                
                document.getElementById('save-profile-image-btn').disabled = false;
                addLog('Image de profil sélectionnée', 'info');
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
                addLog(`Erreur traitement image profil: ${error.message}`, 'error');
            }
        }
        
        async function handleNewGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('new-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('new-group-image-upload').addEventListener('click', () => {
                    document.getElementById('new-group-image-input').click();
                });
                
                addLog('Image de groupe sélectionnée', 'info');
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
                addLog(`Erreur traitement image groupe: ${error.message}`, 'error');
            }
        }
        
        async function handleEditGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const base64Image = await encodeImageToBase64(file);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('edit-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                    document.getElementById('edit-group-image-input').click();
                });
                
                document.getElementById('save-group-image-btn').disabled = false;
                addLog('Image de groupe modifiée', 'info');
} catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
                addLog(`Erreur traitement image groupe: ${error.message}`, 'error');
            }
        }
        
        function changeAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            document.getElementById(`${tab}-form`).classList.add('active');
        }
        
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value;
            const errorEl = document.getElementById('login-email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email || !emailRegex.test(email)) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-password-error');
            
            if (!password) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value;
            const errorEl = document.getElementById('register-email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email || !emailRegex.test(email)) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-password-error');
            
            if (!password || password.length < 6) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorEl = document.getElementById('register-confirm-password-error');
            
            if (password !== confirmPassword) {
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginForm() {
            return validateLoginEmail() && validateLoginPassword();
        }
        
        function validateRegisterForm() {
            return validateRegisterEmail() && 
                   validateRegisterPassword() && 
                   validateRegisterConfirmPassword();
        }
        
        async function loginUser() {
            if (!validateLoginForm()) return;
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            setButtonLoading('loginBtn', true);
            hideLog('login-log');
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                showLog('login-log', 'Connexion réussie !', 'success');
                addLog(`Connexion réussie pour ${email}`, 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';
                }, 500);
                
            } catch (error) {
                let errorMessage = 'Erreur de connexion';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Aucun compte trouvé avec cet email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Mot de passe incorrect';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email invalide';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Trop de tentatives. Réessayez plus tard';
                        break;
                    default:
                        errorMessage = 'Erreur de connexion. Vérifiez vos identifiants';
                }
                
                showLog('login-log', errorMessage, 'error');
                addLog(`Erreur connexion: ${error.message}`, 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }
        
        async function registerUser() {
            if (!validateRegisterForm()) return;
            
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            
            setButtonLoading('registerBtn', true);
            hideLog('register-log');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                await setDoc(doc(db, "Users", currentUser.uid), {
                    email: email,
                    displayName: email.split('@')[0],
                    statut: 'user',
                    createdAt: serverTimestamp(),
                    photoURL: null
                });
                
                showLog('register-log', 'Inscription réussie !', 'success');
                addLog(`Inscription réussie pour ${email}`, 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';
                }, 500);
                
            } catch (error) {
                let errorMessage = 'Erreur lors de l\'inscription';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Un compte existe déjà avec cet email';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email invalide';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Mot de passe trop faible';
                        break;
                    default:
                        errorMessage = 'Erreur lors de l\'inscription';
                }
                
                showLog('register-log', errorMessage, 'error');
                addLog(`Erreur inscription: ${error.message}`, 'error');
            } finally {
                setButtonLoading('registerBtn', false);
            }
        }
        
        async function logoutUser() {
            try {
                // Clean up listeners
                if (conversationsUnsubscribe) {
                    conversationsUnsubscribe();
                    conversationsUnsubscribe = null;
                }
                if (usersUnsubscribe) {
                    usersUnsubscribe();
                    usersUnsubscribe = null;
                }
                if (eventsUnsubscribe) {
                    eventsUnsubscribe();
                    eventsUnsubscribe = null;
                }
                if (forecastsUnsubscribe) {
                    forecastsUnsubscribe();
                    forecastsUnsubscribe = null;
                }
                
                Object.values(chatUnsubscribers).forEach(unsubscribe => {
                    if (unsubscribe) unsubscribe();
                });
                chatUnsubscribers = {};
                
                await signOut(auth);
                
                // Reset app state
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                currentConversation = '';
                currentConversationId = null;
                currentConversationData = null;
                messageQueue = [];
                
                hideLogoutConfirmation();
                document.getElementById('auth-screen').style.display = 'flex';
                
                addLog('Déconnexion réussie', 'info');
                showNotification('Déconnecté avec succès', 'success');
                
            } catch (error) {
                showNotification('Erreur lors de la déconnexion', 'error');
                addLog(`Erreur déconnexion: ${error.message}`, 'error');
            }
        }
        
        async function deleteAccount() {
            try {
                if (!currentUser) return;
                
                hideDeleteAccountConfirmation();
                
                const userId = currentUser.uid;
                
                // Delete user data from Firestore
                await deleteDoc(doc(db, "Users", userId));
                
                // Delete user account
                await deleteUser(currentUser);
                
                // Reset app state
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                document.getElementById('auth-screen').style.display = 'flex';
                showNotification('Compte supprimé avec succès', 'success');
                addLog('Compte utilisateur supprimé', 'warning');
                
            } catch (error) {
                showNotification('Erreur lors de la suppression du compte', 'error');
                addLog(`Erreur suppression compte: ${error.message}`, 'error');
            }
        }
        
        function showLog(logId, message, type) {
            const logEl = document.getElementById(logId);
            if (logEl) {
                logEl.textContent = message;
                logEl.className = `log-message ${type}`;
                logEl.style.display = 'block';
            }
        }
        
        function hideLog(logId) {
            const logEl = document.getElementById(logId);
            if (logEl) {
                logEl.style.display = 'none';
            }
        }
        
        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            const loader = button.querySelector('.btn-loader');
            const text = button.querySelector('.btn-text');
            
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
                if (loader) loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (loader) loader.style.display = 'none';
            }
        }
        
        function showLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function showCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.add('active');
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-public-messages').checked = true;
            groupImageFile = null;
            
            const preview = document.getElementById('new-group-image-preview');
            preview.innerHTML = `
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="new-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            `;
            
            document.getElementById('new-group-image-upload').addEventListener('click', () => {
                document.getElementById('new-group-image-input').click();
            });
            
            history.pushState({ page: 'create-group' }, '');
        }
        
        function hideCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.remove('active');
            groupImageFile = null;
        }
        
        function showEditGroupDialog(conversationId, conversationData) {
            editingConversationId = conversationId;
            
            document.getElementById('edit-group-dialog').classList.add('active');
            document.getElementById('edit-group-name').value = conversationData.name || '';
            document.getElementById('edit-group-description').value = conversationData.description || '';
            document.getElementById('edit-group-public-messages').checked = conversationData.allowPublicMessages !== false;
            
            groupImageFile = null;
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            
            document.getElementById('save-group-name-btn').disabled = true;
            document.getElementById('save-group-description-btn').disabled = true;
            document.getElementById('save-group-permissions-btn').disabled = true;
            document.getElementById('save-group-image-btn').disabled = true;
            
            const preview = document.getElementById('edit-group-image-preview');
            if (conversationData.imageURL) {
                preview.innerHTML = `
                    <img src="${conversationData.imageURL}" alt="${conversationData.name}">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            } else {
                preview.innerHTML = `
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
            
            document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                document.getElementById('edit-group-image-input').click();
            });
            
            history.pushState({ page: 'edit-group' }, '');
        }
        
        function hideEditGroupDialog() {
            document.getElementById('edit-group-dialog').classList.remove('active');
            editingConversationId = null;
            groupImageFile = null;
        }
        
        function showProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.add('active');
            document.getElementById('edit-display-name').value = currentUserData.displayName || '';
            
            profileImageFile = null;
            profileNameChanged = false;
            
            document.getElementById('save-display-name-btn').disabled = true;
            document.getElementById('save-profile-image-btn').disabled = true;
            
            const preview = document.getElementById('profile-image-preview');
            if (currentUserData.photoURL) {
                preview.innerHTML = `<img src="${currentUserData.photoURL}" alt="Profile">`;
            } else {
                preview.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            history.pushState({ page: 'profile-edit' }, '');
        }
        
        function hideProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.remove('active');
            profileImageFile = null;
        }
        
        function showAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.add('active');
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-content').value = '';
            document.getElementById('notif-type').value = 'info';
            
            history.pushState({ page: 'admin-notif' }, '');
        }
        
        function hideAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.remove('active');
        }
        
        async function createNewGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const allowPublicMessages = document.getElementById('group-public-messages').checked;
            
            if (!groupName) {
                document.getElementById('group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('group-name-error').style.display = 'none';
            }
            
            setButtonLoading('create-group-submit', true);
            
            try {
                const conversationsRef = collection(db, "conversations");
                const newGroup = {
                    name: groupName,
                    description: groupDescription,
                    type: 'group',
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    lastMessageTime: serverTimestamp(),
                    allowPublicMessages: allowPublicMessages,
                    imageURL: groupImageFile || null
                };
                
                const groupDocRef = await addDoc(conversationsRef, newGroup);
                
                // Add system message
                const messagesRef = collection(db, "conversations", groupDocRef.id, "messages");
                await addDoc(messagesRef, {
                    text: `Groupe "${groupName}" créé par ${currentUserData.displayName || currentUserData.email.split('@')[0]}`,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    isSystem: true
                });
                
                // Log the group creation
                await addEventLog({
                    type: 'group-create',
                    conversationId: groupDocRef.id,
                    conversationName: groupName,
                    userId: currentUser.uid,
                    timestamp: new Date()
                });
                
                hideCreateGroupDialog();
                showNotification(`Groupe "${groupName}" créé avec succès`, 'success');
                addLog(`Groupe créé: ${groupName}`, 'success');
                
                // Open the new group
                openChat(groupDocRef.id, groupName, { ...newGroup, id: groupDocRef.id });
                
            } catch (error) {
                showNotification('Erreur lors de la création du groupe', 'error');
                addLog(`Erreur création groupe: ${error.message}`, 'error');
            } finally {
                setButtonLoading('create-group-submit', false);
            }
        }
        
        async function sendAdminNotification() {
            const title = document.getElementById('notif-title').value.trim();
            const content = document.getElementById('notif-content').value.trim();
            const type = document.getElementById('notif-type').value;
            
            if (!title) {
                document.getElementById('notif-title-error').style.display = 'block';
                return;
            } else {
                document.getElementById('notif-title-error').style.display = 'none';
            }
            
            if (!content) {
                document.getElementById('notif-content-error').style.display = 'block';
                return;
            } else {
                document.getElementById('notif-content-error').style.display = 'none';
            }
            
            setButtonLoading('send-notification-btn', true);
            
            try {
                await addEventLog({
                    type: 'admin-notification',
                    title: title,
                    content: content,
                    notificationType: type,
                    userId: currentUser.uid,
                    timestamp: new Date()
                });
                
                hideAdminNotificationDialog();
                showNotification('Notification envoyée', 'success');
                addLog(`Notification admin envoyée: ${title}`, 'success');
                
            } catch (error) {
                showNotification('Erreur lors de l\'envoi de la notification', 'error');
                addLog(`Erreur envoi notification: ${error.message}`, 'error');
            } finally {
                setButtonLoading('send-notification-btn', false);
            }
        }
        
        // Event logging system
        async function addEventLog(eventData) {
            try {
                const eventsRef = collection(db, "events");
                await addDoc(eventsRef, {
                    ...eventData,
                    timestamp: eventData.timestamp || serverTimestamp(),
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Error adding event log:', error);
            }
        }
        
        async function listenToEvents() {
            if (eventsUnsubscribe) {
                eventsUnsubscribe();
                eventsUnsubscribe = null;
            }
            
            const eventsList = document.getElementById('events-list');
            if (!eventsList) return;
            
            eventsList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des événements...</div>
                </div>
            `;
            
            try {
                const eventsRef = collection(db, "events");
                const q = query(eventsRef, orderBy("timestamp", "desc"), limit(50));
                
                eventsUnsubscribe = onSnapshot(q, async (snapshot) => {
                    if (snapshot.empty) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-bell"></i>
                                <div class="empty-state-title">Aucun événement</div>
                                <div class="empty-state-text">Les événements apparaîtront ici</div>
                            </div>
                        `;
                        return;
                    }
                    
                    eventsList.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    
                    for (const eventDoc of snapshot.docs) {
                        const eventData = eventDoc.data();
                        const eventElement = await createEventElement(eventDoc.id, eventData);
                        fragment.appendChild(eventElement);
                    }
                    
                    eventsList.appendChild(fragment);
                    
                    // Check for new events
                    const latestEventTimestamp = snapshot.docs[0]?.data().timestamp;
                    if (latestEventTimestamp && lastViewedEventTimestamp && 
                        latestEventTimestamp.toDate() > lastViewedEventTimestamp) {
                        hasNewEvents = true;
                        showEventNotificationDot();
                    }
                    
                    addLog(`${snapshot.size} événements chargés`, 'success');
                });
                
            } catch (error) {
                eventsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les événements</div>
                    </div>
                `;
                addLog(`Erreur chargement événements: ${error.message}`, 'error');
            }
        }
        
        async function createEventElement(eventId, eventData) {
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${eventData.type}`;
            eventItem.setAttribute('data-id', eventId);
            
            let eventIcon = 'fas fa-info-circle';
            let eventTitle = 'Événement';
            let eventContent = eventData.content || '';
            
            switch (eventData.type) {
                case 'group-create':
                    eventIcon = 'fas fa-plus-circle';
                    eventTitle = 'Nouveau groupe créé';
                    eventContent = `Le groupe "${eventData.conversationName}" a été créé`;
                    break;
                case 'private-conversation-create':
                    eventIcon = 'fas fa-user-plus';
                    eventTitle = 'Discussion privée créée';
                    eventContent = 'Une nouvelle discussion privée a été créée';
                    break;
                case 'permission-change':
                    eventIcon = 'fas fa-shield-alt';
                    eventTitle = 'Permissions modifiées';
                    eventContent = `Permissions du groupe "${eventData.conversationName}" modifiées`;
                    break;
                case 'admin-notification':
                    eventIcon = 'fas fa-bullhorn';
                    eventTitle = eventData.title;
                    eventContent = eventData.content;
                    break;
                default:
                    eventIcon = 'fas fa-info-circle';
                    eventTitle = 'Événement';
            }
            
            let timeDisplay = '';
            if (eventData.timestamp) {
                try {
                    let date;
                    if (eventData.timestamp.toDate) {
                        date = eventData.timestamp.toDate();
                    } else {
                        date = new Date(eventData.timestamp);
                    }
                    
                    const now = new Date();
                    const diffInHours = (now - date) / (1000 * 60 * 60);
                    
                    if (diffInHours < 1) {
                        timeDisplay = 'Il y a quelques minutes';
                    } else if (diffInHours < 24) {
                        timeDisplay = `Il y a ${Math.floor(diffInHours)} heure(s)`;
                    } else {
                        timeDisplay = date.toLocaleDateString('fr-FR', { 
                            day: 'numeric', 
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (error) {
                    timeDisplay = '';
                }
            }
            
            eventItem.innerHTML = `
                <div class="event-icon">
                    <i class="${eventIcon}"></i>
                </div>
                <div class="item-content">
                    <div class="event-header">${eventTitle}</div>
                    <div class="event-content">${eventContent}</div>
                    ${timeDisplay ? `<div class="event-time">${timeDisplay}</div>` : ''}
                </div>
                ${isAdmin ? `
                    <div class="event-actions">
                        <button class="event-action-btn delete" onclick="deleteEvent('${eventId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            `;
            
            return eventItem;
        }
        
        function showEventNotificationDot() {
            const notificationDot = document.getElementById('events-notification-dot');
            if (notificationDot) {
                notificationDot.classList.add('active');
            }
        }
        
        function hideEventNotificationDot() {
            const notificationDot = document.getElementById('events-notification-dot');
            if (notificationDot) {
                notificationDot.classList.remove('active');
            }
            hasNewEvents = false;
        }
        
        function updateLastViewedEventTimestamp() {
            lastViewedEventTimestamp = new Date();
        }
        
        function deleteEvent(eventId) {
            currentEventForDeletion = eventId;
            showDeleteEventConfirmation();
        }
        
        function showDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            currentEventForDeletion = null;
        }
        
        async function confirmDeleteEvent() {
            if (!currentEventForDeletion) return;
            
            try {
                await deleteDoc(doc(db, "events", currentEventForDeletion));
                hideDeleteEventConfirmation();
                showNotification('Événement supprimé', 'success');
                addLog('Événement supprimé', 'info');
            } catch (error) {
                showNotification('Erreur lors de la suppression de l\'événement', 'error');
                addLog(`Erreur suppression événement: ${error.message}`, 'error');
            }
        }
        
        // Message actions
        function replyToMessage() {
            if (!currentMessageForAction) return;
            
            replyingToMessage = {
                id: currentMessageForAction.id,
                sender: getSenderName(currentMessageForAction.element),
                text: currentMessageForAction.text
            };
            
            const replyPreview = document.getElementById('reply-preview');
            const replyName = document.getElementById('reply-name');
            const replyContent = document.getElementById('reply-content');
            
            replyName.textContent = replyingToMessage.sender;
            replyContent.textContent = replyingToMessage.text;
            replyPreview.classList.add('active');
            
            const chatInputContainer = document.getElementById('chat-input-container');
            chatInputContainer.classList.add('with-reply');
            
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
            
            document.getElementById('chat-input').focus();
        }
        
        function copyMessageText() {
            if (!currentMessageForAction) return;
            
            try {
                navigator.clipboard.writeText(currentMessageForAction.text);
                showNotification('Message copié', 'success');
                addLog('Message copié dans le presse-papiers', 'info');
            } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentMessageForAction.text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('Message copié', 'success');
                addLog('Message copié dans le presse-papiers', 'info');
            }
        }
        
        function showDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function hideDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function confirmDeleteMessage() {
            if (!currentMessageForAction || !currentConversationId) return;
            
            try {
                const messageElement = currentMessageForAction.element;
                messageElement.classList.add('deleting');
                
                setTimeout(async () => {
                    try {
                        await deleteDoc(doc(db, "conversations", currentConversationId, "messages", currentMessageForAction.id));
                        hideDeleteConfirmation();
                        hideMessageActionsBar();
                        showNotification('Message supprimé', 'success');
                        addLog('Message supprimé', 'info');
                    } catch (error) {
                        messageElement.classList.remove('deleting');
                        showNotification('Erreur lors de la suppression du message', 'error');
                        addLog(`Erreur suppression message: ${error.message}`, 'error');
                    }
                }, 300);
                
            } catch (error) {
                showNotification('Erreur lors de la suppression du message', 'error');
                addLog(`Erreur suppression message: ${error.message}`, 'error');
            }
        }
        
        function getSenderName(messageElement) {
            const senderElement = messageElement.parentElement.querySelector('.message-sender');
            if (senderElement) {
                return senderElement.textContent;
            }
            return 'Vous';
        }
        
        // Touch handling for long press
        function handleGlobalTouchStart(e) {
            if (e.target.closest('.message') && !e.target.closest('.message-image')) {
                longPressTimer = setTimeout(() => {
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    const messageElement = e.target.closest('.message');
                    showMessageActionsBar(messageElement);
                }, longPressDuration);
            }
        }
        
        function handleGlobalTouchEnd(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchMove(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchCancel(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        // Search filters
        function filterConversations(query) {
            const conversationItems = document.querySelectorAll('#conversations-list .chat-item');
            
            conversationItems.forEach(item => {
                const conversationName = item.getAttribute('data-conversation').toLowerCase();
                if (conversationName.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function filterUsers(query) {
            const userItems = document.querySelectorAll('#users-list .user-item');
            
            userItems.forEach(item => {
                const userName = item.getAttribute('data-name').toLowerCase();
                if (userName.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function filterEvents(query) {
            const eventItems = document.querySelectorAll('#events-list .event-item');
            
            eventItems.forEach(item => {
                const eventText = item.textContent.toLowerCase();
                if (eventText.includes(query.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // User profile update
        function updateProfileInfo() {
            if (!currentUserData) return;
            
            const profileNameElement = document.getElementById('profile-name-text');
            const profileEmailElement = document.getElementById('profile-email');
            const profilePicElement = document.querySelector('#profile-section .profile-pic');
            
            if (profileNameElement) {
                profileNameElement.textContent = currentUserData.displayName || currentUserData.email.split('@')[0];
            }
            
            if (profileEmailElement) {
                profileEmailElement.textContent = currentUserData.email;
            }
            
            if (profilePicElement) {
                if (currentUserData.photoURL) {
                    profilePicElement.innerHTML = `
                        <img src="${currentUserData.photoURL}" alt="Profile">
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                } else {
                    profilePicElement.innerHTML = `
                        <i class="fas fa-user"></i>
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                }
                
                // Reattach event handler
                document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            }
        }
        
        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            try {
                document.getElementById('verify-animation').style.display = 'flex';
                
                if (user) {
                    currentUser = user;
                    isLoggedIn = true;
                    
                    // Get user data from Firestore
                    const userDoc = await getDoc(doc(db, "Users", user.uid));
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data();
                        isAdmin = currentUserData.statut === 'admin';
                    } else {
                        // Create user document if it doesn't exist
                        currentUserData = {
                            email: user.email,
                            displayName: user.email.split('@')[0],
                            statut: 'user',
                            createdAt: serverTimestamp(),
                            photoURL: null
                        };
                        
                        await setDoc(doc(db, "Users", user.uid), currentUserData);
                        isAdmin = false;
                    }
                    
                    // Hide auth screen and loading
                    setTimeout(() => {
                        document.getElementById('verify-animation').style.display = 'none';
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('loading').style.display = 'none';
                        
                        // Initialize the app
                        initializeApp();
                    }, 2000);
                    
                } else {
                    // User is not logged in
                    isLoggedIn = false;
                    currentUser = null;
                    currentUserData = null;
                    isAdmin = false;
                    
                    setTimeout(() => {
                        document.getElementById('verify-animation').style.display = 'none';
                        document.getElementById('auth-screen').style.display = 'flex';
                        document.getElementById('loading').style.display = 'none';
                    }, 1000);
                }
            } catch (error) {
                console.error('Auth state error:', error);
                document.getElementById('verify-animation').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';
                addLog(`Erreur authentification: ${error.message}`, 'error');
            }
        });
        
        function initializeApp() {
            // Update profile info
            updateProfileInfo();
            
            // Show admin badge if user is admin
            if (isAdmin) {
                document.getElementById('admin-badge').style.display = 'inline-block';
            }
            
            // Load initial data
            showConversationsSection();
            
            addLog('Application initialisée', 'success');
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Pari Alliance - Application de messagerie sécurisée');
            addLog('Application démarrée', 'info');
            
            setupDarkMode();
            setupConnectionMonitoring();
            setupUIEvents();
            setupAuthEvents();
        });
    </script>
</body>
</html>

