<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pari Alliance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Theme System - Default Theme */
        :root {
            /* Base Theme (Blue) */
            --primary-color: #5D5CDE;
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --chat-received-text: #000000;
            --selection-color: rgba(93, 92, 222, 0.3);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --event-bg: #f1f1f1;
            --event-border: #e0e0e0;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #ffffff;
            --side-menu-active: #f0f2f5;
            --side-menu-hover: #f5f5f5;
            --log-panel-bg: #f8f9fa;
            --log-panel-border: #e0e0e0;
            --link-hover: #0056b3;
            --admin-notif-bg: #f8f9fa;
            --admin-notif-border: #e0e0e0;
            --forecast-win-bg: rgba(76, 175, 80, 0.2);
            --forecast-loss-bg: rgba(244, 67, 54, 0.2);
            --forecast-pending-bg: rgba(255, 193, 7, 0.2);
            --comment-bg: #f5f5f5;
            --comment-border: #ebebeb;
            --social-whatsapp: #25D366;
            --social-telegram: #0088cc;
            --social-youtube: #FF0000;
            --partner-google: #4285F4;
            --partner-firebase: #FFCA28;
            --partner-github: #333333;
            --partner-quora: #B92B27;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.1);
            --warning-text: #FF9800;
            --image-message-bg: rgba(93, 92, 222, 0.1);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --selected-message-border: rgba(93, 92, 222, 0.7);
            --date-separator-bg: rgba(0, 0, 0, 0.05);
            --date-separator-text: var(--inactive-text);
            --reply-preview-bg: rgba(93, 92, 222, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(0, 0, 0, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: var(--bg-color);
            --action-bar-text: var(--text-color);
            --action-bar-border: var(--border-color);
            --reply-quote-bg: rgba(93, 92, 222, 0.15);
            --reply-quote-border: var(--primary-color);
            --group-info-bg: var(--bg-color);
            --group-info-border: var(--border-color);
            --download-btn-bg: var(--primary-color);
            --download-btn-text: white;
            --new-badge-bg: var(--primary-color);
            --new-badge-text: white;
            --theme-option-border: #ddd;
            --theme-option-active: rgba(93, 92, 222, 0.2);
        }
        
        /* Green Theme */
        .theme-green {
            --primary-color: #4CAF50;
            --chat-sent-bg: #4CAF50;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #e8f5e9;
            --chat-received-text: #1b5e20;
            --selection-color: rgba(76, 175, 80, 0.3);
            --admin-badge-bg: #4CAF50;
            --image-message-bg: rgba(76, 175, 80, 0.1);
            --selected-message-border: rgba(76, 175, 80, 0.7);
            --reply-preview-bg: rgba(76, 175, 80, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-quote-bg: rgba(76, 175, 80, 0.15);
            --reply-quote-border: var(--primary-color);
            --download-btn-bg: var(--primary-color);
            --new-badge-bg: var(--primary-color);
        }
        
        /* Red Theme */
        .theme-red {
            --primary-color: #F44336;
            --chat-sent-bg: #F44336;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #ffebee;
            --chat-received-text: #b71c1c;
            --selection-color: rgba(244, 67, 54, 0.3);
            --admin-badge-bg: #F44336;
            --image-message-bg: rgba(244, 67, 54, 0.1);
            --selected-message-border: rgba(244, 67, 54, 0.7);
            --reply-preview-bg: rgba(244, 67, 54, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-quote-bg: rgba(244, 67, 54, 0.15);
            --reply-quote-border: var(--primary-color);
            --download-btn-bg: var(--primary-color);
            --new-badge-bg: var(--primary-color);
        }
        
        /* Orange Theme */
        .theme-orange {
            --primary-color: #FF9800;
            --chat-sent-bg: #FF9800;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #fff3e0;
            --chat-received-text: #e65100;
            --selection-color: rgba(255, 152, 0, 0.3);
            --admin-badge-bg: #FF9800;
            --image-message-bg: rgba(255, 152, 0, 0.1);
            --selected-message-border: rgba(255, 152, 0, 0.7);
            --reply-preview-bg: rgba(255, 152, 0, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-quote-bg: rgba(255, 152, 0, 0.15);
            --reply-quote-border: var(--primary-color);
            --download-btn-bg: var(--primary-color);
            --new-badge-bg: var(--primary-color);
        }
        
        /* Dark Mode Overrides */
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-received-text: #ffffff;
            --selection-color: rgba(93, 92, 222, 0.4);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-bg: #7571F9;
            --admin-badge-text: white;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --event-bg: #2a2a2a;
            --event-border: #3e3e3e;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #222222;
            --side-menu-active: #333333;
            --side-menu-hover: #2a2a2a;
            --log-panel-bg: #222222;
            --log-panel-border: #3e3e3e;
            --link-hover: #64B5F6;
            --admin-notif-bg: #2a2a2a;
            --admin-notif-border: #333333;
            --forecast-win-bg: rgba(76, 175, 80, 0.15);
            --forecast-loss-bg: rgba(244, 67, 54, 0.15);
            --forecast-pending-bg: rgba(255, 193, 7, 0.15);
            --comment-bg: #2a2a2a;
            --comment-border: #333333;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.15);
            --warning-text: #FFA726;
            --image-message-bg: rgba(93, 92, 222, 0.15);
            --image-viewer-bg: rgba(0, 0, 0, 0.95);
            --selected-message-border: rgba(93, 92, 222, 0.8);
            --date-separator-bg: rgba(255, 255, 255, 0.1);
            --date-separator-text: #aaaaaa;
            --reply-preview-bg: rgba(93, 92, 222, 0.15);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(255, 255, 255, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: #222222;
            --action-bar-text: #ffffff;
            --action-bar-border: #3e3e3e;
            --reply-quote-bg: rgba(93, 92, 222, 0.2);
            --group-info-bg: #222222;
            --group-info-border: #3e3e3e;
            --download-btn-bg: #5D5CDE;
            --download-btn-text: white;
            --theme-option-border: #444;
            --theme-option-active: rgba(93, 92, 222, 0.4);
        }
        
        .dark.theme-green {
            --chat-received-text: #e8f5e9;
            --selection-color: rgba(76, 175, 80, 0.4);
        }
        
        .dark.theme-red {
            --chat-received-text: #ffebee;
            --selection-color: rgba(244, 67, 54, 0.4);
        }
        
        .dark.theme-orange {
            --chat-received-text: #fff3e0;
            --selection-color: rgba(255, 152, 0, 0.4);
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: -0.2px;
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            height: 100%;
            width: 250px;
            background-color: var(--side-menu-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .side-menu.active {
            left: 0;
        }
        
        .side-menu-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .side-menu-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 15px;
        }
        
        .side-menu-close {
            font-size: 20px;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
        
        .side-menu-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .side-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .side-menu-item.active {
            background-color: var(--side-menu-active);
        }
        
        .side-menu-item i {
            font-size: 20px;
            width: 30px;
            color: var(--primary-color);
        }
        
        .side-menu-text {
            margin-left: 15px;
            font-weight: 500;
        }
        
        .side-menu-footer {
            margin-top: auto;
        }
        
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .side-menu-overlay.active {
            display: block;
        }
        
        .header {
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .header.search-active {
            height: 50px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: none;
            text-decoration: none;
            transition: opacity 0.3s ease;
            flex: 1;
        }
        
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
            transition: opacity 0.3s ease;
        }
        
        .menu-button, .back-button, .search-button, .events-button, .info-button {
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .menu-button:active, .back-button:active, .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        .notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: var(--notification-dot);
            border-radius: 50%;
            display: none;
        }
        
        .notification-dot.active {
            display: block;
        }
        
        .events-button {
            position: relative;
        }
        
        .search-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .search-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
            margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        
        .search-close {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-close:active {
            background-color: var(--secondary-color);
        }
        
        .header.search-active .header-left,
        .header.search-active .header-title,
        .header.search-active #header-action {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Message actions header bar */
        .message-actions-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--action-bar-bg);
            border-bottom: 1px solid var(--action-bar-border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .message-actions-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .message-actions-title {
            flex: 1;
            font-weight: 500;
            color: var(--action-bar-text);
        }
        
        .message-action-buttons {
            display: flex;
            gap: 15px;
        }
        
        .message-action-btn {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .message-action-btn:active {
            background-color: var(--secondary-color);
        }
        
        .message-action-btn.delete {
            color: var(--danger-color);
        }
        
        .content {
            position: fixed;
            top: 50px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        .content.no-bottom-nav {
            bottom: 0;
        }
        
        .bottom-nav {
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--inactive-text);
            font-size: 10px;
            cursor: pointer;
            height: 100%;
            padding: 8px 0;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        .profile-pic-edit:hover, .profile-pic-edit:active {
            transform: scale(1.1);
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .group-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            z-index: 2;
        }
        
        .group-pic-edit:hover, .group-pic-edit:active {
            transform: scale(1.1);
        }
        
        .chat-item, .user-item, .event-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .restricted-badge {
            display: inline-block;
            background-color: var(--restricted-badge-bg);
            color: var(--restricted-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .new-badge {
            display: inline-block;
            background-color: var(--new-badge-bg);
            color: var(--new-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .loading-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: pulse 2s infinite, bounce 1.5s infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease, background-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button:hover {
            background-color: #4a49c0;
        }

        .button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button.danger:hover {
            background-color: #e53935;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            min-height: 60px;
            max-height: 150px;
            transition: min-height 0.2s ease;
        }
        
        .message-container {
            margin-bottom: 16px;
            clear: both;
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        
        .message-container.sent {
            float: right;
            margin-left: auto;
            align-items: flex-end;
        }
        
        .message-container.received {
            float: left;
            margin-right: auto;
            align-items: flex-start;
        }
        
        .message-sender {
            font-size: 12px;
            margin-bottom: 2px;
            font-weight: bold;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .message {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            color: var(--chat-received-text);
            border-bottom-left-radius: 4px;
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            border-bottom-right-radius: 4px;
        }

        /* Improved visual marking for selected messages */
        .message.selected {
            box-shadow: 0 0 0 2px var(--selected-message-border);
        }
        
        /* Style for deleted messages */
        .message.deleted {
            background-color: var(--deleted-message-bg);
            color: var(--deleted-message-text);
            font-style: italic;
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            position: relative;
        }
        
        /* Improved input field style */
        .chat-input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            font-weight: 400;
            outline: none;
            min-height: 40px;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            vertical-align: middle;
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        .send-button:hover {
            background-color: #4a49c0;
        }

        .send-button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .image-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .image-button:active {
            transform: scale(0.9);
        }

        .image-button:disabled {
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        .profile-edit {
            color: var(--primary-color);
            font-size: 14px;
            margin-top: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 8px;
            border-radius: 15px;
        }
        
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
            text-decoration: none;
            border-bottom: none;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }
        
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            line-height: 1.4;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .notification.success {
            background-color: var(--bg-color);
            color: var(--success-color);
        }

        .notification.error {
            background-color: var(--bg-color);
            color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        
        .verify-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .football-bounce {
            font-size: 80px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-40px); }
            60% { transform: translateY(-20px); }
        }

        .verify-text {
            margin-top: 30px;
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            text-align: center;
        }
        
        @keyframes deleteMessage {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            20% {
                opacity: 0.8;
                transform: scale(0.95);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }
        
        .message.deleting {
            animation: deleteMessage 0.3s ease forwards;
            pointer-events: none;
        }
        
        .create-group-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .create-group-dialog.active {
            display: flex;
        }
        
        .create-group-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .create-group-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .create-group-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .create-group-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-form {
            display: flex;
            flex-direction: column;
        }
        
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-dialog.active {
            display: flex;
        }
        
        .edit-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .edit-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .edit-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .edit-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--group-icon-bg);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .group-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .group-image-preview:hover .group-image-overlay {
            opacity: 1;
        }
        
        .group-image-overlay i {
            color: white;
            font-size: 20px;
        }
        
        .image-upload-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab:hover {
            background-color: #4a49c0;
        }

        .fab.disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
            box-shadow: none;
        }

        .fab.disabled:active {
            transform: none;
        }
        
        .fab i {
            font-size: 24px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 300px;
            padding: 20px;
            z-index: 150;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirmation-button {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .confirmation-delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }

        .event-icon {
            width: 50px;
            height: 50px;
            background-color: var(--event-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            border: 1px solid var(--event-border);
        }
        
        .event-icon i {
            font-size: 22px;
            color: var(--primary-color);
        }

        .event-item {
            transition: none;
            cursor: default;
            position: relative;
        }

        .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-content {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .event-time {
            font-size: 12px;
            color: var(--inactive-text);
            margin-top: 5px;
        }
        
        .admin-count-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .event-item.group-create .event-icon {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .event-item.group-create .event-icon i {
            color: var(--success-color);
        }
        
        .event-item.permission-change .event-icon {
            background-color: rgba(255, 193, 7, 0.2);
        }
        
        .event-item.permission-change .event-icon i {
            color: var(--restricted-badge-bg);
        }
        
        .event-item.user-join .event-icon {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .event-item.user-join .event-icon i {
            color: var(--log-info);
        }

        .restricted-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .profile-edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-edit-dialog.active {
            display: flex;
        }
        
        .profile-image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .profile-image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .profile-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-image-preview i {
            font-size: 50px;
            color: var(--primary-color);
        }
        
        .profile-upload-btn {
            position: absolute;
            bottom: 10px;
            right: calc(50% - 60px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .profile-upload-btn:hover, .profile-upload-btn:active {
            transform: scale(1.1);
            background-color: #4a49c0;
        }

        input[type="file"] {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            text-decoration: none;
            border-bottom: none;
            padding: 0 16px; 
            margin: 15px 0;
        }
        
        .field-error {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .save-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .save-field-btn:hover {
            background-color: #4a49c0;
        }
        
        .save-field-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .editable-field {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .editable-field-input {
            flex: 1;
        }
        
        .forecasts-section {
            padding: 0 0 15px 0;
        }
        
        .forecasts-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .forecast-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
        }
        
        .forecast-tab.active {
            color: var(--primary-color);
        }
        
        .forecast-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        .forecasts-content {
            display: none;
            padding: 0 15px;
        }
        
        .forecasts-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .forecasts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .forecast-item {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .forecast-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .forecast-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .forecast-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        
        .forecast-team-logo {
            width: 40px;
            height: 40px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .forecast-team-name {
            font-weight: 500;
            text-align: center;
            font-size: 14px;
        }
        
        .forecast-score {
            font-size: 22px;
            font-weight: bold;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        .forecast-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .forecast-status.pending {
            background-color: var(--forecast-pending-bg);
            color: var(--text-color);
        }
        
        .forecast-status.win {
            background-color: var(--forecast-win-bg);
            color: var(--text-color);
        }
        
        .forecast-status.loss {
            background-color: var(--forecast-loss-bg);
            color: var(--text-color);
        }
        
        .forecast-date {
            font-size: 12px;
            color: var(--inactive-text);
        }
        
        .forecast-confidence {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-color);
        }
        
        .confidence-bar-container {
            flex: 1;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .confidence-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .no-forecasts {
            text-align: center;
            padding: 30px 15px;
            color: var(--inactive-text);
        }
        
        .no-forecasts i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .admin-notification {
            background-color: var(--bg-color);
            border-radius: 15px;
            margin: 10px 15px 20px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .admin-notification-header {
            color: var(--text-color);
            padding: 0 0 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .admin-notification-title {
            display: flex;
            align-items: center;
        }
        
        .admin-notification-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .admin-notification-content {
            padding: 5px 0;
            line-height: 1.4;
        }
        
        .admin-notification-footer {
            padding: 5px 0 0;
            font-size: 12px;
            color: var(--inactive-text);
            text-align: right;
            border-top: 1px solid var(--border-color);
            margin-top: 10px;
            padding-top: 8px;
        }
        
        .event-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .event-close-btn:hover, .event-close-btn:active {
            transform: scale(1.1);
        }
        
        .event-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        
        .event-action-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s ease;
        }
        
        .event-action-btn:hover, .event-action-btn:active {
            transform: translateY(-1px);
        }
        
        .event-action-btn.delete {
            color: var(--danger-color);
        }
        
        .admin-notif-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .admin-notif-dialog.active {
            display: flex;
        }
        
        .score-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .score-option {
            padding: 5px 12px;
            border-radius: 15px;
            background-color: var(--bg-color);
            font-weight: bold;
            font-size: 14px;
            border: 1px solid var(--border-color);
            transition: transform 0.1s ease;
            cursor: pointer;
        }
        
        .score-option:hover, .score-option:active {
            transform: translateY(-1px);
        }

        .score-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #delete-account-confirmation .confirmation-text {
            color: var(--danger-color);
            font-weight: bold;
        }

        .social-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 15px;
            gap: 10px;
        }
        
        .social-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .social-button:active {
            transform: scale(0.98);
        }
        
        .social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .social-button.whatsapp {
            color: var(--social-whatsapp);
        }
        
        .social-button.telegram {
            color: var(--social-telegram);
        }
        
        .social-button.youtube {
            color: var(--social-youtube);
        }

        .about-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .about-dialog.active {
            display: flex;
        }
        
        .about-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .about-logo {
            text-align: center;
            margin: 20px 0;
        }
        
        .about-logo i {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .about-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .about-version {
            text-align: center;
            font-size: 14px;
            color: var(--inactive-text);
            margin-bottom: 30px;
        }
        
        .about-section {
            margin-bottom: 25px;
        }
        
        .about-section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .about-section-content {
            line-height: 1.5;
            font-size: 14px;
        }
        
        .about-footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: var(--inactive-text);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }
        
        @media (max-height: 640px) {
            .fab {
                bottom: 70px;
            }
        }
        
        @media (max-width: 380px) {
            .confirmation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .confirmation-button {
                width: 100%;
            }
        }
        
        .message-with-image {
            padding: 5px;
            border-radius: 18px;
            background-color: var(--image-message-bg);
            max-width: 100%;
        }
        
        .message-image {
            width: 100%;
            border-radius: 13px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            pointer-events: auto;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .message-image:hover {
            transform: scale(0.98);
        }
        
        .message-text {
            padding: 0 10px 5px;
            word-break: break-word;
        }
        
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .viewer-image-container {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
            margin: 0 auto;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            object-fit: contain;
            pointer-events: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .viewer-close:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .terms-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .terms-dialog.active {
            display: flex;
        }
        
        .terms-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .terms-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .terms-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .terms-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .warning-box {
            background-color: var(--warning-bg);
            border-left: 4px solid var(--warning-text);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .warning-box i {
            color: var(--warning-text);
            margin-right: 10px;
        }
    
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-button, .events-button, .info-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        /* Improved search bar animation */
        @keyframes searchBarIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes searchBarOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        
        .search-container.active {
            animation: searchBarIn 0.3s ease forwards;
        }
        
        .search-container.hiding {
            animation: searchBarOut 0.3s ease forwards;
        }
        
        /* Touch ripple effect for buttons */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Date separators in messages */
        .date-separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
            user-select: none;
        }

        .date-separator:before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: var(--border-color);
            z-index: 1;
        }

        .date-separator-text {
            display: inline-block;
            position: relative;
            z-index: 2;
            background-color: var(--date-separator-bg);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--date-separator-text);
            font-weight: 500;
        }

        /* Reply system */
        .reply-preview {
            background-color: var(--reply-preview-bg);
            border-left: 3px solid var(--reply-preview-border);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 14px;
            position: relative;
            display: none;
        }

        .reply-preview.active {
            display: block;
        }

        .reply-preview-header {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
        }

        .reply-preview-content {
            color: var(--reply-preview-text);
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .reply-preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            cursor: pointer;
            font-size: 10px;
        }

        .chat-input-wrapper.with-reply {
            display: flex;
            flex-direction: column;
        }

        /* Adaptations for reply mode */
        .chat-input-container.with-reply {
            min-height: 100px;
        }
        
        /* Expandable text input styling */
        .chat-input {
            resize: none;
            overflow-y: auto;
            transition: height 0.2s ease;
        }

        /* Improved message quote styling */
        .message-quote {
            margin-bottom: 8px;
            background-color: var(--reply-quote-bg);
            border-left: 3px solid var(--reply-quote-border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            position: relative;
        }
        
        .message-quote-sender {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
            font-size: 12px;
        }
        
        .message-quote-content {
            color: var(--text-color);
            opacity: 0.85;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Group info dialog */
        .group-info-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--group-info-bg);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .group-info-dialog.active {
            display: flex;
        }
        
        .group-info-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--group-info-border);
        }
        
        .group-info-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .group-info-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .group-info-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-info-section {
            margin-bottom: 20px;
        }
        
        .group-info-section-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .group-info-detail {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .group-info-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .group-info-value {
            color: var(--text-color);
            line-height: 1.4;
        }
        
        .group-info-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .group-info-image {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .group-info-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }
        
        .group-info-image:hover img {
            transform: scale(1.05);
        }
        
        .group-info-image-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--border-color);
            opacity: 0.5;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            height: 100%;
        }
        
        .download-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: var(--download-btn-bg);
            color: var(--download-btn-text);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        
        .download-button:hover {
            transform: scale(1.1);
        }

        /* Theme options section */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid var(--theme-option-border);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .theme-option:hover {
            transform: translateY(-2px);
        }
        
        .theme-option.active {
            background-color: var(--theme-option-active);
            border-color: var(--primary-color);
        }
        
        .theme-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .theme-preview-sent, .theme-preview-received {
            position: absolute;
            width: 60%;
            height: 20px;
            border-radius: 10px;
        }
        
        .theme-preview-sent {
            bottom: 10px;
            right: 5px;
        }
        
        .theme-preview-received {
            top: 10px;
            left: 5px;
        }
        
        /* Blue theme preview */
        .theme-blue .theme-preview {
            background-color: #f0f2f5;
        }
        .theme-blue .theme-preview-sent {
            background-color: #5D5CDE;
        }
        .theme-blue .theme-preview-received {
            background-color: #ffffff;
        }
        
        /* Green theme preview */
        .theme-green .theme-preview {
            background-color: #f0f2f5;
        }
        .theme-green .theme-preview-sent {
            background-color: #4CAF50;
        }
        .theme-green .theme-preview-received {
            background-color: #e8f5e9;
        }
        
        /* Red theme preview */
        .theme-red .theme-preview {
            background-color: #f0f2f5;
        }
        .theme-red .theme-preview-sent {
            background-color: #F44336;
        }
        .theme-red .theme-preview-received {
            background-color: #ffebee;
        }
        
        /* Orange theme preview */
        .theme-orange .theme-preview {
            background-color: #f0f2f5;
        }
        .theme-orange .theme-preview-sent {
            background-color: #FF9800;
        }
        .theme-orange .theme-preview-received {
            background-color: #fff3e0;
        }
        
        /* Interface Settings Dialog */
        .interface-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .interface-dialog.active {
            display: flex;
        }
        
        .interface-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .interface-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .interface-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .interface-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Loading indicator for messages */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 20px 0;
        }
        
        .loading-indicator i {
            font-size: 30px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .loading-indicator-text {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        /* Improved scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(128, 128, 128, 0.5);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(128, 128, 128, 0.7);
        }
        
        /* Message pagination controls */
        .load-more-messages {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .load-more-btn {
            background-color: var(--bg-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 5px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .load-more-btn:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        </style>
</head>
<body>
    <div id="verify-animation" class="verify-animation">
        <div class="football-bounce">
            <i class="fas fa-futbol"></i>
        </div>
        <div class="verify-text">Vrification en cours...</div>
    </div>
    
    <div class="side-menu" id="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-close" id="side-menu-close">
                <i class="fas fa-times"></i>
            </div>
            <div class="side-menu-title">Pari Alliance</div>
        </div>
        <div class="side-menu-content">
            <div class="side-menu-item" id="menu-profile">
                <i class="fas fa-user"></i>
                <div class="side-menu-text">Profil</div>
            </div>
            <div class="side-menu-item" id="menu-interface">
                <i class="fas fa-palette"></i>
                <div class="side-menu-text">Interface</div>
            </div>
        </div>
        <div class="side-menu-footer">
            <div class="side-menu-item" id="menu-terms">
                <i class="fas fa-file-alt"></i>
                <div class="side-menu-text">Conditions d'utilisation</div>
            </div>
            <div class="side-menu-item" id="menu-about">
                <i class="fas fa-info-circle"></i>
                <div class="side-menu-text"> propos</div>
            </div>
        </div>
    </div>
    
    <div class="side-menu-overlay" id="side-menu-overlay"></div>
    
    <div id="auth-screen" class="auth-screen" style="display: none;">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">Pari Alliance</h1>
            <p class="auth-subtitle">Messagerie de groupe scurise</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Crez un mot de passe scuris">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractres</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez dj un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <i class="fas fa-futbol loading-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">Pari Alliance</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <div class="header">
        <div class="header-left">
            <div id="header-menu-button" class="menu-button">
                <i class="fas fa-bars"></i>
            </div>
            <div id="header-back-button" class="back-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        <div id="header-title" class="header-title">Groupes</div>
        <div id="header-action">
            <div class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </div>
            <div class="events-button" id="events-button">
                <i class="fas fa-bell"></i>
                <div class="notification-dot" id="events-notification-dot"></div>
            </div>
        </div>
        
        <div class="search-container" id="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            <div class="search-close" id="search-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <!-- Message actions header bar -->
        <div class="message-actions-container" id="message-actions-container">
            <div class="message-actions-title">1 message slectionn</div>
            <div class="message-action-buttons">
                <div class="message-action-btn reply" id="action-reply-btn">
                    <i class="fas fa-reply"></i>
                </div>
                <div class="message-action-btn copy" id="action-copy-btn">
                    <i class="fas fa-copy"></i>
                </div>
                <div class="message-action-btn delete" id="action-delete-btn">
                    <i class="fas fa-trash"></i>
                </div>
                <div class="message-action-btn cancel" id="action-cancel-btn">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="groups-section" class="section active">
            <div class="chat-list" id="groups-list">
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <div class="empty-state-title">Aucun groupe</div>
                    <div class="empty-state-text">Vos groupes apparatront ici</div>
                </div>
            </div>
            
            <div class="fab" id="create-group-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div id="events-section" class="section">
            <div id="events-list">
                <div class="empty-state">
                    <i class="fas fa-bell"></i>
                    <div class="empty-state-title">Aucun vnement</div>
                    <div class="empty-state-text">Les vnements apparatront ici</div>
                </div>
            </div>
            
            <div class="fab" id="close-events-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="fab" id="create-notification-btn" style="display: none; bottom: 150px;">
                <i class="fas fa-bullhorn"></i>
            </div>
        </div>
        
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                    <div class="profile-pic-edit" id="edit-profile-pic">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                    <div class="profile-edit" id="edit-profile-btn">
                        <i class="fas fa-edit"></i> Modifier le profil
                    </div>
                </div>
            </div>
            
            <div class="section-title">Paramtres</div>
            
            <div class="settings-container">
                <div class="setting-item" id="theme-setting">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-palette" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Personnaliser l'interface</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: var(--inactive-text);"></i>
                </div>
            
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="section-title">Nous rejoindre</div>
                
                <div class="social-buttons">
                    <div class="social-button whatsapp" id="whatsapp-btn">
                        WhatsApp
                    </div>
                    <div class="social-button telegram" id="telegram-btn">
                        Telegram
                    </div>
                    <div class="social-button youtube" id="youtube-btn">
                        YouTube
                    </div>
                </div>
                
                <button id="logout-btn" class="button">Se dconnecter</button>
                <button id="delete-account-btn" class="button danger" style="margin-top: 15px;">Supprimer mon compte</button>
            </div>
        </div>
        
        <div id="forecasts-section" class="section">
            <div class="forecasts-tabs">
                <div class="forecast-tab active" data-tab="safes">Safes du jour</div>
                <div class="forecast-tab" data-tab="exact">Scores exacts</div>
                <div class="forecast-tab" data-tab="ai">Prdictions IA</div>
            </div>
            
            <div class="forecasts-content active" id="safes-content">
                <div class="forecasts-list" id="safes-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="exact-content">
                <div class="forecasts-list" id="exact-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="ai-content">
                <div class="forecasts-list" id="ai-list">
                </div>
            </div>
        </div>
    </div>

    <div id="chat-interface" class="chat-section">
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="image-button" id="image-button">
                <i class="fas fa-image"></i>
            </div>
            <div class="chat-input-wrapper" id="chat-input-wrapper">
                <!-- Reply preview dynamically added here -->
                <div class="reply-preview" id="reply-preview">
                    <div class="reply-preview-close" id="reply-close">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="reply-preview-header">Rponse  <span id="reply-name">Utilisateur</span></div>
                    <div class="reply-preview-content" id="reply-content">Message original</div>
                </div>
                <textarea id="chat-input" class="chat-input" placeholder="crire un message..." autocomplete="off" rows="1"></textarea>
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <input type="file" id="chat-image-input" accept="image/*">
    </div>
    
    <div id="create-group-dialog" class="create-group-dialog">
        <div class="create-group-header">
            <div class="create-group-back" id="create-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="create-group-title">Nouveau groupe</div>
        </div>
        <div class="create-group-content">
            <div class="group-form">
                <div class="group-image-preview" id="new-group-image-preview">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="new-group-image-input" accept="image/*">
                
                <div class="form-group">
                    <label class="form-label">Nom du groupe</label>
                    <input type="text" class="form-input" id="group-name" placeholder="Entrez le nom du groupe">
                    <div id="group-name-error" class="form-error">Le nom du groupe est requis</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnelle)</label>
                    <input type="text" class="form-input" id="group-description" placeholder="Dcrivez le groupe">
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions de message</label>
                    <div style="display: flex; align-items: center; margin-top: 8px;">
                        <label class="switch">
                            <input type="checkbox" id="group-public-messages" checked>
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px; font-size: 14px;">Permettre  tous les membres d'crire</span>
                    </div>
                    <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                        Si dsactiv, seuls les administrateurs pourront crire des messages
                    </div>
                </div>
                <button class="button" id="create-group-submit">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Crer le groupe</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="edit-group-dialog" class="edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="edit-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le groupe</div>
        </div>
        <div class="edit-content">
            <div class="group-image-preview" id="edit-group-image-preview">
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="edit-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="edit-group-image-input" accept="image/*">
            
            <div class="form-group">
                <label class="form-label">Nom du groupe</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-name" placeholder="Entrez le nom du groupe">
                    <button class="save-field-btn" id="save-group-name-btn">Enregistrer</button>
                </div>
                <div id="edit-group-name-error" class="field-error">Le nom du groupe est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-description" placeholder="Dcrivez le groupe">
                    <button class="save-field-btn" id="save-group-description-btn">Enregistrer</button>
                </div>
                <div id="edit-group-description-error" class="field-error"></div>
            </div>
            
            <div class="form-group" id="edit-group-permissions-container">
                <label class="form-label">Permissions de message</label>
                <div style="display: flex; align-items: center; margin-top: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="edit-group-public-messages">
                        <span class="slider"></span>
                    </label>
                    <span style="margin-left: 10px; font-size: 14px;">Permettre  tous les membres d'crire</span>
                    <button class="save-field-btn" id="save-group-permissions-btn" style="margin-left: auto;">Enregistrer</button>
                </div>
                <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                    Si dsactiv, seuls les administrateurs pourront crire des messages
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Image du groupe</label>
                <button class="button" id="save-group-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer l'image</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Group Info Dialog -->
    <div id="group-info-dialog" class="group-info-dialog">
        <div class="group-info-header">
            <div class="group-info-back" id="group-info-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="group-info-title">Informations du groupe</div>
        </div>
        <div class="group-info-content">
            <div class="group-info-section">
                <div class="group-image-preview" id="info-group-image-preview" style="width: 120px; height: 120px; margin-bottom: 20px;">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Nom</div>
                    <div class="group-info-value" id="info-group-name">Nom du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Description</div>
                    <div class="group-info-value" id="info-group-description">Description du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Type</div>
                    <div class="group-info-value" id="info-group-type">Public</div>
                </div>
            </div>
            
            <div class="group-info-section">
                <div class="group-info-section-title">Images partages</div>
                <div class="group-info-images" id="info-group-images">
                    <div class="group-info-image-empty">Aucune image partage</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-notif-dialog" class="admin-notif-dialog">
        <div class="edit-header">
            <div class="edit-back" id="admin-notif-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Nouvelle notification</div>
        </div>
        <div class="edit-content">
            <div class="form-group">
                <label class="form-label">Titre de la notification</label>
                <input type="text" class="form-input" id="notif-title" placeholder="Titre de votre notification">
                <div id="notif-title-error" class="field-error">Le titre est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contenu</label>
                <textarea class="form-input" id="notif-content" placeholder="Contenu de votre notification" rows="5" style="resize: none;"></textarea>
                <div id="notif-content-error" class="field-error">Le contenu est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type de notification</label>
                <select class="form-input" id="notif-type">
                    <option value="info">Information</option>
                    <option value="alert">Alerte</option>
                    <option value="update">Mise  jour</option>
                </select>
            </div>
            
            <button class="button" id="send-notification-btn">
                <span class="btn-loader" style="display:none;"></span>
                <span class="btn-text">Envoyer la notification</span>
            </button>
        </div>
    </div>
    
    <div id="profile-edit-dialog" class="profile-edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="profile-edit-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le profil</div>
        </div>
        <div class="edit-content">
            <div class="profile-image-upload">
                <div class="profile-image-preview" id="profile-image-preview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-upload-btn" id="profile-upload-btn">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="profile-image-input" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom d'utilisateur</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-display-name" placeholder="Entrez votre nom d'utilisateur">
                    <button class="save-field-btn" id="save-display-name-btn">Enregistrer</button>
                </div>
                <div id="edit-display-name-error" class="field-error">Le nom d'utilisateur est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Photo de profil</label>
                <button class="button" id="save-profile-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer la photo</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Interface Settings Dialog -->
    <div id="interface-dialog" class="interface-dialog">
        <div class="interface-header">
            <div class="interface-back" id="interface-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="interface-title">Personnaliser l'interface</div>
        </div>
        <div class="interface-content">
            <div class="form-group">
                <label class="form-label">Thme de couleurs</label>
                <div class="theme-options">
                    <div class="theme-option theme-blue active" data-theme="default">
                        <div class="theme-preview">
                            <div class="theme-preview-received"></div>
                            <div class="theme-preview-sent"></div>
                        </div>
                        <div class="theme-name">Bleu</div>
                    </div>
                    <div class="theme-option theme-green" data-theme="green">
                        <div class="theme-preview">
                            <div class="theme-preview-received"></div>
                            <div class="theme-preview-sent"></div>
                        </div>
                        <div class="theme-name">Vert</div>
                    </div>
                    <div class="theme-option theme-red" data-theme="red">
                        <div class="theme-preview">
                            <div class="theme-preview-received"></div>
                            <div class="theme-preview-sent"></div>
                        </div>
                        <div class="theme-name">Rouge</div>
                    </div>
                    <div class="theme-option theme-orange" data-theme="orange">
                        <div class="theme-preview">
                            <div class="theme-preview-received"></div>
                            <div class="theme-preview-sent"></div>
                        </div>
                        <div class="theme-name">Orange</div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mode d'affichage</label>
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="interface-dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Rduire la consommation de donnes</label>
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-tachometer-alt" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Compression d'images</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="image-compression-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="font-size: 12px; color: var(--inactive-text); margin: 5px 0 0 60px;">
                    Rduit la taille des images envoyes pour conomiser de la bande passante
                </div>
            </div>
            
            <button class="button" id="save-interface-settings">
                <span class="btn-loader" style="display:none;"></span>
                <span class="btn-text">Appliquer les changements</span>
            </button>
        </div>
    </div>
    
    <div id="about-dialog" class="about-dialog">
        <div class="edit-header">
            <div class="edit-back" id="about-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title"> propos</div>
        </div>
        <div class="about-content">
            <div class="about-logo">
                <i class="fas fa-futbol"></i>
                <div class="about-title">Pari Alliance</div>
                <div class="about-version">Version 1.2.0</div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Description</div>
                <div class="about-section-content">
                    Pari Alliance est une application de messagerie scurise qui permet aux utilisateurs de crer et de participer  des discussions de groupe.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Fonctionnalits</div>
                <div class="about-section-content">
                     Messagerie de groupe en temps rel<br>
                     Partage de pronostics sportifs<br>
                     Thmes et mode sombre personnalisables<br>
                     Gestion simple des groupes<br>
                     Envoi de notifications pour les administrateurs<br>
                     Compression d'images automatique
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title"> propos de l'application</div>
                <div class="about-section-content">
                    Le logo de l'application est le ballon de football visible sur la page de chargement. L'application a t cre par Pronosoft AI.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Confidentialit</div>
                <div class="about-section-content">
                    Pari Alliance respecte votre vie prive. Vos donnes personnelles ne sont utilises que pour le fonctionnement de l'application et ne sont jamais partages avec des tiers.
                </div>
            </div>
            
            <div class="about-footer">
                 2023-2024 Pari Alliance. Tous droits rservs.
            </div>
        </div>
    </div>
    
    <div id="terms-dialog" class="terms-dialog">
        <div class="terms-header">
            <div class="terms-back" id="terms-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="terms-title">Conditions d'utilisation</div>
        </div>
        <div class="terms-content">
            <div class="about-section">
                <div class="about-section-title">Conditions gnrales</div>
                <div class="about-section-content">
                    En utilisant l'application Pari Alliance, vous acceptez de respecter les prsentes conditions d'utilisation. L'accs et l'utilisation de cette application sont soumis  votre acceptation et au respect des prsentes conditions.
                </div>
            </div>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i> <strong>AVERTISSEMENT :</strong> Les pronostics sont fournis  titre informatif uniquement. La vente ou revente de ces pronostics est strictement interdite et passible de bannissement  vie et de poursuites judiciaires.
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation des pronostics</div>
                <div class="about-section-content">
                    Les pronostics sportifs fournis dans cette application sont destins uniquement  des fins d'information et de divertissement. Ils peuvent tre utiliss pour effectuer des paris rels, mais il est recommand de le faire avec responsabilit.<br><br>
                    
                    Nous ne sommes pas responsables de leurs pertes ventuelles. Les pronostics ne constituent en aucun cas une incitation au jeu ou un conseil d'investissement.<br><br>
                    
                    Il est strictement interdit de:<br>
                     Revendre ou commercialiser ces pronostics<br>
                     Partager ces informations en dehors de la plateforme<br>
                     Utiliser ces informations  des fins commerciales<br><br>
                    
                    Tout utilisateur enfreignant ces rgles s'expose  une suspension immdiate de son compte et  d'ventuelles poursuites judiciaires.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation de l'application</div>
                <div class="about-section-content">
                    Vous vous engagez  utiliser l'application de manire lgale et responsable. Il est interdit de:<br>
                     Publier du contenu illgal, diffamatoire, harcelant ou menaant<br>
                     Usurper l'identit d'une autre personne<br>
                     Tenter d'accder sans autorisation  des parties de l'application qui vous sont interdites<br>
                     Perturber le fonctionnement normal de l'application<br>
                     Publier des messages  caractre commercial non sollicits
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Responsabilit</div>
                <div class="about-section-content">
                    Pari Alliance n'est pas responsable des pertes financires ou autres dommages qui pourraient rsulter de l'utilisation des pronostics ou des informations disponibles sur l'application. Les utilisateurs sont seuls responsables de leurs dcisions et de leurs actions.
                </div>
            </div>
        </div>
    </div>
    
    <div id="delete-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer ce message ?</div>
        <div class="confirmation-text">Cette action est irrversible et le message sera dfinitivement supprim.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-event-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer cet vnement ?</div>
        <div class="confirmation-text">Cette action est irrversible et l'vnement sera supprim.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-event-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-event-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-account-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer votre compte ?</div>
        <div class="confirmation-text">ATTENTION : Cette action est dfinitive et irrversible. Toutes vos donnes seront supprimes.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <div id="logout-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Se dconnecter ?</div>
        <div class="confirmation-text">Voulez-vous vraiment vous dconnecter de Pari Alliance ?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="logout-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="logout-confirm">Dconnecter</div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div class="notification" id="notification"></div>
    
    <div id="image-viewer" class="image-viewer">
        <div class="viewer-image-container">
            <img src="" alt="Image" class="viewer-image" id="viewer-image" oncontextmenu="return false">
        </div>
        <div class="viewer-close" id="viewer-close">
            <i class="fas fa-times"></i>
        </div>
        <div class="download-button" id="download-image-btn">
            <i class="fas fa-download"></i>
        </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-section="groups" style="flex: 1;">
            <i class="nav-icon fas fa-users"></i>
            <span>Groupes</span>
        </div>
        <div class="nav-item" data-section="forecasts" style="flex: 1;">
            <i class="nav-icon fas fa-futbol"></i>
            <span>Pronostics</span>
            <div class="notification-dot" id="forecasts-notification-dot" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let currentGroup = '';
        let currentGroupId = null;
        let currentGroupData = null;
        let currentSection = 'groups';
        let isOnline = navigator.onLine;
        let messageQueue = [];
        let chatUnsubscribers = {};
        let longPressTimer = null;
        let longPressDuration = 500;
        let currentMessageForAction = null;
        let eventsUnsubscribe = null;
        let forecastsUnsubscribe = null;
        let groupImageFile = null;
        let profileImageFile = null;
        let editingGroupId = null;
        let profileUpdating = false;
        let isLoadingGroups = false;
        let isLoadingEvents = false;
        let profileNameChanged = false;
        let groupNameChanged = false;
        let groupDescriptionChanged = false;
        let groupPermissionsChanged = false;
        let currentEventForDeletion = null;
        let currentForecastTab = 'safes';
        let lastViewedEventTimestamp = null;
        let hasNewEvents = false;
        let chatImageFile = null;
        let isSearchActive = false;
        let currentSearchContext = '';
        let replyingToMessage = null;
        let autoResizeTextarea = null;
        let isMessageActionsVisible = false;
        let groupImageCache = {}; // Cache for images in group
        let currentDownloadImage = ''; // Current image URL for download
        let messagesCache = {}; // Cache for messages
        let currentPage = 1; // For message pagination
        let messagesPerPage = 50; // Number of messages to load per page
        let totalMessages = 0; // Total message count
        let lastProcessedMessageId = null; // Tracking for deduplication
        let forecastsCache = {}; // Cache for forecasts
        let isCompressionEnabled = true; // Image compression flag
        
        // Theme management
        const availableThemes = ['default', 'green', 'red', 'orange'];
        let currentTheme = 'default';
        
        function loadUserPreferences() {
            // Load theme preference
            const savedTheme = localStorage.getItem('parisAllianceTheme');
            if (savedTheme && availableThemes.includes(savedTheme)) {
                applyTheme(savedTheme);
            }
            
            // Load dark mode preference
            const savedDarkMode = localStorage.getItem('parisAllianceDarkMode');
            if (savedDarkMode === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-toggle').checked = true;
                if (document.getElementById('interface-dark-toggle')) {
                    document.getElementById('interface-dark-toggle').checked = true;
                }
            } else if (savedDarkMode === 'false') {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-toggle').checked = false;
                if (document.getElementById('interface-dark-toggle')) {
                    document.getElementById('interface-dark-toggle').checked = false;
                }
            }
            
            // Load compression preference
            const compressionSetting = localStorage.getItem('parisAllianceCompression');
            if (compressionSetting === 'false') {
                isCompressionEnabled = false;
                if (document.getElementById('image-compression-toggle')) {
                    document.getElementById('image-compression-toggle').checked = false;
                }
            }
        }
        
        function applyTheme(theme) {
            // First, remove any existing theme classes
            document.documentElement.classList.remove(...availableThemes.map(t => `theme-${t}`));
            
            // Apply the new theme if it's not the default
            if (theme !== 'default') {
                document.documentElement.classList.add(`theme-${theme}`);
            }
            
            currentTheme = theme;
            localStorage.setItem('parisAllianceTheme', theme);
            
            // Update the active state in the theme options if the dialog is open
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-theme') === theme) {
                    option.classList.add('active');
                }
            });
        }
        
        function setupDarkMode() {
            // Check system preference only if no user preference exists
            if (!localStorage.getItem('parisAllianceDarkMode')) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('dark-toggle').checked = true;
                    if (document.getElementById('interface-dark-toggle')) {
                        document.getElementById('interface-dark-toggle').checked = true;
                    }
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('dark-toggle').checked = false;
                    if (document.getElementById('interface-dark-toggle')) {
                        document.getElementById('interface-dark-toggle').checked = false;
                    }
                }
            }
            
            // Listen for system changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                // Only apply system changes if user hasn't set a preference
                if (!localStorage.getItem('parisAllianceDarkMode')) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('dark-toggle').checked = true;
                        if (document.getElementById('interface-dark-toggle')) {
                            document.getElementById('interface-dark-toggle').checked = true;
                        }
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('dark-toggle').checked = false;
                        if (document.getElementById('interface-dark-toggle')) {
                            document.getElementById('interface-dark-toggle').checked = false;
                        }
                    }
                }
            });
        }
        
        function setupConnectionMonitoring() {
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    isOnline = true;
                    processQueuedMessages();
                } else {
                    isOnline = false;
                    showNotification("Pas de connexion internet. Les messages seront envoys lorsque vous serez connect.", "error");
                }
            }
            
            window.addEventListener('online', () => {
                showNotification("Connexion rtablie", "success");
                isOnline = true;
                
                setTimeout(() => {
                    if (isLoggedIn && currentSection === 'groups') {
                        loadGroups();
                    }
                    processQueuedMessages();
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
            });
            
            updateConnectionStatus();
        }
        
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            const processedMessages = [...messageQueue];
            messageQueue = [];
            
            for (const message of processedMessages) {
                try {
                    await sendMessageToFirestore(
                        message.groupId, 
                        message.text,
                        message.imageData,
                        message.replyTo
                    );
                } catch (error) {
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu tre envoys`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont t envoys', 'success');
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            // Ensure any previous notification is fully hidden
            notification.classList.remove('show');
            
            // Wait a short delay to avoid animation conflicts
            setTimeout(() => {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                
                // Remove the class after a delay
                setTimeout(() => {
                    notification.classList.remove('show');
                    
                    // Clean up the element after animation ends
                    setTimeout(() => {
                        notification.className = 'notification';
                        notification.textContent = '';
                    }, 300);
                }, 3000);
            }, 100);
        }
        
        // Function to auto-resize textarea
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('chat-input');
            if (!textarea) return;
            
            // Function to adjust height
            const adjustHeight = () => {
                // Reset height to get content height
                textarea.style.height = 'auto';
                
                // Calculate new height (with max limit)
                const newHeight = Math.min(textarea.scrollHeight, 100);
                textarea.style.height = `${newHeight}px`;
                
                // Adjust container height if needed
                const container = document.getElementById('chat-input-container');
                if (container) {
                    if (replyingToMessage) {
                        container.style.minHeight = `${60 + newHeight}px`;
                    } else {
                        container.style.minHeight = `${newHeight + 20}px`;
                    }
                }
            };
            
            // Initialize height
            adjustHeight();
            
            // Add events to adjust height when content changes
            textarea.addEventListener('input', adjustHeight);
            
            // Store the function for reuse
            autoResizeTextarea = adjustHeight;
        }
        
        function setupUIEvents() {
            document.getElementById('header-menu-button').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('active');
                document.getElementById('side-menu-overlay').classList.add('active');
            });
            
            document.getElementById('side-menu-close').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('side-menu-overlay').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('menu-profile').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showProfileSection();
            });
            
            document.getElementById('menu-interface').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showInterfaceDialog();
            });
            
            document.getElementById('menu-terms').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showTermsDialog();
            });
            
            document.getElementById('terms-back').addEventListener('click', hideTermsDialog);
            
            document.getElementById('menu-about').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showAboutDialog();
            });
            
            document.getElementById('about-back').addEventListener('click', hideAboutDialog);
            
            // Search button handler
            document.getElementById('search-button').addEventListener('click', function() {
                toggleSearchBar();
            });
            
            document.getElementById('search-close').addEventListener('click', function() {
                hideSearchBar();
            });
            
            // Search input handler
            document.getElementById('search-input').addEventListener('input', function() {
                handleSearch(this.value);
            });
            
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                // Mark events as viewed
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            document.getElementById('close-events-btn').addEventListener('click', function() {
                if (currentSection === 'events') {
                    showGroupsSection();
                }
            });
            
            // Group info dialog handler
            document.getElementById('group-info-back').addEventListener('click', hideGroupInfoDialog);
            
            document.getElementById('bottom-nav').addEventListener('click', function(e) {
                const navItems = this.querySelectorAll('.nav-item');
                
                for (let i = 0; i < navItems.length; i++) {
                    const item = navItems[i];
                    const rect = item.getBoundingClientRect();
                    
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const section = item.getAttribute('data-section');
                        if (section === 'groups') {
                            showGroupsSection();
                        } else if (section === 'forecasts') {
                            showForecastsSection();
                        }
                        
                        break;
                    }
                }
            });
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchForecastTab(tabId);
                });
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                localStorage.setItem('parisAllianceDarkMode', this.checked ? 'true' : 'false');
                
                // Sync interface dialog toggle if open
                if (document.getElementById('interface-dark-toggle')) {
                    document.getElementById('interface-dark-toggle').checked = this.checked;
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', showLogoutConfirmation);
            document.getElementById('logout-cancel').addEventListener('click', hideLogoutConfirmation);
            document.getElementById('logout-confirm').addEventListener('click', logoutUser);
            
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            
            document.getElementById('delete-account-cancel').addEventListener('click', hideDeleteAccountConfirmation);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            document.getElementById('edit-profile-btn').addEventListener('click', showProfileEditDialog);
            document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            
            document.getElementById('profile-edit-back').addEventListener('click', hideProfileEditDialog);
            document.getElementById('profile-upload-btn').addEventListener('click', function() {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('profile-image-input').addEventListener('change', handleProfileImageSelect);
            
            document.getElementById('save-display-name-btn').addEventListener('click', updateDisplayName);
            document.getElementById('save-profile-image-btn').addEventListener('click', updateProfileImage);
            
            document.getElementById('edit-display-name').addEventListener('input', function() {
                profileNameChanged = true;
                document.getElementById('save-display-name-btn').disabled = this.value.trim() === '';
            });
            
            // Chat input setup
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Reply close handler
            document.getElementById('reply-close').addEventListener('click', function() {
                cancelReply();
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            
            // Image handlers
            document.getElementById('image-button').addEventListener('click', function() {
                document.getElementById('chat-image-input').click();
            });
            
            document.getElementById('chat-image-input').addEventListener('change', handleChatImageSelect);
            
            // Image viewer handlers
            document.getElementById('viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('download-image-btn').addEventListener('click', downloadCurrentImage);
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('create-group-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showCreateGroupDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent crer des groupes", "error");
                }
            });
            
            document.getElementById('create-group-back').addEventListener('click', hideCreateGroupDialog);
            document.getElementById('create-group-submit').addEventListener('click', createNewGroup);
            
            document.getElementById('create-notification-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showAdminNotificationDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                }
            });
            
            document.getElementById('admin-notif-back').addEventListener('click', hideAdminNotificationDialog);
            document.getElementById('send-notification-btn').addEventListener('click', sendAdminNotification);
            
            document.getElementById('new-group-image-upload').addEventListener('click', function() {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('new-group-image-input').addEventListener('change', handleNewGroupImageSelect);
            
            document.getElementById('edit-group-back').addEventListener('click', hideEditGroupDialog);
            
            document.getElementById('edit-group-image-upload').addEventListener('click', function() {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-image-input').addEventListener('change', handleEditGroupImageSelect);
            
            document.getElementById('save-group-name-btn').addEventListener('click', updateGroupName);
            document.getElementById('save-group-description-btn').addEventListener('click', updateGroupDescription);
            document.getElementById('save-group-permissions-btn').addEventListener('click', updateGroupPermissions);
            document.getElementById('save-group-image-btn').addEventListener('click', updateGroupImage);
            
            document.getElementById('edit-group-name').addEventListener('input', function() {
                groupNameChanged = true;
                document.getElementById('save-group-name-btn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('edit-group-description').addEventListener('input', function() {
                groupDescriptionChanged = true;
                document.getElementById('save-group-description-btn').disabled = false;
            });
            
            document.getElementById('edit-group-public-messages').addEventListener('change', function() {
                groupPermissionsChanged = true;
                document.getElementById('save-group-permissions-btn').disabled = false;
            });
            
            document.getElementById('delete-cancel').addEventListener('click', hideDeleteConfirmation);
            document.getElementById('delete-confirm').addEventListener('click', confirmDeleteMessage);
            
            document.getElementById('delete-event-cancel').addEventListener('click', hideDeleteEventConfirmation);
            document.getElementById('delete-event-confirm').addEventListener('click', confirmDeleteEvent);
            
            // Message action buttons
            document.getElementById('action-reply-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    replyToMessage();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-copy-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    copyMessageText();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-delete-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    showDeleteConfirmation();
                }
            });
            
            document.getElementById('action-cancel-btn').addEventListener('click', function() {
                hideMessageActionsBar();
            });
            
            // Theme options in interface dialog
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    applyTheme(theme);
                    
                    // Update UI
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
            
            // Interface dialog handlers
            document.getElementById('interface-back').addEventListener('click', hideInterfaceDialog);
            document.getElementById('interface-dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                localStorage.setItem('parisAllianceDarkMode', this.checked ? 'true' : 'false');
                document.getElementById('dark-toggle').checked = this.checked;
            });
            
            // Image compression toggle
            document.getElementById('image-compression-toggle').addEventListener('change', function() {
                isCompressionEnabled = this.checked;
                localStorage.setItem('parisAllianceCompression', isCompressionEnabled ? 'true' : 'false');
            });
            
            document.getElementById('save-interface-settings').addEventListener('click', function() {
                hideInterfaceDialog();
                showNotification('Paramtres d\'interface appliqus', 'success');
            });
            
            // Theme button in profile section
            document.getElementById('theme-setting').addEventListener('click', showInterfaceDialog);
            
            // Disable browser context menu on images
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('touchstart', handleGlobalTouchStart, { passive: true });
            document.addEventListener('touchend', handleGlobalTouchEnd, { passive: true });
            document.addEventListener('touchmove', handleGlobalTouchMove, { passive: true });
            document.addEventListener('touchcancel', handleGlobalTouchCancel, { passive: true });
            
            // Social network button handlers
            document.getElementById('whatsapp-btn').addEventListener('click', function() {
                openSocialLink('whatsapp');
            });
            
            document.getElementById('telegram-btn').addEventListener('click', function() {
                openSocialLink('telegram');
            });
            
            document.getElementById('youtube-btn').addEventListener('click', function() {
                openSocialLink('youtube');
            });
            
            // Add ripple effect for touchable buttons
            const touchableElements = document.querySelectorAll('.menu-button, .back-button, .search-button, .events-button, .info-button, .search-close');
            touchableElements.forEach(element => {
                element.addEventListener('touchstart', createRippleEffect);
            });
            
            // Handle Android back button
            window.addEventListener('popstate', handleBackButton);
            
            // Add initial state to history
            history.pushState({ page: 'main' }, '');
        }
        
        // Android back button handler
        function handleBackButton(event) {
            // Prevent default behavior
            event.preventDefault();
            
            // If message actions bar is visible, close it first
            if (isMessageActionsVisible) {
                hideMessageActionsBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If a confirmation dialog is open, close it
            if (document.querySelector('.confirmation-dialog.active')) {
                document.querySelectorAll('.confirmation-dialog.active').forEach(dialog => {
                    // Find the cancel button and simulate click
                    const cancelBtn = dialog.querySelector('.confirmation-cancel');
                    if (cancelBtn) cancelBtn.click();
                });
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If search is active, close it
            if (isSearchActive) {
                hideSearchBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If side menu is open, close it
            if (document.getElementById('side-menu').classList.contains('active')) {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If in chat interface, close it
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If in a section other than main, return to main section
            if (currentSection !== 'groups') {
                showGroupsSection();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If a dialog is open, close it
            const dialogs = [
                { id: 'about-dialog', backBtn: 'about-back' },
                { id: 'terms-dialog', backBtn: 'terms-back' },
                { id: 'profile-edit-dialog', backBtn: 'profile-edit-back' },
                { id: 'edit-group-dialog', backBtn: 'edit-group-back' },
                { id: 'create-group-dialog', backBtn: 'create-group-back' },
                { id: 'admin-notif-dialog', backBtn: 'admin-notif-back' },
                { id: 'group-info-dialog', backBtn: 'group-info-back' },
                { id: 'interface-dialog', backBtn: 'interface-back' }
            ];
            
            for (const dialog of dialogs) {
                if (document.getElementById(dialog.id).classList.contains('active')) {
                    document.getElementById(dialog.backBtn).click();
                    history.pushState({ page: 'main' }, '');
                    return;
                }
            }
            
            // If image viewer is open, close it
            if (document.getElementById('image-viewer').classList.contains('active')) {
                closeImageViewer();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            // If already in main section, prevent leaving app
            if (currentSection === 'groups') {
                history.pushState({ page: 'main' }, '');
            }
        }
        
        function cancelReply() {
            replyingToMessage = null;
            const replyPreview = document.getElementById('reply-preview');
            replyPreview.classList.remove('active');
            
            const chatInputContainer = document.getElementById('chat-input-container');
            chatInputContainer.classList.remove('with-reply');
            
            // Readjust textarea height
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
        }
        
        // Show message actions bar function
        function showMessageActionsBar(messageElement) {
            if (!messageElement) return;
            
            const messageId = messageElement.getAttribute('data-id');
            const messageFrom = messageElement.getAttribute('data-from');
            
            // Store message info for actions
            currentMessageForAction = {
                element: messageElement,
                id: messageId,
                from: messageFrom,
                text: messageElement.textContent.trim()
            };
            
            // Adjust display of options based on message sender
            const deleteBtn = document.getElementById('action-delete-btn');
            if (messageFrom !== currentUser.uid && !isAdmin) {
                deleteBtn.style.display = 'none';
            } else {
                deleteBtn.style.display = 'flex';
            }
            
            // Apply selected class to message
            messageElement.classList.add('selected');
            
            // Show actions bar
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.add('active');
            
            // Hide normal header elements
            document.querySelector('.header-left').style.opacity = '0';
            document.querySelector('.header-title').style.opacity = '0';
            document.getElementById('header-action').style.opacity = '0';
            
            isMessageActionsVisible = true;
            
            // Add state to history for back button handling
            history.pushState({ page: 'message-actions' }, '');
        }
        
        // Hide message actions bar function
        function hideMessageActionsBar() {
            // Hide actions bar
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.remove('active');
            
            // Show normal header elements
            document.querySelector('.header-left').style.opacity = '1';
            document.querySelector('.header-title').style.opacity = '1';
            document.getElementById('header-action').style.opacity = '1';
            
            // Deselect message
            if (currentMessageForAction && currentMessageForAction.element) {
                currentMessageForAction.element.classList.remove('selected');
            }
            
            currentMessageForAction = null;
            isMessageActionsVisible = false;
        }
        
        // Ripple effect for buttons
        function createRippleEffect(e) {
            const button = e.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.touches[0].pageX - button.offsetLeft - diameter / 2}px`;
            circle.style.top = `${e.touches[0].pageY - button.offsetTop - diameter / 2}px`;
            circle.classList.add('ripple');
            
            const ripple = button.querySelector('.ripple');
            if (ripple) {
                ripple.remove();
            }
            
            button.appendChild(circle);
            
            setTimeout(() => {
                circle.remove();
            }, 600);
        }
        
        // Search bar functions
        function toggleSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            if (isSearchActive) {
                hideSearchBar();
            } else {
                header.classList.add('search-active');
                searchContainer.classList.add('active');
                searchInput.focus();
                isSearchActive = true;
                
                // Add state to history for back button handling
                history.pushState({ page: 'search' }, '');
                
                // Determine search context based on active section
                currentSearchContext = currentSection;
                
                // Adapt placeholder based on context
                if (currentSearchContext === 'groups') {
                    searchInput.placeholder = 'Rechercher un groupe...';
                } else if (currentSearchContext === 'events') {
                    searchInput.placeholder = 'Rechercher un vnement...';
                } else if (currentSearchContext === 'forecasts') {
                    searchInput.placeholder = 'Rechercher un pronostic...';
                }
            }
        }
        
        function hideSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            searchContainer.classList.remove('active');
            searchContainer.classList.add('hiding');
            
            setTimeout(() => {
                header.classList.remove('search-active');
                searchInput.value = '';
                searchContainer.classList.remove('hiding');
                isSearchActive = false;
                
                // Reset filters
                handleSearch('');
            }, 300);
        }
        
        // Handle search based on context
        function handleSearch(query) {
            if (currentSearchContext === 'groups') {
                filterGroups(query);
            } else if (currentSearchContext === 'events') {
                filterEvents(query);
            }
            // Add other search contexts as needed
        }
        
        // Function to open social links safely
        function openSocialLink(platform) {
            let url = '';
            
            switch(platform) {
                case 'whatsapp':
                    url = 'https://wa.me/';
                    showNotification('Ouverture de WhatsApp', 'info');
                    break;
                case 'telegram':
                    url = 'https://t.me/';
                    showNotification('Ouverture de Telegram', 'info');
                    break;
                case 'youtube':
                    url = 'https://www.youtube.com/';
                    showNotification('Ouverture de YouTube', 'info');
                    break;
                default:
                    return;
            }
            
            // Open in new window/tab with security parameters
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function showTermsDialog() {
            document.getElementById('terms-dialog').classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'terms' }, '');
        }
        
        function hideTermsDialog() {
            document.getElementById('terms-dialog').classList.remove('active');
        }
        
        function showInterfaceDialog() {
            document.getElementById('interface-dialog').classList.add('active');
            
            // Make sure theme and dark mode toggles match current state
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-theme') === currentTheme) {
                    option.classList.add('active');
                }
            });
            
            document.getElementById('interface-dark-toggle').checked = document.documentElement.classList.contains('dark');
            document.getElementById('image-compression-toggle').checked = isCompressionEnabled;
            
            // Add state to history for back button handling
            history.pushState({ page: 'interface' }, '');
        }
        
        function hideInterfaceDialog() {
            document.getElementById('interface-dialog').classList.remove('active');
        }
        
        function showAboutDialog() {
            document.getElementById('about-dialog').classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'about' }, '');
        }
        
        function hideAboutDialog() {
            document.getElementById('about-dialog').classList.remove('active');
        }
        
        // Show Group Info Dialog
        function showGroupInfoDialog() {
            if (!currentGroupData) return;
            
            const dialog = document.getElementById('group-info-dialog');
            const imagePreview = document.getElementById('info-group-image-preview');
            const nameElement = document.getElementById('info-group-name');
            const descriptionElement = document.getElementById('info-group-description');
            const typeElement = document.getElementById('info-group-type');
            const imagesContainer = document.getElementById('info-group-images');
            
            // Set group info
            nameElement.textContent = currentGroupData.name || 'Sans nom';
            descriptionElement.textContent = currentGroupData.description || 'Sans description';
            typeElement.textContent = currentGroupData.allowPublicMessages !== false ? 
                'Public (Tous peuvent crire)' : 'Restreint (criture limite aux administrateurs)';
            
            // Set group image
            if (currentGroupData.imageURL) {
                imagePreview.innerHTML = `<img src="${currentGroupData.imageURL}" alt="${currentGroupData.name}">`;
            } else {
                imagePreview.innerHTML = `<i class="fas fa-users" style="color: white; font-size: 40px;"></i>`;
            }
            
            // Reset images container
            imagesContainer.innerHTML = '<div class="group-info-image-empty">Chargement des images...</div>';
            
            // Load group images
            loadGroupImages();
            
            dialog.classList.add('active');
            // Add state to history for back button handling
            history.pushState({ page: 'group-info' }, '');
        }
        
        function hideGroupInfoDialog() {
            document.getElementById('group-info-dialog').classList.remove('active');
        }
        
        // Load images shared in the group
        async function loadGroupImages() {
            if (!currentGroupId) return;
            
            const imagesContainer = document.getElementById('info-group-images');
            
            try {
                // Use cache if available
                if (groupImageCache[currentGroupId] && groupImageCache[currentGroupId].length > 0) {
                    displayGroupImages(groupImageCache[currentGroupId]);
                    return;
                }
                
                // Query messages with images
                const messagesRef = collection(db, "groups", currentGroupId, "messages");
                const q = query(messagesRef, where("imageData", "!=", null), limit(12));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partage</div>';
                    return;
                }
                
                const images = [];
                querySnapshot.forEach(doc => {
                    const messageData = doc.data();
                    if (messageData.imageData) {
                        images.push({
                            url: messageData.imageData,
                            id: doc.id,
                            timestamp: messageData.createdAt
                        });
                    }
                });
                
                // Sort by timestamp (newest first)
                images.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return b.timestamp.seconds - a.timestamp.seconds;
                    }
                    return 0;
                });
                
                // Store in cache
                groupImageCache[currentGroupId] = images;
                
                // Display images
                displayGroupImages(images);
                
            } catch (error) {
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Erreur lors du chargement des images</div>';
            }
        }
        
        function displayGroupImages(images) {
            const imagesContainer = document.getElementById('info-group-images');
            
            if (!images || images.length === 0) {
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partage</div>';
                return;
            }
            
            imagesContainer.innerHTML = '';
            
            // Display up to 9 most recent images
            const imagesToShow = images.slice(0, 9);
            
            imagesToShow.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'group-info-image';
                imageElement.innerHTML = `<img src="${image.url}" alt="Image partage">`;
                
                imageElement.addEventListener('click', () => {
                    showImageViewer(image.url);
                });
                
                imagesContainer.appendChild(imageElement);
            });
        }
        
        // Functions for image viewer with download
        function showImageViewer(imageUrl) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            viewerImage.src = imageUrl;
            viewer.classList.add('active');
            
            // Store current image for download
            currentDownloadImage = imageUrl;
            
            // Add state to history for back button handling
            history.pushState({ page: 'image-viewer' }, '');
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('viewer-image').src = '';
                currentDownloadImage = '';
            }, 300);
        }
        
        // Function to download current image
        function downloadCurrentImage() {
            if (!currentDownloadImage) return;
            
            try {
                // Create a temporary anchor element
                const a = document.createElement('a');
                a.href = currentDownloadImage;
                a.download = 'image_' + new Date().getTime() + '.jpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showNotification('Tlchargement dmarr', 'success');
            } catch (error) {
                showNotification('Erreur lors du tlchargement de l\'image', 'error');
            }
        }
        
        // Image compression function for better network performance
        async function compressImage(file, quality = 0.7, maxWidth = 1200) {
            if (!isCompressionEnabled) {
                // If compression is disabled, just encode as base64
                return encodeImageToBase64(file);
            }
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        // Calculate new dimensions while preserving aspect ratio
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Get compressed image as base64
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        
                        // Check size reduction
                        const originalSize = Math.round(file.size / 1024);
                        const compressedSize = Math.round((compressedBase64.length * 3) / 4 / 1024);
                        
                        if (compressedSize < originalSize) {
                            console.log(`Compressed from ${originalSize}KB to ${compressedSize}KB (${Math.round((1 - compressedSize/originalSize) * 100)}% reduction)`);
                            resolve(compressedBase64);
                        } else {
                            // If compression didn't help, use original
                            console.log('Compression not effective, using original');
                            encodeImageToBase64(file).then(resolve).catch(reject);
                        }
                    };
                    img.onerror = function() {
                        reject(new Error('Failed to load image'));
                    };
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
            });
        }
        
        // Process chat images with optional compression
        async function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                showNotification('Veuillez slectionner une image valide', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) { // 5 MB max
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                showNotification('Prparation de l\'image...', 'info');
                
                // Use compression if enabled
                const base64Image = await compressImage(file);
                chatImageFile = base64Image;
                
                // Optional: Show preview
                const inputField = document.getElementById('chat-input');
                if (inputField) {
                    inputField.placeholder = 'Ajoutez un commentaire  l\'image (optionnel)';
                    inputField.focus();
                }
                
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--success-color)';
                }
                
                showNotification('Image prte  tre envoye', 'success');
            } catch (error) {
                console.error('Erreur lors du traitement de l\'image:', error);
                showNotification('Erreur lors du traitement de l\'image', 'error');
                chatImageFile = null;
            }
            
            // Reset input to allow selecting the same image again
            document.getElementById('chat-image-input').value = '';
        }
        
        function switchForecastTab(tabId) {
            currentForecastTab = tabId;
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.forecasts-content').forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            loadForecastsData(tabId);
        }
        
        function showGroupsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                return;
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'groups') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'groups';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('groups-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Groupes';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            // Show bottom nav
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadGroups();
        }
        
        function showForecastsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'forecasts') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'forecasts';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('forecasts-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Pronostics';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            // Show bottom nav
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadForecastsData(currentForecastTab);
        }

        // Function to check if date is today or tomorrow
        function isDateTodayOrTomorrow(date) {
            if (!date) return false;

            let forecastDate;
            if (date.toDate) {
                forecastDate = date.toDate();
            } else if (date instanceof Date) {
                forecastDate = date;
            } else {
                return false;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            // Compare only year, month, day (not time)
            return (
                (forecastDate.getFullYear() === today.getFullYear() && 
                 forecastDate.getMonth() === today.getMonth() && 
                 forecastDate.getDate() === today.getDate()) ||
                (forecastDate.getFullYear() === tomorrow.getFullYear() && 
                 forecastDate.getMonth() === tomorrow.getMonth() && 
                 forecastDate.getDate() === tomorrow.getDate())
            );
        }
        
        async function loadForecastsData(tabType) {
            // Check if we have cached data that's still valid (less than 15 minutes old)
            const now = new Date();
            if (forecastsCache[tabType] && forecastsCache[tabType].timestamp && 
                (now.getTime() - forecastsCache[tabType].timestamp.getTime() < 15 * 60 * 1000)) {
                
                displayCachedForecasts(tabType);
                return;
            }
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
                
                if (forecastsSnap.empty) {
                    await initCollections();
                }
            } catch (error) {
                console.error("Initial error:", error);
            }
            
            if (forecastsUnsubscribe) {
                forecastsUnsubscribe();
                forecastsUnsubscribe = null;
            }
            
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement) return;
            
            listElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des pronostics...</div>
                </div>
            `;
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const q = query(
                    forecastsRef, 
                    where("type", "==", tabType), 
                    orderBy("date", "desc"),
                    limit(50)
                );
                
                forecastsUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-futbol"></i>
                                <div class="empty-state-title">Aucun pronostic</div>
                                <div class="empty-state-text">Aucun pronostic disponible actuellement</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Cache the forecasts
                    const forecasts = [];
                    snapshot.forEach((doc) => {
                        forecasts.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    forecastsCache[tabType] = {
                        data: forecasts,
                        timestamp: new Date()
                    };
                    
                    displayCachedForecasts(tabType);
                });
            } catch (error) {
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les pronostics</div>
                    </div>
                `;
            }
        }
        
        function displayCachedForecasts(tabType) {
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement || !forecastsCache[tabType]) return;
            
            const forecasts = forecastsCache[tabType].data;
            
            let hasMatchesToday = false;
            listElement.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            forecasts.forEach((forecastData) => {
                // Check if forecast date is today or tomorrow
                if (isDateTodayOrTomorrow(forecastData.date)) {
                    hasMatchesToday = true;
                    const forecastElement = createForecastElement(forecastData, tabType);
                    fragment.appendChild(forecastElement);
                }
            });
            
            if (hasMatchesToday) {
                listElement.appendChild(fragment);
            } else {
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-calendar-day"></i>
                        <div class="empty-state-title">Pas de matchs aujourd'hui</div>
                        <div class="empty-state-text">Aucun pronostic disponible pour aujourd'hui ou demain</div>
                    </div>
                `;
            }
        }
        
        async function initCollections() {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
            } catch (error) {
                // Handle error silently
            }
        }
        
        function createForecastElement(forecastData, type) {
            const forecastElement = document.createElement('div');
            forecastElement.className = 'forecast-item';
            
            let statusClass = 'pending';
            let statusText = ' venir';
            
            if (forecastData.status === 'win') {
                statusClass = 'win';
                statusText = 'Gagn';
            } else if (forecastData.status === 'loss') {
                statusClass = 'loss';
                statusText = 'Perdu';
            }
            
            let formattedDate = 'Date inconnue';
            if (forecastData.date) {
                let date;
                if (forecastData.date.toDate) {
                    date = forecastData.date.toDate();
                } else {
                    date = new Date(forecastData.date);
                }
                
                formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let mainContent = '';
            
            if (type === 'safes') {
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Pronostic: ${forecastData.prediction}
                    </div>
                `;
            } else if (type === 'exact') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center;">
                            Rsultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                const scoreOptions = forecastData.scoreOptions || [forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`];
                const scoreOptionsHTML = `
                    <div class="score-options">
                        ${scoreOptions.map(score => `
                            <div class="score-option ${score === (forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`) ? 'active' : ''}">
                                ${score}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Options de score:</div>
                        ${scoreOptionsHTML}
                    </div>
                    ${resultDisplay}
                `;
            } else if (type === 'ai') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center; font-weight: bold; color: ${forecastData.status === 'win' ? 'var(--success-color)' : 'var(--danger-color)'}">
                            Rsultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Prdiction: ${forecastData.prediction}
                    </div>
                    ${resultDisplay}
                    <div style="font-size: 13px; margin-top: 10px; font-style: italic;">
                        "${forecastData.analysis}"
                    </div>
                `;
            }
            
            const confidenceBar = `
                <div class="forecast-confidence">
                    <span>Confiance:</span>
                    <div class="confidence-bar-container">
                        <div class="confidence-bar" style="width: ${forecastData.confidence}%"></div>
                    </div>
                    <span>${forecastData.confidence}%</span>
                </div>
            `;
            
            const footer = `
                <div class="forecast-date">${formattedDate}</div>
            `;
            
            forecastElement.innerHTML = mainContent + confidenceBar + footer;
            return forecastElement;
        }
        
        function showEventsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'events';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('events-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'vnements';
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            // Reattach search event handler
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            
            const createNotifBtn = document.getElementById('create-notification-btn');
            if (createNotifBtn) {
                if (isAdmin) {
                    createNotifBtn.style.display = 'flex';
                } else {
                    createNotifBtn.style.display = 'none';
                }
            }
            
            // Hide bottom nav
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            listenToEvents();
            
            // Add state to history for back button handling
            history.pushState({ page: 'events' }, '');
        }
        
        function showProfileSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'profile';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('profile-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Profil';
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-action').innerHTML = '';
            
            document.getElementById('header-back-button').addEventListener('click', function() {
                showGroupsSection();
            });

            // Hide bottom nav
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            // Add state to history for back button handling
            history.pushState({ page: 'profile' }, '');
        }
        
        async function updateDisplayName() {
            if (!profileNameChanged) return;
            
            const displayName = document.getElementById('edit-display-name').value.trim();
            
            if (!displayName) {
                document.getElementById('edit-display-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-display-name-error').style.display = 'none';
            }
            
            document.getElementById('save-display-name-btn').disabled = true;
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    displayName: displayName
                });
                
                currentUserData.displayName = displayName;
                
                updateProfileInfo();
                
                showNotification('Nom d\'utilisateur mis  jour', 'success');
                profileNameChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise  jour du nom d\'utilisateur', 'error');
            } finally {
                document.getElementById('save-display-name-btn').disabled = false;
            }
        }
        
        async function updateProfileImage() {
            if (!profileImageFile) {
                showNotification('Aucune nouvelle image slectionne', 'info');
                return;
            }
            
            setButtonLoading('save-profile-image-btn', true);
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    photoURL: profileImageFile
                });
                
                currentUserData.photoURL = profileImageFile;
                
                updateProfileInfo();
                
                showNotification('Photo de profil mise  jour', 'success');
                profileImageFile = null;
            } catch (error) {
                showNotification('Erreur lors de la mise  jour de la photo', 'error');
            } finally {
                setButtonLoading('save-profile-image-btn', false);
            }
        }
        
        async function updateGroupName() {
            if (!groupNameChanged || !editingGroupId) return;
            
            const groupName = document.getElementById('edit-group-name').value.trim();
            
            if (!groupName) {
                document.getElementById('edit-group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-group-name-error').style.display = 'none';
            }
            
            document.getElementById('save-group-name-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    name: groupName,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId) {
                    currentGroup = groupName;
                    if (currentGroupData) {
                        currentGroupData.name = groupName;
                    }
                    
                    updateGroupHeader();
                }
                
                showNotification('Nom du groupe mis  jour', 'success');
                groupNameChanged = false;
                
                loadGroups();
            } catch (error) {
                showNotification('Erreur lors de la mise  jour du nom', 'error');
            } finally {
                document.getElementById('save-group-name-btn').disabled = false;
            }
        }
        
        function updateGroupHeader() {
            if (!currentGroupData) return;
            
            const headerTitle = document.getElementById('header-title');
            if (!headerTitle) return;
            
            if (currentGroupData.allowPublicMessages === false) {
                headerTitle.innerHTML = `${currentGroup} <span class="restricted-badge">Restreint</span>`;
            } else {
                headerTitle.innerText = currentGroup;
            }
        }
        
        async function updateGroupDescription() {
            if (!groupDescriptionChanged || !editingGroupId) return;
            
            const groupDescription = document.getElementById('edit-group-description').value.trim();
            
            document.getElementById('save-group-description-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    description: groupDescription,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.description = groupDescription;
                }
                
                showNotification('Description du groupe mise  jour', 'success');
                groupDescriptionChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise  jour de la description', 'error');
            } finally {
                document.getElementById('save-group-description-btn').disabled = false;
            }
        }
        
        async function updateGroupPermissions() {
            if (!groupPermissionsChanged || !editingGroupId) return;
            
            const allowPublicMessages = document.getElementById('edit-group-public-messages').checked;
            
            document.getElementById('save-group-permissions-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                
                const groupDoc = await getDoc(groupRef);
                if (!groupDoc.exists()) {
                    throw new Error("Groupe introuvable");
                }
                
                const groupData = groupDoc.data();
                const permissionsChanged = allowPublicMessages !== groupData.allowPublicMessages;
                
                await updateDoc(groupRef, {
                    allowPublicMessages: allowPublicMessages,
                    lastUpdated: serverTimestamp()
                });
                
                if (permissionsChanged) {
                    try {
                        await addEventLog({
                            type: 'permission-change',
                            groupId: editingGroupId,
                            groupName: groupData.name,
                            userId: currentUser.uid,
                            allowPublicMessages,
                            timestamp: new Date()
                        });
                    } catch (error) {
                        // Handle error silently
                    }
                }
                
                if (currentGroupId === editingGroupId) {
                    if (currentGroupData) {
                        currentGroupData.allowPublicMessages = allowPublicMessages;
                    }
                    
                    updateGroupHeader();
                    
                    checkSendPermissions();
                }
                
                showNotification('Permissions du groupe mises  jour', 'success');
                groupPermissionsChanged = false;
            } catch (error) {
                showNotification('Erreur lors de la mise  jour des permissions', 'error');
            } finally {
                document.getElementById('save-group-permissions-btn').disabled = false;
            }
        }
        
        async function updateGroupImage() {
            if (!groupImageFile || !editingGroupId) {
                showNotification('Aucune nouvelle image slectionne', 'info');
                return;
            }
            
            setButtonLoading('save-group-image-btn', true);
            
            try {
                const groupRef = doc(db, "groups", editingGroupId);
                await updateDoc(groupRef, {
                    imageURL: groupImageFile,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.imageURL = groupImageFile;
                }
                
                showNotification('Image du groupe mise  jour', 'success');
                groupImageFile = null;
                
                loadGroups();
            } catch (error) {
                showNotification('Erreur lors de la mise  jour de l\'image', 'error');
            } finally {
                setButtonLoading('save-group-image-btn', false);
            }
        }
        
        function setupAuthEvents() {
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        function encodeImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    resolve(event.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function handleProfileImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez slectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                // Use compression for profile images too
                const base64Image = await compressImage(file, 0.7, 300); // Smaller max width for profiles
                profileImageFile = base64Image;
                
                const preview = document.getElementById('profile-image-preview');
                preview.innerHTML = `<img src="${base64Image}" alt="Profile Image">`;
                
                document.getElementById('save-profile-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleNewGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez slectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                // Use compression for group images too
                const base64Image = await compressImage(file, 0.7, 500);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('new-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('new-group-image-upload').addEventListener('click', () => {
                    document.getElementById('new-group-image-input').click();
                });
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleEditGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez slectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                // Use compression for group images
                const base64Image = await compressImage(file, 0.7, 500);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('edit-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                    document.getElementById('edit-group-image-input').click();
                });
                
                document.getElementById('save-group-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        function showProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.add('active');
            
            document.getElementById('edit-display-name').value = currentUserData.displayName || '';
            
            document.getElementById('save-display-name-btn').disabled = true;
            document.getElementById('save-profile-image-btn').disabled = true;
            
            profileNameChanged = false;
            profileImageFile = null;
            
            const profileImagePreview = document.getElementById('profile-image-preview');
            if (currentUserData.photoURL) {
                profileImagePreview.innerHTML = `<img src="${currentUserData.photoURL}" alt="Profile">`;
            } else {
                profileImagePreview.innerHTML = `<i class="fas fa-user"></i>`;
            }
            
            // Add state to history for back button handling
            history.pushState({ page: 'profile-edit' }, '');
        }
        
        function hideProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.remove('active');
            
            profileNameChanged = false;
            profileImageFile = null;
            document.getElementById('profile-image-input').value = '';
        }
        
        function filterGroups(searchText) {
            const groupItems = document.querySelectorAll('.chat-item');
            const lowerSearchText = searchText.toLowerCase();
            
            groupItems.forEach(item => {
                const groupName = item.getAttribute('data-group').toLowerCase();
                if (groupName.includes(lowerSearchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleGroups = 0;
            groupItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleGroups++;
                }
            });
            
            const emptyState = document.querySelector('#groups-list .empty-state');
            if (visibleGroups === 0 && groupItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun rsultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun groupe ne correspond  "${searchText}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun rsultat</div>
                        <div class="empty-state-text">Aucun groupe ne correspond  "${searchText}"</div>
                    `;
                    document.getElementById('groups-list').appendChild(newEmptyState);
                }
            } else if (emptyState) {
                if (groupItems.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun groupe';
                    emptyState.querySelector('.empty-state-text').textContent = isAdmin ? 
                        'Crez un nouveau groupe en appuyant sur le bouton +' : 
                        'Aucun groupe disponible pour le moment';
                } else {
                    emptyState.style.display = visibleGroups > 0 ? 'none' : 'block';
                }
            }
        }
        
        function filterEvents(searchText) {
            const eventItems = document.querySelectorAll('.event-item, .admin-notification');
            const lowerSearchText = searchText.toLowerCase();
            
            eventItems.forEach(item => {
                const eventContent = item.querySelector('.event-content, .admin-notification-content')?.textContent.toLowerCase() || '';
                const eventHeader = item.querySelector('.event-header, .admin-notification-title')?.textContent.toLowerCase() || '';
                
                if (eventContent.includes(lowerSearchText) || eventHeader.includes(lowerSearchText)) {
                    item.style.display = item.classList.contains('event-item') ? 'flex' : 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleEvents = 0;
            eventItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleEvents++;
                }
            });
            
            const emptyState = document.querySelector('#events-list .empty-state');
            if (visibleEvents === 0 && eventItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun rsultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun vnement ne correspond  "${searchText}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun rsultat</div>
                        <div class="empty-state-text">Aucun vnement ne correspond  "${searchText}"</div>
                    `;
                    document.getElementById('events-list').appendChild(newEmptyState);
                }
            } else if (emptyState) {
                if (eventItems.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun vnement';
                    emptyState.querySelector('.empty-state-text').textContent = 'Les vnements apparatront ici';
                } else {
                    emptyState.style.display = visibleEvents > 0 ? 'none' : 'block';
                }
            }
        }
        
        function handleGlobalTouchStart(e) {
            const messageElement = findParentMessage(e.target);
            if (messageElement) {
                const messageId = messageElement.getAttribute('data-id');
                const messageFrom = messageElement.getAttribute('data-from');
                
                // Allow action on all messages
                longPressTimer = setTimeout(() => {
                    try {
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        
                        showMessageActionsBar(messageElement);
                    } catch (error) {
                        console.error("Long press error:", error);
                    }
                }, longPressDuration);
            }
        }
        
        function handleGlobalTouchEnd(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchMove(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchCancel(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function findParentMessage(element) {
            while (element && !element.classList.contains('message') && !element.classList.contains('message-with-image')) {
                element = element.parentElement;
            }
            return element;
        }
        
        function replyToMessage() {
            if (!currentMessageForAction) {
                hideMessageActionsBar();
                return;
            }
            
            try {
                const chatInput = document.getElementById('chat-input');
                const senderName = currentMessageForAction.from === currentUser.uid ? 'Vous' : 
                    document.querySelector(`.sender-${currentMessageForAction.from}`).textContent || 'Utilisateur';
                
                // Truncate text if too long
                let shortText = currentMessageForAction.text;
                if (shortText.length > 50) {
                    shortText = shortText.substring(0, 47) + '...';
                }
                
                // Configure reply preview
                const replyPreview = document.getElementById('reply-preview');
                const replyName = document.getElementById('reply-name');
                const replyContent = document.getElementById('reply-content');
                
                replyName.textContent = senderName;
                replyContent.textContent = shortText;
                replyPreview.classList.add('active');
                
                // Enable reply mode
                replyingToMessage = {
                    id: currentMessageForAction.id,
                    sender: senderName,
                    text: shortText
                };
                
                // Adjust input container
                const chatInputContainer = document.getElementById('chat-input-container');
                chatInputContainer.classList.add('with-reply');
                
                chatInput.focus();
                
                if (autoResizeTextarea) {
                    autoResizeTextarea();
                }
                
                hideMessageActionsBar();
            } catch (error) {
                console.error("Reply error:", error);
                hideMessageActionsBar();
            }
        }
        
        function showDeleteConfirmation() {
            // Just hide the message actions bar visually without clearing currentMessageForAction
            if (isMessageActionsVisible) {
                const actionsBar = document.getElementById('message-actions-container');
                actionsBar.classList.remove('active');
                isMessageActionsVisible = false;
                
                // Show normal header elements but don't clear the message reference
                document.querySelector('.header-left').style.opacity = '1';
                document.querySelector('.header-title').style.opacity = '1';
                document.getElementById('header-action').style.opacity = '1';
            }
            document.getElementById('delete-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Add state to history for back button handling
            history.pushState({ page: 'delete-confirmation' }, '');
        }
        
        function hideDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            currentMessageForAction = null;
        }
        
        async function confirmDeleteMessage() {
            if (!currentMessageForAction || !currentGroupId) {
                hideDeleteConfirmation();
                return;
            }
            
            const messageId = currentMessageForAction.id;
            const messageElement = currentMessageForAction.element;
            const messageContainer = messageElement.closest('.message-container');
            const messageFrom = currentMessageForAction.from;
            
            try {
                // Check if user has permission to delete this message
                if (messageFrom !== currentUser.uid && !isAdmin) {
                    showNotification("Vous ne pouvez pas supprimer les messages des autres utilisateurs", "error");
                    hideDeleteConfirmation();
                    return;
                }
                
                // Apply delete animation
                if (messageContainer) {
                    messageContainer.style.animation = 'deleteMessage 0.3s ease forwards';
                }
                
                const messageRef = doc(db, "groups", currentGroupId, "messages", messageId);
                
                // Check if message still exists
                const messageDoc = await getDoc(messageRef);
                if (!messageDoc.exists()) {
                    showNotification("Ce message a dj t supprim", "info");
                    hideDeleteConfirmation();
                    
                    // Remove element from UI
                    if (messageContainer) {
                        setTimeout(() => {
                            messageContainer.remove();
                        }, 300);
                    }
                    return;
                }
                
                // Delete message from Firestore
                await deleteDoc(messageRef);
                
                // Remove element from UI after animation
                if (messageContainer) {
                    setTimeout(() => {
                        messageContainer.remove();
                    }, 300);
                }
                
                hideDeleteConfirmation();
                showNotification('Message supprim', 'success');
                
                // If message was an image, update image cache
                const messageData = messageDoc.data();
                if (messageData && messageData.imageData && groupImageCache[currentGroupId]) {
                    // Remove from cache
                    groupImageCache[currentGroupId] = groupImageCache[currentGroupId].filter(
                        img => img.id !== messageId
                    );
                }
                
            } catch (error) {
                console.error("Delete error:", error);
                showNotification("Erreur lors de la suppression", "error");
                hideDeleteConfirmation();
                
                // Restore element if animation was in progress
                if (messageContainer) {
                    messageContainer.style.animation = '';
                }
            }
        }
        
        function copyMessageText() {
            if (!currentMessageForAction) {
                if (isMessageActionsVisible) {
                    hideMessageActionsBar();
                }
                return;
            }
            
            try {
                const messageElement = currentMessageForAction.element;
                const messageText = messageElement.textContent;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(messageText).then(() => {
                        showNotification('Texte copi dans le presse-papiers', 'success');
                    }).catch(err => {
                        showNotification('Erreur lors de la copie du texte', 'error');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = messageText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showNotification('Texte copi dans le presse-papiers', 'success');
                        } else {
                            showNotification('Impossible de copier le texte', 'error');
                        }
                    } catch (err) {
                        showNotification('Erreur lors de la copie du texte', 'error');
                    }
                    
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                showNotification('Erreur lors de la copie du texte', 'error');
            } finally {
                if (isMessageActionsVisible) {
                    hideMessageActionsBar();
                }
            }
        }
        
        function showCreateGroupDialog() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent crer des groupes", "error");
                return;
            }
            
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-public-messages').checked = true;
            document.getElementById('group-name-error').style.display = 'none';
            
            groupImageFile = null;
            document.getElementById('new-group-image-preview').innerHTML = `
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="new-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            `;
            document.getElementById('new-group-image-input').value = '';
            
            document.getElementById('new-group-image-upload').addEventListener('click', () => {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('create-group-dialog').classList.add('active');
            document.getElementById('group-name').focus();
            
            // Add state to history for back button handling
            history.pushState({ page: 'create-group' }, '');
        }
        
        function hideCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.remove('active');
        }
        
        function showEditGroupDialog(groupId, groupData) {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent modifier le groupe", "error");
                return;
            }
            
            editingGroupId = groupId;
            
            document.getElementById('edit-group-name').value = groupData.name || '';
            document.getElementById('edit-group-description').value = groupData.description || '';
            document.getElementById('edit-group-public-messages').checked = groupData.allowPublicMessages !== false;
            
            document.getElementById('save-group-name-btn').disabled = true;
            document.getElementById('save-group-description-btn').disabled = true;
            document.getElementById('save-group-permissions-btn').disabled = true;
            document.getElementById('save-group-image-btn').disabled = true;
            
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            groupImageFile = null;
            
            const groupImagePreview = document.getElementById('edit-group-image-preview');
            if (groupData.imageURL) {
                groupImagePreview.innerHTML = `
                    <img src="${groupData.imageURL}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            } else {
                groupImagePreview.innerHTML = `
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
            
            document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-dialog').classList.add('active');
            
            // Add state to history for back button handling
            history.pushState({ page: 'edit-group' }, '');
        }
        
        function hideEditGroupDialog() {
            document.getElementById('edit-group-dialog').classList.remove('active');
            editingGroupId = null;
            
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            groupImageFile = null;
            document.getElementById('edit-group-image-input').value = '';
        }
        
        async function createNewGroup() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent crer des groupes", "error");
                return;
            }
            
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const allowPublicMessages = document.getElementById('group-public-messages').checked;
            
            if (!groupName) {
                document.getElementById('group-name-error').style.display = 'block';
                return;
            }
            
            setButtonLoading('create-group-submit', true);
            
            try {
                const groupRef = collection(db, "groups");
                const newGroup = {
                    name: groupName,
                    description: groupDescription || "Groupe de discussion",
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    members: [currentUser.uid],
                    lastMessageTime: serverTimestamp(),
                    allowPublicMessages: allowPublicMessages,
                    admins: [currentUser.uid],
                    imageURL: groupImageFile || null
                };
                
                const groupDocRef = await addDoc(groupRef, newGroup);
                
                const messagesRef = collection(db, "groups", groupDocRef.id, "messages");
                await addDoc(messagesRef, {
                    text: `Bienvenue dans le groupe "${groupName}" !${allowPublicMessages ? '' : '\n(Groupe avec messages restreints - seuls les admins peuvent crire)'}`,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                
                await addEventLog({
                    type: 'group-create',
                    groupId: groupDocRef.id,
                    groupName: groupName,
                    userId: currentUser.uid,
                    allowPublicMessages: allowPublicMessages,
                    timestamp: new Date()
                });
                
                setButtonLoading('create-group-submit', false);
                
                hideCreateGroupDialog();
                
                loadGroups();
                
                showNotification(`Groupe "${groupName}" cr avec succs`, 'success');
            } catch (error) {
                showNotification('Erreur lors de la cration du groupe', 'error');
                setButtonLoading('create-group-submit', false);
            }
        }
        
        async function addEventLog(eventData) {
            try {
                if (!eventData.type || !eventData.timestamp) {
                    return;
                }
                
                const completeEventData = {
                    ...eventData,
                    timestamp: serverTimestamp(),
                    userId: eventData.userId || currentUser.uid
                };
                
                const eventsRef = collection(db, "events");
                await addDoc(eventsRef, completeEventData);
                
            } catch (error) {
                console.error("Event error:", error);
            }
        }
        
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                
                registerForm.style.animation = 'none';
                void registerForm.offsetWidth;
                registerForm.style.animation = '';
                
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                
                loginForm.style.animation = 'none';
                void loginForm.offsetWidth;
                loginForm.style.animation = '';
                
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            
            hideLog('login-log');
            hideLog('register-log');
            
            const activeForm = tab === 'login' ? loginForm : registerForm;
            activeForm.style.animation = 'fadeUp 0.5s ease';
        }
        
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value.trim();
            const errorElement = document.getElementById('login-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value.trim();
            const errorElement = document.getElementById('register-email-error');
            
            if (!email) {
                errorElement.textContent = 'L\'email est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (!isValidEmail(email)) {
                errorElement.textContent = 'Format d\'email invalide';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password) {
                errorElement.textContent = 'Le mot de passe est requis';
                errorElement.style.display = 'block';
                return false;
            } else if (password.length < 6) {
                errorElement.textContent = 'Le mot de passe doit contenir au moins 6 caractres';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (!confirmPassword) {
                                errorElement.textContent = 'La confirmation du mot de passe est requise';
                errorElement.style.display = 'block';
                return false;
            } else if (password !== confirmPassword) {
                errorElement.textContent = 'Les mots de passe ne correspondent pas';
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginForm() {
            const isEmailValid = validateLoginEmail();
            const isPasswordValid = validateLoginPassword();
            
            return isEmailValid && isPasswordValid;
        }
        
        function validateRegisterForm() {
            const isEmailValid = validateRegisterEmail();
            const isPasswordValid = validateRegisterPassword();
            const isConfirmPasswordValid = validateRegisterConfirmPassword();
            
            return isEmailValid && isPasswordValid && isConfirmPasswordValid;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (isLoading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        function showLog(logId, message, type = 'error') {
            const logElement = document.getElementById(logId);
            if (!logElement) return;
            
            logElement.textContent = message;
            logElement.className = `log-message ${type}`;
            logElement.style.display = 'block';
        }
        
        function hideLog(logId) {
            const logElement = document.getElementById(logId);
            if (!logElement) return;
            
            logElement.style.display = 'none';
            logElement.className = 'log-message';
            logElement.textContent = '';
        }
        
        async function loginUser() {
            if (!validateLoginForm()) return;
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            setButtonLoading('loginBtn', true);
            hideLog('login-log');
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
            } catch (error) {
                let errorMessage = 'Erreur lors de la connexion';
                
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Email ou mot de passe incorrect';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'Ce compte a t dsactiv';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Trop de tentatives choues. Veuillez ressayer plus tard';
                }
                
                showLog('login-log', errorMessage, 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }
        
        async function registerUser() {
            if (!validateRegisterForm()) return;
            
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            
            setButtonLoading('registerBtn', true);
            hideLog('register-log');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Create user document in Firestore
                const user = userCredential.user;
                const userDocRef = doc(db, "Users", user.uid);
                
                const userData = {
                    email: user.email,
                    displayName: email.split('@')[0],
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                };
                
                await setDoc(userDocRef, userData);
                
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirm-password').value = '';
                
                showLog('register-log', 'Compte cr avec succs !', 'success');
                
                // Auto switch to login after a delay
                setTimeout(() => {
                    changeAuthTab('login');
                }, 1500);
                
            } catch (error) {
                let errorMessage = 'Erreur lors de l\'inscription';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Cet email est dj utilis';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format d\'email invalide';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Le mot de passe est trop faible';
                }
                
                showLog('register-log', errorMessage, 'error');
            } finally {
                setButtonLoading('registerBtn', false);
            }
        }
        
        function showLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Add state to history for back button handling
            history.pushState({ page: 'logout-confirmation' }, '');
        }
        
        function hideLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function logoutUser() {
            try {
                cleanupListeners();
                await signOut(auth);
                hideLogoutConfirmation();
                currentUserData = null;
                isAdmin = false;
                
                // Clear caches
                messagesCache = {};
                groupImageCache = {};
                forecastsCache = {};
                
                showNotification('Dconnexion russie', 'success');
            } catch (error) {
                showNotification('Erreur lors de la dconnexion', 'error');
                hideLogoutConfirmation();
            }
        }
        
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Add state to history for back button handling
            history.pushState({ page: 'delete-account-confirmation' }, '');
        }
        
        function hideDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function deleteAccount() {
            try {
                if (!currentUser) {
                    throw new Error("Utilisateur non connect");
                }
                
                // Delete user document from Firestore
                const userDocRef = doc(db, "Users", currentUser.uid);
                await deleteDoc(userDocRef);
                
                // Delete user auth account
                await deleteUser(currentUser);
                
                hideDeleteAccountConfirmation();
                cleanupListeners();
                
                currentUserData = null;
                isAdmin = false;
                
                // Clear caches
                messagesCache = {};
                groupImageCache = {};
                forecastsCache = {};
                
                showNotification('Compte supprim avec succs', 'success');
            } catch (error) {
                console.error("Delete account error:", error);
                showNotification('Erreur lors de la suppression du compte. Veuillez vous reconnecter et ressayer.', 'error');
                hideDeleteAccountConfirmation();
                
                // Force logout if account deletion partially succeeded
                try {
                    await signOut(auth);
                } catch (e) {
                    // Ignore signout errors
                }
            }
        }
        
        function cleanupListeners() {
            // Unsubscribe from all Firestore listeners
            if (eventsUnsubscribe) {
                eventsUnsubscribe();
                eventsUnsubscribe = null;
            }
            
            if (forecastsUnsubscribe) {
                forecastsUnsubscribe();
                forecastsUnsubscribe = null;
            }
            
            // Clear chat unsubscribers
            for (const groupId in chatUnsubscribers) {
                if (chatUnsubscribers[groupId]) {
                    chatUnsubscribers[groupId]();
                }
            }
            chatUnsubscribers = {};
        }
        
        function showAdminNotificationDialog() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                return;
            }
            
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-content').value = '';
            document.getElementById('notif-type').value = 'info';
            
            document.getElementById('admin-notif-dialog').classList.add('active');
            document.getElementById('notif-title').focus();
            
            // Add state to history for back button handling
            history.pushState({ page: 'admin-notif' }, '');
        }
        
        function hideAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.remove('active');
        }
        
        async function sendAdminNotification() {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                return;
            }
            
            const title = document.getElementById('notif-title').value.trim();
            const content = document.getElementById('notif-content').value.trim();
            const type = document.getElementById('notif-type').value;
            
            if (!title) {
                document.getElementById('notif-title-error').style.display = 'block';
                return;
            } else {
                document.getElementById('notif-title-error').style.display = 'none';
            }
            
            if (!content) {
                document.getElementById('notif-content-error').style.display = 'block';
                return;
            } else {
                document.getElementById('notif-content-error').style.display = 'none';
            }
            
            setButtonLoading('send-notification-btn', true);
            
            try {
                const eventRef = collection(db, "events");
                
                const notifData = {
                    type: 'admin-notification',
                    title: title,
                    content: content,
                    notificationType: type,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    senderName: currentUserData.displayName || 'Admin',
                    senderPhoto: currentUserData.photoURL || null,
                };
                
                await addDoc(eventRef, notifData);
                
                hideAdminNotificationDialog();
                showNotification("Notification envoye avec succs", "success");
                
                // Reload events if currently in events section
                if (currentSection === 'events') {
                    listenToEvents();
                }
                
            } catch (error) {
                showNotification("Erreur lors de l'envoi de la notification", "error");
            } finally {
                setButtonLoading('send-notification-btn', false);
            }
        }
        
        function showDeleteEventConfirmation(eventId) {
            if (!isAdmin) {
                showNotification("Seuls les administrateurs peuvent supprimer des vnements", "error");
                return;
            }
            
            currentEventForDeletion = eventId;
            
            document.getElementById('delete-event-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            
            // Add state to history for back button handling
            history.pushState({ page: 'delete-event-confirmation' }, '');
        }
        
        function hideDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            
            currentEventForDeletion = null;
        }
        
        async function confirmDeleteEvent() {
            if (!isAdmin || !currentEventForDeletion) {
                hideDeleteEventConfirmation();
                return;
            }
            
            try {
                const eventRef = doc(db, "events", currentEventForDeletion);
                await deleteDoc(eventRef);
                
                hideDeleteEventConfirmation();
                showNotification("vnement supprim avec succs", "success");
                
                // Find and remove the event element
                const eventElement = document.querySelector(`.event-item[data-id="${currentEventForDeletion}"], .admin-notification[data-id="${currentEventForDeletion}"]`);
                if (eventElement) {
                    eventElement.style.animation = 'deleteMessage 0.3s ease forwards';
                    setTimeout(() => {
                        eventElement.remove();
                        
                        // Check if there are no more events
                        const eventsList = document.getElementById('events-list');
                        if (eventsList && !eventsList.querySelector('.event-item, .admin-notification')) {
                            eventsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-bell"></i>
                                    <div class="empty-state-title">Aucun vnement</div>
                                    <div class="empty-state-text">Les vnements apparatront ici</div>
                                </div>
                            `;
                        }
                    }, 300);
                }
                
            } catch (error) {
                console.error("Delete event error:", error);
                showNotification("Erreur lors de la suppression de l'vnement", "error");
                hideDeleteEventConfirmation();
            }
        }
        
        async function listenToEvents() {
            if (eventsUnsubscribe) {
                eventsUnsubscribe();
                eventsUnsubscribe = null;
            }
            
            const eventsList = document.getElementById('events-list');
            if (!eventsList) return;
            
            if (!isLoadingEvents) {
                isLoadingEvents = true;
                
                eventsList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des vnements...</div>
                    </div>
                `;
            }
            
            const eventsRef = collection(db, "events");
            const q = query(eventsRef, orderBy("timestamp", "desc"), limit(100));
            
            eventsUnsubscribe = onSnapshot(q, async (snapshot) => {
                isLoadingEvents = false;
                
                if (snapshot.empty) {
                    eventsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bell"></i>
                            <div class="empty-state-title">Aucun vnement</div>
                            <div class="empty-state-text">Les vnements apparatront ici</div>
                        </div>
                    `;
                    return;
                }
                
                // Load all users to get their display names
                const usersRef = collection(db, "Users");
                const usersSnap = await getDocs(usersRef);
                const usersMap = {};
                
                usersSnap.forEach(userDoc => {
                    const userData = userDoc.data();
                    usersMap[userDoc.id] = {
                        displayName: userData.displayName || 'Utilisateur',
                        photoURL: userData.photoURL || null,
                        isAdmin: userData.isAdmin || false
                    };
                });
                
                let eventsHTML = '';
                
                snapshot.forEach(doc => {
                    const eventData = doc.data();
                    const eventId = doc.id;
                    
                    const user = usersMap[eventData.userId] || { 
                        displayName: 'Utilisateur inconnu',
                        photoURL: null,
                        isAdmin: false
                    };
                    
                    let timestamp = 'Date inconnue';
                    if (eventData.timestamp) {
                        const date = eventData.timestamp.toDate ? 
                            eventData.timestamp.toDate() : 
                            new Date(eventData.timestamp);
                        
                        timestamp = date.toLocaleDateString('fr-FR', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    if (eventData.type === 'admin-notification') {
                        const notifType = eventData.notificationType || 'info';
                        let iconClass = 'fa-info-circle';
                        
                        if (notifType === 'alert') {
                            iconClass = 'fa-exclamation-triangle';
                        } else if (notifType === 'update') {
                            iconClass = 'fa-sync-alt';
                        }
                        
                        eventsHTML += `
                            <div class="admin-notification" data-id="${eventId}">
                                <div class="admin-notification-header">
                                    <div class="admin-notification-title">
                                        <i class="fas ${iconClass}"></i>
                                        ${eventData.title}
                                    </div>
                                    ${isAdmin ? `
                                        <div class="event-close-btn" onclick="window.showDeleteEventConfirmation('${eventId}')">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="admin-notification-content">
                                    ${eventData.content.replace(/\n/g, '<br>')}
                                </div>
                                <div class="admin-notification-footer">
                                    Envoy par ${eventData.senderName || user.displayName}  ${timestamp}
                                </div>
                            </div>
                        `;
                    } else if (eventData.type === 'group-create') {
                        eventsHTML += `
                            <div class="event-item group-create" data-id="${eventId}">
                                <div class="event-icon">
                                    <i class="fas fa-plus"></i>
                                </div>
                                <div class="item-content">
                                    <div class="event-header">Nouveau groupe cr</div>
                                    <div class="event-content">
                                        <strong>${user.displayName}</strong> a cr le groupe <strong>${eventData.groupName}</strong>
                                        ${!eventData.allowPublicMessages ? ' (messages restreints)' : ''}
                                    </div>
                                    <div class="event-time">${timestamp}</div>
                                </div>
                                ${isAdmin ? `
                                    <div class="event-actions">
                                        <div class="event-action-btn delete" onclick="window.showDeleteEventConfirmation('${eventId}')">
                                            <i class="fas fa-trash"></i>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else if (eventData.type === 'permission-change') {
                        eventsHTML += `
                            <div class="event-item permission-change" data-id="${eventId}">
                                <div class="event-icon">
                                    <i class="fas fa-lock${eventData.allowPublicMessages ? '-open' : ''}"></i>
                                </div>
                                <div class="item-content">
                                    <div class="event-header">Permissions modifies</div>
                                    <div class="event-content">
                                        <strong>${user.displayName}</strong> a modifi les permissions du groupe <strong>${eventData.groupName}</strong>
                                        ${eventData.allowPublicMessages ? 
                                            ' (messages ouverts  tous)' : 
                                            ' (messages restreints aux admins)'}
                                    </div>
                                    <div class="event-time">${timestamp}</div>
                                </div>
                                ${isAdmin ? `
                                    <div class="event-actions">
                                        <div class="event-action-btn delete" onclick="window.showDeleteEventConfirmation('${eventId}')">
                                            <i class="fas fa-trash"></i>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else if (eventData.type === 'user-join') {
                        eventsHTML += `
                            <div class="event-item user-join" data-id="${eventId}">
                                <div class="event-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="item-content">
                                    <div class="event-header">Nouvel utilisateur</div>
                                    <div class="event-content">
                                        <strong>${user.displayName}</strong> a rejoint la plateforme
                                    </div>
                                    <div class="event-time">${timestamp}</div>
                                </div>
                                ${isAdmin ? `
                                    <div class="event-actions">
                                        <div class="event-action-btn delete" onclick="window.showDeleteEventConfirmation('${eventId}')">
                                            <i class="fas fa-trash"></i>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                });
                
                eventsList.innerHTML = eventsHTML || `
                    <div class="empty-state">
                        <i class="fas fa-bell"></i>
                        <div class="empty-state-title">Aucun vnement</div>
                        <div class="empty-state-text">Les vnements apparatront ici</div>
                    </div>
                `;
                
                // Make event delete function available to event elements
                window.showDeleteEventConfirmation = showDeleteEventConfirmation;
            }, error => {
                isLoadingEvents = false;
                eventsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les vnements</div>
                    </div>
                `;
            });
        }
        
        function updateLastViewedEventTimestamp() {
            lastViewedEventTimestamp = new Date();
            
            try {
                localStorage.setItem('parisAllianceLastViewedEvents', lastViewedEventTimestamp.toISOString());
            } catch (error) {
                // Ignore local storage errors
            }
        }
        
        function loadLastViewedEventTimestamp() {
            try {
                const timestamp = localStorage.getItem('parisAllianceLastViewedEvents');
                if (timestamp) {
                    lastViewedEventTimestamp = new Date(timestamp);
                }
            } catch (error) {
                // Ignore local storage errors
            }
        }
        
        function showEventNotificationDot() {
            const eventsDot = document.getElementById('events-notification-dot');
            if (eventsDot) {
                eventsDot.classList.add('active');
            }
            
            hasNewEvents = true;
        }
        
        function hideEventNotificationDot() {
            const eventsDot = document.getElementById('events-notification-dot');
            if (eventsDot) {
                eventsDot.classList.remove('active');
            }
            
            hasNewEvents = false;
        }
        
        async function checkForNewEvents() {
            if (!lastViewedEventTimestamp || !isLoggedIn) return;
            
            try {
                const eventsRef = collection(db, "events");
                const q = query(
                    eventsRef,
                    where("timestamp", ">", Timestamp.fromDate(lastViewedEventTimestamp)),
                    limit(1)
                );
                
                const eventsSnap = await getDocs(q);
                
                if (!eventsSnap.empty) {
                    showEventNotificationDot();
                } else {
                    hideEventNotificationDot();
                }
            } catch (error) {
                // Ignore errors in background checks
            }
        }
        
        async function loadGroups() {
            if (!isLoggedIn) return;
            
            const groupsListElement = document.getElementById('groups-list');
            
            if (!isLoadingGroups && groupsListElement) {
                isLoadingGroups = true;
                
                groupsListElement.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des groupes...</div>
                    </div>
                `;
            }
            
            try {
                const groupsRef = collection(db, "groups");
                const q = query(
                    groupsRef,
                    where("members", "array-contains", currentUser.uid),
                    orderBy("lastMessageTime", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                
                if (groupsListElement) {
                    if (querySnapshot.empty) {
                        groupsListElement.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <div class="empty-state-title">Aucun groupe</div>
                                <div class="empty-state-text">${isAdmin ? 
                                    'Crez un nouveau groupe en appuyant sur le bouton +' : 
                                    'Aucun groupe disponible pour le moment'}</div>
                            </div>
                        `;
                    } else {
                        let groupsHTML = '';
                        
                        querySnapshot.forEach((doc) => {
                            const groupData = doc.data();
                            
                            let lastMessage = groupData.lastMessage || 'Aucun message';
                            const isRestricted = groupData.allowPublicMessages === false;
                            
                            // Format last message timestamp
                            let lastTimestamp = 'Rcemment';
                            if (groupData.lastMessageTime) {
                                const date = groupData.lastMessageTime.toDate();
                                
                                const now = new Date();
                                const diff = now - date;
                                
                                if (diff < 60 * 1000) { // Less than 1 minute
                                    lastTimestamp = ' l\'instant';
                                } else if (diff < 60 * 60 * 1000) { // Less than 1 hour
                                    const minutes = Math.floor(diff / (60 * 1000));
                                    lastTimestamp = `Il y a ${minutes} ${minutes === 1 ? 'minute' : 'minutes'}`;
                                } else if (diff < 24 * 60 * 60 * 1000) { // Less than 1 day
                                    const hours = Math.floor(diff / (60 * 60 * 1000));
                                    lastTimestamp = `Il y a ${hours} ${hours === 1 ? 'heure' : 'heures'}`;
                                } else if (diff < 7 * 24 * 60 * 60 * 1000) { // Less than 1 week
                                    const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                                    lastTimestamp = `Il y a ${days} ${days === 1 ? 'jour' : 'jours'}`;
                                } else {
                                    lastTimestamp = date.toLocaleDateString('fr-FR', {
                                        day: 'numeric',
                                        month: 'short'
                                    });
                                }
                            }
                            
                            // Group name with optional restricted badge
                            const groupNameWithBadge = `
                                ${groupData.name}
                                ${isRestricted ? '<span class="restricted-badge">Restreint</span>' : ''}
                            `;
                            
                            // Create group item HTML
                            groupsHTML += `
                                <div class="chat-item" data-id="${doc.id}" data-group="${groupData.name}">
                                    <div class="group-pic">
                                        ${groupData.imageURL ? 
                                            `<img src="${groupData.imageURL}" alt="${groupData.name}">` : 
                                            '<i class="fas fa-users" style="color: white; font-size: 20px;"></i>'}
                                    </div>
                                    <div class="item-content">
                                        <div class="item-title">${groupNameWithBadge}</div>
                                        <div class="item-subtitle">${lastMessage}</div>
                                    </div>
                                    <div class="item-time">${lastTimestamp}</div>
                                </div>
                            `;
                        });
                        
                        groupsListElement.innerHTML = groupsHTML;
                        
                        // Attach click events to chat items
                        document.querySelectorAll('.chat-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const groupId = this.getAttribute('data-id');
                                const groupName = this.getAttribute('data-group');
                                openGroupChat(groupId, groupName);
                            });
                        });
                    }
                }
                
                isLoadingGroups = false;
            } catch (error) {
                console.error("Load groups error:", error);
                
                if (groupsListElement) {
                    groupsListElement.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les groupes</div>
                        </div>
                    `;
                }
                
                isLoadingGroups = false;
            }
        }
        
        async function openGroupChat(groupId, groupName) {
            try {
                currentGroupId = groupId;
                currentGroup = groupName;
                
                // Load group data
                const groupRef = doc(db, "groups", groupId);
                const groupSnap = await getDoc(groupRef);
                
                if (!groupSnap.exists()) {
                    showNotification("Ce groupe n'existe plus", "error");
                    return;
                }
                
                currentGroupData = groupSnap.data();
                
                // Set header title with restricted badge if needed
                const headerTitle = document.getElementById('header-title');
                
                if (currentGroupData.allowPublicMessages === false) {
                    headerTitle.innerHTML = `${groupName} <span class="restricted-badge">Restreint</span>`;
                } else {
                    headerTitle.textContent = groupName;
                }
                
                // Show chat interface
                document.getElementById('chat-interface').style.display = 'block';
                
                // Update header
                document.getElementById('header-menu-button').style.display = 'none';
                document.getElementById('header-back-button').style.display = 'block';
                
                // Update header actions
                document.getElementById('header-action').innerHTML = `
                    <div class="info-button" id="group-info-button">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    ${isAdmin ? `
                        <div class="search-button" id="edit-group-button">
                            <i class="fas fa-cog"></i>
                        </div>
                    ` : ''}
                `;
                
                // Add event listeners to new buttons
                document.getElementById('group-info-button').addEventListener('click', function() {
                    showGroupInfoDialog();
                });
                
                if (isAdmin) {
                    document.getElementById('edit-group-button').addEventListener('click', function() {
                        showEditGroupDialog(groupId, currentGroupData);
                    });
                }
                
                // Clear chat messages
                document.getElementById('chat-messages').innerHTML = '';
                
                // Add loading indicator
                document.getElementById('chat-messages').innerHTML = `
                    <div class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div class="loading-indicator-text">Chargement des messages...</div>
                    </div>
                `;
                
                // Reset message input
                document.getElementById('chat-input').value = '';
                chatImageFile = null;
                
                // Cancel any active reply
                cancelReply();
                
                // Reset image button color
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = '';
                }
                
                // Check send permissions
                checkSendPermissions();
                
                // Load messages
                loadMessages(groupId);
                
                // Add state to history for back button handling
                history.pushState({ page: 'chat', groupId }, '');
                
            } catch (error) {
                console.error("Open chat error:", error);
                showNotification("Erreur lors de l'ouverture de la conversation", "error");
            }
        }
        
        function checkSendPermissions() {
            const sendButton = document.getElementById('send-button');
            const chatInput = document.getElementById('chat-input');
            const imageButton = document.getElementById('image-button');
            
            if (!currentGroupData) return;
            
            // Check if group has restricted messages and user is not admin
            const isRestricted = currentGroupData.allowPublicMessages === false;
            const isGroupAdmin = isAdmin || (currentGroupData.admins && currentGroupData.admins.includes(currentUser.uid));
            
            if (isRestricted && !isGroupAdmin) {
                // Disable sending messages
                sendButton.disabled = true;
                chatInput.disabled = true;
                chatInput.placeholder = "Seuls les administrateurs peuvent envoyer des messages";
                imageButton.style.color = 'var(--inactive-text)';
                imageButton.style.pointerEvents = 'none';
                
                // Show restricted message if not already shown
                if (!document.querySelector('.restricted-message')) {
                    const restrictedMessage = document.createElement('div');
                    restrictedMessage.className = 'restricted-message';
                    restrictedMessage.innerHTML = `
                        <i class="fas fa-lock"></i> Seuls les administrateurs peuvent envoyer des messages dans ce groupe.
                    `;
                    
                    document.getElementById('chat-messages').prepend(restrictedMessage);
                }
            } else {
                // Enable sending messages
                sendButton.disabled = false;
                chatInput.disabled = false;
                chatInput.placeholder = "crire un message...";
                imageButton.style.color = '';
                imageButton.style.pointerEvents = '';
                
                // Remove restricted message if present
                const restrictedMessage = document.querySelector('.restricted-message');
                if (restrictedMessage) {
                    restrictedMessage.remove();
                }
            }
        }
        
        function closeChat() {
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            // Reset header title
            document.getElementById('header-title').textContent = 'Groupes';
            
            // Reset header actions for groups view
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            // Reattach event handlers
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            // Unsubscribe from chat messages
            if (chatUnsubscribers[currentGroupId]) {
                chatUnsubscribers[currentGroupId]();
                delete chatUnsubscribers[currentGroupId];
            }
            
            // Reset current group
            currentGroupId = null;
            currentGroup = '';
            currentGroupData = null;
            
            // Reset chat UI state
            chatImageFile = null;
            cancelReply();
        }
        
        function loadMessages(groupId, scrollToBottom = true) {
            if (chatUnsubscribers[groupId]) {
                chatUnsubscribers[groupId]();
                delete chatUnsubscribers[groupId];
            }
            
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            // Check if we have cached messages
            if (messagesCache[groupId] && messagesCache[groupId].length > 0) {
                displayCachedMessages(groupId, scrollToBottom);
                
                // Start listening for new messages after a short delay
                setTimeout(() => {
                    listenForNewMessages(groupId);
                }, 500);
                
                return;
            }
            
            // No cache, load fresh messages
            loadInitialMessages(groupId, scrollToBottom);
        }
        
        async function loadInitialMessages(groupId, scrollToBottom = true) {
            // Reset message tracking to prevent duplicates
            lastProcessedMessageId = null;
            
            const messagesRef = collection(db, "groups", groupId, "messages");
            const q = query(messagesRef, orderBy("createdAt", "desc"), limit(messagesPerPage));
            
            try {
                const querySnapshot = await getDocs(q);
                
                // Get total message count for pagination
                const countQuery = query(messagesRef);
                const countSnapshot = await getDocs(countQuery);
                totalMessages = countSnapshot.size;
                
                // Reset page to 1
                currentPage = 1;
                
                // Process messages
                const messages = [];
                querySnapshot.forEach((doc) => {
                    const messageData = doc.data();
                    messages.push({
                        id: doc.id,
                        ...messageData
                    });
                });
                
                // Sort messages by timestamp (oldest first)
                messages.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return a.createdAt.seconds - b.createdAt.seconds;
                    }
                    return 0;
                });
                
                // Cache messages
                messagesCache[groupId] = messages;
                
                // Display messages
                displayCachedMessages(groupId, scrollToBottom);
                
                // Start listening for new messages
                listenForNewMessages(groupId);
                
            } catch (error) {
                console.error("Load messages error:", error);
                
                document.getElementById('chat-messages').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 30px; color: var(--danger-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Erreur lors du chargement des messages</div>
                        <button class="button" style="margin-top: 15px; max-width: 200px;" onclick="loadMessages('${groupId}')">
                            Ressayer
                        </button>
                    </div>
                `;
                
                // Make loadMessages available globally for the retry button
                window.loadMessages = loadMessages;
            }
        }
        
        function displayCachedMessages(groupId, scrollToBottom = true) {
            if (!messagesCache[groupId]) return;
            
            const messages = messagesCache[groupId];
            const messagesContainer = document.getElementById('chat-messages');
            
            if (!messagesContainer) return;
            
            // Clear previous messages
            messagesContainer.innerHTML = '';
            
            // Add load more button if there are more messages
            if (currentPage * messagesPerPage < totalMessages) {
                const loadMoreElement = document.createElement('div');
                loadMoreElement.className = 'load-more-messages';
                loadMoreElement.innerHTML = `
                    <button class="load-more-btn" id="load-more-btn">
                        <i class="fas fa-chevron-up"></i> Messages prcdents
                    </button>
                `;
                messagesContainer.appendChild(loadMoreElement);
                
                // Add event listener
                document.getElementById('load-more-btn').addEventListener('click', () => {
                    loadMoreMessages(groupId);
                });
            }
            
            let lastDate = null;
            
            // Display messages with date separators
            messages.forEach((message, index) => {
                // Insert date separator if needed
                if (message.createdAt) {
                    const messageDate = message.createdAt.toDate ? 
                        message.createdAt.toDate() : 
                        new Date(message.createdAt);
                    
                    const formattedDate = messageDate.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    // Capitalize first letter
                    const capitalizedDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
                    
                    if (!lastDate || !isSameDay(lastDate, messageDate)) {
                        const dateElement = document.createElement('div');
                        dateElement.className = 'date-separator';
                        dateElement.innerHTML = `<span class="date-separator-text">${capitalizedDate}</span>`;
                        messagesContainer.appendChild(dateElement);
                        
                        lastDate = messageDate;
                    }
                }
                
                // Add message element
                const messageElement = createMessageElement(message, index === messages.length - 1);
                messagesContainer.appendChild(messageElement);
            });
            
            // Add scroll to bottom if needed
            if (scrollToBottom) {
                setTimeout(() => {
                    scrollChatToBottom();
                }, 100);
            }
        }
        
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        async function loadMoreMessages(groupId) {
            if (!groupId || !messagesCache[groupId]) return;
            
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
                loadMoreBtn.disabled = true;
            }
            
            try {
                // Get the oldest message timestamp
                const oldestMessage = messagesCache[groupId][0];
                if (!oldestMessage || !oldestMessage.createdAt) {
                    throw new Error("Cannot determine oldest message");
                }
                
                const messagesRef = collection(db, "groups", groupId, "messages");
                const q = query(
                    messagesRef,
                    orderBy("createdAt", "desc"),
                    startAfter(oldestMessage.createdAt),
                    limit(messagesPerPage)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    // No more messages
                    if (loadMoreBtn) {
                        loadMoreBtn.remove();
                    }
                    return;
                }
                
                // Process new older messages
                const olderMessages = [];
                querySnapshot.forEach((doc) => {
                    const messageData = doc.data();
                    olderMessages.push({
                        id: doc.id,
                        ...messageData
                    });
                });
                
                // Sort messages by timestamp (oldest first)
                olderMessages.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return a.createdAt.seconds - b.createdAt.seconds;
                    }
                    return 0;
                });
                
                // Get current scroll position and height for maintaining position
                const chatContainer = document.querySelector('.chat-messages-container');
                const oldScrollHeight = chatContainer.scrollHeight;
                const oldScrollTop = chatContainer.scrollTop;
                
                // Update cache with older messages
                messagesCache[groupId] = [...olderMessages, ...messagesCache[groupId]];
                
                // Increment page
                currentPage++;
                
                // Redisplay messages
                displayCachedMessages(groupId, false);
                
                // Maintain scroll position
                setTimeout(() => {
                    const newScrollHeight = chatContainer.scrollHeight;
                    chatContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                }, 100);
                
            } catch (error) {
                console.error("Load more messages error:", error);
                showNotification("Erreur lors du chargement des messages prcdents", "error");
                
                // Reset button state
                if (loadMoreBtn) {
                    loadMoreBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Messages prcdents';
                    loadMoreBtn.disabled = false;
                }
            }
        }
        
        function listenForNewMessages(groupId) {
            if (chatUnsubscribers[groupId]) {
                return; // Already listening
            }
            
            const messagesRef = collection(db, "groups", groupId, "messages");
            let lastMessageTime = null;
            
            // Get timestamp of most recent message to avoid duplication
            if (messagesCache[groupId] && messagesCache[groupId].length > 0) {
                const messages = messagesCache[groupId];
                const latestMessage = messages[messages.length - 1];
                if (latestMessage && latestMessage.createdAt) {
                    lastMessageTime = latestMessage.createdAt;
                }
            }
            
            let q;
            if (lastMessageTime) {
                q = query(
                    messagesRef,
                    orderBy("createdAt", "asc"),
                    startAfter(lastMessageTime)
                );
            } else {
                q = query(
                    messagesRef,
                    orderBy("createdAt", "asc"),
                    limit(1)
                );
            }
            
            chatUnsubscribers[groupId] = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) return;
                
                let hasNewMessages = false;
                
                // Process only the new messages
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const messageData = change.doc.data();
                        const messageId = change.doc.id;
                        
                        // Check if we've already processed this message (deduplication)
                        if (messageId === lastProcessedMessageId) {
                            return;
                        }
                        
                        lastProcessedMessageId = messageId;
                        
                        // Create message object
                        const message = {
                            id: messageId,
                            ...messageData
                        };
                        
                        // Add to cache
                        if (messagesCache[groupId]) {
                            // Make sure we don't already have this message
                            if (!messagesCache[groupId].some(m => m.id === messageId)) {
                                messagesCache[groupId].push(message);
                                hasNewMessages = true;
                            }
                        } else {
                            messagesCache[groupId] = [message];
                            hasNewMessages = true;
                        }
                    }
                });
                
                // If we got new messages, update the UI
                if (hasNewMessages) {
                    // Display the new message
                    appendNewMessages(groupId);
                    
                    // Update total message count
                    totalMessages = messagesCache[groupId].length;
                }
            });
        }
        
        function appendNewMessages(groupId) {
            if (!messagesCache[groupId]) return;
            
            const messages = messagesCache[groupId];
            const messagesContainer = document.getElementById('chat-messages');
            
            if (!messagesContainer) return;
            
            // Get the last displayed message to check date separator
            const lastMessageElements = messagesContainer.querySelectorAll('.message-container');
            const lastMessageElement = lastMessageElements[lastMessageElements.length - 1];
            
            let lastDate = null;
            if (lastMessageElement) {
                const lastMessageTime = lastMessageElement.getAttribute('data-time');
                if (lastMessageTime) {
                    lastDate = new Date(parseInt(lastMessageTime));
                }
            }
            
            // Find the latest message that isn't already displayed
            let startIndex = 0;
            if (lastMessageElement) {
                const lastMessageId = lastMessageElement.getAttribute('data-id');
                if (lastMessageId) {
                    const lastIndex = messages.findIndex(m => m.id === lastMessageId);
                    if (lastIndex !== -1) {
                        startIndex = lastIndex + 1;
                    }
                }
            }
            
            // Display any new messages
            for (let i = startIndex; i < messages.length; i++) {
                const message = messages[i];
                
                // Check if this message is already displayed
                if (document.querySelector(`.message-container[data-id="${message.id}"]`)) {
                    continue;
                }
                
                // Insert date separator if needed
                if (message.createdAt) {
                    const messageDate = message.createdAt.toDate ? 
                        message.createdAt.toDate() : 
                        new Date(message.createdAt);
                    
                    const formattedDate = messageDate.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    // Capitalize first letter
                    const capitalizedDate = formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
                    
                    if (!lastDate || !isSameDay(lastDate, messageDate)) {
                        const dateElement = document.createElement('div');
                        dateElement.className = 'date-separator';
                        dateElement.innerHTML = `<span class="date-separator-text">${capitalizedDate}</span>`;
                        messagesContainer.appendChild(dateElement);
                        
                        lastDate = messageDate;
                    }
                }
                
                // Add message element
                const messageElement = createMessageElement(message, i === messages.length - 1);
                messagesContainer.appendChild(messageElement);
            }
            
            // Scroll to bottom if user is already at bottom
            const chatContainer = document.querySelector('.chat-messages-container');
            if (chatContainer) {
                const isAtBottom = chatContainer.scrollHeight - chatContainer.clientHeight <= chatContainer.scrollTop + 100;
                
                if (isAtBottom) {
                    scrollChatToBottom();
                }
            }
        }
        
        function createMessageElement(message, isLatest = false) {
            const container = document.createElement('div');
            const isSentByMe = message.senderId === currentUser.uid;
            
            container.className = `message-container ${isSentByMe ? 'sent' : 'received'}`;
            container.setAttribute('data-id', message.id);
            
            if (message.createdAt) {
                const timestamp = message.createdAt.toDate ? 
                    message.createdAt.toDate().getTime() : 
                    new Date(message.createdAt).getTime();
                
                container.setAttribute('data-time', timestamp);
            }
            
            // Format message time
            let messageTime = 'Rcemment';
            if (message.createdAt) {
                const date = message.createdAt.toDate ? 
                    message.createdAt.toDate() : 
                    new Date(message.createdAt);
                
                messageTime = date.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // Get sender name from users map or use fallback
            let senderName = message.senderName || 'Utilisateur';
            
            // Don't show sender name for own messages
            const senderElement = isSentByMe ? '' : `<div class="message-sender sender-${message.senderId}">${senderName}</div>`;
            
            let messageContent = '';
            
            // Handle replies
            let replyElement = '';
            if (message.replyTo) {
                replyElement = `
                    <div class="message-quote">
                        <div class="message-quote-sender">${message.replyTo.sender}</div>
                        <div class="message-quote-content">${message.replyTo.text}</div>
                    </div>
                `;
            }
            
            // Handle image messages
            if (message.imageData) {
                const messageText = message.text || '';
                
                messageContent = `
                    <div class="message-with-image" data-id="${message.id}" data-from="${message.senderId}">
                        <img src="${message.imageData}" class="message-image" alt="Image">
                        ${messageText ? `<div class="message-text">${messageText}</div>` : ''}
                    </div>
                `;
            } else {
                // Text-only message
                messageContent = `
                    <div class="message ${isSentByMe ? 'message-sent' : 'message-received'}" data-id="${message.id}" data-from="${message.senderId}">
                        ${message.text || ''}
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${senderElement}
                ${replyElement}
                ${messageContent}
                <div class="message-time">${messageTime}</div>
            `;
            
            // Add click handler for image viewing
            const imageElement = container.querySelector('.message-image');
            if (imageElement) {
                imageElement.addEventListener('click', () => {
                    showImageViewer(message.imageData);
                });
            }
            
            return container;
        }
        
        function scrollChatToBottom() {
            const chatContainer = document.querySelector('.chat-messages-container');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        async function sendMessage() {
            if (!currentGroupId) return;
            
            const messageText = document.getElementById('chat-input').value.trim();
            const hasImage = chatImageFile !== null;
            
            // Don't send if there's nothing to send
            if (!messageText && !hasImage) return;
            
            // Check if user has permission to send messages
            if (currentGroupData && currentGroupData.allowPublicMessages === false) {
                const isGroupAdmin = isAdmin || (currentGroupData.admins && currentGroupData.admins.includes(currentUser.uid));
                if (!isGroupAdmin) {
                    showNotification("Vous n'avez pas la permission d'envoyer des messages dans ce groupe", "error");
                    return;
                }
            }
            
            // Clear input and image
            document.getElementById('chat-input').value = '';
            const imageButton = document.getElementById('image-button');
            if (imageButton) {
                imageButton.style.color = '';
            }
            
            const imageToSend = chatImageFile;
            chatImageFile = null;
            
            // Get reply data and reset
            const replyData = replyingToMessage;
            cancelReply();
            
            // Adjust textarea height
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
            
            if (!isOnline) {
                // Queue message for later
                messageQueue.push({
                    groupId: currentGroupId,
                    text: messageText,
                    imageData: imageToSend,
                    replyTo: replyData
                });
                
                showNotification("Message en attente de connexion", "info");
                return;
            }
            
            try {
                await sendMessageToFirestore(currentGroupId, messageText, imageToSend, replyData);
            } catch (error) {
                console.error("Send message error:", error);
                
                // Queue message if failed
                messageQueue.push({
                    groupId: currentGroupId,
                    text: messageText,
                    imageData: imageToSend,
                    replyTo: replyData
                });
                
                showNotification("Impossible d'envoyer le message maintenant. Il sera envoy ultrieurement.", "error");
            }
        }
        
        async function sendMessageToFirestore(groupId, text, imageData, replyTo) {
            try {
                const messageData = {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUserData.displayName || currentUser.email?.split('@')[0] || 'Utilisateur',
                    createdAt: serverTimestamp(),
                    imageData: imageData || null,
                    replyTo: replyTo || null
                };
                
                const messagesRef = collection(db, "groups", groupId, "messages");
                await addDoc(messagesRef, messageData);
                
                // Update group's last message
                const groupRef = doc(db, "groups", groupId);
                await updateDoc(groupRef, {
                    lastMessage: text || (imageData ? '[Image]' : 'Message'),
                    lastMessageTime: serverTimestamp()
                });
                
                return true;
            } catch (error) {
                console.error("Send message to Firestore error:", error);
                throw error;
            }
        }
        
        function updateProfileInfo() {
            const profileNameElement = document.getElementById('profile-name-text');
            const profileEmailElement = document.getElementById('profile-email');
            const adminBadgeElement = document.getElementById('admin-badge');
            const profilePicElement = document.querySelector('.profile-header .profile-pic');
            
            if (profileNameElement) {
                profileNameElement.textContent = currentUserData.displayName || currentUser.email?.split('@')[0] || 'Utilisateur';
            }
            
            if (profileEmailElement) {
                profileEmailElement.textContent = currentUser.email || 'email@example.com';
            }
            
            if (adminBadgeElement) {
                if (isAdmin) {
                    adminBadgeElement.style.display = 'inline-block';
                } else {
                    adminBadgeElement.style.display = 'none';
                }
            }
            
            if (profilePicElement) {
                if (currentUserData.photoURL) {
                    profilePicElement.innerHTML = `
                        <img src="${currentUserData.photoURL}" alt="Profile">
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                } else {
                    profilePicElement.innerHTML = `
                        <i class="fas fa-user"></i>
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                }
                
                document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            }
        }
        
        async function getCurrentUser() {
            if (!currentUser) return null;
            
            try {
                const userDocRef = doc(db, "Users", currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                
                if (userSnap.exists()) {
                    return userSnap.data();
                } else {
                    // User doc doesn't exist, create it
                    const userData = {
                        email: currentUser.email,
                        displayName: currentUser.email?.split('@')[0] || 'Utilisateur',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    };
                    
                    await setDoc(userDocRef, userData);
                    return userData;
                }
            } catch (error) {
                console.error("Get user error:", error);
                return null;
            }
        }
        
        async function checkAdminStatus() {
            if (!currentUser) return false;
            
            try {
                const adminsRef = doc(db, "admins", "adminsList");
                const adminsSnap = await getDoc(adminsRef);
                
                if (adminsSnap.exists()) {
                    const adminsList = adminsSnap.data().admins || [];
                    return adminsList.includes(currentUser.uid);
                }
                
                return false;
            } catch (error) {
                console.error("Check admin error:", error);
                return false;
            }
        }
        
        // Main function to initialize the app
        async function initApp() {
            setupDarkMode();
            setupConnectionMonitoring();
            setupAuthEvents();
            setupUIEvents();
            setupTextareaAutoResize();
            loadUserPreferences();
            
            // Show loading animation initially
            document.getElementById('loading').style.display = 'flex';
            
            onAuthStateChanged(auth, async (user) => {
                // Hide verification animation
                document.getElementById('verify-animation').style.display = 'none';
                
                if (user) {
                    // User is signed in
                    currentUser = user;
                    isLoggedIn = true;
                    
                    // Get user data and admin status
                    currentUserData = await getCurrentUser();
                    isAdmin = await checkAdminStatus();
                    
                    // Update admin badge if user is admin
                    if (isAdmin && currentUserData) {
                        // Update user document with admin status
                        try {
                            const userRef = doc(db, "Users", user.uid);
                            await updateDoc(userRef, { isAdmin: true });
                            currentUserData.isAdmin = true;
                        } catch (error) {
                            // Ignore error
                        }
                    }
                    
                    // Update user's lastLogin
                    try {
                        const userRef = doc(db, "Users", user.uid);
                        await updateDoc(userRef, { lastLogin: serverTimestamp() });
                    } catch (error) {
                        // Ignore error
                    }
                    
                    // Update profile info
                    updateProfileInfo();
                    
                    // Hide auth screen, show app
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('loading').style.display = 'none';
                    
                    // Set fab visibility based on admin status
                    const createGroupBtn = document.getElementById('create-group-btn');
                    if (createGroupBtn) {
                        if (!isAdmin) {
                            createGroupBtn.classList.add('disabled');
                        } else {
                            createGroupBtn.classList.remove('disabled');
                        }
                    }
                    
                    // Load initial groups
                    loadGroups();
                    
                    // Load events timestamp
                    loadLastViewedEventTimestamp();
                    
                    // Check for new events
                    checkForNewEvents();
                    
                    // Set create notification button visibility
                    const createNotifBtn = document.getElementById('create-notification-btn');
                    if (createNotifBtn) {
                        if (isAdmin) {
                            createNotifBtn.style.display = 'flex';
                        } else {
                            createNotifBtn.style.display = 'none';
                        }
                    }
                    
                } else {
                    // User is signed out
                    currentUser = null;
                    isLoggedIn = false;
                    
                    // Show auth screen, hide app
                    document.getElementById('auth-screen').style.display = 'flex';
                    document.getElementById('loading').style.display = 'none';
                    
                    // Clear current page
                    document.querySelectorAll('.section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById('groups-section').classList.add('active');
                    currentSection = 'groups';
                    
                    // Clear chat interface
                    document.getElementById('chat-interface').style.display = 'none';
                    
                    // Reset header
                    document.getElementById('header-menu-button').style.display = 'block';
                    document.getElementById('header-back-button').style.display = 'none';
                    document.getElementById('header-title').textContent = 'Groupes';
                    
                    document.getElementById('header-action').innerHTML = `
                        <div class="search-button" id="search-button">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="events-button" id="events-button">
                            <i class="fas fa-bell"></i>
                            <div class="notification-dot" id="events-notification-dot"></div>
                        </div>
                    `;
                    
                    // Reset state
                    currentGroupId = null;
                    currentGroup = '';
                    currentGroupData = null;
                    
                    // Clear any errors
                    hideLog('login-log');
                    hideLog('register-log');
                    
                    // Cleanup listeners
                    cleanupListeners();
                }
            });
        }
        
        // Initialize app
        initApp();
    </script>
</body>
</html>

