<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pari Alliance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            /* Thème par défaut (bleu) */
            --primary-color: #5D5CDE;
            --text-color: #000000;
            --bg-color: #ffffff;
            --border-color: #dddfe2;
            --secondary-color: #f0f2f5;
            --chat-sent-bg: #5D5CDE;
            --chat-sent-text: #ffffff;
            --chat-received-bg: #f0f2f5;
            --selection-color: rgba(93, 92, 222, 0.3);
            --action-menu-bg: rgba(0, 0, 0, 0.9);
            --action-menu-text: #ffffff;
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(255, 255, 255, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.1);
            --group-icon-bg: #4CAF50;
            --danger-color: #ff4842;
            --success-color: #4caf50;
            --input-bg: #f0f2f5;
            --input-placeholder: #8e8e93;
            --button-text: #000000;
            --inactive-text: #8e8e93;
            --link-color: #007aff;
            --admin-badge-bg: #5D5CDE;
            --admin-badge-text: white;
            --log-bg: rgba(0, 0, 0, 0.8);
            --log-text: #ffffff;
            --log-info: #2196F3;
            --log-warning: #FFC107;
            --log-error: #FF5252;
            --log-success: #4CAF50;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --event-bg: #f1f1f1;
            --event-border: #e0e0e0;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #ffffff;
            --side-menu-active: #f0f2f5;
            --side-menu-hover: #f5f5f5;
            --log-panel-bg: #f8f9fa;
            --log-panel-border: #e0e0e0;
            --link-hover: #0056b3;
            --admin-notif-bg: #f8f9fa;
            --admin-notif-border: #e0e0e0;
            --forecast-win-bg: rgba(76, 175, 80, 0.2);
            --forecast-loss-bg: rgba(244, 67, 54, 0.2);
            --forecast-pending-bg: rgba(255, 193, 7, 0.2);
            --comment-bg: #f5f5f5;
            --comment-border: #ebebeb;
            --social-whatsapp: #25D366;
            --social-telegram: #0088cc;
            --social-youtube: #FF0000;
            --partner-google: #4285F4;
            --partner-firebase: #FFCA28;
            --partner-github: #333333;
            --partner-quora: #B92B27;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.1);
            --warning-text: #FF9800;
            --image-message-bg: rgba(93, 92, 222, 0.1);
            --image-viewer-bg: rgba(0, 0, 0, 0.9);
            --selected-message-border: rgba(93, 92, 222, 0.7);
            --date-separator-bg: rgba(0, 0, 0, 0.05);
            --date-separator-text: var(--inactive-text);
            --reply-preview-bg: rgba(93, 92, 222, 0.1);
            --reply-preview-border: var(--primary-color);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(0, 0, 0, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: var(--bg-color);
            --action-bar-text: var(--text-color);
            --action-bar-border: var(--border-color);
            --reply-quote-bg: rgba(93, 92, 222, 0.15);
            --reply-quote-border: var(--primary-color);
            --group-info-bg: var(--bg-color);
            --group-info-border: var(--border-color);
            --download-btn-bg: var(--primary-color);
            --download-btn-text: white;
            --new-badge-bg: var(--primary-color);
            --new-badge-text: white;
            --theme-selector-border: #ddd;
            --user-item-bg: var(--bg-color);
            --unread-badge-bg: #FF4842;
            --unread-badge-text: white;
        }
        
        /* Thème vert */
        .theme-green {
            --primary-color: #4CAF50;
            --chat-sent-bg: #4CAF50;
            --selection-color: rgba(76, 175, 80, 0.3);
            --admin-badge-bg: #4CAF50;
            --reply-preview-bg: rgba(76, 175, 80, 0.1);
            --reply-preview-border: #4CAF50;
            --reply-quote-bg: rgba(76, 175, 80, 0.15);
            --reply-quote-border: #4CAF50;
            --download-btn-bg: #4CAF50;
            --new-badge-bg: #4CAF50;
            --image-message-bg: rgba(76, 175, 80, 0.1);
            --selected-message-border: rgba(76, 175, 80, 0.7);
        }
        
        /* Thème rouge */
        .theme-red {
            --primary-color: #F44336;
            --chat-sent-bg: #F44336;
            --selection-color: rgba(244, 67, 54, 0.3);
            --admin-badge-bg: #F44336;
            --reply-preview-bg: rgba(244, 67, 54, 0.1);
            --reply-preview-border: #F44336;
            --reply-quote-bg: rgba(244, 67, 54, 0.15);
            --reply-quote-border: #F44336;
            --download-btn-bg: #F44336;
            --new-badge-bg: #F44336;
            --image-message-bg: rgba(244, 67, 54, 0.1);
            --selected-message-border: rgba(244, 67, 54, 0.7);
        }
        
        /* Thème orange */
        .theme-orange {
            --primary-color: #FF9800;
            --chat-sent-bg: #FF9800;
            --selection-color: rgba(255, 152, 0, 0.3);
            --admin-badge-bg: #FF9800;
            --reply-preview-bg: rgba(255, 152, 0, 0.1);
            --reply-preview-border: #FF9800;
            --reply-quote-bg: rgba(255, 152, 0, 0.15);
            --reply-quote-border: #FF9800;
            --download-btn-bg: #FF9800;
            --new-badge-bg: #FF9800;
            --image-message-bg: rgba(255, 152, 0, 0.1);
            --selected-message-border: rgba(255, 152, 0, 0.7);
        }
        
        .dark {
            --bg-color: #181818;
            --text-color: #ffffff;
            --border-color: #3e4042;
            --secondary-color: #2c2c2c;
            --chat-received-bg: #2c2c2c;
            --chat-sent-text: #ffffff;
            --selection-color: rgba(93, 92, 222, 0.4);
            --action-menu-bg: rgba(60, 60, 60, 0.95);
            --highlight-color: #FFEB3B;
            --blocked-color: #ff6b6b;
            --reaction-bg: rgba(40, 40, 40, 0.9);
            --reaction-shadow: rgba(0, 0, 0, 0.3);
            --group-icon-bg: #388E3C;
            --danger-color: #ff6b6b;
            --success-color: #66bb6a;
            --input-bg: #2c2c2c;
            --input-placeholder: #6c6c6c;
            --link-color: #2196F3;
            --admin-badge-text: white;
            --log-bg: rgba(20, 20, 20, 0.9);
            --log-info: #64B5F6;
            --log-warning: #FFD54F;
            --log-error: #FF8A80;
            --log-success: #81C784;
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --event-bg: #2a2a2a;
            --event-border: #3e3e3e;
            --restricted-badge-bg: #FFC107;
            --restricted-badge-text: #000000;
            --side-menu-bg: #222222;
            --side-menu-active: #333333;
            --side-menu-hover: #2a2a2a;
            --log-panel-bg: #222222;
            --log-panel-border: #3e3e3e;
            --link-hover: #64B5F6;
            --admin-notif-bg: #2a2a2a;
            --admin-notif-border: #333333;
            --forecast-win-bg: rgba(76, 175, 80, 0.15);
            --forecast-loss-bg: rgba(244, 67, 54, 0.15);
            --forecast-pending-bg: rgba(255, 193, 7, 0.15);
            --comment-bg: #2a2a2a;
            --comment-border: #333333;
            --notification-dot: #FF4842;
            --warning-bg: rgba(255, 152, 0, 0.15);
            --warning-text: #FFA726;
            --image-message-bg: rgba(93, 92, 222, 0.15);
            --image-viewer-bg: rgba(0, 0, 0, 0.95);
            --selected-message-border: rgba(93, 92, 222, 0.8);
            --date-separator-bg: rgba(255, 255, 255, 0.1);
            --date-separator-text: #aaaaaa;
            --reply-preview-bg: rgba(93, 92, 222, 0.15);
            --reply-preview-text: var(--text-color);
            --deleted-message-bg: rgba(255, 255, 255, 0.05);
            --deleted-message-text: #888888;
            --action-bar-bg: #222222;
            --action-bar-text: #ffffff;
            --action-bar-border: #3e3e3e;
            --reply-quote-bg: rgba(93, 92, 222, 0.2);
            --group-info-bg: #222222;
            --group-info-border: #3e3e3e;
            --download-btn-text: white;
            --theme-selector-border: #444;
            --user-item-bg: #222222;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: -0.2px;
        }
        
        .side-menu {
            position: fixed;
            top: 0;
            left: -250px;
            height: 100%;
            width: 250px;
            background-color: var(--side-menu-bg);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .side-menu.active {
            left: 0;
        }
        
        .side-menu-header {
            display: flex;
            align-items: center;
            padding: 20px 15px;
            border-bottom: none;
        }
        
        .side-menu-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 15px;
        }
        
        .side-menu-close {
            font-size: 20px;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }
        
        .side-menu-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .side-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .side-menu-item.active {
            background-color: var(--side-menu-active);
        }
        
        .side-menu-item i {
            font-size: 20px;
            width: 30px;
            color: var(--primary-color);
        }
        
        .side-menu-text {
            margin-left: 15px;
            font-weight: 500;
        }
        
        .side-menu-footer {
            margin-top: auto;
        }
        
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        .side-menu-overlay.active {
            display: block;
        }
        
        .header {
            background-color: var(--bg-color);
            border-bottom: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .header.search-active {
            height: 50px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            transition: opacity 0.3s ease;
        }
        
        .header-title {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
            border-bottom: none;
            text-decoration: none;
            transition: opacity 0.3s ease;
            flex: 1;
        }
        
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
            transition: opacity 0.3s ease;
        }
        
        .menu-button, .back-button, .search-button, .events-button, .info-button {
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        
        .menu-button:active, .back-button:active, .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        .notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background-color: var(--notification-dot);
            border-radius: 50%;
            display: none;
        }
        
        .notification-dot.active {
            display: block;
        }
        
        .events-button {
            position: relative;
        }
        
        .search-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .search-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 18px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            color: var(--text-color);
            outline: none;
            margin-right: 10px;
            transition: background-color 0.2s ease;
        }
        
        .search-close {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-close:active {
            background-color: var(--secondary-color);
        }
        
        .header.search-active .header-left,
        .header.search-active .header-title,
        .header.search-active #header-action {
            opacity: 0;
            pointer-events: none;
        }

        /* Debug log panel */
        .debug-log-panel {
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            max-height: 200px;
            background-color: var(--log-panel-bg);
            border: 1px solid var(--log-panel-border);
            border-radius: 8px;
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .debug-log-panel.active {
            display: flex;
        }

        .debug-log-header {
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debug-log-close {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .debug-log-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .debug-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .debug-log-item {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            border-left: 3px solid;
        }

        .debug-log-item.error {
            background-color: rgba(244, 67, 54, 0.1);
            border-left-color: var(--log-error);
            color: var(--log-error);
        }

        .debug-log-item.warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-left-color: var(--log-warning);
            color: var(--log-warning);
        }

        .debug-log-item.info {
            background-color: rgba(33, 150, 243, 0.1);
            border-left-color: var(--log-info);
            color: var(--log-info);
        }

        .debug-log-item.success {
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: var(--log-success);
            color: var(--log-success);
        }

        .debug-log-timestamp {
            font-size: 10px;
            opacity: 0.7;
            margin-right: 5px;
        }

        .debug-log-link {
            color: var(--link-color);
            text-decoration: underline;
            cursor: pointer;
            word-break: break-all;
        }

        .debug-log-link:hover {
            color: var(--link-hover);
        }

        .debug-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--log-error);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }

        .debug-toggle-btn.active {
            display: flex;
        }

        .debug-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        /* Message actions header bar */
        .message-actions-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: var(--action-bar-bg);
            border-bottom: none;
            display: flex;
            align-items: center;
            padding: 0 15px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-5px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
        }
        
        .message-actions-container.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        
        .message-actions-title {
            flex: 1;
            font-weight: 500;
            color: var(--action-bar-text);
        }
        
        .message-action-buttons {
            display: flex;
            gap: 15px;
        }
        
        .message-action-btn {
            padding: 8px;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .message-action-btn:active {
            background-color: var(--secondary-color);
        }
        
        .message-action-btn.delete {
            color: var(--danger-color);
        }
        
        .content {
            position: fixed;
            top: 50px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: var(--bg-color);
        }
        
        .content.no-bottom-nav {
            bottom: 0;
        }
        
        .bottom-nav {
            background-color: var(--bg-color);
            border-top: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            z-index: 10;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--inactive-text);
            font-size: 10px;
            cursor: pointer;
            height: 100%;
            padding: 8px 0;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .section {
            padding: 10px 0;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        .profile-pic-edit:hover, .profile-pic-edit:active {
            transform: scale(1.1);
        }
        
        .group-pic {
            width: 50px;
            height: 50px;
            background-color: var(--group-icon-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .group-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-pic-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
            z-index: 2;
        }
        
        .group-pic-edit:hover, .group-pic-edit:active {
            transform: scale(1.1);
        }
        
        .chat-item, .user-item, .event-item {
            display: flex;
            padding: 12px 16px;
            border-bottom: none;
            align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease, opacity 0.4s ease;
        }
        
        .chat-item.selected, .user-item.selected {
            background-color: var(--selection-color);
        }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .item-subtitle {
            color: #6b7280;
            font-size: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-time {
            color: #6b7280;
            font-size: 12px;
        }
        
        .item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .admin-badge {
            display: inline-block;
            background-color: var(--admin-badge-bg);
            color: var(--admin-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .restricted-badge {
            display: inline-block;
            background-color: var(--restricted-badge-bg);
            color: var(--restricted-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .new-badge {
            display: inline-block;
            background-color: var(--new-badge-bg);
            color: var(--new-badge-text);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .unread-badge {
            display: inline-block;
            background-color: var(--unread-badge-bg);
            color: var(--unread-badge-text);
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 50%;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        
        .loading-spinner {
            font-size: 60px;
            color: var(--primary-color);
            animation: pulse 2s infinite, bounce 1.5s infinite;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        .settings-container {
            padding: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: none;
            cursor: pointer;
        }
        
        .setting-icon {
            width: 36px;
            height: 36px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.15s ease, opacity 0.2s ease, background-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .button:hover {
            background-color: #4a49c0;
        }

        .button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .button.danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .button.danger:hover {
            background-color: #e53935;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        .chat-section {
            display: none;
            position: fixed;
            top: 50px;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            z-index: 5;
        }
        
        .chat-messages-container {
            position: absolute;
            top: 0;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            background-color: var(--secondary-color);
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            justify-content: flex-end;
        }
        
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            padding: 10px;
            background-color: var(--bg-color);
            border-top: none;
            align-items: flex-end;
            min-height: 60px;
            max-height: 150px;
            transition: min-height 0.2s ease;
        }
        
        .message-container {
            margin-bottom: 16px;
            clear: both;
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }
        
        .message-container.sent {
            float: right;
            margin-left: auto;
            align-items: flex-end;
        }
        
        .message-container.received {
            float: left;
            margin-right: auto;
            align-items: flex-start;
        }
        
        .message-sender {
            font-size: 12px;
            margin-bottom: 2px;
            font-weight: bold;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .message {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            transition: background-color 0.2s ease, transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .message-received {
            background-color: var(--chat-received-bg);
            border-bottom-left-radius: 4px;
        }
        
        .message-sent {
            background-color: var(--chat-sent-bg);
            color: var(--chat-sent-text);
            border-bottom-right-radius: 4px;
        }

        /* Improved visual marking for selected messages */
        .message.selected {
            box-shadow: 0 0 0 2px var(--selected-message-border);
        }
        
        /* Style for deleted messages */
        .message.deleted {
            background-color: var(--deleted-message-bg);
            color: var(--deleted-message-text);
            font-style: italic;
        }
        
        .message-time {
            font-size: 10px;
            margin-top: 2px;
            opacity: 0.7;
        }
        
        .chat-input-wrapper {
            flex: 1;
            margin: 0 10px;
            position: relative;
        }
        
        /* Improved input field style */
        .chat-input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            background-color: var(--secondary-color);
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            font-weight: 400;
            outline: none;
            min-height: 40px;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            vertical-align: middle;
        }
        
        .send-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .send-button:active {
            transform: scale(0.9);
        }
        
        .send-button:hover {
            background-color: #4a49c0;
        }

        .send-button:disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .image-button {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }
        
        .image-button:active {
            transform: scale(0.9);
        }

        .image-button:disabled {
            color: var(--inactive-text);
            cursor: not-allowed;
        }
        
        .profile-header {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            border-bottom: none;
        }
        
        .profile-header .profile-pic {
            width: 80px;
            height: 80px;
            margin-right: 20px;
        }
        
        .profile-header .profile-pic i {
            font-size: 30px;
            color: var(--primary-color);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .profile-email {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .profile-status {
            color: #6b7280;
        }
        
        .profile-edit {
            color: var(--primary-color);
            font-size: 14px;
            margin-top: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 8px;
            border-radius: 15px;
        }
        
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .auth-header {
            padding: 40px 0 20px;
            text-align: center;
        }
        
        .auth-logo {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .auth-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .auth-subtitle {
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
            padding: 0 20px;
            text-align: center;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: none;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
            text-decoration: none;
            border-bottom: none;
        }
        
        .auth-tab.active {
            color: var(--primary-color);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        .auth-form {
            padding: 20px;
            display: none;
            animation: fadeUp 0.5s ease;
        }
        
        @keyframes fadeUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            font-size: 16px;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .form-input::placeholder {
            color: var(--input-placeholder);
        }
        
        .form-error {
            color: var(--danger-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
            animation: shakeX 0.75s ease;
        }
        
        @keyframes shakeX {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        .form-footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .form-footer-text {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .form-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .form-link:hover {
            text-decoration: underline;
        }

        .log-message {
            margin-top: 15px;
            padding: 12px;
            font-weight: bold;
            border-radius: 6px;
            white-space: pre-line;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
          
        .log-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
          
        .log-message.success {
            background: #d4edda;
            color: #155724;
        }
          
        .log-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--inactive-text);
        }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .btn-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .button.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .button.loading .btn-text {
            visibility: hidden;
        }
        
        .button.loading .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
            visibility: visible;
        }
        
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            line-height: 1.4;
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .notification.success {
            background-color: var(--bg-color);
            color: var(--success-color);
        }

        .notification.error {
            background-color: var(--bg-color);
            color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }
        
        .verify-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .football-bounce {
            font-size: 80px;
            color: var(--primary-color);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-40px); }
            60% { transform: translateY(-20px); }
        }

        .verify-text {
            margin-top: 30px;
            font-size: 16px;
            color: var(--text-color);
            opacity: 0.8;
            text-align: center;
        }
        
        @keyframes deleteMessage {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            20% {
                opacity: 0.8;
                transform: scale(0.95);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
                height: 0;
                margin: 0;
                padding: 0;
            }
        }
        
        .message.deleting {
            animation: deleteMessage 0.3s ease forwards;
            pointer-events: none;
        }
        
        .create-group-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 100;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .create-group-dialog.active {
            display: flex;
        }
        
        .create-group-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: none;
        }
        
        .create-group-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .create-group-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .create-group-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-form {
            display: flex;
            flex-direction: column;
        }
        
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-dialog.active {
            display: flex;
        }
        
        .edit-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: none;
        }
        
        .edit-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .edit-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .edit-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--group-icon-bg);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .group-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .group-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .group-image-preview:hover .group-image-overlay {
            opacity: 1;
        }
        
        .group-image-overlay i {
            color: white;
            font-size: 20px;
        }
        
        .image-upload-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab:hover {
            background-color: #4a49c0;
        }

        .fab.disabled {
            background-color: var(--border-color);
            color: var(--inactive-text);
            cursor: not-allowed;
            box-shadow: none;
        }

        .fab.disabled:active {
            transform: none;
        }
        
        .fab i {
            font-size: 24px;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 85%;
            max-width: 300px;
            padding: 20px;
            z-index: 150;
            display: none;
        }
        
        .confirmation-dialog.active {
            display: block;
        }
        
        .confirmation-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .confirmation-button {
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            text-align: center;
        }
        
        .confirmation-cancel {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .confirmation-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        
        .confirmation-delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }

        .event-icon {
            width: 50px;
            height: 50px;
            background-color: var(--event-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            border: 1px solid var(--event-border);
        }
        
        .event-icon i {
            font-size: 22px;
            color: var(--primary-color);
        }

        .event-item {
            transition: none;
            cursor: default;
            position: relative;
        }

        .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .event-content {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
        }

        .event-time {
            font-size: 12px;
            color: var(--inactive-text);
            margin-top: 5px;
        }
        
        .admin-count-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 6px;
        }

        .event-item.group-create .event-icon {
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .event-item.group-create .event-icon i {
            color: var(--success-color);
        }
        
        .event-item.permission-change .event-icon {
            background-color: rgba(255, 193, 7, 0.2);
        }
        
        .event-item.permission-change .event-icon i {
            color: var(--restricted-badge-bg);
        }
        
        .event-item.user-join .event-icon {
            background-color: rgba(33, 150, 243, 0.2);
        }
        
        .event-item.user-join .event-icon i {
            color: var(--log-info);
        }

        .restricted-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        
        .profile-edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .profile-edit-dialog.active {
            display: flex;
        }
        
        .profile-image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .profile-image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .profile-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        
        .profile-image-preview i {
            font-size: 50px;
            color: var(--primary-color);
        }
        
        .profile-upload-btn {
            position: absolute;
            bottom: 10px;
            right: calc(50% - 60px);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        
        .profile-upload-btn:hover, .profile-upload-btn:active {
            transform: scale(1.1);
            background-color: #4a49c0;
        }

        input[type="file"] {
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            text-decoration: none;
            border-bottom: none;
            padding: 0 16px; 
            margin: 15px 0;
        }
        
        .field-error {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .save-field-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .save-field-btn:hover {
            background-color: #4a49c0;
        }
        
        .save-field-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .editable-field {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .editable-field-input {
            flex: 1;
        }
        
        .forecasts-section {
            padding: 0 0 15px 0;
        }
        
        .forecasts-tabs {
            display: flex;
            border-bottom: none;
            margin-bottom: 15px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .forecast-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            color: var(--inactive-text);
            transition: color 0.3s, background-color 0.2s ease;
        }
        
        .forecast-tab.active {
            color: var(--primary-color);
        }
        
        .forecast-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
            animation: slideIn 0.3s ease;
        }
        
        .forecasts-content {
            display: none;
            padding: 0 15px;
        }
        
        .forecasts-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .forecasts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .forecast-item {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .forecast-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .forecast-match {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .forecast-team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
        }
        
        .forecast-team-logo {
            width: 40px;
            height: 40px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .forecast-team-name {
            font-weight: 500;
            text-align: center;
            font-size: 14px;
        }
        
        .forecast-score {
            font-size: 22px;
            font-weight: bold;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        .forecast-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .forecast-status.pending {
            background-color: var(--forecast-pending-bg);
            color: var(--text-color);
        }
        
        .forecast-status.win {
            background-color: var(--forecast-win-bg);
            color: var(--text-color);
        }
        
        .forecast-status.loss {
            background-color: var(--forecast-loss-bg);
            color: var(--text-color);
        }
        
        .forecast-date {
            font-size: 12px;
            color: var(--inactive-text);
        }
        
        .forecast-confidence {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-color);
        }
        
        .confidence-bar-container {
            flex: 1;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .confidence-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .no-forecasts {
            text-align: center;
            padding: 30px 15px;
            color: var(--inactive-text);
        }
        
        .no-forecasts i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .admin-notification {
            background-color: var(--bg-color);
            border-radius: 15px;
            margin: 10px 15px 20px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .admin-notification-header {
            color: var(--text-color);
            padding: 0 0 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            margin-bottom: 10px;
        }
        
        .admin-notification-title {
            display: flex;
            align-items: center;
        }
        
        .admin-notification-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .admin-notification-content {
            padding: 5px 0;
            line-height: 1.4;
        }
        
        .admin-notification-footer {
            padding: 5px 0 0;
            font-size: 12px;
            color: var(--inactive-text);
            text-align: right;
            border-top: none;
            margin-top: 10px;
            padding-top: 8px;
        }
        
        .event-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .event-close-btn:hover, .event-close-btn:active {
            transform: scale(1.1);
        }
        
        .event-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        
        .event-action-btn {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.1s ease;
        }
        
        .event-action-btn:hover, .event-action-btn:active {
            transform: translateY(-1px);
        }
        
        .event-action-btn.delete {
            color: var(--danger-color);
        }
        
        .admin-notif-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .admin-notif-dialog.active {
            display: flex;
        }
        
        .score-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .score-option {
            padding: 5px 12px;
            border-radius: 15px;
            background-color: var(--bg-color);
            font-weight: bold;
            font-size: 14px;
            border: 1px solid var(--border-color);
            transition: transform 0.1s ease;
            cursor: pointer;
        }
        
        .score-option:hover, .score-option:active {
            transform: translateY(-1px);
        }

        .score-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #delete-account-confirmation .confirmation-text {
            color: var(--danger-color);
            font-weight: bold;
        }

        .social-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 0 15px;
            gap: 10px;
        }
        
        .social-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border-radius: 10px;
            background-color: var(--secondary-color);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .social-button:active {
            transform: scale(0.98);
        }
        
        .social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .social-button.whatsapp {
            color: var(--social-whatsapp);
        }
        
        .social-button.telegram {
            color: var(--social-telegram);
        }
        
        .social-button.youtube {
            color: var(--social-youtube);
        }

        .about-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .about-dialog.active {
            display: flex;
        }
        
        .about-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .about-logo {
            text-align: center;
            margin: 20px 0;
        }
        
        .about-logo i {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .about-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .about-version {
            text-align: center;
            font-size: 14px;
            color: var(--inactive-text);
            margin-bottom: 30px;
        }
        
        .about-section {
            margin-bottom: 25px;
        }
        
        .about-section-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .about-section-content {
            line-height: 1.5;
            font-size: 14px;
        }
        
        .about-footer {
            text-align: center;
            padding: 20px 0;
            font-size: 12px;
            color: var(--inactive-text);
            border-top: none;
            margin-top: auto;
        }
        
        @media (max-height: 640px) {
            .fab {
                bottom: 70px;
            }
        }
        
        @media (max-width: 380px) {
            .confirmation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .confirmation-button {
                width: 100%;
            }
        }
        
        .message-with-image {
            padding: 5px;
            border-radius: 18px;
            background-color: var(--image-message-bg);
            max-width: 100%;
        }
        
        .message-image {
            width: 100%;
            max-width: 250px;
            max-height: 250px;
            border-radius: 13px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            pointer-events: auto;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            object-fit: contain;
        }
        
        .message-image:hover {
            transform: scale(0.98);
        }
        
        .message-text {
            padding: 0 10px 5px;
            word-break: break-word;
        }
        
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--image-viewer-bg);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .image-viewer.active {
            display: flex;
        }
        
        .viewer-image-container {
            position: relative;
            max-width: 90%;
            max-height: 80vh;
            margin: 0 auto;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            object-fit: contain;
            pointer-events: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .viewer-close:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .terms-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .terms-dialog.active {
            display: flex;
        }
        
        .terms-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .terms-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: none;
        }
        
        .terms-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .terms-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .warning-box {
            background-color: var(--warning-bg);
            border-left: 4px solid var(--warning-text);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .warning-box i {
            color: var(--warning-text);
            margin-right: 10px;
        }
    
        #header-action {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-button, .events-button, .info-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .search-button:active, .events-button:active, .info-button:active {
            background-color: var(--secondary-color);
        }
        
        /* Improved search bar animation */
        @keyframes searchBarIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes searchBarOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-5px);
            }
        }
        
        .search-container.active {
            animation: searchBarIn 0.3s ease forwards;
        }
        
        .search-container.hiding {
            animation: searchBarOut 0.3s ease forwards;
        }
        
        /* Touch ripple effect for buttons */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Date separators in messages */
        .date-separator {
            text-align: center;
            margin: 20px 0;
            position: relative;
            user-select: none;
        }

        .date-separator:before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: var(--border-color);
            z-index: 1;
        }

        .date-separator-text {
            display: inline-block;
            position: relative;
            z-index: 2;
            background-color: var(--date-separator-bg);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            color: var(--date-separator-text);
            font-weight: 500;
        }

        /* Reply system */
        .reply-preview {
            background-color: var(--reply-preview-bg);
            border-left: 3px solid var(--reply-preview-border);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 14px;
            position: relative;
            display: none;
        }

        .reply-preview.active {
            display: block;
        }

        .reply-preview-header {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
        }

        .reply-preview-content {
            color: var(--reply-preview-text);
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .reply-preview-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            cursor: pointer;
            font-size: 10px;
        }

        .chat-input-wrapper.with-reply {
            display: flex;
            flex-direction: column;
        }

        /* Adaptations for reply mode */
        .chat-input-container.with-reply {
            min-height: 100px;
        }
        
        /* Expandable text input styling */
        .chat-input {
            resize: none;
            overflow-y: auto;
            transition: height 0.2s ease;
        }

        /* Improved message quote styling */
        .message-quote {
            margin-bottom: 8px;
            background-color: var(--reply-quote-bg);
            border-left: 3px solid var(--reply-quote-border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            position: relative;
        }
        
        .message-quote-sender {
            font-weight: bold;
            margin-bottom: 3px;
            color: var(--primary-color);
            font-size: 12px;
        }
        
        .message-quote-content {
            color: var(--text-color);
            opacity: 0.85;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Group info dialog */
        .group-info-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--group-info-bg);
            z-index: 120;
            display: none;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        
        .group-info-dialog.active {
            display: flex;
        }
        
        .group-info-header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: none;
        }
        
        .group-info-title {
            flex: 1;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            text-decoration: none;
            border-bottom: none;
        }
        
        .group-info-back {
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }
        
        .group-info-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .group-info-section {
            margin-bottom: 20px;
        }
        
        .group-info-section-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .group-info-detail {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .group-info-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .group-info-value {
            color: var(--text-color);
            line-height: 1.4;
        }
        
        .group-info-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .group-info-image {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .group-info-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }
        
        .group-info-image:hover img {
            transform: scale(1.05);
        }
        
        .group-info-image-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--border-color);
            opacity: 0.5;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            height: 100%;
        }
        
        .download-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: var(--download-btn-bg);
            color: var(--download-btn-text);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        
        .download-button:hover {
            transform: scale(1.1);
        }
        
        /* Ajout des styles pour la section des utilisateurs */
        #users-section {
            padding: 10px 0;
        }
        
        .users-list {
            display: flex;
            flex-direction: column;
        }
        
        .user-item {
            background-color: var(--user-item-bg);
            transition: background-color 0.2s ease;
        }
        
        .user-item:hover, .user-item:active {
            background-color: var(--selection-color);
        }
        
        .user-pic {
            width: 50px;
            height: 50px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            overflow: hidden;
        }
        
        .user-pic i {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .user-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Interface Theme Selector */
        .theme-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .theme-option {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            border: 2px solid var(--theme-selector-border);
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
        }
        
        .theme-option.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .theme-option.active:before {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        
        .theme-option.theme-blue {
            background-color: #5D5CDE;
        }
        
        .theme-option.theme-green {
            background-color: #4CAF50;
        }
        
        .theme-option.theme-red {
            background-color: #F44336;
        }
        
        .theme-option.theme-orange {
            background-color: #FF9800;
        }
        
        .theme-label {
            margin-top: 5px;
            font-size: 12px;
            text-align: center;
            font-weight: 500;
        }
        
        .interface-section {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin: 15px;
        }
        
        .interface-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--primary-color);
        }

        .discussion-type-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 6px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .discussion-type-badge.group {
            background-color: var(--success-color);
        }

        .discussion-type-badge.direct {
            background-color: #007aff;
        }
    </style>
</head>
<body>
    <div id="verify-animation" class="verify-animation">
        <div class="football-bounce">
            <i class="fas fa-futbol"></i>
        </div>
        <div class="verify-text">Vérification en cours...</div>
    </div>

    <!-- Debug Panel -->
    <div id="debug-log-panel" class="debug-log-panel">
        <div class="debug-log-header">
            <span>Debug Console</span>
            <span class="debug-log-close" id="debug-log-close">×</span>
        </div>
        <div class="debug-log-content" id="debug-log-content">
            <!-- Logs will be added here -->
        </div>
    </div>

    <div id="debug-toggle-btn" class="debug-toggle-btn">
        <i class="fas fa-bug"></i>
    </div>
    
    <div class="side-menu" id="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-close" id="side-menu-close">
                <i class="fas fa-times"></i>
            </div>
            <div class="side-menu-title">Pari Alliance</div>
        </div>
        <div class="side-menu-content">
            <div class="side-menu-item" id="menu-profile">
                <i class="fas fa-user"></i>
                <div class="side-menu-text">Profil</div>
            </div>
            <div class="side-menu-item" id="menu-interface">
                <i class="fas fa-paint-brush"></i>
                <div class="side-menu-text">Interface</div>
            </div>
            <div class="side-menu-item" id="menu-users">
                <i class="fas fa-address-book"></i>
                <div class="side-menu-text">Utilisateurs</div>
            </div>
        </div>
        <div class="side-menu-footer">
            <div class="side-menu-item" id="menu-terms">
                <i class="fas fa-file-alt"></i>
                <div class="side-menu-text">Conditions d'utilisation</div>
            </div>
            <div class="side-menu-item" id="menu-about">
                <i class="fas fa-info-circle"></i>
                <div class="side-menu-text">À propos</div>
            </div>
        </div>
    </div>
    
    <div class="side-menu-overlay" id="side-menu-overlay"></div>
    
    <div id="auth-screen" class="auth-screen" style="display: none;">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-futbol"></i>
            </div>
            <h1 class="auth-title">Pari Alliance</h1>
            <p class="auth-subtitle">Messagerie de groupe sécurisée</p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="login-tab">Connexion</div>
            <div class="auth-tab" id="register-tab">Inscription</div>
        </div>
        
        <div id="login-form" class="auth-form active">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="login-email" placeholder="Votre email">
                <div id="login-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="login-password" placeholder="Votre mot de passe">
                <div id="login-password-error" class="form-error">Le mot de passe est obligatoire</div>
            </div>
            
            <div id="login-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="loginBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Se connecter</span>
                </button>
                <p class="form-footer-text">
                    Vous n'avez pas de compte ? <a href="#" class="form-link" id="goto-register">S'inscrire</a>
                </p>
            </div>
        </div>
        
        <div id="register-form" class="auth-form">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="register-email" placeholder="Votre adresse email">
                <div id="register-email-error" class="form-error">Veuillez entrer un email valide</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mot de passe</label>
                <input type="password" class="form-input" id="register-password" placeholder="Créez un mot de passe sécurisé">
                <div id="register-password-error" class="form-error">Le mot de passe doit contenir au moins 6 caractères</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmer le mot de passe</label>
                <input type="password" class="form-input" id="register-confirm-password" placeholder="Confirmez votre mot de passe">
                <div id="register-confirm-password-error" class="form-error">Les mots de passe ne correspondent pas</div>
            </div>
            
            <div id="register-log" class="log-message" style="display:none;"></div>

            <div class="form-footer">
                <button class="button" id="registerBtn">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">S'inscrire</span>
                </button>
                <p class="form-footer-text">
                    Vous avez déjà un compte ? <a href="#" class="form-link" id="goto-login">Se connecter</a>
                </p>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <i class="fas fa-futbol loading-spinner"></i>
        <div style="font-weight: bold; font-size: 24px; color: var(--primary-color);">Pari Alliance</div>
        <div style="margin-top: 10px; color: #6b7280;">Chargement...</div>
    </div>

    <div class="header">
        <div class="header-left">
            <div id="header-menu-button" class="menu-button">
                <i class="fas fa-bars"></i>
            </div>
            <div id="header-back-button" class="back-button" style="display:none;">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        <div id="header-title" class="header-title">Discussions</div>
        <div id="header-action">
            <div class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </div>
            <div class="events-button" id="events-button">
                <i class="fas fa-bell"></i>
                <div class="notification-dot" id="events-notification-dot"></div>
            </div>
        </div>
        
        <div class="search-container" id="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Rechercher...">
            <div class="search-close" id="search-close">
                <i class="fas fa-times"></i>
            </div>
        </div>
        
        <!-- Message actions bar -->
        <div class="message-actions-container" id="message-actions-container">
            <div class="message-actions-title">1 message sélectionné</div>
            <div class="message-action-buttons">
                <div class="message-action-btn reply" id="action-reply-btn">
                    <i class="fas fa-reply"></i>
                </div>
                <div class="message-action-btn copy" id="action-copy-btn">
                    <i class="fas fa-copy"></i>
                </div>
                <div class="message-action-btn delete" id="action-delete-btn">
                    <i class="fas fa-trash"></i>
                </div>
                <div class="message-action-btn cancel" id="action-cancel-btn">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="discussions-section" class="section active">
            <div class="chat-list" id="discussions-list">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <div class="empty-state-title">Aucune discussion</div>
                    <div class="empty-state-text">Vos discussions apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="create-group-btn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div id="events-section" class="section">
            <div id="events-list">
                <div class="empty-state">
                    <i class="fas fa-bell"></i>
                    <div class="empty-state-title">Aucun événement</div>
                    <div class="empty-state-text">Les événements apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="close-events-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="fab" id="create-notification-btn" style="display: none; bottom: 150px;">
                <i class="fas fa-bullhorn"></i>
            </div>
        </div>
        
        <div id="users-section" class="section">
            <div class="users-list" id="users-list">
                <div class="empty-state">
                    <i class="fas fa-address-book"></i>
                    <div class="empty-state-title">Aucun utilisateur</div>
                    <div class="empty-state-text">Les utilisateurs apparaîtront ici</div>
                </div>
            </div>
            
            <div class="fab" id="close-users-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
        </div>
        
        <div id="interface-section" class="section">
            <div class="interface-section">
                <div class="interface-title">Thème de couleur</div>
                <div class="theme-selector">
                    <div class="theme-option theme-blue active" data-theme="default">
                        <div class="theme-label">Bleu</div>
                    </div>
                    <div class="theme-option theme-green" data-theme="green">
                        <div class="theme-label">Vert</div>
                    </div>
                    <div class="theme-option theme-red" data-theme="red">
                        <div class="theme-label">Rouge</div>
                    </div>
                    <div class="theme-option theme-orange" data-theme="orange">
                        <div class="theme-label">Orange</div>
                    </div>
                </div>
            </div>
            
            <div class="interface-section">
                <div class="interface-title">Mode d'affichage</div>
                <div class="setting-item">
                    <div class="setting-row">
                        <div class="setting-icon">
                            <i class="fas fa-moon" style="color: var(--primary-color);"></i>
                        </div>
                        <div class="setting-label">Mode sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="dark-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="fab" id="close-interface-btn" style="background-color: #f44336;">
                <i class="fas fa-arrow-left"></i>
            </div>
        </div>
        
        <div id="profile-section" class="section">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                    <div class="profile-pic-edit" id="edit-profile-pic">
                        <i class="fas fa-pencil-alt"></i>
                    </div>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">
                        <span id="profile-name-text">Utilisateur</span>
                        <span class="admin-badge" id="admin-badge" style="display: none;">Admin</span>
                    </div>
                    <div class="profile-email" id="profile-email">user@example.com</div>
                    <div class="profile-status">En ligne</div>
                    <div class="profile-edit" id="edit-profile-btn">
                        <i class="fas fa-edit"></i> Modifier le profil
                    </div>
                </div>
            </div>
            
            <div class="section-title">Paramètres</div>
            
            <div class="settings-container">
                <div class="section-title">Nous rejoindre</div>
                
                <div class="social-buttons">
                    <div class="social-button whatsapp" id="whatsapp-btn">
                        WhatsApp
                    </div>
                    <div class="social-button telegram" id="telegram-btn">
                        Telegram
                    </div>
                    <div class="social-button youtube" id="youtube-btn">
                        YouTube
                    </div>
                </div>
                
                <button id="logout-btn" class="button">Se déconnecter</button>
                <button id="delete-account-btn" class="button danger" style="margin-top: 15px;">Supprimer mon compte</button>
            </div>
        </div>
        
        <div id="forecasts-section" class="section">
            <div class="forecasts-tabs">
                <div class="forecast-tab active" data-tab="safes">Safes du jour</div>
                <div class="forecast-tab" data-tab="exact">Scores exacts</div>
                <div class="forecast-tab" data-tab="ai">Prédictions IA</div>
            </div>
            
            <div class="forecasts-content active" id="safes-content">
                <div class="forecasts-list" id="safes-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="exact-content">
                <div class="forecasts-list" id="exact-list">
                </div>
            </div>
            
            <div class="forecasts-content" id="ai-content">
                <div class="forecasts-list" id="ai-list">
                </div>
            </div>
        </div>
    </div>

    <div id="chat-interface" class="chat-section">
        <div class="chat-messages-container">
            <div class="chat-messages" id="chat-messages">
            </div>
        </div>
        <div class="chat-input-container" id="chat-input-container">
            <div class="image-button" id="image-button">
                <i class="fas fa-image"></i>
            </div>
            <div class="chat-input-wrapper" id="chat-input-wrapper">
                <!-- Reply preview dynamically added here -->
                <div class="reply-preview" id="reply-preview">
                    <div class="reply-preview-close" id="reply-close">
                        <i class="fas fa-times"></i>
                    </div>
                    <div class="reply-preview-header">Réponse à <span id="reply-name">Utilisateur</span></div>
                    <div class="reply-preview-content" id="reply-content">Message original</div>
                </div>
                <textarea id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off" rows="1"></textarea>
            </div>
            <div class="send-button" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <input type="file" id="chat-image-input" accept="image/*">
    </div>
    
    <div id="create-group-dialog" class="create-group-dialog">
        <div class="create-group-header">
            <div class="create-group-back" id="create-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="create-group-title">Nouveau groupe</div>
        </div>
        <div class="create-group-content">
            <div class="group-form">
                <div class="group-image-preview" id="new-group-image-preview">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <input type="file" id="new-group-image-input" accept="image/*">
                
                <div class="form-group">
                    <label class="form-label">Nom du groupe</label>
                    <input type="text" class="form-input" id="group-name" placeholder="Entrez le nom du groupe">
                    <div id="group-name-error" class="form-error">Le nom du groupe est requis</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnelle)</label>
                    <input type="text" class="form-input" id="group-description" placeholder="Décrivez le groupe">
                </div>
                <div class="form-group">
                    <label class="form-label">Permissions de message</label>
                    <div style="display: flex; align-items: center; margin-top: 8px;">
                        <label class="switch">
                            <input type="checkbox" id="group-public-messages" checked>
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    </div>
                    <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                        Si désactivé, seuls les administrateurs pourront écrire des messages
                    </div>
                </div>
                <button class="button" id="create-group-submit">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Créer le groupe</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="edit-group-dialog" class="edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="edit-group-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le groupe</div>
        </div>
        <div class="edit-content">
            <div class="group-image-preview" id="edit-group-image-preview">
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="edit-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="edit-group-image-input" accept="image/*">
            
            <div class="form-group">
                <label class="form-label">Nom du groupe</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-name" placeholder="Entrez le nom du groupe">
                    <button class="save-field-btn" id="save-group-name-btn">Enregistrer</button>
                </div>
                <div id="edit-group-name-error" class="field-error">Le nom du groupe est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-group-description" placeholder="Décrivez le groupe">
                    <button class="save-field-btn" id="save-group-description-btn">Enregistrer</button>
                </div>
                <div id="edit-group-description-error" class="field-error"></div>
            </div>
            
            <div class="form-group" id="edit-group-permissions-container">
                <label class="form-label">Permissions de message</label>
                <div style="display: flex; align-items: center; margin-top: 8px;">
                    <label class="switch">
                        <input type="checkbox" id="edit-group-public-messages">
                        <span class="slider"></span>
                    </label>
                    <span style="margin-left: 10px; font-size: 14px;">Permettre à tous les membres d'écrire</span>
                    <button class="save-field-btn" id="save-group-permissions-btn" style="margin-left: auto;">Enregistrer</button>
                </div>
                <div style="font-size: 12px; color: var(--inactive-text); margin-top: 5px; margin-left: 60px;">
                    Si désactivé, seuls les administrateurs pourront écrire des messages
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Image du groupe</label>
                <button class="button" id="save-group-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer l'image</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Group Info Dialog -->
    <div id="group-info-dialog" class="group-info-dialog">
        <div class="group-info-header">
            <div class="group-info-back" id="group-info-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="group-info-title">Informations du groupe</div>
        </div>
        <div class="group-info-content">
            <div class="group-info-section">
                <div class="group-image-preview" id="info-group-image-preview" style="width: 120px; height: 120px; margin-bottom: 20px;">
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Nom</div>
                    <div class="group-info-value" id="info-group-name">Nom du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Description</div>
                    <div class="group-info-value" id="info-group-description">Description du groupe</div>
                </div>
                
                <div class="group-info-detail">
                    <div class="group-info-label">Type</div>
                    <div class="group-info-value" id="info-group-type">Public</div>
                </div>
            </div>
            
            <div class="group-info-section">
                <div class="group-info-section-title">Images partagées</div>
                <div class="group-info-images" id="info-group-images">
                    <div class="group-info-image-empty">Aucune image partagée</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-notif-dialog" class="admin-notif-dialog">
        <div class="edit-header">
            <div class="edit-back" id="admin-notif-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Nouvelle notification</div>
        </div>
        <div class="edit-content">
            <div class="form-group">
                <label class="form-label">Titre de la notification</label>
                <input type="text" class="form-input" id="notif-title" placeholder="Titre de votre notification">
                <div id="notif-title-error" class="field-error">Le titre est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contenu</label>
                <textarea class="form-input" id="notif-content" placeholder="Contenu de votre notification" rows="5" style="resize: none;"></textarea>
                <div id="notif-content-error" class="field-error">Le contenu est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type de notification</label>
                <select class="form-input" id="notif-type">
                    <option value="info">Information</option>
                    <option value="alert">Alerte</option>
                    <option value="update">Mise à jour</option>
                </select>
            </div>
            
            <button class="button" id="send-notification-btn">
                <span class="btn-loader" style="display:none;"></span>
                <span class="btn-text">Envoyer la notification</span>
            </button>
        </div>
    </div>
    
    <div id="profile-edit-dialog" class="profile-edit-dialog">
        <div class="edit-header">
            <div class="edit-back" id="profile-edit-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">Modifier le profil</div>
        </div>
        <div class="edit-content">
            <div class="profile-image-upload">
                <div class="profile-image-preview" id="profile-image-preview">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-upload-btn" id="profile-upload-btn">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="file" id="profile-image-input" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nom d'utilisateur</label>
                <div class="editable-field">
                    <input type="text" class="form-input editable-field-input" id="edit-display-name" placeholder="Entrez votre nom d'utilisateur">
                    <button class="save-field-btn" id="save-display-name-btn">Enregistrer</button>
                </div>
                <div id="edit-display-name-error" class="field-error">Le nom d'utilisateur est requis</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Photo de profil</label>
                <button class="button" id="save-profile-image-btn" style="margin-top: 10px;">
                    <span class="btn-loader" style="display:none;"></span>
                    <span class="btn-text">Enregistrer la photo</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="about-dialog" class="about-dialog">
        <div class="edit-header">
            <div class="edit-back" id="about-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="edit-title">À propos</div>
        </div>
        <div class="about-content">
            <div class="about-logo">
                <i class="fas fa-futbol"></i>
                <div class="about-title">Pari Alliance</div>
                <div class="about-version">Version 1.3.0</div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Description</div>
                <div class="about-section-content">
                    Pari Alliance est une application de messagerie sécurisée qui permet aux utilisateurs de créer et de participer à des discussions de groupe.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Fonctionnalités</div>
                <div class="about-section-content">
                    • Messagerie de groupe en temps réel<br>
                    • Partage de pronostics sportifs<br>
                    • Mode sombre personnalisable<br>
                    • Thèmes de couleurs multiples<br>
                    • Gestion simple des groupes<br>
                    • Messages directs entre utilisateurs<br>
                    • Envoi de notifications pour les administrateurs
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">À propos de l'application</div>
                <div class="about-section-content">
                    Le logo de l'application est constitué deux mains qui se soutiennent et en arrière-plan ballon de football. L'application a été créée par Pronosoft AI.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Confidentialité</div>
                <div class="about-section-content">
                    Pari Alliance respecte votre vie privée. Vos données personnelles ne sont utilisées que pour le fonctionnement de l'application et ne sont jamais partagées avec des tiers.
                </div>
            </div>
            
            <div class="about-footer">
                © 2025-2026 Pari Alliance. Tous droits réservés.
            </div>
        </div>
    </div>
    
    <div id="terms-dialog" class="terms-dialog">
        <div class="terms-header">
            <div class="terms-back" id="terms-back">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="terms-title">Conditions d'utilisation</div>
        </div>
        <div class="terms-content">
            <div class="about-section">
                <div class="about-section-title">Conditions générales</div>
                <div class="about-section-content">
                    En utilisant l'application Pari Alliance, vous acceptez de respecter les présentes conditions d'utilisation. L'accès et l'utilisation de cette application sont soumis à votre acceptation et au respect des présentes conditions.
                </div>
            </div>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i> <strong>AVERTISSEMENT :</strong> Les pronostics sont fournis à titre informatif uniquement. La vente ou revente de ces pronostics est strictement interdite et passible de bannissement à vie et de poursuites judiciaires.
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation des pronostics</div>
                <div class="about-section-content">
                    Les pronostics sportifs fournis dans cette application sont destinés uniquement à des fins d'information et de divertissement. Ils peuvent être utilisés pour effectuer des paris réels, mais il est recommandé de le faire avec responsabilité.<br><br>
                    
                    Nous ne sommes pas responsables de leurs pertes éventuelles. Les pronostics ne constituent en aucun cas une incitation au jeu ou un conseil d'investissement.<br><br>
                    
                    Il est strictement interdit de:<br>
                    • Revendre ou commercialiser ces pronostics<br>
                    • Partager ces informations en dehors de la plateforme<br>
                    • Utiliser ces informations à des fins commerciales<br><br>
                    
                    Tout utilisateur enfreignant ces règles s'expose à une suspension immédiate de son compte et à d'éventuelles poursuites judiciaires.
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Utilisation de l'application</div>
                <div class="about-section-content">
                    Vous vous engagez à utiliser l'application de manière légale et responsable. Il est interdit de:<br>
                    • Publier du contenu illégal, diffamatoire, harcelant ou menaçant<br>
                    • Usurper l'identité d'une autre personne<br>
                    • Tenter d'accéder sans autorisation à des parties de l'application qui vous sont interdites<br>
                    • Perturber le fonctionnement normal de l'application<br>
                    • Publier des messages à caractère commercial non sollicités
                </div>
            </div>
            
            <div class="about-section">
                <div class="about-section-title">Responsabilité</div>
                <div class="about-section-content">
                    Pari Alliance n'est pas responsable des pertes financières ou autres dommages qui pourraient résulter de l'utilisation des pronostics(des événements imprévus tels que les cartons rouges,les fautes pouvant causer un penalty etc...)ou des informations disponibles sur l'application. Les utilisateurs sont seuls responsables de leurs décisions et de leurs actions.
                </div>
            </div>
        </div>
    </div>
    
    <div id="delete-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer ce message ?</div>
        <div class="confirmation-text">Cette action est irréversible et le message sera définitivement supprimé.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-event-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer cet événement ?</div>
        <div class="confirmation-text">Cette action est irréversible et l'événement sera supprimé.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-event-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-event-confirm">Supprimer</div>
        </div>
    </div>
    
    <div id="delete-account-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Supprimer votre compte ?</div>
        <div class="confirmation-text">ATTENTION : Cette action est définitive et irréversible. Toutes vos données seront supprimées.</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="delete-account-cancel">Annuler</div>
            <div class="confirmation-button confirmation-delete" id="delete-account-confirm">Supprimer</div>
        </div>
    </div>

    <div id="logout-confirmation" class="confirmation-dialog">
        <div class="confirmation-title">Se déconnecter ?</div>
        <div class="confirmation-text">Voulez-vous vraiment vous déconnecter de Pari Alliance ?</div>
        <div class="confirmation-buttons">
            <div class="confirmation-button confirmation-cancel" id="logout-cancel">Annuler</div>
            <div class="confirmation-button confirmation-confirm" id="logout-confirm">Déconnecter</div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <div class="notification" id="notification"></div>
    
    <div id="image-viewer" class="image-viewer">
        <div class="viewer-image-container">
            <img src="" alt="Image" class="viewer-image" id="viewer-image" oncontextmenu="return false">
        </div>
        <div class="viewer-close" id="viewer-close">
            <i class="fas fa-times"></i>
        </div>
        <div class="download-button" id="download-image-btn">
            <i class="fas fa-download"></i>
        </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" data-section="discussions" style="flex: 1;">
            <i class="nav-icon fas fa-comments"></i>
            <span>Discussions</span>
        </div>
        <div class="nav-item" data-section="users" style="flex: 1;">
            <i class="nav-icon fas fa-address-book"></i>
            <span>Utilisateurs</span>
            <div class="notification-dot" id="users-notification-dot" style="display: none;"></div>
        </div>
        <div class="nav-item" data-section="forecasts" style="flex: 1;">
            <i class="nav-icon fas fa-futbol"></i>
            <span>Pronostics</span>
            <div class="notification-dot" id="forecasts-notification-dot" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, addDoc, onSnapshot, where, deleteDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDTPLxUiA8lj82kqc6CyCPLQDITc0CtLUE",
            authDomain: "ichat-betai.firebaseapp.com",
            databaseURL: "https://ichat-betai-default-rtdb.firebaseio.com",
            projectId: "ichat-betai",
            storageBucket: "ichat-betai.appspot.com",
            messagingSenderId: "168337722600",
            appId: "1:168337722600:web:beb331f83cc4778c5b4d5d",
            measurementId: "G-STXPSZN7X8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Debug system
        let debugLogs = [];
        let debugPanelVisible = false;

        function addDebugLog(message, type = 'info', linkUrl = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const log = {
                timestamp,
                message,
                type,
                linkUrl
            };
            
            debugLogs.push(log);
            
            // Keep only last 50 logs
            if (debugLogs.length > 50) {
                debugLogs.shift();
            }
            
            updateDebugPanel();
            
            // Show debug button if there are errors
            if (type === 'error') {
                document.getElementById('debug-toggle-btn').classList.add('active');
            }
        }

        function updateDebugPanel() {
            const content = document.getElementById('debug-log-content');
            content.innerHTML = '';
            
            debugLogs.forEach(log => {
                const item = document.createElement('div');
                item.className = `debug-log-item ${log.type}`;
                
                let messageContent = log.message;
                
                // Handle Firestore index links
                if (log.linkUrl) {
                    const linkPattern = /https:\/\/console\.firebase\.google\.com[^\s)]+/g;
                    messageContent = messageContent.replace(linkPattern, (url) => {
                        return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="debug-log-link">${url}</a>`;
                    });
                }
                
                item.innerHTML = `
                    <span class="debug-log-timestamp">${log.timestamp}</span>
                    ${messageContent}
                `;
                content.appendChild(item);
            });
            
            // Auto scroll to bottom
            content.scrollTop = content.scrollHeight;
        }

        function handleFirestoreError(error, operation) {
            let errorMessage = `Erreur ${operation}: ${error.code || 'inconnu'}`;
            let linkUrl = null;
            
            if (error.code === 'failed-precondition' || error.message.includes('index')) {
                // Extract index URL from error message if available
                const urlMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s)]+/);
                if (urlMatch) {
                    linkUrl = urlMatch[0];
                    errorMessage += `\n\nLien pour créer l'index: ${linkUrl}`;
                } else {
                    errorMessage += '\n\nUn index Firestore est requis. Consultez la console Firebase.';
                }
            }
            
            console.error(`${operation} error:`, error);
            addDebugLog(errorMessage, 'error', linkUrl);
            
            return errorMessage;
        }

        let isLoggedIn = false;
        let currentUser = null;
        let currentUserData = null;
        let isAdmin = false;
        let currentGroup = '';
        let currentGroupId = null;
        let currentGroupData = null;
        let currentSection = 'discussions';
        let isOnline = navigator.onLine;
        let messageQueue = [];
        let chatUnsubscribers = {};
        let longPressTimer = null;
        let longPressDuration = 500;
        let currentMessageForAction = null;
        let eventsUnsubscribe = null;
        let forecastsUnsubscribe = null;
        let usersUnsubscribe = null;
        let groupImageFile = null;
        let profileImageFile = null;
        let editingGroupId = null;
        let profileUpdating = false;
        let isLoadingGroups = false;
        let isLoadingEvents = false;
        let isLoadingUsers = false;
        let profileNameChanged = false;
        let groupNameChanged = false;
        let groupDescriptionChanged = false;
        let groupPermissionsChanged = false;
        let currentEventForDeletion = null;
        let currentForecastTab = 'safes';
        let lastViewedEventTimestamp = null;
        let hasNewEvents = false;
        let chatImageFile = null;
        let isSearchActive = false;
        let currentSearchContext = '';
        let replyingToMessage = null;
        let autoResizeTextarea = null;
        let isMessageActionsVisible = false;
        let groupImageCache = {};
        let currentDownloadImage = '';
        let forecastsCache = {};
        let usersCache = {};
        let currentChatPartner = null;
        let processingMessage = false;
        let selectedTheme = localStorage.getItem('parisAllianceTheme') || 'default';
        let directChatsCache = {};
        let allDiscussions = [];
        let unreadCounts = {};
        
        function setupTheme() {
            document.documentElement.classList.remove('theme-green', 'theme-red', 'theme-orange');
            
            if (selectedTheme !== 'default') {
                document.documentElement.classList.add(`theme-${selectedTheme}`);
            }
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const activeThemeOption = document.querySelector(`.theme-option[data-theme="${selectedTheme}"]`);
            if (activeThemeOption) {
                activeThemeOption.classList.add('active');
            }
        }
        
        function setupDarkMode() {
            const savedPreference = localStorage.getItem('parisAllianceDarkMode');
            
            if (savedPreference === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-toggle').checked = true;
            } else if (savedPreference === 'false') {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-toggle').checked = false;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-toggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('dark-toggle').checked = false;
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (localStorage.getItem('parisAllianceDarkMode') === null) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('dark-toggle').checked = true;
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('dark-toggle').checked = false;
                    }
                }
            });
        }
        
        function setupConnectionMonitoring() {
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    isOnline = true;
                    processQueuedMessages();
                } else {
                    isOnline = false;
                    showNotification("Pas de connexion internet. Les messages seront envoyés lorsque vous serez connecté.", "error");
                }
            }
            
            window.addEventListener('online', () => {
                showNotification("Connexion rétablie", "success");
                isOnline = true;
                
                setTimeout(() => {
                    if (isLoggedIn && currentSection === 'discussions') {
                        loadDiscussions();
                    }
                    processQueuedMessages();
                }, 1000);
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
            });
            
            updateConnectionStatus();
        }
        
        async function processQueuedMessages() {
            if (messageQueue.length === 0) return;
            
            const processedMessages = [...messageQueue];
            messageQueue = [];
            
            for (const message of processedMessages) {
                try {
                    if (message.direct) {
                        await sendDirectMessage(message.chatId, message.text, message.imageData, message.replyTo);
                    } else {
                        await sendMessageToFirestore(
                            message.groupId, 
                            message.text,
                            message.imageData,
                            message.replyTo
                        );
                    }
                } catch (error) {
                    messageQueue.push(message);
                }
            }
            
            if (messageQueue.length > 0) {
                showNotification(`${messageQueue.length} message(s) n'ont pas pu être envoyés`, 'error');
            } else if (processedMessages.length > 0) {
                showNotification('Tous les messages ont été envoyés', 'success');
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.classList.remove('show');
            
            setTimeout(() => {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    
                    setTimeout(() => {
                        notification.className = 'notification';
                        notification.textContent = '';
                    }, 300);
                }, 3000);
            }, 100);
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('chat-input');
            if (!textarea) return;
            
            const adjustHeight = () => {
                textarea.style.height = 'auto';
                
                const newHeight = Math.min(textarea.scrollHeight, 100);
                textarea.style.height = `${newHeight}px`;
                
                const container = document.getElementById('chat-input-container');
                if (container) {
                    if (replyingToMessage) {
                        container.style.minHeight = `${60 + newHeight}px`;
                    } else {
                        container.style.minHeight = `${newHeight + 20}px`;
                    }
                }
            };
            
            adjustHeight();
            
            textarea.addEventListener('input', adjustHeight);
            
            autoResizeTextarea = adjustHeight;
        }
        
        function setupUIEvents() {
            // Debug panel setup
            document.getElementById('debug-toggle-btn').addEventListener('click', function() {
                debugPanelVisible = !debugPanelVisible;
                const panel = document.getElementById('debug-log-panel');
                if (debugPanelVisible) {
                    panel.classList.add('active');
                    updateDebugPanel();
                } else {
                    panel.classList.remove('active');
                }
            });

            document.getElementById('debug-log-close').addEventListener('click', function() {
                debugPanelVisible = false;
                document.getElementById('debug-log-panel').classList.remove('active');
            });

            document.getElementById('header-menu-button').addEventListener('click', function() {
                document.getElementById('side-menu').classList.add('active');
                document.getElementById('side-menu-overlay').classList.add('active');
            });
            
            document.getElementById('side-menu-close').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('side-menu-overlay').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
            });
            
            document.getElementById('menu-profile').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showProfileSection();
            });
            
            document.getElementById('menu-interface').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showInterfaceSection();
            });
            
            document.getElementById('menu-users').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showUsersSection();
            });
            
            document.getElementById('menu-terms').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showTermsDialog();
            });
            
            document.getElementById('terms-back').addEventListener('click', hideTermsDialog);
            
            document.getElementById('menu-about').addEventListener('click', function() {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                showAboutDialog();
            });
            
            document.getElementById('about-back').addEventListener('click', hideAboutDialog);
            
            document.getElementById('search-button').addEventListener('click', function() {
                toggleSearchBar();
            });
            
            document.getElementById('search-close').addEventListener('click', function() {
                hideSearchBar();
            });
            
            document.getElementById('search-input').addEventListener('input', function() {
                handleSearch(this.value);
            });
            
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });
            
            document.getElementById('close-events-btn').addEventListener('click', function() {
                if (currentSection === 'events') {
                    showDiscussionsSection();
                }
            });
            
            document.getElementById('close-users-btn').addEventListener('click', function() {
                if (currentSection === 'users') {
                    showDiscussionsSection();
                }
            });
            
            document.getElementById('close-interface-btn').addEventListener('click', function() {
                if (currentSection === 'interface') {
                    showDiscussionsSection();
                }
            });
            
            document.getElementById('group-info-back').addEventListener('click', hideGroupInfoDialog);
            
            document.getElementById('bottom-nav').addEventListener('click', function(e) {
                const navItems = this.querySelectorAll('.nav-item');
                
                for (let i = 0; i < navItems.length; i++) {
                    const item = navItems[i];
                    const rect = item.getBoundingClientRect();
                    
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        const section = item.getAttribute('data-section');
                        if (section === 'discussions') {
                            showDiscussionsSection();
                        } else if (section === 'forecasts') {
                            showForecastsSection();
                        } else if (section === 'users') {
                            showUsersSection();
                        }
                        
                        break;
                    }
                }
            });
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchForecastTab(tabId);
                });
            });
            
            document.getElementById('dark-toggle').addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                localStorage.setItem('parisAllianceDarkMode', this.checked ? 'true' : 'false');
            });
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    selectedTheme = theme;
                    
                    document.documentElement.classList.remove('theme-green', 'theme-red', 'theme-orange');
                    
                    if (theme !== 'default') {
                        document.documentElement.classList.add(`theme-${theme}`);
                    }
                    
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    localStorage.setItem('parisAllianceTheme', theme);
                    
                    showNotification(`Thème ${theme} appliqué`, 'success');
                });
            });
            
            document.getElementById('logout-btn').addEventListener('click', showLogoutConfirmation);
            document.getElementById('logout-cancel').addEventListener('click', hideLogoutConfirmation);
            document.getElementById('logout-confirm').addEventListener('click', logoutUser);
            
            document.getElementById('delete-account-btn').addEventListener('click', showDeleteAccountConfirmation);
            
            document.getElementById('delete-account-cancel').addEventListener('click', hideDeleteAccountConfirmation);
            document.getElementById('delete-account-confirm').addEventListener('click', deleteAccount);
            
            document.getElementById('edit-profile-btn').addEventListener('click', showProfileEditDialog);
            document.getElementById('edit-profile-pic').addEventListener('click', showProfileEditDialog);
            
            document.getElementById('profile-edit-back').addEventListener('click', hideProfileEditDialog);
            document.getElementById('profile-upload-btn').addEventListener('click', function() {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('profile-image-input').addEventListener('change', handleProfileImageSelect);
            
            document.getElementById('save-display-name-btn').addEventListener('click', updateDisplayName);
            document.getElementById('save-profile-image-btn').addEventListener('click', updateProfileImage);
            
            document.getElementById('edit-display-name').addEventListener('input', function() {
                profileNameChanged = true;
                document.getElementById('save-display-name-btn').disabled = this.value.trim() === '';
            });
            
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('reply-close').addEventListener('click', function() {
                cancelReply();
            });
            
            document.getElementById('send-button').addEventListener('click', sendMessage);
            
            document.getElementById('image-button').addEventListener('click', function() {
                document.getElementById('chat-image-input').click();
            });
            
            document.getElementById('chat-image-input').addEventListener('change', handleChatImageSelect);
            
            document.getElementById('viewer-close').addEventListener('click', closeImageViewer);
            document.getElementById('download-image-btn').addEventListener('click', downloadCurrentImage);
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('create-group-btn').addEventListener('click', function() {
                showCreateGroupDialog();
            });
            
            document.getElementById('create-group-back').addEventListener('click', hideCreateGroupDialog);
            document.getElementById('create-group-submit').addEventListener('click', createNewGroup);
            
            document.getElementById('create-notification-btn').addEventListener('click', function() {
                if (isAdmin) {
                    showAdminNotificationDialog();
                } else {
                    showNotification("Seuls les administrateurs peuvent envoyer des notifications", "error");
                }
            });
            
            document.getElementById('admin-notif-back').addEventListener('click', hideAdminNotificationDialog);
            document.getElementById('send-notification-btn').addEventListener('click', sendAdminNotification);
            
            document.getElementById('new-group-image-upload').addEventListener('click', function() {
                document.getElementById('new-group-image-input').click();
            });
            
            document.getElementById('new-group-image-input').addEventListener('change', handleNewGroupImageSelect);
            
            document.getElementById('edit-group-back').addEventListener('click', hideEditGroupDialog);
            
            document.getElementById('edit-group-image-upload').addEventListener('click', function() {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('edit-group-image-input').addEventListener('change', handleEditGroupImageSelect);
            
            document.getElementById('save-group-name-btn').addEventListener('click', updateGroupName);
            document.getElementById('save-group-description-btn').addEventListener('click', updateGroupDescription);
            document.getElementById('save-group-permissions-btn').addEventListener('click', updateGroupPermissions);
            document.getElementById('save-group-image-btn').addEventListener('click', updateGroupImage);
            
            document.getElementById('edit-group-name').addEventListener('input', function() {
                groupNameChanged = true;
                document.getElementById('save-group-name-btn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('edit-group-description').addEventListener('input', function() {
                groupDescriptionChanged = true;
                document.getElementById('save-group-description-btn').disabled = false;
            });
            
            document.getElementById('edit-group-public-messages').addEventListener('change', function() {
                groupPermissionsChanged = true;
                document.getElementById('save-group-permissions-btn').disabled = false;
            });
            
            document.getElementById('delete-cancel').addEventListener('click', hideDeleteConfirmation);
            document.getElementById('delete-confirm').addEventListener('click', confirmDeleteMessage);
            
            document.getElementById('delete-event-cancel').addEventListener('click', hideDeleteEventConfirmation);
            document.getElementById('delete-event-confirm').addEventListener('click', confirmDeleteEvent);
            
            document.getElementById('action-reply-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    replyToMessage();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-copy-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    copyMessageText();
                    hideMessageActionsBar();
                }
            });
            
            document.getElementById('action-delete-btn').addEventListener('click', function() {
                if (currentMessageForAction) {
                    showDeleteConfirmation();
                }
            });
            
            document.getElementById('action-cancel-btn').addEventListener('click', function() {
                hideMessageActionsBar();
            });
            
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('touchstart', handleGlobalTouchStart, { passive: true });
            document.addEventListener('touchend', handleGlobalTouchEnd, { passive: true });
            document.addEventListener('touchmove', handleGlobalTouchMove, { passive: true });
            document.addEventListener('touchcancel', handleGlobalTouchCancel, { passive: true });
            
            document.getElementById('whatsapp-btn').addEventListener('click', function() {
                openSocialLink('whatsapp');
            });
            
            document.getElementById('telegram-btn').addEventListener('click', function() {
                openSocialLink('telegram');
            });
            
            document.getElementById('youtube-btn').addEventListener('click', function() {
                openSocialLink('youtube');
            });
            
            const touchableElements = document.querySelectorAll('.menu-button, .back-button, .search-button, .events-button, .info-button, .search-close');
            touchableElements.forEach(element => {
                element.addEventListener('touchstart', createRippleEffect);
            });
            
            window.addEventListener('popstate', handleBackButton);
            
            history.pushState({ page: 'main' }, '');
        }
        
        function handleBackButton(event) {
            event.preventDefault();
            
            if (isMessageActionsVisible) {
                hideMessageActionsBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (document.querySelector('.confirmation-dialog.active')) {
                document.querySelectorAll('.confirmation-dialog.active').forEach(dialog => {
                    const cancelBtn = dialog.querySelector('.confirmation-cancel');
                    if (cancelBtn) cancelBtn.click();
                });
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (isSearchActive) {
                hideSearchBar();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (document.getElementById('side-menu').classList.contains('active')) {
                document.getElementById('side-menu').classList.remove('active');
                document.getElementById('side-menu-overlay').classList.remove('active');
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (currentSection !== 'discussions') {
                showDiscussionsSection();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            const dialogs = [
                { id: 'about-dialog', backBtn: 'about-back' },
                { id: 'terms-dialog', backBtn: 'terms-back' },
                { id: 'profile-edit-dialog', backBtn: 'profile-edit-back' },
                { id: 'edit-group-dialog', backBtn: 'edit-group-back' },
                { id: 'create-group-dialog', backBtn: 'create-group-back' },
                { id: 'admin-notif-dialog', backBtn: 'admin-notif-back' },
                { id: 'group-info-dialog', backBtn: 'group-info-back' }
            ];
            
            for (const dialog of dialogs) {
                if (document.getElementById(dialog.id).classList.contains('active')) {
                    document.getElementById(dialog.backBtn).click();
                    history.pushState({ page: 'main' }, '');
                    return;
                }
            }
            
            if (document.getElementById('image-viewer').classList.contains('active')) {
                closeImageViewer();
                history.pushState({ page: 'main' }, '');
                return;
            }
            
            if (currentSection === 'discussions') {
                history.pushState({ page: 'main' }, '');
            }
        }
        
        function cancelReply() {
            replyingToMessage = null;
            const replyPreview = document.getElementById('reply-preview');
            replyPreview.classList.remove('active');
            
            const chatInputContainer = document.getElementById('chat-input-container');
            chatInputContainer.classList.remove('with-reply');
            
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
        }
        
        function showMessageActionsBar(messageElement) {
            if (!messageElement) return;
            
            const messageId = messageElement.getAttribute('data-id');
            const messageFrom = messageElement.getAttribute('data-from');
            
            currentMessageForAction = {
                element: messageElement,
                id: messageId,
                from: messageFrom,
                text: messageElement.textContent.trim()
            };
            
            const deleteBtn = document.getElementById('action-delete-btn');
            if (messageFrom !== currentUser.uid && !isAdmin) {
                deleteBtn.style.display = 'none';
            } else {
                deleteBtn.style.display = 'flex';
            }
            
            messageElement.classList.add('selected');
            
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.add('active');
            
            document.querySelector('.header-left').style.opacity = '0';
            document.querySelector('.header-title').style.opacity = '0';
            document.getElementById('header-action').style.opacity = '0';
            
            isMessageActionsVisible = true;
            
            history.pushState({ page: 'message-actions' }, '');
        }
        
        function hideMessageActionsBar() {
            const actionsBar = document.getElementById('message-actions-container');
            actionsBar.classList.remove('active');
            
            document.querySelector('.header-left').style.opacity = '1';
            document.querySelector('.header-title').style.opacity = '1';
            document.getElementById('header-action').style.opacity = '1';
            
            if (currentMessageForAction && currentMessageForAction.element) {
                currentMessageForAction.element.classList.remove('selected');
            }
            
            currentMessageForAction = null;
            isMessageActionsVisible = false;
        }
        
        function createRippleEffect(e) {
            const button = e.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.touches[0].pageX - button.offsetLeft - diameter / 2}px`;
            circle.style.top = `${e.touches[0].pageY - button.offsetTop - diameter / 2}px`;
            circle.classList.add('ripple');
            
            const ripple = button.querySelector('.ripple');
            if (ripple) {
                ripple.remove();
            }
            
            button.appendChild(circle);
            
            setTimeout(() => {
                circle.remove();
            }, 600);
        }
        
        function toggleSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            if (isSearchActive) {
                hideSearchBar();
            } else {
                header.classList.add('search-active');
                searchContainer.classList.add('active');
                searchInput.focus();
                isSearchActive = true;
                
                history.pushState({ page: 'search' }, '');
                
                currentSearchContext = currentSection;
                
                if (currentSearchContext === 'discussions') {
                    searchInput.placeholder = 'Rechercher une discussion...';
                } else if (currentSearchContext === 'events') {
                    searchInput.placeholder = 'Rechercher un événement...';
                } else if (currentSearchContext === 'users') {
                    searchInput.placeholder = 'Rechercher un utilisateur...';
                } else if (currentSearchContext === 'forecasts') {
                    searchInput.placeholder = 'Rechercher un pronostic...';
                }
            }
        }
        
        function hideSearchBar() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            const header = document.querySelector('.header');
            
            searchContainer.classList.remove('active');
            searchContainer.classList.add('hiding');
            
            setTimeout(() => {
                header.classList.remove('search-active');
                searchInput.value = '';
                searchContainer.classList.remove('hiding');
                isSearchActive = false;
                
                handleSearch('');
            }, 300);
        }
        
        function handleSearch(query) {
            if (currentSearchContext === 'discussions') {
                filterDiscussions(query);
            } else if (currentSearchContext === 'events') {
                filterEvents(query);
            } else if (currentSearchContext === 'users') {
                filterUsers(query);
            }
        }
        
        function openSocialLink(platform) {
            let url = '';
            
            switch(platform) {
                case 'whatsapp':
                    url = 'https://wa.me/';
                    showNotification('Ouverture de WhatsApp', 'info');
                    break;
                case 'telegram':
                    url = 'https://t.me/';
                    showNotification('Ouverture de Telegram', 'info');
                    break;
                case 'youtube':
                    url = 'https://www.youtube.com/';
                    showNotification('Ouverture de YouTube', 'info');
                    break;
                default:
                    return;
            }
            
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function showTermsDialog() {
            document.getElementById('terms-dialog').classList.add('active');
            history.pushState({ page: 'terms' }, '');
        }
        
        function hideTermsDialog() {
            document.getElementById('terms-dialog').classList.remove('active');
        }
        
        function showAboutDialog() {
            document.getElementById('about-dialog').classList.add('active');
            history.pushState({ page: 'about' }, '');
        }
        
        function hideAboutDialog() {
            document.getElementById('about-dialog').classList.remove('active');
        }
        
        function showGroupInfoDialog() {
            if (!currentGroupData) return;
            
            const dialog = document.getElementById('group-info-dialog');
            const imagePreview = document.getElementById('info-group-image-preview');
            const nameElement = document.getElementById('info-group-name');
            const descriptionElement = document.getElementById('info-group-description');
            const typeElement = document.getElementById('info-group-type');
            const imagesContainer = document.getElementById('info-group-images');
            
            nameElement.textContent = currentGroupData.name || 'Sans nom';
            descriptionElement.textContent = currentGroupData.description || 'Sans description';
            typeElement.textContent = currentGroupData.allowPublicMessages !== false ? 
                'Public (Tous peuvent écrire)' : 'Restreint (Écriture limitée aux administrateurs)';
            
            if (currentGroupData.imageURL) {
                imagePreview.innerHTML = `<img src="${currentGroupData.imageURL}" alt="${currentGroupData.name}">`;
            } else {
                imagePreview.innerHTML = `<i class="fas fa-users" style="color: white; font-size: 40px;"></i>`;
            }
            
            imagesContainer.innerHTML = '<div class="group-info-image-empty">Chargement des images...</div>';
            
            loadGroupImages();
            
            dialog.classList.add('active');
            history.pushState({ page: 'group-info' }, '');
        }
        
        function hideGroupInfoDialog() {
            document.getElementById('group-info-dialog').classList.remove('active');
        }
        
        async function loadGroupImages() {
            if (!currentGroupId) return;
            
            const imagesContainer = document.getElementById('info-group-images');
            
            try {
                if (groupImageCache[currentGroupId] && groupImageCache[currentGroupId].length > 0) {
                    displayGroupImages(groupImageCache[currentGroupId]);
                    return;
                }
                
                const messagesRef = collection(db, "discussions", currentGroupId, "messages");
                const q = query(messagesRef, where("imageData", "!=", null));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partagée</div>';
                    return;
                }
                
                const images = [];
                querySnapshot.forEach(doc => {
                    const messageData = doc.data();
                    if (messageData.imageData) {
                        images.push({
                            url: messageData.imageData,
                            id: doc.id,
                            timestamp: messageData.createdAt
                        });
                    }
                });
                
                images.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return b.timestamp.seconds - a.timestamp.seconds;
                    }
                    return 0;
                });
                
                groupImageCache[currentGroupId] = images;
                
                displayGroupImages(images);
                
            } catch (error) {
                const errorMsg = handleFirestoreError(error, 'chargement des images du groupe');
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Erreur lors du chargement des images</div>';
            }
        }
        
        function displayGroupImages(images) {
            const imagesContainer = document.getElementById('info-group-images');
            
            if (!images || images.length === 0) {
                imagesContainer.innerHTML = '<div class="group-info-image-empty">Aucune image partagée</div>';
                return;
            }
            
            imagesContainer.innerHTML = '';
            
            const imagesToShow = images.slice(0, 9);
            
            imagesToShow.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'group-info-image';
                imageElement.innerHTML = `<img src="${image.url}" alt="Image partagée">`;
                
                imageElement.addEventListener('click', () => {
                    showImageViewer(image.url);
                });
                
                imagesContainer.appendChild(imageElement);
            });
        }
        
        function showImageViewer(imageUrl) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            viewerImage.src = imageUrl;
            viewer.classList.add('active');
            
            currentDownloadImage = imageUrl;
            
            history.pushState({ page: 'image-viewer' }, '');
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('viewer-image').src = '';
                currentDownloadImage = '';
            }, 300);
        }
        
        function downloadCurrentImage() {
            if (!currentDownloadImage) return;
            
            try {
                const a = document.createElement('a');
                a.href = currentDownloadImage;
                a.download = 'image_' + new Date().getTime() + '.jpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showNotification('Téléchargement démarré', 'success');
            } catch (error) {
                showNotification('Erreur lors du téléchargement de l\'image', 'error');
            }
        }
        
        async function handleChatImageSelect(e) {
            const file = e.target.files[0];
            if (!file || !file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image valide', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                showNotification('Préparation de l\'image...', 'info');
                
                const optimizedImage = await optimizeImage(file, 800);
                const base64Image = await encodeImageToBase64(optimizedImage);
                chatImageFile = base64Image;
                
                const inputField = document.getElementById('chat-input');
                if (inputField) {
                    inputField.placeholder = 'Ajoutez un commentaire à l\'image (optionnel)';
                    inputField.focus();
                }
                
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--success-color)';
                }
                
                showNotification('Image prête à être envoyée', 'success');
            } catch (error) {
                console.error('Erreur lors du traitement de l\'image:', error);
                showNotification('Erreur lors du traitement de l\'image', 'error');
                chatImageFile = null;
            }
            
            document.getElementById('chat-image-input').value = '';
        }
        
        function optimizeImage(file, maxDimension) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = Math.round(height * (maxDimension / width));
                            width = maxDimension;
                        } else {
                            width = Math.round(width * (maxDimension / height));
                            height = maxDimension;
                        }
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(
                        blob => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Échec de la conversion en Blob'));
                            }
                        }, 
                        file.type, 
                        0.8
                    );
                };
                
                img.onerror = function() {
                    reject(new Error('Échec du chargement de l\'image'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        function switchForecastTab(tabId) {
            currentForecastTab = tabId;
            
            document.querySelectorAll('.forecast-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.forecasts-content').forEach(content => {
                if (content.id === `${tabId}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            loadForecastsData(tabId);
        }
        
        function showDiscussionsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
                return;
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'discussions') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'discussions';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('discussions-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Discussions';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadDiscussions();
        }
        
        function showUsersSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'users') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'users';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('users-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Utilisateurs';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadUsers();
            
            history.pushState({ page: 'users' }, '');
        }
        
        function showInterfaceSection() {
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'interface';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('interface-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Interface';
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-action').innerHTML = '';
            
            document.getElementById('header-back-button').addEventListener('click', function() {
                showDiscussionsSection();
            });

            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            setupTheme();
            
            history.pushState({ page: 'interface' }, '');
        }
        
        function isDateTodayOrTomorrow(date) {
            if (!date) return false;

            let forecastDate;
            if (date.toDate) {
                forecastDate = date.toDate();
            } else if (date instanceof Date) {
                forecastDate = date;
            } else {
                return false;
            }

            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);

            return (
                (forecastDate.getFullYear() === today.getFullYear() && 
                 forecastDate.getMonth() === today.getMonth() && 
                 forecastDate.getDate() === today.getDate()) ||
                (forecastDate.getFullYear() === tomorrow.getFullYear() && 
                 forecastDate.getMonth() === tomorrow.getMonth() && 
                 forecastDate.getDate() === tomorrow.getDate())
            );
        }
        
        async function loadForecastsData(tabType) {
            if (forecastsCache[tabType]) {
                displayForecastsFromCache(tabType);
                return;
            }
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
                
                if (forecastsSnap.empty) {
                    await initCollections();
                }
            } catch (error) {
                console.error("Initial error:", error);
            }
            
            if (forecastsUnsubscribe) {
                forecastsUnsubscribe();
                forecastsUnsubscribe = null;
            }
            
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement) return;
            
            listElement.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des pronostics...</div>
                </div>
            `;
            
            try {
                const forecastsRef = collection(db, "forecasts");
                const q = query(
                    forecastsRef, 
                    where("type", "==", tabType), 
                    orderBy("date", "desc"),
                    limit(50)
                );
                
                forecastsUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        listElement.innerHTML = `
                            <div class="no-forecasts">
                                <i class="fas fa-futbol"></i>
                                <div class="empty-state-title">Aucun pronostic</div>
                                <div class="empty-state-text">Aucun pronostic disponible actuellement</div>
                            </div>
                        `;
                        return;
                    }
                    
                    let forecasts = [];
                    snapshot.forEach((doc) => {
                        forecasts.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    forecastsCache[tabType] = forecasts;
                    
                    displayForecastsFromCache(tabType);
                }, (error) => {
                    const errorMsg = handleFirestoreError(error, 'chargement des pronostics');
                    listElement.innerHTML = `
                        <div class="no-forecasts">
                            <i class="fas fa-exclamation-circle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les pronostics</div>
                        </div>
                    `;
                });
            } catch (error) {
                const errorMsg = handleFirestoreError(error, 'chargement des pronostics');
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-exclamation-circle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les pronostics</div>
                    </div>
                `;
            }
        }
        
        function displayForecastsFromCache(tabType) {
            const listElement = document.getElementById(`${tabType}-list`);
            if (!listElement || !forecastsCache[tabType]) return;
            
            let hasMatchesToday = false;
            listElement.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            forecastsCache[tabType].forEach((forecastData) => {
                if (isDateTodayOrTomorrow(forecastData.date)) {
                    hasMatchesToday = true;
                    const forecastElement = createForecastElement(forecastData, tabType);
                    fragment.appendChild(forecastElement);
                }
            });
            
            if (hasMatchesToday) {
                listElement.appendChild(fragment);
            } else {
                listElement.innerHTML = `
                    <div class="no-forecasts">
                        <i class="fas fa-calendar-day"></i>
                        <div class="empty-state-title">Pas de matchs aujourd'hui</div>
                        <div class="empty-state-text">Aucun pronostic disponible pour aujourd'hui ou demain</div>
                    </div>
                `;
            }
        }
        
        async function initCollections() {
            try {
                const forecastsRef = collection(db, "forecasts");
                const forecastsSnap = await getDocs(forecastsRef);
            } catch (error) {
            }
        }
        
        function createForecastElement(forecastData, type) {
            const forecastElement = document.createElement('div');
            forecastElement.className = 'forecast-item';
            
            let statusClass = 'pending';
            let statusText = 'À venir';
            
            if (forecastData.status === 'win') {
                statusClass = 'win';
                statusText = 'Gagné';
            } else if (forecastData.status === 'loss') {
                statusClass = 'loss';
                statusText = 'Perdu';
            }
            
            let formattedDate = 'Date inconnue';
            if (forecastData.date) {
                let date;
                if (forecastData.date.toDate) {
                    date = forecastData.date.toDate();
                } else {
                    date = new Date(forecastData.date);
                }
                
                formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            let mainContent = '';
            
            if (type === 'safes') {
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Pronostic: ${forecastData.prediction}
                    </div>
                `;
            } else if (type === 'exact') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center;">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                const scoreOptions = forecastData.scoreOptions || [forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`];
                const scoreOptionsHTML = `
                    <div class="score-options">
                        ${scoreOptions.map(score => `
                            <div class="score-option ${score === (forecastData.primaryOption || `${forecastData.homeScore}-${forecastData.awayScore}`) ? 'active' : ''}">
                                ${score}
                            </div>
                        `).join('')}
                    </div>
                `;
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 10px 0;">
                        <div style="font-weight: bold; margin-bottom: 5px;">Options de score:</div>
                        ${scoreOptionsHTML}
                    </div>
                    ${resultDisplay}
                `;
            } else if (type === 'ai') {
                let resultDisplay = '';
                if (forecastData.status !== 'pending') {
                    resultDisplay = `
                        <div style="margin-top: 5px; text-align: center; font-weight: bold; color: ${forecastData.status === 'win' ? 'var(--success-color)' : 'var(--danger-color)'}">
                            Résultat final: ${forecastData.homeScoreResult || 0}-${forecastData.awayScoreResult || 0}
                        </div>
                    `;
                }
                
                mainContent = `
                    <div class="forecast-header">
                        <div>${forecastData.league}</div>
                        <div class="forecast-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="forecast-match">
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.homeTeam}</div>
                        </div>
                        <div class="forecast-score">VS</div>
                        <div class="forecast-team">
                            <div class="forecast-team-logo">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="forecast-team-name">${forecastData.awayTeam}</div>
                        </div>
                    </div>
                    <div style="text-align: center; font-weight: bold; margin: 10px 0;">
                        Prédiction: ${forecastData.prediction}
                    </div>
                    ${resultDisplay}
                    <div style="font-size: 13px; margin-top: 10px; font-style: italic;">
                        "${forecastData.analysis}"
                    </div>
                `;
            }
            
            const confidenceBar = `
                <div class="forecast-confidence">
                    <span>Confiance:</span>
                    <div class="confidence-bar-container">
                        <div class="confidence-bar" style="width: ${forecastData.confidence}%"></div>
                    </div>
                    <span>${forecastData.confidence}%</span>
                </div>
            `;
            
            const footer = `
                <div class="forecast-date">${formattedDate}</div>
            `;
            
            forecastElement.innerHTML = mainContent + confidenceBar + footer;
            return forecastElement;
        }
        
        function showForecastsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-section') === 'forecasts') {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            currentSection = 'forecasts';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('forecasts-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Pronostics';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="events-button" id="events-button">
                    <i class="fas fa-bell"></i>
                    <div class="notification-dot" id="events-notification-dot"></div>
                </div>
            `;
            
            if (hasNewEvents) {
                document.getElementById('events-notification-dot').classList.add('active');
            }
            
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            document.getElementById('events-button').addEventListener('click', function() {
                showEventsSection();
                updateLastViewedEventTimestamp();
                hideEventNotificationDot();
            });

            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelector('.content').classList.remove('no-bottom-nav');
            
            loadForecastsData(currentForecastTab);
        }
        
        function showEventsSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'events';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('events-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Événements';
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            document.getElementById('header-action').innerHTML = `
                <div class="search-button" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
            `;
            
            document.getElementById('search-button').addEventListener('click', toggleSearchBar);
            
            const createNotifBtn = document.getElementById('create-notification-btn');
            if (createNotifBtn) {
                if (isAdmin) {
                    createNotifBtn.style.display = 'flex';
                } else {
                    createNotifBtn.style.display = 'none';
                }
            }
            
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            listenToEvents();
            
            history.pushState({ page: 'events' }, '');
        }
        
        function showProfileSection() {
            if (document.getElementById('chat-interface').style.display === 'block') {
                closeChat();
            }
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'profile';
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById('profile-section').classList.add('active');
            
            document.getElementById('header-title').textContent = 'Profil';
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-action').innerHTML = '';
            
            document.getElementById('header-back-button').addEventListener('click', function() {
                showDiscussionsSection();
            });

            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            history.pushState({ page: 'profile' }, '');
        }
        
        async function updateDisplayName() {
            if (!profileNameChanged) return;
            
            const displayName = document.getElementById('edit-display-name').value.trim();
            
            if (!displayName) {
                document.getElementById('edit-display-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-display-name-error').style.display = 'none';
            }
            
            document.getElementById('save-display-name-btn').disabled = true;
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    displayName: displayName
                });
                
                currentUserData.displayName = displayName;
                
                updateProfileInfo();
                
                showNotification('Nom d\'utilisateur mis à jour', 'success');
                profileNameChanged = false;
            } catch (error) {
                handleFirestoreError(error, 'mise à jour du nom d\'utilisateur');
                showNotification('Erreur lors de la mise à jour du nom d\'utilisateur', 'error');
            } finally {
                document.getElementById('save-display-name-btn').disabled = false;
            }
        }
        
        async function updateProfileImage() {
            if (!profileImageFile) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-profile-image-btn', true);
            
            try {
                const userRef = doc(db, "Users", currentUser.uid);
                await updateDoc(userRef, {
                    photoURL: profileImageFile
                });
                
                currentUserData.photoURL = profileImageFile;
                
                updateProfileInfo();
                
                showNotification('Photo de profil mise à jour', 'success');
                profileImageFile = null;
            } catch (error) {
                handleFirestoreError(error, 'mise à jour de la photo de profil');
                showNotification('Erreur lors de la mise à jour de la photo', 'error');
            } finally {
                setButtonLoading('save-profile-image-btn', false);
            }
        }
        
        async function updateGroupName() {
            if (!groupNameChanged || !editingGroupId) return;
            
            const groupName = document.getElementById('edit-group-name').value.trim();
            
            if (!groupName) {
                document.getElementById('edit-group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('edit-group-name-error').style.display = 'none';
            }
            
            document.getElementById('save-group-name-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "discussions", editingGroupId);
                await updateDoc(groupRef, {
                    name: groupName,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId) {
                    currentGroup = groupName;
                    if (currentGroupData) {
                        currentGroupData.name = groupName;
                    }
                    
                    updateGroupHeader();
                }
                
                showNotification('Nom du groupe mis à jour', 'success');
                groupNameChanged = false;
                
                loadDiscussions();
            } catch (error) {
                handleFirestoreError(error, 'mise à jour du nom du groupe');
                showNotification('Erreur lors de la mise à jour du nom', 'error');
            } finally {
                document.getElementById('save-group-name-btn').disabled = false;
            }
        }
        
        function updateGroupHeader() {
            if (!currentGroupData) return;
            
            const headerTitle = document.getElementById('header-title');
            if (!headerTitle) return;
            
            if (currentGroupData.allowPublicMessages === false) {
                headerTitle.innerHTML = `${currentGroup} <span class="restricted-badge">Restreint</span>`;
            } else {
                headerTitle.innerText = currentGroup;
            }
        }
        
        async function updateGroupDescription() {
            if (!groupDescriptionChanged || !editingGroupId) return;
            
            const groupDescription = document.getElementById('edit-group-description').value.trim();
            
            document.getElementById('save-group-description-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "discussions", editingGroupId);
                await updateDoc(groupRef, {
                    description: groupDescription,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.description = groupDescription;
                }
                
                showNotification('Description du groupe mise à jour', 'success');
                groupDescriptionChanged = false;
            } catch (error) {
                handleFirestoreError(error, 'mise à jour de la description du groupe');
                showNotification('Erreur lors de la mise à jour de la description', 'error');
            } finally {
                document.getElementById('save-group-description-btn').disabled = false;
            }
        }
        
        async function updateGroupPermissions() {
            if (!groupPermissionsChanged || !editingGroupId) return;
            
            const allowPublicMessages = document.getElementById('edit-group-public-messages').checked;
            
            document.getElementById('save-group-permissions-btn').disabled = true;
            
            try {
                const groupRef = doc(db, "discussions", editingGroupId);
                
                const groupDoc = await getDoc(groupRef);
                if (!groupDoc.exists()) {
                    throw new Error("Groupe introuvable");
                }
                
                const groupData = groupDoc.data();
                const permissionsChanged = allowPublicMessages !== groupData.allowPublicMessages;
                
                await updateDoc(groupRef, {
                    allowPublicMessages: allowPublicMessages,
                    lastUpdated: serverTimestamp()
                });
                
                if (permissionsChanged) {
                    try {
                        await addEventLog({
                            type: 'permission-change',
                            groupId: editingGroupId,
                            groupName: groupData.name,
                            userId: currentUser.uid,
                            allowPublicMessages,
                            timestamp: new Date()
                        });
                    } catch (error) {
                    }
                }
                
                if (currentGroupId === editingGroupId) {
                    if (currentGroupData) {
                        currentGroupData.allowPublicMessages = allowPublicMessages;
                    }
                    
                    updateGroupHeader();
                    
                    checkSendPermissions();
                }
                
                showNotification('Permissions du groupe mises à jour', 'success');
                groupPermissionsChanged = false;
            } catch (error) {
                handleFirestoreError(error, 'mise à jour des permissions du groupe');
                showNotification('Erreur lors de la mise à jour des permissions', 'error');
            } finally {
                document.getElementById('save-group-permissions-btn').disabled = false;
            }
        }
        
        async function updateGroupImage() {
            if (!groupImageFile || !editingGroupId) {
                showNotification('Aucune nouvelle image sélectionnée', 'info');
                return;
            }
            
            setButtonLoading('save-group-image-btn', true);
            
            try {
                const groupRef = doc(db, "discussions", editingGroupId);
                await updateDoc(groupRef, {
                    imageURL: groupImageFile,
                    lastUpdated: serverTimestamp()
                });
                
                if (currentGroupId === editingGroupId && currentGroupData) {
                    currentGroupData.imageURL = groupImageFile;
                }
                
                showNotification('Image du groupe mise à jour', 'success');
                groupImageFile = null;
                
                loadDiscussions();
            } catch (error) {
                handleFirestoreError(error, 'mise à jour de l\'image du groupe');
                showNotification('Erreur lors de la mise à jour de l\'image', 'error');
            } finally {
                setButtonLoading('save-group-image-btn', false);
            }
        }
        
        function setupAuthEvents() {
            document.getElementById('login-tab').addEventListener('click', () => changeAuthTab('login'));
            document.getElementById('register-tab').addEventListener('click', () => changeAuthTab('register'));
            
            document.getElementById('goto-register').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('register');
            });
            
            document.getElementById('goto-login').addEventListener('click', (e) => {
                e.preventDefault();
                changeAuthTab('login');
            });
            
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            document.getElementById('login-email').addEventListener('input', validateLoginEmail);
            document.getElementById('login-password').addEventListener('input', validateLoginPassword);
            document.getElementById('register-email').addEventListener('input', validateRegisterEmail);
            document.getElementById('register-password').addEventListener('input', validateRegisterPassword);
            document.getElementById('register-confirm-password').addEventListener('input', validateRegisterConfirmPassword);
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateLoginForm()) {
                    loginUser();
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateRegisterForm()) {
                    registerUser();
                }
            });
        }
        
        function encodeImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    resolve(event.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function handleProfileImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const optimizedImage = await optimizeImage(file, 300);
                const base64Image = await encodeImageToBase64(optimizedImage);
                profileImageFile = base64Image;
                
                const preview = document.getElementById('profile-image-preview');
                preview.innerHTML = `<img src="${base64Image}" alt="Profile Image">`;
                
                document.getElementById('save-profile-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleNewGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const optimizedImage = await optimizeImage(file, 300);
                const base64Image = await encodeImageToBase64(optimizedImage);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('new-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="new-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('new-group-image-upload').addEventListener('click', () => {
                    document.getElementById('new-group-image-input').click();
                });
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        async function handleEditGroupImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Veuillez sélectionner une image', 'error');
                return;
            }
            
            try {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('L\'image est trop volumineuse (max 5 Mo)', 'error');
                    return;
                }
                
                const optimizedImage = await optimizeImage(file, 300);
                const base64Image = await encodeImageToBase64(optimizedImage);
                groupImageFile = base64Image;
                
                const preview = document.getElementById('edit-group-image-preview');
                preview.innerHTML = `
                    <img src="${base64Image}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
                
                document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                    document.getElementById('edit-group-image-input').click();
                });
                
                document.getElementById('save-group-image-btn').disabled = false;
                
            } catch (error) {
                showNotification('Erreur lors du traitement de l\'image', 'error');
            }
        }
        
        function showProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.add('active');
            
            document.getElementById('edit-display-name').value = currentUserData.displayName || '';
            
            document.getElementById('save-display-name-btn').disabled = true;
            document.getElementById('save-profile-image-btn').disabled = true;
            
            profileNameChanged = false;
            profileImageFile = null;
            
            const profileImagePreview = document.getElementById('profile-image-preview');
            if (currentUserData.photoURL) {
                profileImagePreview.innerHTML = `<img src="${currentUserData.photoURL}" alt="Profile">`;
            } else {
                profileImagePreview.innerHTML = `<i class="fas fa-user"></i>`;
            }
            
            history.pushState({ page: 'profile-edit' }, '');
        }
        
        function hideProfileEditDialog() {
            document.getElementById('profile-edit-dialog').classList.remove('active');
            
            profileNameChanged = false;
            profileImageFile = null;
            document.getElementById('profile-image-input').value = '';
        }

        // Fonction pour marquer les messages comme lus
        async function markMessagesAsRead(discussionId, discussionType) {
            try {
                if (discussionType === 'group') {
                    const userReadStatusRef = doc(db, "discussions", discussionId, "readStatus", currentUser.uid);
                    await setDoc(userReadStatusRef, {
                        lastReadTime: serverTimestamp(),
                        userId: currentUser.uid
                    });
                } else if (discussionType === 'direct') {
                    const userReadStatusRef = doc(db, "directChats", discussionId, "readStatus", currentUser.uid);
                    await setDoc(userReadStatusRef, {
                        lastReadTime: serverTimestamp(),
                        userId: currentUser.uid
                    });
                }
                
                // Supprimer de la cache des messages non lus
                delete unreadCounts[discussionId];
                
                // Mettre à jour l'affichage
                updateDiscussionElement(discussionId);
                
            } catch (error) {
                console.error('Erreur lors du marquage des messages comme lus:', error);
            }
        }

        // Fonction pour calculer les messages non lus
        async function calculateUnreadCount(discussionId, discussionType, lastMessageTime) {
            try {
                let userReadStatusRef;
                
                if (discussionType === 'group') {
                    userReadStatusRef = doc(db, "discussions", discussionId, "readStatus", currentUser.uid);
                } else {
                    userReadStatusRef = doc(db, "directChats", discussionId, "readStatus", currentUser.uid);
                }
                
                const readStatusDoc = await getDoc(userReadStatusRef);
                
                if (!readStatusDoc.exists()) {
                    // L'utilisateur n'a jamais lu cette discussion
                    if (lastMessageTime) {
                        // Compter tous les messages depuis la création
                        let messagesRef;
                        if (discussionType === 'group') {
                            messagesRef = collection(db, "discussions", discussionId, "messages");
                        } else {
                            messagesRef = collection(db, "directChats", discussionId, "messages");
                        }
                        
                        const messagesQuery = query(messagesRef, where("from", "!=", currentUser.uid));
                        const messagesSnapshot = await getDocs(messagesQuery);
                        
                        return messagesSnapshot.size;
                    }
                    return 0;
                }
                
                const lastReadTime = readStatusDoc.data().lastReadTime;
                
                if (!lastReadTime || !lastMessageTime) {
                    return 0;
                }
                
                // Comparer les timestamps
                let messagesRef;
                if (discussionType === 'group') {
                    messagesRef = collection(db, "discussions", discussionId, "messages");
                } else {
                    messagesRef = collection(db, "directChats", discussionId, "messages");
                }
                
                const unreadQuery = query(
                    messagesRef,
                    where("createdAt", ">", lastReadTime),
                    where("from", "!=", currentUser.uid)
                );
                
                const unreadSnapshot = await getDocs(unreadQuery);
                return unreadSnapshot.size;
                
            } catch (error) {
                console.error('Erreur lors du calcul des messages non lus:', error);
                return 0;
            }
        }

        // Fonction pour mettre à jour l'élément de discussion
        function updateDiscussionElement(discussionId) {
            const discussionElement = document.querySelector(`[data-id="${discussionId}"]`);
            if (!discussionElement) return;
            
            const unreadBadge = discussionElement.querySelector('.unread-badge');
            const unreadCount = unreadCounts[discussionId] || 0;
            
            if (unreadCount > 0) {
                if (unreadBadge) {
                    unreadBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                } else {
                    // Ajouter le badge de messages non lus
                    const itemMeta = discussionElement.querySelector('.item-meta');
                    if (itemMeta) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                        itemMeta.appendChild(badge);
                    }
                }
            } else {
                if (unreadBadge) {
                    unreadBadge.remove();
                }
            }
        }
        
        async function loadUsers() {
            if (isLoadingUsers) return;
            isLoadingUsers = true;
            
            const usersList = document.getElementById('users-list');
            if (!usersList) return;
            
            usersList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des utilisateurs...</div>
                </div>
            `;
            
            try {
                if (Object.keys(usersCache).length > 0) {
                    displayUsersFromCache();
                    isLoadingUsers = false;
                    return;
                }
                
                if (usersUnsubscribe) {
                    usersUnsubscribe();
                    usersUnsubscribe = null;
                }
                
                const usersRef = collection(db, "Users");
                
                usersUnsubscribe = onSnapshot(usersRef, (snapshot) => {
                    if (snapshot.empty) {
                        usersList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-address-book"></i>
                                <div class="empty-state-title">Aucun utilisateur</div>
                                <div class="empty-state-text">Aucun utilisateur trouvé</div>
                            </div>
                        `;
                        isLoadingUsers = false;
                        return;
                    }
                    
                    usersCache = {};
                    
                    snapshot.forEach((doc) => {
                        if (doc.id !== currentUser.uid) {
                            usersCache[doc.id] = {
                                id: doc.id,
                                ...doc.data()
                            };
                        }
                    });
                    
                    displayUsersFromCache();
                    isLoadingUsers = false;
                }, (error) => {
                    handleFirestoreError(error, 'chargement des utilisateurs');
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les utilisateurs</div>
                        </div>
                    `;
                    isLoadingUsers = false;
                });
            } catch (error) {
                handleFirestoreError(error, 'chargement des utilisateurs');
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les utilisateurs</div>
                    </div>
                `;
                isLoadingUsers = false;
            }
        }
        
        function displayUsersFromCache() {
            const usersList = document.getElementById('users-list');
            if (!usersList) return;
            
            if (Object.keys(usersCache).length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-address-book"></i>
                        <div class="empty-state-title">Aucun utilisateur</div>
                        <div class="empty-state-text">Aucun utilisateur trouvé</div>
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            
            Object.values(usersCache).forEach(userData => {
                const userElement = createUserElement(userData);
                fragment.appendChild(userElement);
            });
            
            usersList.appendChild(fragment);
        }
        
        function createUserElement(userData) {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.setAttribute('data-id', userData.id);
            
            const isUserAdmin = userData.statut === 'admin';
            
            userItem.innerHTML = `
                <div class="user-pic">
                    ${userData.photoURL ? `<img src="${userData.photoURL}" alt="${userData.displayName || 'Utilisateur'}">` : '<i class="fas fa-user"></i>'}
                </div>
                <div class="item-content">
                    <div class="item-title">
                        ${userData.displayName || 'Utilisateur'}
                        ${isUserAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                    </div>
                    <div class="item-subtitle">
                        ${userData.email || ''}
                    </div>
                </div>
            `;
            
            userItem.addEventListener('click', () => {
                openDirectChat(userData);
            });
            
            return userItem;
        }
        
        function filterUsers(query) {
            const userItems = document.querySelectorAll('.user-item');
            const lowerQuery = query.toLowerCase();
            
            userItems.forEach(item => {
                const userId = item.getAttribute('data-id');
                const userData = usersCache[userId];
                
                if (!userData) return;
                
                const displayName = (userData.displayName || 'Utilisateur').toLowerCase();
                const email = (userData.email || '').toLowerCase();
                
                if (displayName.includes(lowerQuery) || email.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleUsers = 0;
            userItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleUsers++;
                }
            });
            
            const emptyState = document.querySelector('#users-list .empty-state');
            if (visibleUsers === 0 && userItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun résultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun utilisateur ne correspond à "${query}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun résultat</div>
                        <div class="empty-state-text">Aucun utilisateur ne correspond à "${query}"</div>
                    `;
                    document.getElementById('users-list').appendChild(newEmptyState);
                }
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        function openDirectChat(userData) {
            currentChatPartner = userData;
            
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'chat';
            currentGroupId = null;
            currentGroup = userData.displayName || 'Utilisateur';
            currentGroupData = null;
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('chat-interface').style.display = 'block';
            
            document.getElementById('header-title').innerText = userData.displayName || 'Utilisateur';
            
            document.getElementById('header-action').innerHTML = ``;
            
            document.getElementById('chat-messages').innerHTML = '';
            
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            setupChatInput();
            
            const user1 = currentUser.uid;
            const user2 = userData.id;
            const chatId = [user1, user2].sort().join('_');
            
            loadDirectMessages(chatId);
            
            updateDirectChatInCache(chatId, userData);
            
            // Marquer les messages comme lus
            markMessagesAsRead(chatId, 'direct');
            
            history.pushState({ page: 'direct-chat' }, '');
        }
        
        async function loadDirectMessages(chatId) {
            try {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des messages...</div>
                    </div>
                `;
                
                if (chatUnsubscribers[chatId]) {
                    chatUnsubscribers[chatId]();
                    delete chatUnsubscribers[chatId];
                }
                
                const chatDocRef = doc(db, "directChats", chatId);
                const chatDoc = await getDoc(chatDocRef);
                
                if (!chatDoc.exists()) {
                    await setDoc(chatDocRef, {
                        participants: [currentUser.uid, currentChatPartner.id],
                        createdAt: serverTimestamp(),
                        lastMessageTime: serverTimestamp()
                    });
                }
                
                const messagesRef = collection(db, "directChats", chatId, "messages");
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                chatUnsubscribers[chatId] = onSnapshot(q, async (snapshot) => {
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                <i class="fas fa-comments" style="font-size: 30px; margin-bottom: 10px;"></i>
                                <div>Aucun message. Commencez la conversation !</div>
                            </div>
                        `;
                        return;
                    }
                    
                    let lastDate = null;
                    
                    for (const doc of snapshot.docs) {
                        const messageData = doc.data();
                        
                        if (messageData.createdAt) {
                            const messageDate = messageData.createdAt.toDate();
                            const messageDay = new Date(messageDate.getFullYear(), messageDate.getMonth(), messageDate.getDate());
                            
                            if (!lastDate || messageDay.getTime() !== lastDate.getTime()) {
                                const dateSeparator = createDateSeparator(messageDate);
                                messagesContainer.appendChild(dateSeparator);
                                lastDate = messageDay;
                            }
                        }
                        
                        const messageElement = await createMessageElement(doc.id, messageData);
                        messagesContainer.appendChild(messageElement);
                    }
                    
                    scrollToBottom();
                }, (error) => {
                    handleFirestoreError(error, 'chargement des messages directs');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                                <div>Erreur lors du chargement des messages</div>
                            </div>
                        `;
                    }
                });
                
            } catch (error) {
                handleFirestoreError(error, 'chargement des messages directs');
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                            <div>Erreur lors du chargement des messages</div>
                        </div>
                    `;
                }
            }
        }
        
        function updateDirectChatInCache(chatId, userData) {
            directChatsCache[chatId] = {
                id: chatId,
                name: userData.displayName || 'Utilisateur',
                type: 'direct',
                partner: userData,
                lastMessage: null,
                lastMessageTime: new Date()
            };
        }
        
        async function loadDiscussions() {
            if (isLoadingGroups) return;
            isLoadingGroups = true;
            
            const discussionsList = document.getElementById('discussions-list');
            if (!discussionsList) return;
            
            discussionsList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des discussions...</div>
                </div>
            `;
            
            try {
                allDiscussions = [];
                unreadCounts = {};
                
                // Load discussions from the "discussions" collection
                const discussionsRef = collection(db, "discussions");
                const discussionsQuery = query(discussionsRef, orderBy("lastUpdated", "desc"));
                const discussionsSnap = await getDocs(discussionsQuery);
                
                for (const doc of discussionsSnap.docs) {
                    const discussionData = doc.data();
                    
                    // Calculer les messages non lus
                    const unreadCount = await calculateUnreadCount(doc.id, 'group', discussionData.lastUpdated);
                    unreadCounts[doc.id] = unreadCount;
                    
                    allDiscussions.push({
                        id: doc.id,
                        type: 'group',
                        name: discussionData.name || 'Sans nom',
                        data: discussionData,
                        lastMessageTime: discussionData.lastUpdated || discussionData.createdAt
                    });
                }
                
                // Load direct chats
                const directChatsRef = collection(db, "directChats");
                const directChatsQuery = query(
                    directChatsRef, 
                    where("participants", "array-contains", currentUser.uid),
                    orderBy("lastMessageTime", "desc")
                );
                const directChatsSnap = await getDocs(directChatsQuery);
                
                for (const chatDoc of directChatsSnap.docs) {
                    const chatData = chatDoc.data();
                    const partnerId = chatData.participants.find(id => id !== currentUser.uid);
                    
                    let partnerData = null;
                    if (usersCache[partnerId]) {
                        partnerData = usersCache[partnerId];
                    } else {
                        try {
                            const userDoc = await getDoc(doc(db, "Users", partnerId));
                            if (userDoc.exists()) {
                                partnerData = { id: partnerId, ...userDoc.data() };
                                usersCache[partnerId] = partnerData;
                            }
                        } catch (error) {
                            continue;
                        }
                    }
                    
                    if (partnerData) {
                        // Calculer les messages non lus pour cette discussion directe
                        const unreadCount = await calculateUnreadCount(chatDoc.id, 'direct', chatData.lastMessageTime);
                        unreadCounts[chatDoc.id] = unreadCount;
                        
                        allDiscussions.push({
                            id: chatDoc.id,
                            type: 'direct',
                            name: partnerData.displayName || 'Utilisateur',
                            data: chatData,
                            partner: partnerData,
                            lastMessageTime: chatData.lastMessageTime
                        });
                    }
                }
                
                // Sort by last message time
                allDiscussions.sort((a, b) => {
                    const timeA = a.lastMessageTime ? (a.lastMessageTime.toDate ? a.lastMessageTime.toDate() : a.lastMessageTime) : new Date(0);
                    const timeB = b.lastMessageTime ? (b.lastMessageTime.toDate ? b.lastMessageTime.toDate() : b.lastMessageTime) : new Date(0);
                    return timeB - timeA;
                });
                
                displayDiscussions();
                
            } catch (error) {
                handleFirestoreError(error, 'chargement des discussions');
                discussionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les discussions</div>
                    </div>
                `;
            } finally {
                isLoadingGroups = false;
            }
        }
        
        function displayDiscussions() {
            const discussionsList = document.getElementById('discussions-list');
            if (!discussionsList) return;
            
            if (allDiscussions.length === 0) {
                discussionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <div class="empty-state-title">Aucune discussion</div>
                        <div class="empty-state-text">Vos discussions apparaîtront ici</div>
                    </div>
                `;
                return;
            }
            
            discussionsList.innerHTML = '';
            
            allDiscussions.forEach(discussion => {
                const discussionElement = createDiscussionElement(discussion);
                discussionsList.appendChild(discussionElement);
            });
        }
        
        function createDiscussionElement(discussion) {
            const discussionElement = document.createElement('div');
            discussionElement.className = 'chat-item';
            discussionElement.setAttribute('data-group', discussion.name);
            discussionElement.setAttribute('data-id', discussion.id);
            discussionElement.setAttribute('data-type', discussion.type);
            
            let lastMessageText = 'Pas de messages';
            let lastMessageFrom = '';
            let lastMessageTime = '';
            let imageUrl = '';
            let badgeHtml = '';
            let senderName = '';
            
            if (discussion.type === 'group') {
                const groupData = discussion.data;
                
                if (groupData.lastMessage) {
                    lastMessageText = groupData.lastMessage.text || 'Nouveau message';
                    if (groupData.lastMessage.from === currentUser.uid) {
                        senderName = 'Vous';
                    } else if (usersCache[groupData.lastMessage.from]) {
                        senderName = usersCache[groupData.lastMessage.from].displayName || 'Utilisateur';
                    } else {
                        senderName = 'Utilisateur';
                    }
                    lastMessageFrom = senderName + ': ';
                    
                    if (groupData.lastMessage.timestamp) {
                        const now = new Date();
                        const messageDate = groupData.lastMessage.timestamp.toDate();
                        
                        if (messageDate.toDateString() === now.toDateString()) {
                            lastMessageTime = messageDate.toLocaleTimeString('fr-FR', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } else {
                            lastMessageTime = messageDate.toLocaleDateString('fr-FR', {
                                day: 'numeric',
                                month: 'short'
                            });
                        }
                    }
                }
                
                imageUrl = groupData.imageURL;
                
                if (groupData.allowPublicMessages === false) {
                    badgeHtml = '<span class="restricted-badge">Restreint</span>';
                }
                badgeHtml += '<span class="discussion-type-badge group">Groupe</span>';
                
            } else if (discussion.type === 'direct') {
                const partnerData = discussion.partner;
                imageUrl = partnerData.photoURL;
                lastMessageText = 'Discussion privée';
                badgeHtml = '<span class="discussion-type-badge direct">Direct</span>';
                
                if (partnerData.statut === 'admin') {
                    badgeHtml = '<span class="admin-badge">Admin</span>' + badgeHtml;
                }
            }
            
            // Badge de messages non lus
            const unreadCount = unreadCounts[discussion.id] || 0;
            let unreadBadgeHtml = '';
                if (unreadCount > 0) {
                unreadBadgeHtml = `<div class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</div>`;
            }
            
            discussionElement.innerHTML = `
                <div class="${discussion.type === 'group' ? 'group-pic' : 'profile-pic'}">
                    ${imageUrl ? `<img src="${imageUrl}" alt="${discussion.name}">` : (discussion.type === 'group' ? '<i class="fas fa-users"></i>' : '<i class="fas fa-user"></i>')}
                    ${discussion.type === 'group' && isAdmin ? '<div class="group-pic-edit"><i class="fas fa-pencil-alt"></i></div>' : ''}
                </div>
                <div class="item-content">
                    <div class="item-title">
                        ${discussion.name}
                        ${badgeHtml}
                    </div>
                    <div class="item-subtitle">
                        ${lastMessageFrom}${lastMessageText}
                    </div>
                </div>
                <div class="item-meta">
                    <div class="item-time">${lastMessageTime}</div>
                    ${unreadBadgeHtml}
                </div>
            `;
            
            discussionElement.addEventListener('click', () => {
                if (discussion.type === 'group') {
                    openChat(discussion.id, discussion.name, discussion.data);
                } else {
                    openDirectChat(discussion.partner);
                }
            });
            
            if (discussion.type === 'group' && isAdmin) {
                const editButton = discussionElement.querySelector('.group-pic-edit');
                if (editButton) {
                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editingGroupId = discussion.id;
                        showEditGroupDialog(discussion.data);
                    });
                }
            }
            
            return discussionElement;
        }
        
        function filterDiscussions(query) {
            const chatItems = document.querySelectorAll('.chat-item');
            const lowerQuery = query.toLowerCase();
            
            chatItems.forEach(item => {
                const groupName = item.getAttribute('data-group').toLowerCase();
                
                if (groupName.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleChats = 0;
            chatItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleChats++;
                }
            });
            
            const discussionsList = document.getElementById('discussions-list');
            const emptyState = discussionsList.querySelector('.empty-state');
            
            if (visibleChats === 0 && chatItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun résultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucune discussion ne correspond à "${query}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun résultat</div>
                        <div class="empty-state-text">Aucune discussion ne correspond à "${query}"</div>
                    `;
                    discussionsList.appendChild(newEmptyState);
                }
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        function openChat(groupId, groupName, groupData) {
            hideSearchBar();
            hideMessageActionsBar();
            
            currentSection = 'chat';
            currentGroupId = groupId;
            currentGroup = groupName;
            currentGroupData = groupData;
            currentChatPartner = null;
            
            document.getElementById('header-menu-button').style.display = 'none';
            document.getElementById('header-back-button').style.display = 'block';
            
            document.getElementById('header-back-button').addEventListener('click', closeChat);
            
            document.getElementById('chat-interface').style.display = 'block';
            
            updateGroupHeader();
            
            let headerActionHtml = '';
            if (isAdmin) {
                headerActionHtml = `
                    <div class="info-button" id="group-info-button">
                        <i class="fas fa-info-circle"></i>
                    </div>
                `;
            }
            
            document.getElementById('header-action').innerHTML = headerActionHtml;
            
            if (isAdmin) {
                document.getElementById('group-info-button').addEventListener('click', showGroupInfoDialog);
            }
            
            document.getElementById('chat-messages').innerHTML = '';
            
            document.getElementById('bottom-nav').style.display = 'none';
            document.querySelector('.content').classList.add('no-bottom-nav');
            
            setupChatInput();
            loadMessages();
            
            // Marquer les messages comme lus
            markMessagesAsRead(groupId, 'group');
            
            history.pushState({ page: 'group-chat' }, '');
        }
        
        function closeChat() {
            document.getElementById('chat-interface').style.display = 'none';
            
            currentSection = 'discussions';
            currentGroupId = null;
            currentGroup = '';
            currentGroupData = null;
            currentChatPartner = null;
            
            document.getElementById('header-menu-button').style.display = 'block';
            document.getElementById('header-back-button').style.display = 'none';
            
            if (chatUnsubscribers[currentGroupId || currentChatPartner?.id]) {
                chatUnsubscribers[currentGroupId || currentChatPartner?.id]();
                delete chatUnsubscribers[currentGroupId || currentChatPartner?.id];
            }
            
            showDiscussionsSection();
        }
        
        function setupChatInput() {
            const chatInput = document.getElementById('chat-input');
            if (!chatInput) return;
            
            chatInput.value = '';
            chatInput.placeholder = 'Écrire un message...';
            
            const imageButton = document.getElementById('image-button');
            if (imageButton) {
                imageButton.style.color = 'var(--primary-color)';
            }
            
            chatImageFile = null;
            
            cancelReply();
            
            checkSendPermissions();
            
            setupTextareaAutoResize();
        }
        
        function checkSendPermissions() {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const imageButton = document.getElementById('image-button');
            const chatInputContainer = document.getElementById('chat-input-container');
            
            if (!chatInput || !sendButton || !imageButton || !chatInputContainer) return;
            
            if (currentChatPartner) {
                chatInput.disabled = false;
                sendButton.disabled = false;
                imageButton.disabled = false;
                chatInputContainer.style.display = 'flex';
                return;
            }
            
            if (!currentGroupData) return;
            
            const canSend = currentGroupData.allowPublicMessages !== false || isAdmin;
            
            chatInput.disabled = !canSend;
            sendButton.disabled = !canSend;
            imageButton.disabled = !canSend;
            
            if (!canSend) {
                chatInput.placeholder = 'Seuls les administrateurs peuvent écrire dans ce groupe';
                chatInputContainer.innerHTML = `
                    <div class="restricted-message">
                        <i class="fas fa-lock"></i>
                        Seuls les administrateurs peuvent écrire des messages dans ce groupe
                    </div>
                `;
            } else {
                chatInputContainer.innerHTML = `
                    <div class="image-button" id="image-button">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="chat-input-wrapper" id="chat-input-wrapper">
                        <div class="reply-preview" id="reply-preview">
                            <div class="reply-preview-close" id="reply-close">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="reply-preview-header">Réponse à <span id="reply-name">Utilisateur</span></div>
                            <div class="reply-preview-content" id="reply-content">Message original</div>
                        </div>
                        <textarea id="chat-input" class="chat-input" placeholder="Écrire un message..." autocomplete="off" rows="1"></textarea>
                    </div>
                    <div class="send-button" id="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                `;
                
                document.getElementById('image-button').addEventListener('click', function() {
                    document.getElementById('chat-image-input').click();
                });
                
                document.getElementById('send-button').addEventListener('click', sendMessage);
                
                document.getElementById('reply-close').addEventListener('click', function() {
                    cancelReply();
                });
                
                const chatInputElement = document.getElementById('chat-input');
                chatInputElement.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                setupTextareaAutoResize();
            }
        }
        
        async function loadMessages() {
            if (!currentGroupId) return;
            
            try {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                        <div style="margin-top: 10px; font-weight: bold;">Chargement des messages...</div>
                    </div>
                `;
                
                if (chatUnsubscribers[currentGroupId]) {
                    chatUnsubscribers[currentGroupId]();
                    delete chatUnsubscribers[currentGroupId];
                }
                
                const messagesRef = collection(db, "discussions", currentGroupId, "messages");
                const q = query(messagesRef, orderBy("createdAt", "asc"));
                
                chatUnsubscribers[currentGroupId] = onSnapshot(q, async (snapshot) => {
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--inactive-text);">
                                <i class="fas fa-comments" style="font-size: 30px; margin-bottom: 10px;"></i>
                                <div>Aucun message. Commencez la conversation !</div>
                            </div>
                        `;
                        return;
                    }
                    
                    let lastDate = null;
                    
                    for (const doc of snapshot.docs) {
                        const messageData = doc.data();
                        
                        if (messageData.createdAt) {
                            const messageDate = messageData.createdAt.toDate();
                            const messageDay = new Date(messageDate.getFullYear(), messageDate.getMonth(), messageDate.getDate());
                            
                            if (!lastDate || messageDay.getTime() !== lastDate.getTime()) {
                                const dateSeparator = createDateSeparator(messageDate);
                                messagesContainer.appendChild(dateSeparator);
                                lastDate = messageDay;
                            }
                        }
                        
                        const messageElement = await createMessageElement(doc.id, messageData);
                        messagesContainer.appendChild(messageElement);
                    }
                    
                    scrollToBottom();
                }, (error) => {
                    handleFirestoreError(error, 'chargement des messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                                <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                                <div>Erreur lors du chargement des messages</div>
                            </div>
                        `;
                    }
                });
                
            } catch (error) {
                handleFirestoreError(error, 'chargement des messages');
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                            <div>Erreur lors du chargement des messages</div>
                        </div>
                    `;
                }
            }
        }
        
        function createDateSeparator(date) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'date-separator';
            
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            
            let dateText;
            if (date.toDateString() === today.toDateString()) {
                dateText = "Aujourd'hui";
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateText = "Hier";
            } else {
                dateText = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
            
            dateSeparator.innerHTML = `<div class="date-separator-text">${dateText}</div>`;
            
            return dateSeparator;
        }
        
        async function createMessageElement(messageId, messageData) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            messageContainer.setAttribute('data-id', messageId);
            messageContainer.setAttribute('data-from', messageData.from);
            
            const isSentByMe = messageData.from === currentUser.uid;
            messageContainer.classList.add(isSentByMe ? 'sent' : 'received');
            
            let senderName = '';
            if (!isSentByMe && currentGroupId) {
                if (usersCache[messageData.from]) {
                    senderName = usersCache[messageData.from].displayName || 'Utilisateur';
                } else {
                    try {
                        const userDoc = await getDoc(doc(db, "Users", messageData.from));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            senderName = userData.displayName || 'Utilisateur';
                            usersCache[messageData.from] = { id: messageData.from, ...userData };
                        } else {
                            senderName = 'Utilisateur';
                        }
                    } catch (error) {
                        senderName = 'Utilisateur';
                    }
                }
            }
            
            let messageHTML = '';
            
            if (!isSentByMe && currentGroupId) {
                messageHTML += `<div class="message-sender">${senderName}</div>`;
            }
            
            let replyQuoteHTML = '';
            if (messageData.replyTo) {
                let replyToName = 'Utilisateur';
                if (messageData.replyTo.from === currentUser.uid) {
                    replyToName = 'Vous';
                } else if (usersCache[messageData.replyTo.from]) {
                    replyToName = usersCache[messageData.replyTo.from].displayName || 'Utilisateur';
                }
                
                replyQuoteHTML = `
                    <div class="message-quote">
                        <div class="message-quote-sender">${replyToName}</div>
                        <div class="message-quote-content">${messageData.replyTo.text || 'Message'}</div>
                    </div>
                `;
            }
            
            const messageClass = isSentByMe ? 'message-sent' : 'message-received';
            
            let messageContent = '';
            if (messageData.imageData) {
                messageContent = `
                    <div class="message ${messageClass} message-with-image">
                        ${replyQuoteHTML}
                        <img src="${messageData.imageData}" alt="Image" class="message-image">
                        ${messageData.text ? `<div class="message-text">${messageData.text}</div>` : ''}
                        <div class="message-time">${formatMessageTime(messageData.createdAt)}</div>
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="message ${messageClass}">
                        ${replyQuoteHTML}
                        <div>${messageData.text || ''}</div>
                        <div class="message-time">${formatMessageTime(messageData.createdAt)}</div>
                    </div>
                `;
            }
            
            messageHTML += messageContent;
            messageContainer.innerHTML = messageHTML;
            
            const messageElement = messageContainer.querySelector('.message');
            if (messageElement) {
                setupMessageInteractions(messageElement, messageId, messageData);
            }
            
            return messageContainer;
        }
        
        function setupMessageInteractions(messageElement, messageId, messageData) {
            let touchStartTime = 0;
            let touchStarted = false;
            
            messageElement.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) return;
                
                touchStartTime = Date.now();
                touchStarted = true;
                
                longPressTimer = setTimeout(() => {
                    if (touchStarted) {
                        showMessageActionsBar(messageElement);
                    }
                }, longPressDuration);
            }, { passive: true });
            
            messageElement.addEventListener('touchend', function(e) {
                touchStarted = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                
                const touchEndTime = Date.now();
                const touchDuration = touchEndTime - touchStartTime;
                
                if (touchDuration < 200) {
                    if (messageData.imageData) {
                        const img = messageElement.querySelector('.message-image');
                        if (img && e.target === img) {
                            showImageViewer(messageData.imageData);
                        }
                    }
                }
            }, { passive: true });
            
            messageElement.addEventListener('touchmove', function(e) {
                touchStarted = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }, { passive: true });
            
            messageElement.addEventListener('touchcancel', function(e) {
                touchStarted = false;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }, { passive: true });
            
            if (messageData.imageData) {
                const img = messageElement.querySelector('.message-image');
                if (img) {
                    img.addEventListener('click', function() {
                        showImageViewer(messageData.imageData);
                    });
                }
            }
        }
        
        function handleGlobalTouchStart(e) {
            // Handle global touch events if needed
        }
        
        function handleGlobalTouchEnd(e) {
            // Handle global touch events if needed
        }
        
        function handleGlobalTouchMove(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function handleGlobalTouchCancel(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate();
            return date.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }
        
        async function sendMessage() {
            if (processingMessage) return;
            
            const messageText = document.getElementById('chat-input').value.trim();
            
            if (!messageText && !chatImageFile) {
                return;
            }
            
            processingMessage = true;
            
            try {
                const messageData = {
                    text: messageText,
                    imageData: chatImageFile,
                    replyTo: replyingToMessage
                };
                
                if (currentChatPartner) {
                    const user1 = currentUser.uid;
                    const user2 = currentChatPartner.id;
                    const chatId = [user1, user2].sort().join('_');
                    
                    await sendDirectMessage(chatId, messageText, chatImageFile, replyingToMessage);
                } else if (currentGroupId) {
                    await sendMessageToFirestore(currentGroupId, messageText, chatImageFile, replyingToMessage);
                }
                
                document.getElementById('chat-input').value = '';
                chatImageFile = null;
                
                const imageButton = document.getElementById('image-button');
                if (imageButton) {
                    imageButton.style.color = 'var(--primary-color)';
                }
                
                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.placeholder = 'Écrire un message...';
                }
                
                cancelReply();
                
                if (autoResizeTextarea) {
                    autoResizeTextarea();
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                showNotification('Erreur lors de l\'envoi du message', 'error');
            } finally {
                processingMessage = false;
            }
        }
        
        async function sendDirectMessage(chatId, text, imageData, replyTo) {
            if (!isOnline) {
                messageQueue.push({
                    direct: true,
                    chatId: chatId,
                    text: text,
                    imageData: imageData,
                    replyTo: replyTo
                });
                showNotification('Message mis en file d\'attente', 'info');
                return;
            }
            
            try {
                const messageData = {
                    text: text || '',
                    from: currentUser.uid,
                    createdAt: serverTimestamp(),
                    ...(imageData && { imageData }),
                    ...(replyTo && { replyTo })
                };
                
                const messagesRef = collection(db, "directChats", chatId, "messages");
                await addDoc(messagesRef, messageData);
                
                const chatRef = doc(db, "directChats", chatId);
                await updateDoc(chatRef, {
                    lastMessage: {
                        text: text || 'Image',
                        from: currentUser.uid,
                        timestamp: serverTimestamp()
                    },
                    lastMessageTime: serverTimestamp()
                });
                
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message direct:', error);
                handleFirestoreError(error, 'envoi du message direct');
                throw error;
            }
        }
        
        async function sendMessageToFirestore(groupId, text, imageData, replyTo) {
            if (!isOnline) {
                messageQueue.push({
                    groupId: groupId,
                    text: text,
                    imageData: imageData,
                    replyTo: replyTo
                });
                showNotification('Message mis en file d\'attente', 'info');
                return;
            }
            
            try {
                const messageData = {
                    text: text || '',
                    from: currentUser.uid,
                    createdAt: serverTimestamp(),
                    ...(imageData && { imageData }),
                    ...(replyTo && { replyTo })
                };
                
                const messagesRef = collection(db, "discussions", groupId, "messages");
                await addDoc(messagesRef, messageData);
                
                const groupRef = doc(db, "discussions", groupId);
                await updateDoc(groupRef, {
                    lastMessage: {
                        text: text || 'Image',
                        from: currentUser.uid,
                        timestamp: serverTimestamp()
                    },
                    lastUpdated: serverTimestamp()
                });
                
                if (groupImageCache[groupId] && imageData) {
                    delete groupImageCache[groupId];
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                handleFirestoreError(error, 'envoi du message');
                throw error;
            }
        }
        
        function replyToMessage() {
            if (!currentMessageForAction) return;
            
            replyingToMessage = {
                id: currentMessageForAction.id,
                from: currentMessageForAction.from,
                text: currentMessageForAction.text
            };
            
            const replyPreview = document.getElementById('reply-preview');
            const replyName = document.getElementById('reply-name');
            const replyContent = document.getElementById('reply-content');
            
            let senderName = 'Utilisateur';
            if (currentMessageForAction.from === currentUser.uid) {
                senderName = 'Vous';
            } else if (usersCache[currentMessageForAction.from]) {
                senderName = usersCache[currentMessageForAction.from].displayName || 'Utilisateur';
            }
            
            replyName.textContent = senderName;
            replyContent.textContent = currentMessageForAction.text || 'Message';
            
            replyPreview.classList.add('active');
            
            const chatInputWrapper = document.getElementById('chat-input-wrapper');
            chatInputWrapper.classList.add('with-reply');
            
            const chatInputContainer = document.getElementById('chat-input-container');
            chatInputContainer.classList.add('with-reply');
            
            if (autoResizeTextarea) {
                autoResizeTextarea();
            }
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.focus();
            }
        }
        
        function copyMessageText() {
            if (!currentMessageForAction || !currentMessageForAction.text) return;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentMessageForAction.text).then(() => {
                    showNotification('Message copié', 'success');
                }).catch(() => {
                    fallbackCopyText(currentMessageForAction.text);
                });
            } else {
                fallbackCopyText(currentMessageForAction.text);
            }
        }
        
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('Message copié', 'success');
            } catch (err) {
                showNotification('Impossible de copier le message', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        function showDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            history.pushState({ page: 'delete-confirmation' }, '');
        }
        
        function hideDeleteConfirmation() {
            document.getElementById('delete-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function confirmDeleteMessage() {
            if (!currentMessageForAction) return;
            
            hideDeleteConfirmation();
            
            try {
                const messageElement = currentMessageForAction.element;
                if (messageElement) {
                    messageElement.classList.add('deleting');
                }
                
                let messagesRef;
                if (currentChatPartner) {
                    const user1 = currentUser.uid;
                    const user2 = currentChatPartner.id;
                    const chatId = [user1, user2].sort().join('_');
                    messagesRef = collection(db, "directChats", chatId, "messages");
                } else {
                    messagesRef = collection(db, "discussions", currentGroupId, "messages");
                }
                
                const messageRef = doc(messagesRef, currentMessageForAction.id);
                await deleteDoc(messageRef);
                
                showNotification('Message supprimé', 'success');
                
                hideMessageActionsBar();
                
            } catch (error) {
                console.error('Erreur lors de la suppression du message:', error);
                handleFirestoreError(error, 'suppression du message');
                showNotification('Erreur lors de la suppression du message', 'error');
                
                if (currentMessageForAction && currentMessageForAction.element) {
                    currentMessageForAction.element.classList.remove('deleting');
                }
            }
        }
        
        function changeAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
            }
            
            clearAuthErrors();
        }
        
        function clearAuthErrors() {
            const errorElements = document.querySelectorAll('.form-error');
            errorElements.forEach(element => {
                element.style.display = 'none';
            });
            
            const logElements = document.querySelectorAll('.log-message');
            logElements.forEach(element => {
                element.style.display = 'none';
            });
        }
        
        function validateLoginEmail() {
            const email = document.getElementById('login-email').value;
            const errorElement = document.getElementById('login-email-error');
            
            if (!email || !isValidEmail(email)) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginPassword() {
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-password-error');
            
            if (!password) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterEmail() {
            const email = document.getElementById('register-email').value;
            const errorElement = document.getElementById('register-email-error');
            
            if (!email || !isValidEmail(email)) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterPassword() {
            const password = document.getElementById('register-password').value;
            const errorElement = document.getElementById('register-password-error');
            
            if (!password || password.length < 6) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateRegisterConfirmPassword() {
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const errorElement = document.getElementById('register-confirm-password-error');
            
            if (password !== confirmPassword) {
                errorElement.style.display = 'block';
                return false;
            } else {
                errorElement.style.display = 'none';
                return true;
            }
        }
        
        function validateLoginForm() {
            const emailValid = validateLoginEmail();
            const passwordValid = validateLoginPassword();
            return emailValid && passwordValid;
        }
        
        function validateRegisterForm() {
            const emailValid = validateRegisterEmail();
            const passwordValid = validateRegisterPassword();
            const confirmPasswordValid = validateRegisterConfirmPassword();
            return emailValid && passwordValid && confirmPasswordValid;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        async function loginUser() {
            if (!validateLoginForm()) return;
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            setButtonLoading('loginBtn', true);
            showAuthLog('login-log', 'Connexion en cours...', 'info');
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                showAuthLog('login-log', 'Connexion réussie !', 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                let errorMessage = 'Erreur de connexion';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Aucun compte trouvé avec cet email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Mot de passe incorrect';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Adresse email invalide';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Ce compte a été désactivé';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Trop de tentatives. Réessayez plus tard';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Erreur de connexion. Vérifiez votre internet';
                        break;
                    default:
                        errorMessage = `Erreur: ${error.message}`;
                }
                
                showAuthLog('login-log', errorMessage, 'error');
            } finally {
                setButtonLoading('loginBtn', false);
            }
        }
        
        async function registerUser() {
            if (!validateRegisterForm()) return;
            
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            setButtonLoading('registerBtn', true);
            showAuthLog('register-log', 'Création du compte...', 'info');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                await setDoc(doc(db, "Users", currentUser.uid), {
                    email: currentUser.email,
                    displayName: currentUser.displayName || 'Utilisateur',
                    photoURL: currentUser.photoURL || null,
                    statut: 'member',
                    createdAt: serverTimestamp()
                });
                
                showAuthLog('register-log', 'Compte créé avec succès !', 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                let errorMessage = 'Erreur lors de la création du compte';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Un compte existe déjà avec cet email';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Adresse email invalide';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'L\'inscription est temporairement désactivée';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Le mot de passe est trop faible';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Erreur de connexion. Vérifiez votre internet';
                        break;
                    default:
                        errorMessage = `Erreur: ${error.message}`;
                }
                
                showAuthLog('register-log', errorMessage, 'error');
            } finally {
                setButtonLoading('registerBtn', false);
            }
        }
        
        function showAuthLog(elementId, message, type) {
            const logElement = document.getElementById(elementId);
            logElement.className = `log-message ${type}`;
            logElement.textContent = message;
            logElement.style.display = 'block';
        }
        
        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            const loader = button.querySelector('.btn-loader');
            const text = button.querySelector('.btn-text');
            
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
                loader.style.display = 'inline-block';
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                loader.style.display = 'none';
            }
        }
        
        function showLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            history.pushState({ page: 'logout-confirmation' }, '');
        }
        
        function hideLogoutConfirmation() {
            document.getElementById('logout-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function logoutUser() {
            hideLogoutConfirmation();
            
            try {
                if (eventsUnsubscribe) {
                    eventsUnsubscribe();
                    eventsUnsubscribe = null;
                }
                
                if (forecastsUnsubscribe) {
                    forecastsUnsubscribe();
                    forecastsUnsubscribe = null;
                }
                
                if (usersUnsubscribe) {
                    usersUnsubscribe();
                    usersUnsubscribe = null;
                }
                
                Object.values(chatUnsubscribers).forEach(unsubscribe => {
                    if (unsubscribe) unsubscribe();
                });
                chatUnsubscribers = {};
                
                await signOut(auth);
                
                isLoggedIn = false;
                currentUser = null;
                currentUserData = null;
                isAdmin = false;
                
                showNotification('Déconnexion réussie', 'success');
                
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'flex';
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Erreur lors de la déconnexion:', error);
                showNotification('Erreur lors de la déconnexion', 'error');
            }
        }
        
        function showDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            history.pushState({ page: 'delete-account-confirmation' }, '');
        }
        
        function hideDeleteAccountConfirmation() {
            document.getElementById('delete-account-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        async function deleteAccount() {
            hideDeleteAccountConfirmation();
            
            try {
                showNotification('Suppression du compte en cours...', 'info');
                
                await deleteDoc(doc(db, "Users", currentUser.uid));
                
                await deleteUser(currentUser);
                
                showNotification('Compte supprimé avec succès', 'success');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Erreur lors de la suppression du compte:', error);
                
                let errorMessage = 'Erreur lors de la suppression du compte';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Veuillez vous reconnecter avant de supprimer votre compte';
                }
                
                showNotification(errorMessage, 'error');
            }
        }
        
        function updateProfileInfo() {
            if (!currentUserData) return;
            
            const profileNameElement = document.getElementById('profile-name-text');
            const profileEmailElement = document.getElementById('profile-email');
            const adminBadge = document.getElementById('admin-badge');
            const profilePic = document.querySelector('.profile-header .profile-pic');
            
            if (profileNameElement) {
                profileNameElement.textContent = currentUserData.displayName || 'Utilisateur';
            }
            
            if (profileEmailElement) {
                profileEmailElement.textContent = currentUserData.email || '';
            }
            
            if (adminBadge) {
                adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
            }
            
            if (profilePic) {
                if (currentUserData.photoURL) {
                    profilePic.innerHTML = `
                        <img src="${currentUserData.photoURL}" alt="Profile">
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                } else {
                    profilePic.innerHTML = `
                        <i class="fas fa-user"></i>
                        <div class="profile-pic-edit" id="edit-profile-pic">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                    `;
                }
                
                const editPicBtn = document.getElementById('edit-profile-pic');
                if (editPicBtn) {
                    editPicBtn.addEventListener('click', showProfileEditDialog);
                }
            }
        }
        
        function showCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.add('active');
            
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            document.getElementById('group-public-messages').checked = true;
            
            groupImageFile = null;
            
            const groupImagePreview = document.getElementById('new-group-image-preview');
            groupImagePreview.innerHTML = `
                <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                <div class="group-image-overlay" id="new-group-image-upload">
                    <i class="fas fa-camera"></i>
                </div>
            `;
            
            document.getElementById('new-group-image-upload').addEventListener('click', () => {
                document.getElementById('new-group-image-input').click();
            });
            
            document.querySelectorAll('.form-error').forEach(error => {
                error.style.display = 'none';
            });
            
            history.pushState({ page: 'create-group' }, '');
        }
        
        function hideCreateGroupDialog() {
            document.getElementById('create-group-dialog').classList.remove('active');
            groupImageFile = null;
            document.getElementById('new-group-image-input').value = '';
        }
        
        async function createNewGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const allowPublicMessages = document.getElementById('group-public-messages').checked;
            
            if (!groupName) {
                document.getElementById('group-name-error').style.display = 'block';
                return;
            } else {
                document.getElementById('group-name-error').style.display = 'none';
            }
            
            setButtonLoading('create-group-submit', true);
            
            try {
                const groupData = {
                    name: groupName,
                    description: groupDescription || '',
                    allowPublicMessages: allowPublicMessages,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp(),
                    ...(groupImageFile && { imageURL: groupImageFile })
                };
                
                const docRef = await addDoc(collection(db, "discussions"), groupData);
                
                try {
                    await addEventLog({
                        type: 'group-create',
                        groupId: docRef.id,
                        groupName: groupName,
                        userId: currentUser.uid,
                        timestamp: new Date()
                    });
                } catch (error) {
                }
                
                showNotification('Groupe créé avec succès', 'success');
                
                hideCreateGroupDialog();
                
                loadDiscussions();
                
                setTimeout(() => {
                    openChat(docRef.id, groupName, groupData);
                }, 500);
                
            } catch (error) {
                handleFirestoreError(error, 'création du groupe');
                showNotification('Erreur lors de la création du groupe', 'error');
            } finally {
                setButtonLoading('create-group-submit', false);
            }
        }
        
        function showEditGroupDialog(groupData) {
            if (!groupData || !editingGroupId) return;
            
            document.getElementById('edit-group-dialog').classList.add('active');
            
            document.getElementById('edit-group-name').value = groupData.name || '';
            document.getElementById('edit-group-description').value = groupData.description || '';
            document.getElementById('edit-group-public-messages').checked = groupData.allowPublicMessages !== false;
            
            const editGroupImagePreview = document.getElementById('edit-group-image-preview');
            if (groupData.imageURL) {
                editGroupImagePreview.innerHTML = `
                    <img src="${groupData.imageURL}" alt="Group Image">
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            } else {
                editGroupImagePreview.innerHTML = `
                    <i class="fas fa-users" style="color: white; font-size: 40px;"></i>
                    <div class="group-image-overlay" id="edit-group-image-upload">
                        <i class="fas fa-camera"></i>
                    </div>
                `;
            }
            
            document.getElementById('edit-group-image-upload').addEventListener('click', () => {
                document.getElementById('edit-group-image-input').click();
            });
            
            document.getElementById('save-group-name-btn').disabled = true;
            document.getElementById('save-group-description-btn').disabled = true;
            document.getElementById('save-group-permissions-btn').disabled = true;
            document.getElementById('save-group-image-btn').disabled = true;
            
            groupNameChanged = false;
            groupDescriptionChanged = false;
            groupPermissionsChanged = false;
            groupImageFile = null;
            
            document.querySelectorAll('.field-error').forEach(error => {
                error.style.display = 'none';
            });
            
            history.pushState({ page: 'edit-group' }, '');
        }
        
        function hideEditGroupDialog() {
            document.getElementById('edit-group-dialog').classList.remove('active');
            editingGroupId = null;
            groupImageFile = null;
            document.getElementById('edit-group-image-input').value = '';
        }
        
        async function listenToEvents() {
            if (isLoadingEvents) return;
            isLoadingEvents = true;
            
            const eventsList = document.getElementById('events-list');
            if (!eventsList) return;
            
            eventsList.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--primary-color);"></i>
                    <div style="margin-top: 10px; font-weight: bold;">Chargement des événements...</div>
                </div>
            `;
            
            try {
                if (eventsUnsubscribe) {
                    eventsUnsubscribe();
                    eventsUnsubscribe = null;
                }
                
                const eventsRef = collection(db, "events");
                const q = query(eventsRef, orderBy("timestamp", "desc"), limit(50));
                
                eventsUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-bell"></i>
                                <div class="empty-state-title">Aucun événement</div>
                                <div class="empty-state-text">Les événements apparaîtront ici</div>
                            </div>
                        `;
                        isLoadingEvents = false;
                        return;
                    }
                    
                    const events = [];
                    snapshot.forEach((doc) => {
                        events.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    displayEvents(events);
                    isLoadingEvents = false;
                }, (error) => {
                    handleFirestoreError(error, 'chargement des événements');
                    eventsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="empty-state-title">Erreur</div>
                            <div class="empty-state-text">Impossible de charger les événements</div>
                        </div>
                    `;
                    isLoadingEvents = false;
                });
            } catch (error) {
                handleFirestoreError(error, 'chargement des événements');
                eventsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="empty-state-title">Erreur</div>
                        <div class="empty-state-text">Impossible de charger les événements</div>
                    </div>
                `;
                isLoadingEvents = false;
            }
        }
        
        function displayEvents(events) {
            const eventsList = document.getElementById('events-list');
            if (!eventsList) return;
            
            eventsList.innerHTML = '';
            
            events.forEach(eventData => {
                const eventElement = createEventElement(eventData);
                eventsList.appendChild(eventElement);
            });
        }
        
        function createEventElement(eventData) {
            const eventElement = document.createElement('div');
            eventElement.className = `event-item ${eventData.type}`;
            eventElement.setAttribute('data-id', eventData.id);
            
            let iconClass = 'fas fa-bell';
            let eventContent = '';
            
            switch (eventData.type) {
                case 'group-create':
                    iconClass = 'fas fa-plus-circle';
                    eventContent = `Nouveau groupe créé : "${eventData.groupName}"`;
                    break;
                case 'permission-change':
                    iconClass = 'fas fa-shield-alt';
                    eventContent = `Permissions modifiées pour "${eventData.groupName}"`;
                    if (eventData.allowPublicMessages !== undefined) {
                        eventContent += ` - ${eventData.allowPublicMessages ? 'Ouvert à tous' : 'Restreint aux administrateurs'}`;
                    }
                    break;
                case 'user-join':
                    iconClass = 'fas fa-user-plus';
                    eventContent = `Nouvel utilisateur inscrit`;
                    break;
                case 'admin-notification':
                    iconClass = 'fas fa-bullhorn';
                    eventContent = eventData.title || 'Notification administrative';
                    break;
                default:
                    eventContent = eventData.content || 'Événement';
            }
            
            const timestamp = eventData.timestamp?.toDate?.() || new Date(eventData.timestamp);
            const timeString = timestamp.toLocaleString('fr-FR', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let adminActions = '';
            if (isAdmin) {
                adminActions = `
                    <div class="event-actions">
                        <div class="event-action-btn delete" onclick="deleteEvent('${eventData.id}')">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                `;
            }
            
            eventElement.innerHTML = `
                <div class="event-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="item-content">
                    <div class="event-header">${eventContent}</div>
                    ${eventData.content && eventData.type === 'admin-notification' ? `<div class="event-content">${eventData.content}</div>` : ''}
                    <div class="event-time">${timeString}</div>
                    ${adminActions}
                </div>
            `;
            
            return eventElement;
        }
        
        function deleteEvent(eventId) {
            currentEventForDeletion = eventId;
            showDeleteEventConfirmation();
        }
        
        function showDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            history.pushState({ page: 'delete-event-confirmation' }, '');
        }
        
        function hideDeleteEventConfirmation() {
            document.getElementById('delete-event-confirmation').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            currentEventForDeletion = null;
        }
        
        async function confirmDeleteEvent() {
            if (!currentEventForDeletion) return;
            
            hideDeleteEventConfirmation();
            
            try {
                await deleteDoc(doc(db, "events", currentEventForDeletion));
                showNotification('Événement supprimé', 'success');
            } catch (error) {
                handleFirestoreError(error, 'suppression de l\'événement');
                showNotification('Erreur lors de la suppression', 'error');
            }
            
            currentEventForDeletion = null;
        }
        
        function filterEvents(query) {
            const eventItems = document.querySelectorAll('.event-item');
            const lowerQuery = query.toLowerCase();
            
            eventItems.forEach(item => {
                const eventContent = item.textContent.toLowerCase();
                
                if (eventContent.includes(lowerQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            let visibleEvents = 0;
            eventItems.forEach(item => {
                if (item.style.display !== 'none') {
                    visibleEvents++;
                }
            });
            
            const eventsList = document.getElementById('events-list');
            const emptyState = eventsList.querySelector('.empty-state');
            
            if (visibleEvents === 0 && eventItems.length > 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('.empty-state-title').textContent = 'Aucun résultat';
                    emptyState.querySelector('.empty-state-text').textContent = `Aucun événement ne correspond à "${query}"`;
                } else {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <div class="empty-state-title">Aucun résultat</div>
                        <div class="empty-state-text">Aucun événement ne correspond à "${query}"</div>
                    `;
                    eventsList.appendChild(newEmptyState);
                }
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
        
        function showAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.add('active');
            
            document.getElementById('notif-title').value = '';
            document.getElementById('notif-content').value = '';
            document.getElementById('notif-type').value = 'info';
            
            document.querySelectorAll('.field-error').forEach(error => {
                error.style.display = 'none';
            });
            
            history.pushState({ page: 'admin-notification' }, '');
        }
        
        function hideAdminNotificationDialog() {
            document.getElementById('admin-notif-dialog').classList.remove('active');
        }
        
        async function sendAdminNotification() {
            const title = document.getElementById('notif-title').value.trim();
            const content = document.getElementById('notif-content').value.trim();
            const type = document.getElementById('notif-type').value;
            
            let hasErrors = false;
            
            if (!title) {
                document.getElementById('notif-title-error').style.display = 'block';
                hasErrors = true;
            } else {
                document.getElementById('notif-title-error').style.display = 'none';
            }
            
            if (!content) {
                document.getElementById('notif-content-error').style.display = 'block';
                hasErrors = true;
            } else {
                document.getElementById('notif-content-error').style.display = 'none';
            }
            
            if (hasErrors) return;
            
            setButtonLoading('send-notification-btn', true);
            
            try {
                await addEventLog({
                    type: 'admin-notification',
                    title: title,
                    content: content,
                    notificationType: type,
                    userId: currentUser.uid,
                    timestamp: new Date()
                });
                
                showNotification('Notification envoyée avec succès', 'success');
                hideAdminNotificationDialog();
                
            } catch (error) {
                handleFirestoreError(error, 'envoi de la notification');
                showNotification('Erreur lors de l\'envoi de la notification', 'error');
            } finally {
                setButtonLoading('send-notification-btn', false);
            }
        }
        
        async function addEventLog(eventData) {
            try {
                await addDoc(collection(db, "events"), {
                    ...eventData,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error('Erreur lors de l\'ajout de l\'événement:', error);
                throw error;
            }
        }
        
        function updateLastViewedEventTimestamp() {
            lastViewedEventTimestamp = new Date();
            hasNewEvents = false;
        }
        
        function hideEventNotificationDot() {
            const notificationDot = document.getElementById('events-notification-dot');
            if (notificationDot) {
                notificationDot.classList.remove('active');
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('verify-animation').style.display = 'flex';
            
            setupTheme();
            setupDarkMode();
            setupConnectionMonitoring();
            setupUIEvents();
            setupAuthEvents();
            
            onAuthStateChanged(auth, async (user) => {
                try {
                    if (user) {
                        currentUser = user;
                        isLoggedIn = true;
                        
                        const userDoc = await getDoc(doc(db, "Users", user.uid));
                        if (userDoc.exists()) {
                            currentUserData = userDoc.data();
                            isAdmin = currentUserData.statut === 'admin';
                        } else {
                            currentUserData = {
                                email: user.email,
                                displayName: user.displayName || 'Utilisateur',
                                photoURL: user.photoURL || null,
                                statut: 'member'
                            };
                            
                            await setDoc(doc(db, "Users", user.uid), {
                                ...currentUserData,
                                createdAt: serverTimestamp()
                            });
                        }
                        
                        updateProfileInfo();
                        
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('verify-animation').style.display = 'none';
                        
                        showDiscussionsSection();
                        
                    } else {
                        isLoggedIn = false;
                        currentUser = null;
                        currentUserData = null;
                        isAdmin = false;
                        
                        document.getElementById('verify-animation').style.display = 'none';
                        document.getElementById('auth-screen').style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'initialisation:', error);
                    document.getElementById('verify-animation').style.display = 'none';
                    document.getElementById('auth-screen').style.display = 'flex';
                }
            });
        });

        // Expose deleteEvent function globally for onclick handlers
        window.deleteEvent = deleteEvent;
    </script>
</body>
</html>
